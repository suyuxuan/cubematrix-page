System.register([],(function(e,t){"use strict";return{execute:async function(){e({A:void 0,E:void 0,F:void 0,G:void 0,H:void 0,I:void 0,J:void 0,L:void 0,M:void 0,O:void 0,Q:void 0,S:void 0,T:void 0,aF:void 0,aL:hc,aM:_c,aN:fc,aO:pc,aP:mc,b:void 0,b$:rf,b9:kM,bD:H,bE:B,bF:function(){},bO:ae,bP:re,bQ:ne,bS:Ac,bU:function(e,t,n,i,o){void 0===n&&(n=Ca.R32F),void 0===i&&(i=0),void 0===o&&(o=0);var r=ac[n];o||(o=r.size);for(var a="set"+KI(r),s=r.size/r.count,c=Math.floor(t.length/r.count),l=ux.isLittleEndian,u=0;u<c;++u)for(var h=i+o*u,_=0;_<r.count;++_){var f=h+s*_;e[a](f,t[r.count*u+_],l)}},bV:GR,bW:QI,bY:nt,bZ:function(e){return D_(F_({formerlySerializedAs:e}))},ba:WM,bd:$M,bj:ee,bk:J,bl:R,bm:y,bo:oe,bq:void 0,bs:void 0,bu:P,bv:g,bx:function(e,t,n,i,o,r){void 0===t&&(t=Ca.R32F),void 0===n&&(n=0),void 0===i&&(i=e.byteLength-n),void 0===o&&(o=0),void 0===r&&(r=[]);var a=ac[t];o||(o=a.size);for(var s="get"+KI(a),c=a.size/a.count,l=Math.floor(i/o),u=ux.isLittleEndian,h=0;h<l;++h)for(var _=n+o*h,f=0;f<a.count;++f){var d=_+c*f;r[a.count*h+f]=e[s](d,u)}return r},by:function(){},c:void 0,c1:void 0,cB:void 0,cD:void 0,cJ:void 0,cK:void 0,cR:we,cS:Ze,cU:Ri,cV:Fe,c_:void 0,cc:void 0,cd:void 0,cg:void 0,cr:sn,cs:$f,ct:function(e,t,n){for(Un.identity(n);e!==t;)Un.fromRTS(WF,e.rotation,e.position,e.scale),Un.multiply(n,WF,n),e=e.parent;return n},cx:BF,cy:zF,cz:FF,d:void 0,d0:rt,d9:on,dC:an,dF:pt,dK:rn,dS:tn,dU:pi,dX:xn,dY:le,db:$,dg:void 0,di:void 0,dn:void 0,dr:yt,ds:Le,dt:C,dv:void 0,dy:void 0,e:void 0,e$:void 0,e3:qn,e4:In,e5:Xn,e6:zn,e8:Vn,eC:Kt,eD:si,eE:Nd,eG:LI,eV:v,eW:x,eX:D,eY:L,eZ:F,e_:M,ea:Zn,eb:$n,ec:Tn,ee:nn,ef:cn,eh:un,ei:hn,ej:_n,ek:fn,el:dn,em:pn,en:mn,eo:vn,ep:gn,eq:yn,er:tt,ex:function(e){e>0&&(X=e)},ey:wy,ez:Cy,f:void 0,fI:KF,fJ:QF,fK:ZF,fL:yL,fM:CL,fQ:bL,fR:RL,fU:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},fW:rz,fa:Yw,g:void 0,h:void 0,i:void 0,j:void 0,k:void 0,l:void 0,m:void 0,n:void 0,o:void 0,p:void 0,q:void 0,r:void 0,s:void 0,t:void 0,u:void 0,v:void 0,w:void 0,x:void 0,y:void 0,z:void 0});const n=e("bt",!1),i=e("dJ",!1),o=e("dH",!1),r=e("dI",!1);var a="undefined"==typeof window?global:window,s=e("bw",{_global:a});s.internal={},a.CC_BUILD=!0,a.CC_TEST=!1,a.CC_EDITOR=false,a.CC_PREVIEW=!1,a.CC_DEV=!1,a.CC_DEBUG=!1,a.CC_JSB=r,a.CC_BYTEDANCE=!1,a.CC_WECHAT=n,a.CC_ALIPAY=!1,a.CC_XIAOMI=!1,a.CC_BAIDU=!1,a.CC_COCOSPLAY=!1,a.CC_HUAWEI=!1,a.CC_OPPO=!1,a.CC_VIVO=!1,a.CC_MINIGAME=o,a.CC_RUNTIME_BASED=i,a.CC_SUPPORT_JIT=!0;var c=e("e1","3.2.0");a.CocosEngine=s.ENGINE_VERSION=c,a.cc=s;var l="https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md",u=null,h=console.log.bind(console),_=h,f=h,d=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];console.log("ASSERT: "+m.apply(void 0,[t].concat(i)))}},p=h;function m(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return s.js.formatStr.apply(null,[e].concat(n))}function v(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return h.apply(void 0,[e].concat(n))}function g(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return _.apply(void 0,[e].concat(n))}function y(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return f.apply(void 0,[e].concat(n))}function x(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];return d.apply(void 0,[e,t].concat(i))}function E(){return p.apply(void 0,arguments)}function S(e){if(h=_=f=d=p=function(){},e!==N.NONE){if(e>N.ERROR){var t=function(e){if(s.game.canvas){if(!u){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",s.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(u=document.createElement("textarea")).setAttribute("rows","20"),u.setAttribute("cols","30"),u.setAttribute("disabled","true");var i=u.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(u),s.game.canvas.parentNode.appendChild(t)}u.value=u.value+e+"\r\n",u.scrollTop=u.scrollHeight}};f=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];t("ERROR :  "+m.apply(void 0,[e].concat(i)))},d=function(e,n){if(!e){for(var i=arguments.length,o=new Array(i>2?i-2:0),r=2;r<i;r++)o[r-2]=arguments[r];t("ASSERT: "+m.apply(void 0,[n].concat(o)))}},e!==N.ERROR_FOR_WEB_PAGE&&(_=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];t("WARN :  "+m.apply(void 0,[e].concat(i)))}),e===N.INFO_FOR_WEB_PAGE&&(h=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];t(m.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),f=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},d=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];var r=m.apply(void 0,[t].concat(i));throw new Error(r)}});if(e!==N.ERROR&&(_=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e===N.INFO&&(h=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=N.VERBOSE&&"function"==typeof console.debug){var n=console.debug;p=function(){return n.apply(void 0,arguments)}}}}function T(e){y(e.stack||e)}function A(e){return function(t){for(var n=e+" "+t+", please go to "+l+"#"+t+" to see details.",i=arguments.length,o=new Array(i>1?i-1:0),r=1;r<i;r++)o[r-1]=arguments[r];return 0===o.length?n:n+" Arguments: "+o.join(", ")}}var w=A("Log");function C(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];v(w.apply(void 0,[e].concat(n)))}var I=A("Warning");function P(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];g(I.apply(void 0,[e].concat(n)))}var b=A("Error");function R(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];y(b.apply(void 0,[e].concat(n)))}var N,O=A("Assert");function D(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];x(!1,O.apply(void 0,[t].concat(i)))}}function M(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return b.apply(void 0,[e].concat(n))}function L(){return!!s.profiler&&s.profiler.isShowingStats()}function F(e){s.profiler&&(e?s.profiler.showStats():s.profiler.hideStats(),s.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(N||(N=e("e$",{})));var z=Object.freeze({__proto__:null,log:v,warn:g,error:y,assert:x,debug:E,_resetDebugSetting:S,_throw:T,logID:C,warnID:P,errorID:R,assertID:D,get DebugMode(){return N},getError:M,isDisplayStats:L,setDisplayStats:F});function B(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function U(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function H(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}var G=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,o=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--o;e[t]=i<<o&255}}(G);var V=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(e){return(e>0)-(e<0)},abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:B,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:U,nextPow2:H,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return G[255&e]<<24|G[e>>>8&255]<<16|G[e>>>16&255]<<8|G[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>U(e)+1}});e("e2",V);var k,W,j,q,Y,X=10,K=0,Q=new Map;function Z(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function J(e,t,n){return t&&Z(e.prototype,t),n&&Z(e,n),e}function $(){return($=e("db",Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e})).apply(this,arguments)}function ee(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,te(e,t)}function te(e,t){return(te=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ne(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ie(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function oe(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ie(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ie(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function re(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function ae(e,t,n,i,o){var r={};return Object.keys(i).forEach((function(e){r[e]=i[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),r),o&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(o):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null),r}j=function(e,t,n,i,o,r,a){var s=Q.get(r);s&&s.logTimes>s.count&&(o("'%s' is deprecated, please use '%s' instead. "+a,e+"."+t,n+"."+i),s.count++)},k=e("cc",(function(e,t,n){null!=e&&n.forEach((function(n){var i=K++;Q.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var o=null!=n.target?n.target:e,r=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:t,s=o===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return j(t,n.name,a,r,g,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return j(t,n.name,a,r,g,i,c),n.customGetter.call(this)},set:function(e){j(t,n.name,a,r,g,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){j(t,n.name,a,r,g,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return j(t,n.name,a,r,g,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return j(t,n.name,a,r,g,i,c),s?this[r]:o[r]},set:function(e){j(t,n.name,a,r,g,i,c),s?this[r]=e:o[r]=e},enumerable:!1})}))})),Y=function(e,t,n,i,o){var r=Q.get(i);r&&r.logTimes>r.count&&(n("'%s' has been removed. "+o,e+"."+t),r.count++)},W=e("cd",(function(e,t,n){null!=e&&n.forEach((function(n){var i=K++;Q.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var o=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return Y(t,n.name,y,i,o)},set:function(){Y(t,n.name,y,i,o)},enumerable:!1})}))})),q=function(e,t,n,i,o){var r=Q.get(i);r&&r.logTimes>r.count&&(n("'%s' is deprecated. "+o,e+"."+t),r.count++)},e("dg",(function(e,t,n){if(null!=e){var i=function(t,n,i,o,r,a){if(t.get){var s=t.get;t.get=function(){return q(n,i,o,r,a),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){q(n,i,o,r,a),c.call(this,e)}}Object.defineProperty(e,i,t)};n.forEach((function(n){var o=n.name,r=Object.getOwnPropertyDescriptor(e,o);if(r&&r.configurable){var a=K++;Q.set(a,{id:a,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var s=n.suggest?"("+n.suggest+")":"";if(null!=r.value)if("function"==typeof r.value){var c=r.value;e[o]=function(){return q(t,o,g,a,s),c.call.apply(c,[this].concat(Array.prototype.slice.call(arguments)))}}else i(r,t,o,g,a,s);else i(r,t,o,g,a,s);Object.defineProperty(e,o,{enumerable:!1})}}))}}));var se=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},J(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function ce(e,t){e.splice(t,1)}function le(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function ue(e,t){var n=e.indexOf(t);return n>=0&&(ce(e,n),!0)}function he(e,t){return e.indexOf(t)>=0}var _e=Object.freeze({__proto__:null,removeAt:ce,fastRemoveAt:le,remove:ue,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:function(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return ce(e,n),i}},verifyType:function(e,t){if(e&&e.length>0)for(var n,i=oe(e);!(n=i()).done;)if(!(n.value instanceof t))return C(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)ue(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:he,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:se}),fe=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();fe.global=new fe("global");var de=new fe("TmpCId."),pe="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),me="__cid__";function ve(e){return"number"==typeof e||e instanceof Number}function ge(e){return"string"==typeof e||e instanceof String}function ye(e){for(var t in e)return!1;return!0}var xe,Ee=(xe={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,o){xe.value=n,xe.writable=i,xe.enumerable=o,Object.defineProperty(e,t,xe),xe.value=void 0}),Se=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,o,r,a){void 0===r&&(r=!1),void 0===a&&(a=!1),"boolean"==typeof o&&(r=o,o=void 0),e.get=i,e.set=o,e.enumerable=r,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),Te=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,o,r){e.get=i,e.enumerable=o,e.configurable=r,Object.defineProperty(t,n,e),e.get=void 0}}(),Ae=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,o,r){e.set=i,e.enumerable=o,e.configurable=r,Object.defineProperty(t,n,e),e.set=void 0}}();function we(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function Ce(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,o=e.toString();(i="["===o.charAt(0)?o.match(/\[\w+\s*(\w+)\]/):o.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?Ce(e.constructor):""}function Ie(e,t,n,i){var o=/([^.]+)$/,r=o.exec(t)[0],a=o.exec(n)[0];function s(){return this[a]}i?Se(e,r,s,(function(e){this[a]=e})):Te(e,r,s)}function Pe(e,t,n,i){for(var o in n)Ie(e,t+"."+o,n[o],i)}var be=/(%d)|(%s)/,Re=/%s/;function Ne(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var o="string"==typeof e&&be.test(e);if(o)for(var r,a=oe(n);!(r=a()).done;){var s=r.value,c="number"==typeof s?be:Re;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=oe(n);!(u=h()).done;){var _=u.value;e+=" "+_}return e}function Oe(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function De(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function Me(e,t,n){var i=De(t,e);i&&Object.defineProperty(n,e,i)}function Le(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var o=0,r=n;o<r.length;o++){var a=r[o];if(a){if("object"!=typeof a){R(5402,a);continue}for(var s in a)s in e||Me(s,a,e)}}return e}function Fe(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var o=0,r=n;o<r.length;o++){var a=r[o];if(a){if("object"!=typeof a){R(5403,a);continue}for(var s in a)Me(s,a,e)}}return e}function ze(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Be(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function Ue(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Be(e)))return!1;if(e===t)return!0}}return!1}function He(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var Ge=we(!0),Ve=we(!0);function ke(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],Ee(i.prototype,e,n),n){var o=t[n];o&&o!==i?y("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var We=ke("__cid__",Ge),je=ke("__classname__",Ve);function qe(e,t){if(je(e,t),!t.prototype.hasOwnProperty(me)){var n=e||de.getNewId();n&&We(n,t)}}function Ye(e,t){var n=Ve[t],i=Ge[t],o=!0;if(n&&n!==e&&(y('"'+t+'" has already been set as name or alias of another class.'),o=!1),i&&i!==e&&(y('"'+t+'" has already been set as id or alias of another class.'),o=!1),o){var r=e[pe];r||(r=[],e[pe]=r),r.push(t),Ve[t]=e,Ge[t]=e}}function Xe(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,o=t;i<o.length;i++){var r=o[i],a=r.prototype,s=a.__cid__;s&&delete Ge[s];var c=a.__classname__;c&&delete Ve[c];var l=a[pe];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete Ve[h],delete Ge[h]}}}function Ke(e){return Ge[e]}function Qe(e){return Ve[e]}function Ze(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(me))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(me))return e.__cid__}return""}var Je=e("cW",function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}()),$e=e("dP",_e),et=e("cf",{IDGenerator:fe,Pool:Je,array:_e,isNumber:ve,isString:ge,isEmptyObject:ye,getPropertyDescriptor:De,addon:Le,mixin:Fe,extend:ze,getSuper:Be,isChildClassOf:Ue,clear:He,value:Ee,getset:Se,get:Te,set:Ae,unregisterClass:Xe,getClassName:Ce,setClassName:qe,setClassAlias:Ye,getClassByName:Qe,get _registeredClassNames(){return $({},Ve)},set _registeredClassNames(e){He(Ve),Object.assign(Ve,e)},get _registeredClassIds(){return $({},Ge)},set _registeredClassIds(e){He(Ge),Object.assign(Ge,e)},_getClassId:Ze,_setClassId:We,_getClassById:Ke,obsolete:Ie,obsoletes:Pe,formatStr:Ne,shiftArguments:Oe,createMap:we});function tt(e){if("__bitmask__"in e)return e;Ee(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var o=n[i],r=e[o];if(-1===r)r=++t,e[o]=r;else if("number"==typeof r)t=r;else if("string"==typeof r&&Number.isInteger(parseFloat(o)))continue;var a=""+r;o!==a&&Ee(e,a,o)}return e}function nt(e){return"__enums__"in e?e:(Ee(e,"__enums__",null,!0),nt.update(e))}function it(e){e.hasOwnProperty("__enums__")}function ot(e){it(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function rt(e){"__enums__"in e||Ee(e,"__enums__",null,!0)}s.js=et,e("et",Object.freeze({__proto__:null,array:$e,js:et,IDGenerator:fe,Pool:Je,isNumber:ve,isString:ge,isEmptyObject:ye,value:Ee,getset:Se,get:Te,set:Ae,createMap:we,getClassName:Ce,obsolete:Ie,obsoletes:Pe,formatStr:Ne,shiftArguments:Oe,getPropertyDescriptor:De,addon:Le,mixin:Fe,extend:ze,getSuper:Be,isChildClassOf:Ue,clear:He,_idToClass:Ge,_nameToClass:Ve,_setClassId:We,setClassName:qe,setClassAlias:Ye,unregisterClass:Xe,_getClassById:Ke,getClassByName:Qe,_getClassId:Ze})),tt.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},tt.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},s.BitMask=tt,nt.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var o=n[i],r=e[o];if(-1===r)r=++t,e[o]=r;else if("number"==typeof r)t=r;else if("string"==typeof r&&Number.isInteger(parseFloat(o)))continue;var a=""+r;o!==a&&Ee(e,a,o)}return Array.isArray(e.__enums__)&&ot(e),e},nt||(nt=e("bY",{})),nt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},nt.getList=function(e){return it(e),e.__enums__?e.__enums__:ot(e)},s.Enum=nt;var at=e("es",function(){function e(){}var t=e.prototype;return t.clone=function(){return R(100,Ce(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){R(100,Ce(this)+".set")},t.toString=function(){return""+{}},e}());qe("cc.ValueType",at),s.ValueType=at;var st=e("bn",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20});s.macro=st;for(var ct=/^(?:cc|dragonBones|sp|ccsg)\..+/,lt=new Array(123),ut=0;ut<123;++ut)lt[ut]=64;for(var ht=0;ht<64;++ht)lt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(ht)]=ht;var _t=lt;function ft(e,t,n){function i(e,t,n,i){var o=Object.getOwnPropertyDescriptor(e,t);if(o)o.get&&(e[n]=o.get),o.set&&i&&(e[i]=o.set);else{var r=e[n];Se(e,t,r,e[i])}}for(var o,r=e.prototype,a=0;a<t.length;a++){var s=(o=t[a])[0].toUpperCase()+o.slice(1);i(r,o,"get"+s,"set"+s)}for(o in n){var c=n[o];i(r,o,c[0],c[1])}}function dt(e,t,n,i){var o=e[t];o?Array.isArray(o)?i?(o.push(o[0]),o[0]=n):o.push(n):e[t]=i?[n,o]:[o,n]:e[t]=n}function pt(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function mt(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function vt(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function gt(e){return!(!e||e.constructor!==Object)&&ye(e)}function yt(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function xt(e){return e*st.RAD}function Et(e){return e*st.DEG}s.misc={BUILTIN_CLASSID_RE:ct,BASE64_VALUES:_t,propertyDefine:ft,pushToMap:dt,contains:pt,isDomNode:mt,callInNextTick:vt,isPlainEmptyObj_DEV:gt,clampf:yt,degreesToRadians:xt,radiansToDegrees:Et},e("eu",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:ct,BASE64_VALUES:_t,propertyDefine:ft,pushToMap:dt,contains:pt,isDomNode:mt,callInNextTick:vt,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:gt,clampf:yt,degreesToRadians:xt,radiansToDegrees:Et}));var St="$_$";function Tt(e,t){var n=t?Object.create(t):{};return Ee(e,"__attrs__",n),n}function At(e){if("function"!=typeof e)return Tt(e,Ct(e.constructor));for(var t,n=s.Class.getInheritanceChain(e),i=n.length-1;i>=0;i--){var o=n[i];o.hasOwnProperty("__attrs__")&&o.__attrs__||Tt(o,(t=n[i+1])&&t.__attrs__)}return Tt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function wt(e,t){var n=Ct(e),i=t+St,o={};for(var r in n)r.startsWith(i)&&(o[r.slice(i.length)]=n[r]);return o}function Ct(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||At(e)}function It(e,t,n,i){Ct(e)[t+St+n]=i}var Pt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),bt=e("eH",new Pt("Integer",0));s.Integer=bt,s.CCInteger=bt;var Rt=e("eI",new Pt("Float",0));s.Float=Rt,s.CCFloat=Rt;var Nt=e("eJ",new Pt("Boolean",!1));s.Boolean=Nt,s.CCBoolean=Nt;var Ot=e("ce",new Pt("String",""));function Dt(e,t){return function(n,i){var o='"'+Ce(n)+"."+i+'"',r=wt(n,i),a=r.type;if(a===bt||a===Rt?a="Number":a!==Ot&&a!==Nt||(a=""+a),a===e){if(r.hasOwnProperty("default")){var s=r.default;if(void 0!==s&&!Array.isArray(s)&&!gt(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof r.ctor)return;P(3605,o,Ce(r.ctor))}else"Number"!==e&&P(3606,t,o,e);else{if("function"===c)return;e===Ot.default&&null==s?P(3607,o):P(3611,t,o,c)}delete r.type}}}else P(3604,o)}}s.String=Ot,s.CCString=Ot;var Mt=Object.freeze({__proto__:null,DELIMETER:St,createAttrsSingle:Tt,createAttrs:At,attr:wt,getClassAttrs:Ct,setClassAttr:It,PrimitiveType:Pt,CCInteger:bt,CCFloat:Rt,CCBoolean:Nt,CCString:Ot,getTypeChecker_ET:Dt,getObjTypeChecker_ET:function(e){return function(t,n){Dt("Object","type")(t,n);var i=Ct(t)[n+St+"default"],o=s.Class.getDefault(i);if(!Array.isArray(o)&&Ue(e,s.ValueType)){var r=Ce(e),a=Ne('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Ce(t),n,r);i?v(a):P(3612,a,r,Ce(t),n,r)}}}}),Lt={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Ft(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var o="_N$"+t;e.get=function(){return this[o]},e.set=function(e){var t=this[o];this[o]=e,n.call(this,t)};var r={};for(var a in i[o]=r,Lt){var s=Lt[a];e.hasOwnProperty(a)&&(r[a]=e[a],s.canUsedInGet||delete e[a])}}}function zt(e,t,n,i){if(Array.isArray(t)){if(!(t.length>0))return R(5508,n,i);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=s.String:t===Boolean?e.type=s.Boolean:t===Number&&(e.type=s.Float))}function Bt(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function Ut(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return Bt(t,[],e);if("function"==typeof e){var n=e;return Bt(t,Ue(n,s.ValueType)?new n:null,n)}return Bt(t,e instanceof Pt?e.default:e)}return null}var Ht=[];function Gt(){return Ht[Ht.length-1]}s._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),Ht.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=Ht.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:Gt};var Vt=St,kt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,o=n.props;"function"==typeof o&&(o=o());var r=Ce(i);o?Xt(i,r,o,i.$super,n.mixins):R(3633,r)}this.datas=null}}};function Wt(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),Zt(e,i,t,n)}function jt(e,t,n,i){var o=i.get;i.set,o&&(Zt(e,i,t,n),It(e,n,"serializable",!1))}function qt(e){return"function"==typeof e?e():e}function Yt(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,De(t,i))}function Xt(e,t,n,i,o){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),o)for(var r=0;r<o.length;++r){var a=o[r];a.__props__&&(e.__props__=e.__props__.concat(a.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],o=Ut(i,!1);if(o&&(i=e[n]=o),i){var r=i.notify;r&&Ft(i,n,r,e),"type"in i&&zt(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?jt(e,t,s,c):Wt(e,t,s,c)}var l=Ct(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+Vt+"serializable"]}))}function Kt(e){var t=e.name,n=e.extends,i=e.mixins,o=function(e,t,n,i){var o=s.Component,r=Gt();if(r&&Ue(t,o)){if(Ue(r.cls,o))return R(3615),null;e=e||r.script}var a=function(e,t,n,i){var o=i.ctor,r=[o],a=o;Ee(a,"__ctors__",r.length>0?r:null,!0);var s=a.prototype;if(t&&(a.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Yt(s,l.prototype),Kt._isCCClass(l)&&Yt(Ct(a),Ct(l))}s.constructor=a}return qe(e,a),a}(e,t,n,i);if(r)if(Ue(t,o)){var c=r.uuid;c&&We(c,a),r.cls=a}else Ue(r.cls,o)||(r.cls=a);return a}(t,n,i,e);t||(t=s.js.getClassName(o)),o._sealed=!0,n&&(n._sealed=!1);var r=e.properties;"function"==typeof r||n&&null===n.__props__||i&&i.some((function(e){return null===e.__props__}))?(kt.push({cls:o,props:r,mixins:i}),o.__props__=o.__values__=null):Xt(o,t,r,n,e.mixins);var a=e.editor;return a&&Ue(n,s.Component)&&s.Component._registerEditorProps(o,a),o}Kt._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},Kt.fastDefine=function(e,t,n){qe(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),o=Ct(t),r=0;r<i.length;r++){var a=i[r];o[a+Vt+"visible"]=!1,o[a+Vt+"default"]=n[a]}},Kt.Attr=Mt,Kt.attr=wt,Kt.getInheritanceChain=function(e){for(var t=[];e=Be(e);)e!==Object&&t.push(e);return t};var Qt={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Zt(e,t,n,i){var o=null,r="";function a(){return r=i+Vt,o=Ct(e)}"type"in t&&void 0===t.type&&P(3660,i,n);var s=t.type;s&&(Qt[s]?(o||a())[r+"type"]=s:"Object"===s||("object"==typeof s?nt.isEnum(s)?((o||a())[r+"type"]="Enum",o[r+"enumList"]=nt.getList(s)):tt.isBitMask(s)&&((o||a())[r+"type"]="BitMask",o[r+"bitmaskList"]=tt.getList(s)):"function"==typeof s&&((o||a())[r+"type"]="Object",o[r+"ctor"]=s))),"default"in t&&((o||a())[r+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((o||a())[r+e]=i)}};t.editorOnly&&((o||a())[r+"editorOnly"]=!0),t.__noImplicit?(o||a())[r+"serializable"]=null!==(c=t.serializable)&&void 0!==c&&c:!1===t.serializable&&((o||a())[r+"serializable"]=!1),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((o||a())[r+"min"]=u[0],o[r+"max"]=u[1],u.length>2&&(o[r+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Kt.isArray=function(e){return e=qt(e),Array.isArray(e)},Kt.getDefault=qt,Kt.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Kt.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Kt.getNewValueTypeCode=function(e){for(var t=Ce(e),n=e.constructor,i="new "+t+"(",o=0;o<n.__props__.length;o++)i+=e[n.__props__[o]],o<n.__props__.length-1&&(i+=",");return i+")"},s.Class=Kt;var Jt=Math.PI/180,$t=180/Math.PI,en=e("ed",1e-6);function tn(e,t){return Math.abs(e-t)<=en*Math.max(1,Math.abs(e),Math.abs(t))}function nn(e,t,n){return n=n||en,Math.abs(e-t)<=n}function on(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function rn(e){return e<0?0:e>1?1:e}function an(e,t,n){return e+(t-e)*n}function sn(e){return e*Jt}function cn(e){return e*$t}var ln=e("eg",Math.random);function un(e,t){return Math.random()*(t-e)+e}function hn(e,t){return Math.floor(un(e,t))}function _n(e){return(e=(9301*e+49297)%233280)/233280}function fn(e,t,n){return _n(e)*(n-t)+t}function dn(e,t,n){return Math.floor(fn(e,t,n))}function pn(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function mn(e,t){return e-Math.floor(e/t)*t}function vn(e,t){return e=mn(e,2*t),t-Math.abs(e-t)}function gn(e,t,n){return(n-e)/(t-e)}function yn(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function xn(e,t){return Math.abs(e)>Math.abs(t)?e:t}var En=1/255,Sn=e("cl",function(e){function t(t,n,i,o){var r;return(r=e.call(this)||this)._val=0,"string"==typeof t?r.fromHEX(t):void 0!==n?r.set(t,n,i,o):r.set(t),r}ee(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,o){return e.r=t,e.g=n,e.b=i,e.a=o,e},t.fromHEX=function(e,t){return t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0,e.a=parseInt(t.substr(6,2),16)||255,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var o=t.r,r=t.g,a=t.b,s=t.a;return o+=(n.r-o)*i,r+=(n.g-r)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(a<<16)+(r<<8)+o),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var o=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*o,e[i+1]=n.g*o,e[i+2]=n.b*o,e[i+3]=n.a*o,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=en),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,o=this.b,r=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,o+=(e.b-o)*t,r+=(e.a-r)*t,this._val=Math.floor((r<<24>>>0)+(o<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*En).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,o=parseInt(e.substr(6,2),16)||255;return this._val=(o<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,o=0,r=0;if(0===t)i=o=r=n;else if(0===n)i=o=r=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),s=e-a,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(a){case 0:i=n,o=u,r=c;break;case 1:i=l,o=n,r=c;break;case 2:i=c,o=n,r=u;break;case 3:i=c,o=l,r=n;break;case 4:i=u,o=c,r=n;break;case 5:i=n,o=c,r=l}}return i*=255,o*=255,r*=255,this._val=(this.a<<24>>>0)+(r<<16)+(o<<8)+(0|i),this},n.toHSV=function(){var e=this.r*En,t=this.g*En,n=this.b*En,i={h:0,s:0,v:0},o=Math.max(e,t,n),r=Math.min(e,t,n),a=0;return i.v=o,i.s=o?(o-r)/o:0,i.s?(a=o-r,i.h=e===o?(t-n)/a:t===o?2+(n-e)/a:4+(e-t)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,o=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&o|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},J(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~on(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~on(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~on(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~on(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*En},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*En},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*En},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*En},set:function(e){this.a=255*e}}]),t}(at));function Tn(e,t,n,i){return new Sn(e,t,n,i)}Sn.WHITE=Object.freeze(new Sn(255,255,255,255)),Sn.GRAY=Object.freeze(new Sn(127,127,127,255)),Sn.BLACK=Object.freeze(new Sn(0,0,0,255)),Sn.TRANSPARENT=Object.freeze(new Sn(0,0,0,0)),Sn.RED=Object.freeze(new Sn(255,0,0,255)),Sn.GREEN=Object.freeze(new Sn(0,255,0,255)),Sn.BLUE=Object.freeze(new Sn(0,0,255,255)),Sn.CYAN=Object.freeze(new Sn(0,255,255,255)),Sn.MAGENTA=Object.freeze(new Sn(255,0,255,255)),Sn.YELLOW=Object.freeze(new Sn(255,255,0,255)),Kt.fastDefine("cc.Color",Sn,{r:0,g:0,b:0,a:255}),s.Color=Sn,s.color=Tn;var An=e("bJ",function(e){function t(t,n,i){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z):(o.x=t||0,o.y=n||0,o.z=i||0),o}ee(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,o=t.z-e.z;return Math.sqrt(n*n+i*i+o*o)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,o=t.z-e.z;return n*n+i*i+o*o},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,o=t.z;return Math.abs(n)<en?e.x=0:e.x=1/n,Math.abs(i)<en?e.y=0:e.y=1/i,Math.abs(o)<en?e.z=0:e.z=1/o,e},t.normalize=function(e,t){var n=t.x,i=t.y,o=t.z,r=n*n+i*i+o*o;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r,e.z=o*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,o=t.y,r=t.z,a=n.x,s=n.y,c=n.z;return e.x=o*c-r*s,e.y=r*a-i*c,e.z=i*s-o*a,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*ln()*Math.PI,i=2*ln()-1,o=Math.sqrt(1-i*i);return e.x=o*Math.cos(n)*t,e.y=o*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,o=t.y,r=t.z,a=n.m03*i+n.m07*o+n.m11*r+n.m15;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*o+n.m08*r+n.m12)*a,e.y=(n.m01*i+n.m05*o+n.m09*r+n.m13)*a,e.z=(n.m02*i+n.m06*o+n.m10*r+n.m14)*a,e},t.transformMat4Normal=function(e,t,n){var i=t.x,o=t.y,r=t.z,a=n.m03*i+n.m07*o+n.m11*r;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*o+n.m08*r)*a,e.y=(n.m01*i+n.m05*o+n.m09*r)*a,e.z=(n.m02*i+n.m06*o+n.m10*r)*a,e},t.transformMat3=function(e,t,n){var i=t.x,o=t.y,r=t.z;return e.x=i*n.m00+o*n.m03+r*n.m06,e.y=i*n.m01+o*n.m04+r*n.m07,e.z=i*n.m02+o*n.m05+r*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,o=t.y,r=t.z;return e.x=n.m00*i+n.m04*o+n.m08*r+n.m12,e.y=n.m01*i+n.m05*o+n.m09*r+n.m13,e.x=n.m02*i+n.m06*o+n.m10*r+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,o=n.w*t.y+n.z*t.x-n.x*t.z,r=n.w*t.z+n.x*t.y-n.y*t.x,a=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+a*-n.x+o*-n.z-r*-n.y,e.y=o*n.w+a*-n.y+r*-n.x-i*-n.z,e.z=r*n.w+a*-n.z+i*-n.y-o*-n.x,e},t.transformRTS=function(e,t,n,i,o){var r=t.x*o.x,a=t.y*o.y,s=t.z*o.z,c=n.w*r+n.y*s-n.z*a,l=n.w*a+n.z*r-n.x*s,u=n.w*s+n.x*a-n.y*r,h=-n.x*r-n.y*a-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,o){var r=t.x-i.x,a=t.y-i.y,s=t.z-i.z,c=n.w*r-n.y*s+n.z*a,l=n.w*a-n.z*r+n.x*s,u=n.w*s-n.x*a+n.y*r,h=n.x*r+n.y*a+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/o.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/o.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/o.z,e},t.rotateX=function(e,t,n,i){var o=t.x-n.x,r=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=o,u=r*s-a*c,h=r*c+a*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var o=t.x-n.x,r=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+o*s,u=r,h=a*s-o*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var o=t.x-n.x,r=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=o*s-r*c,u=o*c+r*s,h=a;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=en);var i=e.x,o=e.y,r=e.z,a=t.x,s=t.y,c=t.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(o-s)<=n*Math.max(1,Math.abs(o),Math.abs(s))&&Math.abs(r-c)<=n*Math.max(1,Math.abs(r),Math.abs(c))},t.angle=function(e,n){t.normalize(wn,e),t.normalize(Cn,n);var i=t.dot(wn,Cn);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var o=t.lengthSqr(i);return o<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/o)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=en),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=en),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=on(this.x,e.x,t.x),this.y=on(this.y,e.y,t.y),this.z=on(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,o=e.x,r=e.y,a=e.z;return this.x=n*a-i*r,this.y=i*o-t*a,this.z=t*r-n*o,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,o=e.m03*t+e.m07*n+e.m11*i+e.m15;return o=o?1/o:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*o,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*o,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*o,this},t}(at));An.UNIT_X=Object.freeze(new An(1,0,0)),An.UNIT_Y=Object.freeze(new An(0,1,0)),An.UNIT_Z=Object.freeze(new An(0,0,1)),An.RIGHT=Object.freeze(new An(1,0,0)),An.UP=Object.freeze(new An(0,1,0)),An.FORWARD=Object.freeze(new An(0,0,-1)),An.ZERO=Object.freeze(new An(0,0,0)),An.ONE=Object.freeze(new An(1,1,1)),An.NEG_ONE=Object.freeze(new An(-1,-1,-1));var wn=new An,Cn=new An;function In(e,t,n){return new An(e,t,n)}Kt.fastDefine("cc.Vec3",An,{x:0,y:0,z:0}),s.Vec3=An,s.v3=In;var Pn=e("e7",function(e){function t(t,n,i,o,r,a,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=o,u.m04=r,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}ee(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,o,r,a,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=o,e.m04=r,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,o=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=o}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,o=t.m02,r=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*a-s*l,_=-u*r+s*c,f=l*r-a*c,d=n*h+i*_+o*f;return 0===d?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(d=1/d,e.m00=h*d,e.m01=(-u*i+o*l)*d,e.m02=(s*i-o*a)*d,e.m03=_*d,e.m04=(u*n-o*c)*d,e.m05=(-s*n+o*r)*d,e.m06=f*d,e.m07=(-l*n+i*c)*d,e.m08=(a*n-i*r)*d,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,o=e.m03,r=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*r-a*c)+n*(-l*o+a*s)+i*(c*o-r*s)},t.multiply=function(e,t,n){var i=t.m00,o=t.m01,r=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return e.m00=_*i+f*a+d*l,e.m01=_*o+f*s+d*u,e.m02=_*r+f*c+d*h,e.m03=p*i+m*a+v*l,e.m04=p*o+m*s+v*u,e.m05=p*r+m*c+v*h,e.m06=g*i+y*a+x*l,e.m07=g*o+y*s+x*u,e.m08=g*r+y*c+x*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,o=t.m01,r=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return e.m00=_*i+f*a+d*l,e.m01=_*o+f*s+d*u,e.m02=_*r+f*c+d*h,e.m03=p*i+m*a+v*l,e.m04=p*o+m*s+v*u,e.m05=p*r+m*c+v*h,e.m06=g*i+y*a+x*l,e.m07=g*o+y*s+x*u,e.m08=g*r+y*c+x*h,e},t.transform=function(e,t,n){var i=t.m00,o=t.m01,r=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.x,f=n.y;return e.m00=i,e.m01=o,e.m02=r,e.m03=a,e.m04=s,e.m05=c,e.m06=_*i+f*a+l,e.m07=_*o+f*s+u,e.m08=_*r+f*c+h,e},t.scale=function(e,t,n){var i=n.x,o=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=o*t.m03,e.m04=o*t.m04,e.m05=o*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,o=t.m01,r=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=Math.sin(n),f=Math.cos(n);return e.m00=f*i+_*a,e.m01=f*o+_*s,e.m02=f*r+_*c,e.m03=f*a-_*i,e.m04=f*s-_*o,e.m05=f*c-_*r,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return An.lengthSqr(n)<en*en?(t.identity(e),e):(i=i||An.UNIT_Y,An.normalize(bn,An.cross(bn,i,n)),An.lengthSqr(bn)<en*en?(t.identity(e),e):(An.cross(Rn,n,bn),t.set(e,bn.x,bn.y,bn.z,Rn.x,Rn.y,Rn.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,o=t.z,r=t.w,a=n+n,s=i+i,c=o+o,l=n*a,u=i*a,h=i*s,_=o*a,f=o*s,d=o*c,p=r*a,m=r*s,v=r*c;return e.m00=1-h-d,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-l-d,e.m07=f-p,e.m02=_-m,e.m05=f+p,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,o=t.m02,r=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-o*a,x=n*l-r*a,E=i*c-o*s,S=i*l-r*s,T=o*l-r*c,A=u*p-h*d,w=u*m-_*d,C=u*v-f*d,I=h*m-_*p,P=h*v-f*p,b=_*v-f*m,R=g*b-y*P+x*I+E*C-S*w+T*A;return R?(R=1/R,e.m00=(s*b-c*P+l*I)*R,e.m01=(c*C-a*b-l*w)*R,e.m02=(a*P-s*C+l*A)*R,e.m03=(o*P-i*b-r*I)*R,e.m04=(n*b-o*C+r*w)*R,e.m05=(i*C-n*P-r*A)*R,e.m06=(p*T-m*S+v*E)*R,e.m07=(m*x-d*T-v*y)*R,e.m08=(d*S-p*x+v*g)*R,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=en),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,o,r,a,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=1),void 0===r&&(r=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=o,this.m05=r,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=en),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,o=this.m04,r=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*o-r*s,u=-c*i+r*a,h=s*i-o*a,_=e*l+t*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*t+n*s)*_,this.m02=(r*t-n*o)*_,this.m03=u*_,this.m04=(c*e-n*a)*_,this.m05=(-r*e+n*i)*_,this.m06=h*_,this.m07=(-s*e+t*a)*_,this.m08=(o*e-t*i)*_,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,o=this.m04,r=this.m05,a=this.m06,s=this.m07,c=this.m08;return e*(c*o-r*s)+t*(-c*i+r*a)+n*(s*i-o*a)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,o=this.m03,r=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,_=e.m02,f=e.m03,d=e.m04,p=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*o+_*s,this.m01=u*n+h*r+_*c,this.m02=u*i+h*a+_*l,this.m03=f*t+d*o+p*s,this.m04=f*n+d*r+p*c,this.m05=f*i+d*a+p*l,this.m06=m*t+v*o+g*s,this.m07=m*n+v*r+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,o=this.m03,r=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*o,this.m01=h*n+u*r,this.m02=h*i+u*a,this.m03=h*o-u*t,this.m04=h*r-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,o=e.w,r=t+t,a=n+n,s=i+i,c=t*r,l=n*r,u=n*a,h=i*r,_=i*a,f=i*s,d=o*r,p=o*a,m=o*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+p,this.m01=l+m,this.m04=1-c-f,this.m07=_-d,this.m02=h-p,this.m05=_+d,this.m08=1-c-u,this},t}(at));Pn.IDENTITY=Object.freeze(new Pn);var bn=new An,Rn=new An;Kt.fastDefine("cc.Mat3",Pn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),s.Mat3=Pn;var Nn=e("bM",function(e){function t(t,n,i,o){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z,r.w=t.w):(r.x=t||0,r.y=n||0,r.z=i||0,r.w=null!=o?o:1),r}ee(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,o){return e.x=t,e.y=n,e.z=i,e.w=o,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var o=An.dot(n,i);return o<-.999999?(An.cross(Mn,An.UNIT_X,n),Mn.length()<1e-6&&An.cross(Mn,An.UNIT_Y,n),An.normalize(Mn,Mn),t.fromAxisAngle(e,Mn,Math.PI),e):o>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(An.cross(Mn,n,i),e.x=Mn.x,e.y=Mn.y,e.z=Mn.z,e.w=1+o,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,o=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,r=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,a=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=o,e.z=r,e.w=a,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),o=Math.cos(n),r=t.x,a=t.y,s=t.z,c=t.w;return e.x=r*o+c*i,e.y=a*o+s*i,e.z=s*o-a*i,e.w=c*o-r*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),o=Math.cos(n),r=t.x,a=t.y,s=t.z,c=t.w;return e.x=r*o-s*i,e.y=a*o+c*i,e.z=s*o+r*i,e.w=c*o-a*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),o=Math.cos(n),r=t.x,a=t.y,s=t.z,c=t.w;return e.x=r*o+a*i,e.y=a*o-r*i,e.z=s*o+c*i,e.w=c*o-s*i,e},t.rotateAround=function(e,n,i,o){return t.invert(On,n),An.transformQuat(Mn,i,On),t.fromAxisAngle(On,Mn,o),t.multiply(e,n,On),e},t.rotateAroundLocal=function(e,n,i,o){return t.fromAxisAngle(On,i,o),t.multiply(e,n,On),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var o=0,r=0,a=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);o=Math.sin((1-i)*h)/_,r=Math.sin(i*h)/_}else o=1-i,r=i;return e.x=o*t.x+r*a,e.y=o*t.y+r*s,e.z=o*t.z+r*c,e.w=o*t.w+r*l,e},t.sqlerp=function(e,n,i,o,r,a){return t.slerp(On,n,r,a),t.slerp(Dn,i,o,a),t.slerp(e,On,Dn,2*a*(1-a)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,o){return Pn.set(Ln,n.x,n.y,n.z,i.x,i.y,i.z,o.x,o.y,o.z),t.normalize(e,t.fromMat3(e,Ln))},t.fromViewUp=function(e,n,i){return Pn.fromViewUp(Ln,n,i),t.normalize(e,t.fromMat3(e,Ln))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,o=t.m06,r=t.m01,a=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+a+u;if(h>0){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(l-s)*_,e.y=(o-c)*_,e.z=(r-i)*_}else if(n>a&&n>u){var f=2*Math.sqrt(1+n-a-u);e.w=(l-s)/f,e.x=.25*f,e.y=(i+r)/f,e.z=(o+c)/f}else if(a>u){var d=2*Math.sqrt(1+a-n-u);e.w=(o-c)/d,e.x=(i+r)/d,e.y=.25*d,e.z=(s+l)/d}else{var p=2*Math.sqrt(1+u-n-a);e.w=(r-i)/p,e.x=(o+c)/p,e.y=(s+l)/p,e.z=.25*p}return e},t.fromEuler=function(e,t,n,i){t*=Fn,n*=Fn,i*=Fn;var o=Math.sin(t),r=Math.cos(t),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=o*s*l+r*a*c,e.y=r*a*l+o*s*c,e.z=r*s*c-o*a*l,e.w=r*s*l-o*a*c,e},t.fromAngleZ=function(e,t){return t*=Fn,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,o=2*t.z;return e.x=i*t.x-o*t.w,e.y=1-n*t.x-o*t.z,e.z=o*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,o=2*t.z;return e.x=o*t.x-i*t.w,e.y=o*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,o=t.y,r=t.z,a=t.w,s=0,c=0,l=0,u=i*o+r*a;if(u>.499999)s=0,c=cn(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-cn(2*Math.atan2(i,a)),l=-90;else{var h=i*i,_=o*o,f=r*r;s=cn(Math.atan2(2*i*a-2*o*r,1-2*h-2*f)),c=cn(Math.atan2(2*o*a-2*i*r,1-2*_-2*f)),l=cn(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=en),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=en),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}(at));Nn.IDENTITY=Object.freeze(new Nn);var On=new Nn,Dn=new Nn,Mn=new An,Ln=new Pn,Fn=.5*Math.PI/180;function zn(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new Nn(e,t,n,i)}Kt.fastDefine("cc.Quat",Nn,{x:0,y:0,z:0,w:1}),s.Quat=Nn,s.quat=zn;var Bn=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Un=e("cb",function(e){function t(t,n,i,o,r,a,s,c,l,u,h,_,f,d,p,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=o,v.m04=r,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=d,v.m14=p,v.m15=m),v}ee(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,o,r,a,s,c,l,u,h,_,f,d,p,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=o,e.m04=r,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=d,e.m14=p,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,o=t.m03,r=t.m06,a=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=r,e.m11=t.m14,e.m12=o,e.m13=a,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,o=t.m02,r=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-o*a,x=n*l-r*a,E=i*c-o*s,S=i*l-r*s,T=o*l-r*c,A=u*p-h*d,w=u*m-_*d,C=u*v-f*d,I=h*m-_*p,P=h*v-f*p,b=_*v-f*m,R=g*b-y*P+x*I+E*C-S*w+T*A;return 0===R?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(R=1/R,e.m00=(s*b-c*P+l*I)*R,e.m01=(o*P-i*b-r*I)*R,e.m02=(p*T-m*S+v*E)*R,e.m03=(_*S-h*T-f*E)*R,e.m04=(c*C-a*b-l*w)*R,e.m05=(n*b-o*C+r*w)*R,e.m06=(m*x-d*T-v*y)*R,e.m07=(u*T-_*x+f*y)*R,e.m08=(a*P-s*C+l*A)*R,e.m09=(i*C-n*P-r*A)*R,e.m10=(d*S-p*x+v*g)*R,e.m11=(h*x-u*S-f*g)*R,e.m12=(s*w-a*I-c*A)*R,e.m13=(n*I-i*w+o*A)*R,e.m14=(p*y-d*E-m*g)*R,e.m15=(u*E-h*y+_*g)*R,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,o=e.m03,r=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11,f=e.m12,d=e.m13,p=e.m14,m=e.m15;return(t*a-n*r)*(h*m-_*p)-(t*s-i*r)*(u*m-_*d)+(t*c-o*r)*(u*p-h*d)+(n*s-i*a)*(l*m-_*f)-(n*c-o*a)*(l*p-h*f)+(i*c-o*s)*(l*d-u*f)},t.multiply=function(e,t,n){var i=t.m00,o=t.m01,r=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=t.m09,f=t.m10,d=t.m11,p=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,x=n.m01,E=n.m02,S=n.m03;return e.m00=y*i+x*s+E*h+S*p,e.m01=y*o+x*c+E*_+S*m,e.m02=y*r+x*l+E*f+S*v,e.m03=y*a+x*u+E*d+S*g,y=n.m04,x=n.m05,E=n.m06,S=n.m07,e.m04=y*i+x*s+E*h+S*p,e.m05=y*o+x*c+E*_+S*m,e.m06=y*r+x*l+E*f+S*v,e.m07=y*a+x*u+E*d+S*g,y=n.m08,x=n.m09,E=n.m10,S=n.m11,e.m08=y*i+x*s+E*h+S*p,e.m09=y*o+x*c+E*_+S*m,e.m10=y*r+x*l+E*f+S*v,e.m11=y*a+x*u+E*d+S*g,y=n.m12,x=n.m13,E=n.m14,S=n.m15,e.m12=y*i+x*s+E*h+S*p,e.m13=y*o+x*c+E*_+S*m,e.m14=y*r+x*l+E*f+S*v,e.m15=y*a+x*u+E*d+S*g,e},t.transform=function(e,t,n){var i=n.x,o=n.y,r=n.z;if(t===e)e.m12=t.m00*i+t.m04*o+t.m08*r+t.m12,e.m13=t.m01*i+t.m05*o+t.m09*r+t.m13,e.m14=t.m02*i+t.m06*o+t.m10*r+t.m14,e.m15=t.m03*i+t.m07*o+t.m11*r+t.m15;else{var a=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,_=t.m06,f=t.m07,d=t.m08,p=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=a,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=_,e.m07=f,e.m08=d,e.m09=p,e.m10=m,e.m11=v,e.m12=a*i+u*o+d*r+t.m12,e.m13=s*i+h*o+p*r+t.m13,e.m14=c*i+_*o+m*r+t.m14,e.m15=l*i+f*o+v*r+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,o=n.y,r=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*o,e.m05=t.m05*o,e.m06=t.m06*o,e.m07=t.m07*o,e.m08=t.m08*r,e.m09=t.m09*r,e.m10=t.m10*r,e.m11=t.m11*r,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var o=i.x,r=i.y,a=i.z,s=Math.sqrt(o*o+r*r+a*a);if(Math.abs(s)<en)return null;o*=s=1/s,r*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,_=t.m01,f=t.m02,d=t.m03,p=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,x=t.m09,E=t.m10,S=t.m11,T=o*o*u+l,A=r*o*u+a*c,w=a*o*u-r*c,C=o*r*u-a*c,I=r*r*u+l,P=a*r*u+o*c,b=o*a*u+r*c,R=r*a*u-o*c,N=a*a*u+l;return e.m00=h*T+p*A+y*w,e.m01=_*T+m*A+x*w,e.m02=f*T+v*A+E*w,e.m03=d*T+g*A+S*w,e.m04=h*C+p*I+y*P,e.m05=_*C+m*I+x*P,e.m06=f*C+v*I+E*P,e.m07=d*C+g*I+S*P,e.m08=h*b+p*R+y*N,e.m09=_*b+m*R+x*N,e.m10=f*b+v*R+E*N,e.m11=d*b+g*R+S*N,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),o=Math.cos(n),r=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=r*o+l*i,e.m05=a*o+u*i,e.m06=s*o+h*i,e.m07=c*o+_*i,e.m08=l*o-r*i,e.m09=u*o-a*i,e.m10=h*o-s*i,e.m11=_*o-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),o=Math.cos(n),r=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=r*o-l*i,e.m01=a*o-u*i,e.m02=s*o-h*i,e.m03=c*o-_*i,e.m08=r*i+l*o,e.m09=a*i+u*o,e.m10=s*i+h*o,e.m11=c*i+_*o,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),o=Math.cos(n),r=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=r*o+l*i,e.m01=a*o+u*i,e.m02=s*o+h*i,e.m03=c*o+_*i,e.m04=l*o-r*i,e.m05=u*o-a*i,e.m06=h*o-s*i,e.m07=_*o-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,o=n.y,r=n.z,a=Math.sqrt(i*i+o*o+r*r);if(Math.abs(a)<en)return null;i*=a=1/a,o*=a,r*=a;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=o*i*l+r*s,e.m02=r*i*l-o*s,e.m03=0,e.m04=i*o*l-r*s,e.m05=o*o*l+c,e.m06=r*o*l+i*s,e.m07=0,e.m08=i*r*l+o*s,e.m09=o*r*l-i*s,e.m10=r*r*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,o=t.y,r=t.z,a=t.w,s=i+i,c=o+o,l=r+r,u=i*s,h=i*c,_=i*l,f=o*c,d=o*l,p=r*l,m=a*s,v=a*c,g=a*l;return e.m00=1-(f+p),e.m01=h+g,e.m02=_-v,e.m03=0,e.m04=h-g,e.m05=1-(u+p),e.m06=d+m,e.m07=0,e.m08=_+v,e.m09=d-m,e.m10=1-(u+f),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=Gn.m00=t.m00,i=Gn.m01=t.m01,o=Gn.m02=t.m02,r=Gn.m03=t.m04,a=Gn.m04=t.m05,s=Gn.m05=t.m06,c=Gn.m06=t.m08,l=Gn.m07=t.m09,u=Gn.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+o*o),e.y=Math.sqrt(r*r+a*a+s*s),e.z=Math.sqrt(c*c+l*l+u*u),Pn.determinant(Gn)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=An.set(Hn,e.m00,e.m01,e.m02).length(),Gn.m00=e.m00/i.x,Gn.m01=e.m01/i.x,Gn.m02=e.m02/i.x,i.y=An.set(Hn,e.m04,e.m05,e.m06).length(),Gn.m03=e.m04/i.y,Gn.m04=e.m05/i.y,Gn.m05=e.m06/i.y,i.z=An.set(Hn,e.m08,e.m09,e.m10).length(),Gn.m06=e.m08/i.z,Gn.m07=e.m09/i.z,Gn.m08=e.m10/i.z,Pn.determinant(Gn)<0&&(i.x*=-1,Gn.m00*=-1,Gn.m01*=-1,Gn.m02*=-1),Nn.fromMat3(t,Gn),An.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var o=t.x,r=t.y,a=t.z,s=t.w,c=o+o,l=r+r,u=a+a,h=o*c,_=o*l,f=o*u,d=r*l,p=r*u,m=a*u,v=s*c,g=s*l,y=s*u,x=i.x,E=i.y,S=i.z;return e.m00=(1-(d+m))*x,e.m01=(_+y)*x,e.m02=(f-g)*x,e.m03=0,e.m04=(_-y)*E,e.m05=(1-(h+m))*E,e.m06=(p+v)*E,e.m07=0,e.m08=(f+g)*S,e.m09=(p-v)*S,e.m10=(1-(h+d))*S,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,o){var r=t.x,a=t.y,s=t.z,c=t.w,l=r+r,u=a+a,h=s+s,_=r*l,f=r*u,d=r*h,p=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,E=i.x,S=i.y,T=i.z,A=o.x,w=o.y,C=o.z;return e.m00=(1-(p+v))*E,e.m01=(f+x)*E,e.m02=(d-y)*E,e.m03=0,e.m04=(f-x)*S,e.m05=(1-(_+v))*S,e.m06=(m+g)*S,e.m07=0,e.m08=(d+y)*T,e.m09=(m-g)*T,e.m10=(1-(_+p))*T,e.m11=0,e.m12=n.x+A-(e.m00*A+e.m04*w+e.m08*C),e.m13=n.y+w-(e.m01*A+e.m05*w+e.m09*C),e.m14=n.z+C-(e.m02*A+e.m06*w+e.m10*C),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,o=t.z,r=t.w,a=n+n,s=i+i,c=o+o,l=n*a,u=i*a,h=i*s,_=o*a,f=o*s,d=o*c,p=r*a,m=r*s,v=r*c;return e.m00=1-h-d,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-l-d,e.m06=f+p,e.m07=0,e.m08=_+m,e.m09=f-p,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,o,r,a){var s=1/(n-t),c=1/(o-i),l=1/(r-a);return e.m00=2*r*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*r*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(o+i)*c,e.m10=(a+r)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*r*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,o,r,a,s,c){void 0===r&&(r=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-o),h=r?l/n:l,_=(r?l:l*n)*s,f=Bn[c];return e.m00=h*f[0],e.m01=h*f[1],e.m02=0,e.m03=0,e.m04=_*f[2],e.m05=_*f[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(o-a*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=o*i*u*(1-a),e.m15=0,e},t.ortho=function(e,t,n,i,o,r,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-o)*c,_=1/(r-a),f=-2*u,d=-2*h,p=(t+n)*u,m=(o+i)*h,v=Bn[l];return e.m00=f*v[0],e.m01=f*v[1],e.m02=0,e.m03=0,e.m04=d*v[2],e.m05=d*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-s),e.m11=0,e.m12=p*v[0]+m*v[2],e.m13=p*v[1]+m*v[3],e.m14=(r-s*a)*_,e.m15=1,e},t.lookAt=function(e,t,n,i){var o=t.x,r=t.y,a=t.z,s=i.x,c=i.y,l=i.z,u=o-n.x,h=r-n.y,_=a-n.z,f=1/Math.sqrt(u*u+h*h+_*_),d=c*(_*=f)-l*(h*=f),p=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(d*d+p*p+m*m))-_*(p*=f),g=_*(d*=f)-u*m,y=u*p-h*d;return e.m00=d,e.m01=v,e.m02=u,e.m03=0,e.m04=p,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(d*o+p*r+m*a),e.m13=-(v*o+g*r+y*a),e.m14=-(u*o+h*r+_*a),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,o=t.m02,r=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-o*a,x=n*l-r*a,E=i*c-o*s,S=i*l-r*s,T=o*l-r*c,A=u*p-h*d,w=u*m-_*d,C=u*v-f*d,I=h*m-_*p,P=h*v-f*p,b=_*v-f*m,R=g*b-y*P+x*I+E*C-S*w+T*A;return R?(R=1/R,e.m00=(s*b-c*P+l*I)*R,e.m01=(c*C-a*b-l*w)*R,e.m02=(a*P-s*C+l*A)*R,e.m03=0,e.m04=(o*P-i*b-r*I)*R,e.m05=(n*b-o*C+r*w)*R,e.m06=(i*C-n*P-r*A)*R,e.m07=0,e.m08=(p*T-m*S+v*E)*R,e.m09=(m*x-d*T-v*y)*R,e.m10=(d*S-p*x+v*g)*R,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=en),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,o,r,a,s,c,l,u,h,_,f,d,p){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=o,this.m05=r,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=d,this.m15=p,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=en),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,o=this.m07,r=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=o,this.m14=r,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,o=this.m04,r=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15,m=e*r-t*o,v=e*a-n*o,g=e*s-i*o,y=t*a-n*r,x=t*s-i*r,E=n*s-i*a,S=c*f-l*_,T=c*d-u*_,A=c*p-h*_,w=l*d-u*f,C=l*p-h*f,I=u*p-h*d,P=m*I-v*C+g*w+y*A-x*T+E*S;return 0===P?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(P=1/P,this.m00=(r*I-a*C+s*w)*P,this.m01=(n*C-t*I-i*w)*P,this.m02=(f*E-d*x+p*y)*P,this.m03=(u*x-l*E-h*y)*P,this.m04=(a*A-o*I-s*T)*P,this.m05=(e*I-n*A+i*T)*P,this.m06=(d*g-_*E-p*v)*P,this.m07=(c*E-u*g+h*v)*P,this.m08=(o*C-r*A+s*S)*P,this.m09=(t*A-e*C-i*S)*P,this.m10=(_*x-f*g+p*m)*P,this.m11=(l*g-c*x-h*m)*P,this.m12=(r*T-o*w-a*S)*P,this.m13=(e*w-t*T+n*S)*P,this.m14=(f*v-_*y-d*m)*P,this.m15=(c*y-l*v+u*m)*P,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,o=this.m04,r=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15;return(e*r-t*o)*(u*p-h*d)-(e*a-n*o)*(l*p-h*f)+(e*s-i*o)*(l*d-u*f)+(t*a-n*r)*(c*p-h*_)-(t*s-i*r)*(c*d-u*_)+(n*s-i*a)*(c*f-l*_)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,o=this.m03,r=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,d=this.m13,p=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,x=e.m03;return this.m00=v*t+g*r+y*l+x*f,this.m01=v*n+g*a+y*u+x*d,this.m02=v*i+g*s+y*h+x*p,this.m03=v*o+g*c+y*_+x*m,v=e.m04,g=e.m05,y=e.m06,x=e.m07,this.m04=v*t+g*r+y*l+x*f,this.m05=v*n+g*a+y*u+x*d,this.m06=v*i+g*s+y*h+x*p,this.m07=v*o+g*c+y*_+x*m,v=e.m08,g=e.m09,y=e.m10,x=e.m11,this.m08=v*t+g*r+y*l+x*f,this.m09=v*n+g*a+y*u+x*d,this.m10=v*i+g*s+y*h+x*p,this.m11=v*o+g*c+y*_+x*m,v=e.m12,g=e.m13,y=e.m14,x=e.m15,this.m12=v*t+g*r+y*l+x*f,this.m13=v*n+g*a+y*u+x*d,this.m14=v*i+g*s+y*h+x*p,this.m15=v*o+g*c+y*_+x*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,o=t.z,r=Math.sqrt(n*n+i*i+o*o);if(Math.abs(r)<en)return null;n*=r=1/r,i*=r,o*=r;var a=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,d=this.m05,p=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,E=n*n*c+s,S=i*n*c+o*a,T=o*n*c-i*a,A=n*i*c-o*a,w=i*i*c+s,C=o*i*c+n*a,I=n*o*c+i*a,P=i*o*c-n*a,b=o*o*c+s;return this.m00=l*E+f*S+v*T,this.m01=u*E+d*S+g*T,this.m02=h*E+p*S+y*T,this.m03=_*E+m*S+x*T,this.m04=l*A+f*w+v*C,this.m05=u*A+d*w+g*C,this.m06=h*A+p*w+y*C,this.m07=_*A+m*w+x*C,this.m08=l*I+f*P+v*b,this.m09=u*I+d*P+g*b,this.m10=h*I+p*P+y*b,this.m11=_*I+m*P+x*b,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=Gn.m00=this.m00,n=Gn.m01=this.m01,i=Gn.m02=this.m02,o=Gn.m03=this.m04,r=Gn.m04=this.m05,a=Gn.m05=this.m06,s=Gn.m06=this.m08,c=Gn.m07=this.m09,l=Gn.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(o*o+r*r+a*a),e.z=Math.sqrt(s*s+c*c+l*l),Pn.determinant(Gn)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,o=e.y,r=e.z,a=e.w,s=i+i,c=o+o,l=r+r,u=i*s,h=i*c,_=i*l,f=o*c,d=o*l,p=r*l,m=a*s,v=a*c,g=a*l,y=n.x,x=n.y,E=n.z;return this.m00=(1-(f+p))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+p))*x,this.m06=(d+m)*x,this.m07=0,this.m08=(_+v)*E,this.m09=(d-m)*E,this.m10=(1-(u+f))*E,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,o=e.w,r=t+t,a=n+n,s=i+i,c=t*r,l=n*r,u=n*a,h=i*r,_=i*a,f=i*s,d=o*r,p=o*a,m=o*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-p,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+d,this.m07=0,this.m08=h+p,this.m09=_-d,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}(at));Un.IDENTITY=Object.freeze(new Un);var Hn=new An,Gn=new Pn;function Vn(e,t,n,i,o,r,a,s,c,l,u,h,_,f,d,p){return new Un(e,t,n,i,o,r,a,s,c,l,u,h,_,f,d,p)}Kt.fastDefine("cc.Mat4",Un,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),s.Mat4=Un,s.mat4=Vn;var kn=e("cM",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}ee(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<en?e.x=0:e.x=1/n,Math.abs(i)<en?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,o=n*n+i*i;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e},t.lerp=function(e,t,n,i){var o=t.x,r=t.y;return e.x=o+i*(n.x-o),e.y=r+i*(n.y-r),e},t.random=function(e,t){t=t||1;var n=2*ln()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,o=t.y;return e.x=n.m00*i+n.m03*o+n.m06,e.y=n.m01*i+n.m04*o+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,o=t.y;return e.x=n.m00*i+n.m04*o+n.m12,e.y=n.m01*i+n.m05*o+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=en),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize(Wn,e),t.normalize(jn,n);var i=t.dot(Wn,jn);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=en),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=en),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=on(this.x,e.x,t.x),this.y=on(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=on(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),o=Math.cos(e);return this.x=o*t-i*n,this.y=i*t+o*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}(at));kn.ZERO=Object.freeze(new kn(0,0)),kn.ONE=Object.freeze(new kn(1,1)),kn.NEG_ONE=Object.freeze(new kn(-1,-1)),kn.UNIT_X=Object.freeze(new kn(1,0)),kn.UNIT_Y=Object.freeze(new kn(0,1));var Wn=new kn,jn=new kn;function qn(e,t){return new kn(e,t)}Kt.fastDefine("cc.Vec2",kn,{x:0,y:0}),s.Vec2=kn,s.v2=qn;var Yn=e("c4",function(e){function t(t,n,i,o){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z,r.w=t.w):(r.x=t||0,r.y=n||0,r.z=i||0,r.w=o||0),r}ee(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,o){return e.x=t,e.y=n,e.z=i,e.w=o,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,o=t.z-e.z,r=t.w-e.w;return Math.sqrt(n*n+i*i+o*o+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,o=t.z-e.z,r=t.w-e.w;return n*n+i*i+o*o+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z,o=e.w;return Math.sqrt(t*t+n*n+i*i+o*o)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,o=e.w;return t*t+n*n+i*i+o*o},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,o=t.z,r=t.w;return Math.abs(n)<en?e.x=0:e.x=1/n,Math.abs(i)<en?e.y=0:e.y=1/i,Math.abs(o)<en?e.z=0:e.z=1/o,Math.abs(r)<en?e.w=0:e.w=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,o=t.z,r=t.w,a=n*n+i*i+o*o+r*r;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=o*a,e.w=r*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*ln()*Math.PI,i=2*ln()-1,o=Math.sqrt(1-i*i);return e.x=o*Math.cos(n)*t,e.y=o*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,o=t.y,r=t.z,a=t.w;return e.x=n.m00*i+n.m04*o+n.m08*r+n.m12*a,e.y=n.m01*i+n.m05*o+n.m09*r+n.m13*a,e.z=n.m02*i+n.m06*o+n.m10*r+n.m14*a,e.w=n.m03*i+n.m07*o+n.m11*r+n.m15*a,e},t.transformAffine=function(e,t,n){var i=t.x,o=t.y,r=t.z,a=t.w;return e.x=n.m00*i+n.m01*o+n.m02*r+n.m03*a,e.y=n.m04*i+n.m05*o+n.m06*r+n.m07*a,e.x=n.m08*i+n.m09*o+n.m10*r+n.m11*a,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,o=t.y,r=t.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*r-c*o,h=l*o+c*i-a*r,_=l*r+a*o-s*i,f=-a*i-s*o-c*r;return e.x=u*l+f*-a+h*-c-_*-s,e.y=h*l+f*-s+_*-a-u*-c,e.z=_*l+f*-c+u*-s-h*-a,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=en),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=en),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,o){return void 0===o&&(o=en),Math.abs(this.x-e)<=o*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=o*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=o*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=o*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,o=this.z,r=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=o+t*(e.z-o),this.w=r+t*(e.w-r),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=on(this.x,e.x,t.x),this.y=on(this.y,e.y,t.y),this.z=on(this.z,e.z,t.z),this.w=on(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,o=e.x,r=e.y,a=e.z;return this.x=n*a-i*r,this.y=i*o-t*a,this.z=t*r-n*o,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,o=e*e+t*t+n*n+i*i;return o>0&&(o=1/Math.sqrt(o),this.x=e*o,this.y=t*o,this.z=n*o,this.w=i*o),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,o=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*o,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*o,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*o,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*o,this},t}(at));function Xn(e,t,n,i){return new Yn(e,t,n,i)}Yn.ZERO=Object.freeze(new Yn(0,0,0,0)),Yn.ONE=Object.freeze(new Yn(1,1,1,1)),Yn.NEG_ONE=Object.freeze(new Yn(-1,-1,-1,-1)),Kt.fastDefine("cc.Vec4",Yn,{x:0,y:0,z:0,w:0}),s.Vec4=Yn,s.v4=Xn,k(kn,"Vec2",[{name:"sub",newName:"subtract",target:kn,targetName:"Vec2"},{name:"mul",newName:"multiply",target:kn,targetName:"Vec2"},{name:"div",newName:"divide",target:kn,targetName:"Vec2"},{name:"dist",newName:"distance",target:kn,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:kn,targetName:"Vec2"},{name:"mag",newName:"len",target:kn,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:kn,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:kn,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:kn,targetName:"Vec2"}]),k(kn.prototype,"Vec2",[{name:"mag",newName:"length",target:kn.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:kn.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:kn.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:kn.prototype,targetName:"Vec2"}]),k(An,"Vec3",[{name:"sub",newName:"subtract",target:An,targetName:"Vec3"},{name:"mul",newName:"multiply",target:An,targetName:"Vec3"},{name:"div",newName:"divide",target:An,targetName:"Vec3"},{name:"dist",newName:"distance",target:An,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:An,targetName:"Vec3"},{name:"mag",newName:"len",target:An,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:An,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:An,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:An,targetName:"Vec3"}]),k(An.prototype,"Vec3",[{name:"mag",newName:"length",target:An.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:An.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:An.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:An.prototype,targetName:"Vec3"}]),k(Yn,"Vec4",[{name:"sub",newName:"subtract",target:Yn,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Yn,targetName:"Vec4"},{name:"div",newName:"divide",target:Yn,targetName:"Vec4"},{name:"dist",newName:"distance",target:Yn,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Yn,targetName:"Vec4"},{name:"mag",newName:"len",target:Yn,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Yn,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Yn,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Yn,targetName:"Vec4"}]),k(Yn.prototype,"Vec4",[{name:"mag",newName:"length",target:Yn.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Yn.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Yn.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Yn.prototype,targetName:"Vec4"}]),k(Nn,"Quat",[{name:"mag",newName:"len",target:Nn,targetName:"Quat"},{name:"mul",newName:"multiply",target:Nn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Nn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Nn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Nn,targetName:"Quat"}]),k(Nn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Nn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Nn.prototype,targetName:"Quat"}]),k(Sn,"Color",[{name:"sub",newName:"subtract",target:Sn,targetName:"Color"},{name:"mul",newName:"multiply",target:Sn,targetName:"Color"},{name:"div",newName:"divide",target:Sn,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:Sn,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[1].toString(16);return s.Color.fromHEX(t[0],i)}}]),k(Pn,"Mat3",[{name:"sub",newName:"subtract",target:Pn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Pn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Pn,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Pn,targetName:"Mat3"}]),k(Pn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Pn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Pn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Pn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Pn.prototype,targetName:"Mat3"}]),k(Un,"Mat4",[{name:"sub",newName:"subtract",target:Un,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Un,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Un,targetName:"Mat4"}]),k(Un.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Un.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Un.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Un.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Un.prototype,targetName:"Mat4"}]);var Kn=e("e9",function(){function e(e,t,n,i,o,r){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===o&&(o=0),void 0===r&&(r=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=o,this.ty=r}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,o=t.b,r=t.c,a=t.d,s=t.tx,c=t.ty;e.a=i*n.a+o*n.c,e.b=i*n.b+o*n.d,e.c=r*n.a+a*n.c,e.d=r*n.b+a*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var o,r;void 0===i?(i=n,o=t.x,r=t.y):(o=t,r=n),e.x=i.a*o+i.c*r+i.tx,e.y=i.b*o+i.d*r+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,o=t.y+t.height,r=n.a*t.x+n.c*t.y+n.tx,a=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*o+n.tx,u=n.b*t.x+n.d*o+n.ty,h=n.a*i+n.c*o+n.tx,_=n.b*i+n.d*o+n.ty,f=Math.min(r,s,l,h),d=Math.max(r,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);e.x=f,e.y=p,e.width=d-f,e.height=m-p},e.transformObb=function(e,t,n,i,o,r){var a=r.a*o.x+r.c*o.y+r.tx,s=r.b*o.x+r.d*o.y+r.ty,c=r.a*o.width,l=r.b*o.width,u=r.c*o.height,h=r.d*o.height;t.x=a,t.y=s,n.x=c+a,n.y=l+s,e.x=u+a,e.y=h+s,i.x=c+u+a,i.y=l+h+s},e}());s.AffineTransform=Kn;var Qn=e("cQ",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}ee(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},J(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}(at));function Zn(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new Qn(e,t)}Qn.ZERO=Object.freeze(new Qn(0,0)),Qn.ONE=Object.freeze(new Qn(1,1)),Kt.fastDefine("cc.Size",Qn,{width:0,height:0}),s.size=Zn,s.Size=Qn;var Jn=e("cP",function(e){function t(t,n,i,o){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.y=t.y,r.width=t.width,r.height=t.height,r.x=t.x):(r.x=t||0,r.y=n||0,r.width=i||0,r.height=o||0),r}ee(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),o=Math.min(t.y,n.y),r=Math.max(t.x,n.x),a=Math.max(t.y,n.y);return e.x=i,e.y=o,e.width=r-i,e.height=a-o,e},t.lerp=function(e,t,n,i){var o=t.x,r=t.y,a=t.width,s=t.height;return e.x=o+(n.x-o)*i,e.y=r+(n.y-r)*i,e.width=a+(n.width-a)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,o=t.y,r=t.x+t.width,a=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(o,c),e.width=Math.min(r,l)-e.x,e.height=Math.min(a,u)-e.y,e},t.union=function(e,t,n){var i=t.x,o=t.y,r=t.width,a=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(o,c),e.width=Math.max(i+r,s+l)-e.x,e.height=Math.max(o+a,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,o=this.width,r=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=o+(e.width-o)*t,this.height=r+(e.height-r)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,o=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||o<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,o=n+this.height,r=e.m00*t+e.m04*n+e.m12,a=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*o+e.m12,u=e.m01*t+e.m05*o+e.m13,h=e.m00*i+e.m04*o+e.m12,_=e.m01*i+e.m05*o+e.m13,f=Math.min(r,s,l,h),d=Math.max(r,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=p,this.width=d-f,this.height=m-p,this},n.transformMat4ToPoints=function(e,t,n,i,o){var r=this.x,a=this.y,s=r+this.width,c=a+this.height;t.x=e.m00*r+e.m04*a+e.m12,t.y=e.m01*r+e.m05*a+e.m13,o.x=e.m00*s+e.m04*a+e.m12,o.y=e.m01*s+e.m05*a+e.m13,n.x=e.m00*r+e.m04*c+e.m12,n.y=e.m01*r+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},J(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new kn(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new kn(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new Qn(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}(at));function $n(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new Jn(e,t,n,i)}Kt.fastDefine("cc.Rect",Jn,{x:0,y:0,width:0,height:0}),s.Rect=Jn,s.rect=$n;var ei=Object.freeze({__proto__:null,bits:V,Vec2:kn,v2:qn,Vec3:An,v3:In,Vec4:Yn,v4:Xn,Quat:Nn,quat:zn,Mat3:Pn,Mat4:Un,mat4:Vn,AffineTransform:Kn,Size:Qn,size:Zn,Rect:Jn,rect:$n,Color:Sn,color:Tn,EPSILON:en,equals:tn,approx:nn,clamp:on,clamp01:rn,lerp:an,toRadian:sn,toDegree:cn,random:ln,randomRange:un,randomRangeInt:hn,pseudoRandom:_n,pseudoRandomRange:fn,pseudoRandomRangeInt:dn,nextPow2:pn,repeat:mn,pingPong:vn,inverseLerp:gn,absMaxComponent:yn,absMax:xn});e("d$",ei);var ti=e("P",function(){function e(e,t){this._ctor=void 0,this._elementsPerBatch=void 0,this._nextAvail=void 0,this._freepool=[],this._ctor=e,this._elementsPerBatch=Math.max(t,1),this._nextAvail=this._elementsPerBatch-1;for(var n=0;n<this._elementsPerBatch;++n)this._freepool.push(e())}var t=e.prototype;return t.alloc=function(){if(this._nextAvail<0){for(var e=this._elementsPerBatch,t=0;t<e;t++)this._freepool.push(this._ctor());this._nextAvail=e-1}var n=this._freepool[this._nextAvail--];return this._freepool.length--,n},t.free=function(e){this._freepool.push(e),this._nextAvail++},t.freeArray=function(e){Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},t.destroy=function(e){if(e)for(var t=0;t<=this._nextAvail;t++)e(this._freepool[t]);this._freepool.length=0,this._nextAvail=-1},e}()),ni=e("R",function(){function e(e,t){this._fn=void 0,this._count=0,this._data=void 0,this._fn=e,this._data=new Array(t);for(var n=0;n<t;++n)this._data[n]=e()}var t=e.prototype;return t.reset=function(){this._count=0},t.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},t.add=function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]},t.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},J(e,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}()),ii=e("C",function(){function e(e,t){this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(e),this.length=0,this._compareFn=void 0!==t?t:function(e,t){return e-t}}var t=e.prototype;return t.push=function(e){this.array[this.length++]=e},t.pop=function(){return this.array[--this.length]},t.get=function(e){return this.array[e]},t.clear=function(){this.length=0},t.destroy=function(){this.length=0,this.array.length=0},t.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},t.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},t.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},t.indexOf=function(e){return this.array.indexOf(e)},e}()),oi=[],ri=e("d5",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=oi.length,t=0;t<e;++t){var n=oi[t];1&n._objFlags||n._destroyImmediate()}e===oi.length?oi.length=0:oi.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(P(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,oi.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,i=e instanceof s._BaseNode||e instanceof s.Component,o=i?"_id":null,r={};for(n in e)if(e.hasOwnProperty(n)){if(n===o)continue;switch(typeof e[n]){case"string":r[n]="";break;case"object":case"function":r[n]=null}}if(Kt._isCCClass(t))for(var a=s.Class.Attr.getClassAttrs(t),c=t.__props__,l=0;l<c.length;l++){var u=(n=c[l])+s.Class.Attr.DELIMETER+"default";if(u in a){if(i&&"_id"===n)continue;switch(typeof a[u]){case"string":r[n]="";break;case"object":case"function":r[n]=null;break;case"undefined":r[n]=void 0}}}var h="";for(n in r){var _;_=Kt.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Kt.escapeForJS(n)+"]=";var f=r[n];""===f&&(f='""'),h+=_+f+";\n"}return Function("o",h)}(this,e),Ee(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?R(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},J(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),ai=ri.prototype;function si(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}ai._deserialize=null,ai._onPreDestroy=null,Kt.fastDefine("cc.Object",ri,{_name:"",_objFlags:0}),Ee(ri,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),s.isValid=si,s.Object=ri;var ci=$e.fastRemoveAt;function li(){}var ui=function(){function e(){this.callback=li,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||li,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=li,this.once=!1},t.check=function(){return!(this.target instanceof ri&&!si(this.target,!0))},e}(),hi=new ti((function(){return new ui}),32),_i=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),hi.free(n),ci(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),hi.free(n),ci(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:ci(this.callbackInfos,e),hi.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),hi.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||ci(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),fi=new ti((function(){return new _i}),16),di=function(){function e(){this._callbackTable=we(!0)}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var o=this._callbackTable[e];o||(o=this._callbackTable[e]=fi.alloc());var r=hi.alloc();r.set(t,n,i),o.callbackInfos.push(r)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var o=i.callbackInfos;if(!t){if(i.isInvoking){for(var r=0;r<o.length;++r)if(o[r])return!0;return!1}return o.length>0}for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){if("string"==typeof e){var t=this._callbackTable&&this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),fi.free(t),delete this._callbackTable[e]))}else if(e)for(var n in this._callbackTable){var i=this._callbackTable[n];if(i.isInvoking)for(var o=i.callbackInfos,r=0;r<o.length;++r){var a=o[r];a&&a.target===e&&i.cancel(r)}else i.removeByTarget(e)}},t.off=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(i){var o=i.callbackInfos;if(t)for(var r=0;r<o.length;++r){var a=o[r];if(a&&a.callback===t&&a.target===n){i.cancel(r);break}}else this.removeAll(e)}},t.emit=function(e,t,n,i,o,r){var a=this._callbackTable&&this._callbackTable[e];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(e,_,f),h.check()?f?_.call(f,t,n,i,o,r):_(t,n,i,o,r):this.off(e,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),fi.free(t),delete this._callbackTable[e])}},e}();function pi(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=we(!0),t}ee(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=di.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),o=0;o<i.length;++o){var r=i[o];if(!(r in t.prototype)){var a=Object.getOwnPropertyDescriptor(n,r);a&&Object.defineProperty(t.prototype,r,a)}}return t}var mi,vi,gi,yi,xi,Ei,Si,Ti=e("dZ",pi((function(){})));s.EventTarget=Ti,function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(mi||(mi=e("bs",{}))),function(e){e.HIDE="hide",e.SHOW="show",e.RESIZE="resize",e.ORIENTATION_CHANGE="orientation_change"}(vi||(vi={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(gi||(gi={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(yi||(yi={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(xi||(xi=e("bq",{}))),function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE"}(Ei||(Ei={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(Si||(Si={}));var Ai=function(){function e(){var e,t=this;this.networkType=void 0,this.isNative=void 0,this.isBrowser=void 0,this.isMobile=void 0,this.isLittleEndian=void 0,this.platform=void 0,this.language=void 0,this.nativeLanguage=void 0,this.os=void 0,this.osVersion=void 0,this.osMainVersion=void 0,this.browserType=void 0,this.browserVersion=void 0,this.pixelRatio=void 0,this.supportCapability=void 0,this._eventTarget=new Ti,this._html=void 0,this._battery=void 0;var n,i=window.navigator,o=i.userAgent.toLowerCase();this._html=document.getElementsByTagName("html")[0],null===(e=i.getBattery)||void 0===e||e.call(i).then((function(e){t._battery=e})),this.networkType=yi.LAN,this.isNative=!1,this.isBrowser=!0,this.isMobile=/mobile|android|iphone|ipad/.test(o),this.platform=this.isMobile?Si.MOBILE_BROWSER:Si.DESKTOP_BROWSER,this.isLittleEndian=(n=new ArrayBuffer(2),new DataView(n).setInt16(0,256,!0),256===new Int16Array(n)[0]);var r=i.language;this.nativeLanguage=r.toLowerCase(),r=(r=r||i.browserLanguage)?r.split("-")[0]:gi.ENGLISH,this.language=r;var a=!1,s=!1,c="",l=0,u=/android\s*(\d+(?:\.\d+)*)/i.exec(o)||/android\s*(\d+(?:\.\d+)*)/i.exec(i.platform);u&&(a=!0,c=u[1]||"",l=parseInt(c)||0),(u=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(o))?(s=!0,c=u[2]||"",l=parseInt(c)||0):(/(iPhone|iPad|iPod)/.exec(i.platform)||"MacIntel"===i.platform&&i.maxTouchPoints&&i.maxTouchPoints>1)&&(s=!0,c="",l=0);var h=xi.UNKNOWN;-1!==i.appVersion.indexOf("Win")?h=xi.WINDOWS:s?h=xi.IOS:-1!==i.appVersion.indexOf("Mac")?h=xi.OSX:-1!==i.appVersion.indexOf("X11")&&-1===i.appVersion.indexOf("Linux")?h=xi.LINUX:a?h=xi.ANDROID:-1===i.appVersion.indexOf("Linux")&&-1===o.indexOf("ubuntu")||(h=xi.LINUX),this.os=h,this.osVersion=c,this.osMainVersion=l,this.browserType=mi.UNKNOWN;var _=/wechat|weixin|micromessenger/i.exec(o)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(o)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(o)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(o),f=_?_[0].toLowerCase():xi.UNKNOWN;("safari"===f&&a||"qq"===f&&/android.*applewebkit/i.test(o))&&(f=mi.ANDROID);var d={micromessenger:mi.WECHAT,wechat:mi.WECHAT,weixin:mi.WECHAT,trident:mi.IE,edge:mi.EDGE,"360 aphone":mi.BROWSER_360,mxbrowser:mi.MAXTHON,"opr/":mi.OPERA,ubrowser:mi.UC,huaweibrowser:mi.HUAWEI};this.browserType=d[f]||f,this.browserVersion="";var p=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(o);p||(p=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(o)),this.browserVersion=p?p[4]:"",this.pixelRatio=window.devicePixelRatio||1;var m,v=document.createElement("canvas"),g=!!v.getContext("2d"),y=!1;window.WebGLRenderingContext&&(y=!0);try{m=v.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){m=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(v.width=v.height=2,createImageBitmap(v,{}).then((function(e){x=!0,null==e||e.close()})).catch((function(){}))),this.supportCapability={webp:m,gl:y,canvas:g,imageBitmap:x},this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this;window.addEventListener("resize",(function(){e._eventTarget.emit(vi.RESIZE)})),window.addEventListener("orientationchange",(function(){e._eventTarget.emit(vi.ORIENTATION_CHANGE)})),this._registerVisibilityEvent()},t._registerVisibilityEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t._eventTarget.emit(vi.HIDE))},o=function(e,i,o,r,a){n&&(n=!1,t._eventTarget.emit(vi.SHOW,e,i,o,r,a))};if(e)for(var r=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<r.length;a++)document.addEventListener(r[a],(function(t){var n=document[e];(n=n||t.hidden)?i():o()}));else window.addEventListener("blur",i),window.addEventListener("focus",o);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=o),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",o),document.addEventListener("pagehide",i),document.addEventListener("pageshow",o))},t.getViewSize=function(){var e=document.getElementById("GameDiv");return this.isMobile||!e||e===this._html?new Qn(window.innerWidth,window.innerHeight):new Qn(e.clientWidth,e.clientHeight)},t.getOrientation=function(){throw new Error("TODO")},t.getSafeAreaEdge=function(){return{top:0,bottom:0,left:0,right:0}},t.getBatteryLevel=function(){return this._battery?this._battery.level:1},t.triggerGC=function(){},t.openURL=function(e){window.open(e)},t.now=function(){return Date.now?Date.now():+new Date},t.restartJSVM=function(){},t.onHide=function(e){this._eventTarget.on(vi.HIDE,e)},t.onShow=function(e){this._eventTarget.on(vi.SHOW,e)},t.onViewResize=function(e){this._eventTarget.on(vi.RESIZE,e)},t.onOrientationChange=function(e){this._eventTarget.on(vi.ORIENTATION_CHANGE,e)},t.offHide=function(e){this._eventTarget.off(vi.HIDE,e)},t.offShow=function(e){this._eventTarget.off(vi.SHOW,e)},t.offViewResize=function(e){this._eventTarget.off(vi.RESIZE,e)},t.offOrientationChange=function(e){this._eventTarget.off(vi.ORIENTATION_CHANGE,e)},e}(),wi=e("bp",new Ai),Ci=/(\.[^\.\/\?\\]*)(\?.*)?$/,Ii=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,Pi=/[^\.\/]+\/\.\.\//;function bi(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var o=0,r=n;o<r.length;o++){var a=r[o];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function Ri(e){var t=Ci.exec(e);return t?t[1]:""}function Ni(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function Oi(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var o=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?o.substring(0,o.length-t.length):o}function Di(e){var t=Ii.exec(e);return t?t[2]:""}function Mi(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function Li(e,t,n){if(0===t.indexOf("."))return Mi(e,t);var i=e.indexOf("?"),o="",r=n?Ri(e):"";return i>0&&(o=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+r+o}function Fi(e){var t=e=String(e);do{t=e,e=e.replace(Pi,"")}while(t.length!==e.length);return e}function zi(e){return e.replace(/[\/\\]$/,"")}function Bi(){return wi.os===xi.WINDOWS?"\\":"/"}e("ev",Object.freeze({__proto__:null,join:bi,extname:Ri,mainFileName:Ni,basename:Oi,dirname:Di,changeExtname:Mi,changeBasename:Li,_normalize:Fi,stripSep:zi,getSeperator:Bi})),s.log=v,s.warn=g,s.error=y,s.assert=x,s._throw=T,s.logID=C,s.warnID=P,s.errorID=R,s.assertID=D,s.debug=z,s.path={join:bi,extname:Ri,mainFileName:Ni,basename:Oi,dirname:Di,changeExtname:Mi,changeBasename:Li,_normalize:Fi,stripSep:zi,get sep(){return Bi()}};var Ui,Hi,Gi,Vi,ki,Wi,ji,qi,Yi,Xi,Ki,Qi,Zi,Ji,$i,eo,to,no,io,oo,ro,ao,so,co,lo,uo=0,ho={},_o=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}(),fo=function(){function e(){}return e.prototype.bind=function(){},e}(),po=function(){function e(){}var t=e.prototype;return t.alloc=function(e,t){return new ArrayBuffer(t)},t.free=function(){},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(lo||(lo={}));var mo,vo=function(){function e(e,t,n,i){void 0===i&&(i=8),this._dataType=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freelists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=n.COUNT,this._entryBits=i,this._dataType=t,this._stride=4*this._elementCount,this._entriesPerChunk=1<<i,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new _o(e,i,this._stride);var o=lo.NEVER,r=!1,a=!1;for(var s in t){if(r=this._hasFloat32,(a=this._hasUint32)&&r)break;o=t[s],r||o!==lo.FLOAT32?a||o!==lo.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freelists.length;e++){var t=this._freelists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),o=[],r=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&o.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&r.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return this._arrayBuffers.push(i),c&&this._uint32BufferViews.push(r),s&&this._float32BufferViews.push(o),this._freelists.push(a),(e<<this._entryBits)+this._poolFlag},t.get=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e;return(this._dataType[t]===lo.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i][t]},t.set=function(e,t,n){var i=(this._chunkMask&e)>>this._entryBits,o=this._entryMask&e;(this._dataType[t]===lo.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][o][t]=n},t.setVec2=function(){},t.setVec3=function(){},t.getVec3=function(){},t.setVec4=function(){},t.getVec4=function(){},t.setMat4=function(){},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freelists[t].push(n)},e}(),go=function(){function e(e,t,n){this._ctor=void 0,this._dtor=void 0,this._indexMask=void 0,this._poolFlag=void 0,this._array=[],this._freelist=[],this._nativePool=void 0,this._ctor=t,n&&(this._dtor=n),this._poolFlag=1<<29,this._indexMask=~this._poolFlag,this._nativePool=new fo(e,this._array)}var t=e.prototype;return t.alloc=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._freelist,o=-1;if(i.length)o=i[i.length-1],i.length--,this._array[o]=this._ctor(arguments,this._array[o]);else{o=this._array.length;var r=this._ctor(arguments);if(!r)return 0;this._array.push(r)}return o+this._poolFlag},t.get=function(e){var t=this._indexMask&e;return this._array[t]},t.free=function(e){var t=this._indexMask&e;this._dtor&&(this._array[t]=this._dtor(this._array[t])),this._freelist.push(t)},e}(),yo=function(){function e(e){this._nativeBufferAllocator=void 0,this._buffers=new Map,this._nextBufferIdx=0,this._poolFlag=void 0,this._bufferIdxMask=void 0,this._freelist=[],this._poolFlag=1<<30,this._bufferIdxMask=~this._poolFlag,this._nativeBufferAllocator=new po(e)}var t=e.prototype;return t.alloc=function(e){var t=this._freelist,n=-1;t.length?(n=t[t.length-1],t.length--):n=this._nextBufferIdx++;var i=this._nativeBufferAllocator.alloc(n,e);return this._buffers.set(n,i),n|this._poolFlag},t.free=function(e){var t=this._bufferIdxMask&e;this._buffers.get(t)&&(this._nativeBufferAllocator.free(t),this._buffers.delete(t),this._freelist.push(t))},t.getBuffer=function(e){var t=this._bufferIdxMask&e;return this._buffers.get(t)||null},e}(),xo=function(e){function t(t,n,i,o){var r;return(r=e.call(this,t)||this)._viewCtor=void 0,r._size=void 0,r._step=void 0,r._viewCtor=n,r._size=i*n.BYTES_PER_ELEMENT,r._step=o||i,r}ee(t,e);var n=t.prototype;return n.alloc=function(){var e=this._nextBufferIdx++,t=this._nativeBufferAllocator.alloc(e,this._size);return this._buffers.set(e,new this._viewCtor(t)),e|this._poolFlag},n.getBuffer=function(){return null},n.assign=function(e,t,n){var i=this._bufferIdxMask&e,o=this._buffers.get(i);if(o){var r=t+1;if(r>=o.length){for(var a=o.length;r>=a;)a+=this._step;a*=this._viewCtor.BYTES_PER_ELEMENT;var s=new this._viewCtor(this._nativeBufferAllocator.alloc(i,a));s.set(o),o=s,this._buffers.set(i,o)}o[r]=n;var c=o[0];o[0]=r>c?r:c}},n.erase=function(e,t){var n=this._bufferIdxMask&e,i=this._buffers.get(n);if(i&&!(t>=i[0])){for(var o=t+1;o<i[0];++o)i[o]=i[o+1];--i[0]}},n.push=function(e,t){var n=this._bufferIdxMask&e,i=this._buffers.get(n);i&&this.assign(e,i[0],t)},n.pop=function(e){var t=this._bufferIdxMask&e,n=this._buffers.get(t);n&&0!==n[0]&&--n[0]},n.clear=function(e){var t=this._bufferIdxMask&e,n=this._buffers.get(t);n&&(n[0]=0)},n.get=function(e,t){var n=this._bufferIdxMask&e,i=this._buffers.get(n);return!i||t>=i[0]?0:i[t+1]},n.length=function(e){var t=this._bufferIdxMask&e,n=this._buffers.get(t);return n?n[0]:0},t}(yo);function Eo(e,t,n,i){void 0===i&&(i=!0);for(var o=t.length(e),r=0;r<o;r++){var a=t.get(e,r);a&&n.free(a)}i?t.free(e):t.clear(e)}!function(e){e[e.ATTRIBUTE=0]="ATTRIBUTE",e[e.DESCRIPTOR_SETS=1]="DESCRIPTOR_SETS",e[e.SHADER=2]="SHADER",e[e.INPUT_ASSEMBLER=3]="INPUT_ASSEMBLER",e[e.PIPELINE_LAYOUT=4]="PIPELINE_LAYOUT",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.PASS=100]="PASS",e[e.SUB_MODEL=101]="SUB_MODEL",e[e.MODEL=102]="MODEL",e[e.SCENE=103]="SCENE",e[e.CAMERA=104]="CAMERA",e[e.NODE=105]="NODE",e[e.ROOT=106]="ROOT",e[e.AABB=107]="AABB",e[e.RENDER_WINDOW=108]="RENDER_WINDOW",e[e.FRUSTUM=109]="FRUSTUM",e[e.AMBIENT=110]="AMBIENT",e[e.FOG=111]="FOG",e[e.SKYBOX=112]="SKYBOX",e[e.SHADOW=113]="SHADOW",e[e.LIGHT=114]="LIGHT",e[e.SPHERE=115]="SPHERE",e[e.INSTANCED_ATTRIBUTE=116]="INSTANCED_ATTRIBUTE",e[e.FLAT_BUFFER=117]="FLAT_BUFFER",e[e.SUB_MESH=118]="SUB_MESH",e[e.RASTERIZER_STATE=119]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=120]="DEPTH_STENCIL_STATE",e[e.BLEND_TARGET=121]="BLEND_TARGET",e[e.BLEND_STATE=122]="BLEND_STATE",e[e.BATCH_2D=123]="BATCH_2D",e[e.PIPELINE_SCENE_DATA=124]="PIPELINE_SCENE_DATA",e[e.SUB_MODEL_ARRAY=200]="SUB_MODEL_ARRAY",e[e.MODEL_ARRAY=201]="MODEL_ARRAY",e[e.ATTRIBUTE_ARRAY=202]="ATTRIBUTE_ARRAY",e[e.FLAT_BUFFER_ARRAY=203]="FLAT_BUFFER_ARRAY",e[e.INSTANCED_BUFFER_ARRAY=204]="INSTANCED_BUFFER_ARRAY",e[e.LIGHT_ARRAY=205]="LIGHT_ARRAY",e[e.BLEND_TARGET_ARRAY=206]="BLEND_TARGET_ARRAY",e[e.BATCH_ARRAY_2D=207]="BATCH_ARRAY_2D",e[e.RAW_BUFFER=300]="RAW_BUFFER",e[e.RAW_OBJECT=400]="RAW_OBJECT"}(mo||(mo={}));var So,To=e("dk",0),Ao=new go(mo.SHADER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createShader(e[1])}),(function(e){return e&&e.destroy(),e})),wo=e("dw",new go(mo.DESCRIPTOR_SETS,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createDescriptorSet(e[1])}),(function(e){return e&&e.destroy(),e}))),Co=e("dj",new go(mo.INPUT_ASSEMBLER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createInputAssembler(e[1])}),(function(e){return e&&e.destroy(),e}))),Io=new go(mo.PIPELINE_LAYOUT,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createPipelineLayout(e[1])}),(function(e){return e&&e.destroy(),e})),Po=new go(mo.FRAMEBUFFER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createFramebuffer(e[1])}),(function(e){return e&&e.destroy(),e})),bo=new xo(mo.SUB_MODEL_ARRAY,Uint32Array,8,4),Ro=new xo(mo.MODEL_ARRAY,Uint32Array,32,16),No=new xo(mo.ATTRIBUTE_ARRAY,Uint32Array,8,4),Oo=new xo(mo.FLAT_BUFFER_ARRAY,Uint32Array,8,4),Do=new xo(mo.LIGHT_ARRAY,Uint32Array,8,4),Mo=new xo(mo.BLEND_TARGET_ARRAY,Uint32Array,8,4),Lo=new xo(mo.BATCH_ARRAY_2D,Uint32Array,32,16),Fo=new yo(mo.RAW_BUFFER),zo=new go(mo.RAW_OBJECT,(function(e){return e[0]||{}}),(function(){}));!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.BATCHING_SCHEME=3]="BATCHING_SCHEME",e[e.PRIMITIVE=4]="PRIMITIVE",e[e.DYNAMIC_STATES=5]="DYNAMIC_STATES",e[e.HASH=6]="HASH",e[e.RASTERIZER_STATE=7]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=8]="DEPTH_STENCIL_STATE",e[e.BLEND_STATE=9]="BLEND_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.PIPELINE_LAYOUT=11]="PIPELINE_LAYOUT",e[e.COUNT=12]="COUNT"}(So||(So={}));var Bo,Uo=((Ui={})[So.PRIORITY]=lo.UINT32,Ui[So.STAGE]=lo.UINT32,Ui[So.PHASE]=lo.UINT32,Ui[So.BATCHING_SCHEME]=lo.UINT32,Ui[So.PRIMITIVE]=lo.UINT32,Ui[So.DYNAMIC_STATES]=lo.UINT32,Ui[So.HASH]=lo.UINT32,Ui[So.RASTERIZER_STATE]=lo.UINT32,Ui[So.DEPTH_STENCIL_STATE]=lo.UINT32,Ui[So.BLEND_STATE]=lo.UINT32,Ui[So.DESCRIPTOR_SET]=lo.UINT32,Ui[So.PIPELINE_LAYOUT]=lo.UINT32,Ui[So.COUNT]=lo.NEVER,Ui),Ho=e("dq",new vo(mo.PASS,Uo,So));!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.PASS_COUNT=1]="PASS_COUNT",e[e.PASS_0=2]="PASS_0",e[e.PASS_1=3]="PASS_1",e[e.PASS_2=4]="PASS_2",e[e.PASS_3=5]="PASS_3",e[e.PASS_4=6]="PASS_4",e[e.PASS_5=7]="PASS_5",e[e.PASS_6=8]="PASS_6",e[e.PASS_7=9]="PASS_7",e[e.SHADER_0=10]="SHADER_0",e[e.SHADER_1=11]="SHADER_1",e[e.SHADER_2=12]="SHADER_2",e[e.SHADER_3=13]="SHADER_3",e[e.SHADER_4=14]="SHADER_4",e[e.SHADER_5=15]="SHADER_5",e[e.SHADER_6=16]="SHADER_6",e[e.SHADER_7=17]="SHADER_7",e[e.PLANAR_SHADER=18]="PLANAR_SHADER",e[e.PLANAR_INSTANCE_SHADER=19]="PLANAR_INSTANCE_SHADER",e[e.DESCRIPTOR_SET=20]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=21]="INPUT_ASSEMBLER",e[e.SUB_MESH=22]="SUB_MESH",e[e.COUNT=23]="COUNT"}(Bo||(Bo=e("dv",{})));var Go,Vo=((Hi={})[Bo.PRIORITY]=lo.UINT32,Hi[Bo.PASS_COUNT]=lo.UINT32,Hi[Bo.PASS_0]=lo.UINT32,Hi[Bo.PASS_1]=lo.UINT32,Hi[Bo.PASS_2]=lo.UINT32,Hi[Bo.PASS_3]=lo.UINT32,Hi[Bo.PASS_4]=lo.UINT32,Hi[Bo.PASS_5]=lo.UINT32,Hi[Bo.PASS_6]=lo.UINT32,Hi[Bo.PASS_7]=lo.UINT32,Hi[Bo.SHADER_0]=lo.UINT32,Hi[Bo.SHADER_1]=lo.UINT32,Hi[Bo.SHADER_2]=lo.UINT32,Hi[Bo.SHADER_3]=lo.UINT32,Hi[Bo.SHADER_4]=lo.UINT32,Hi[Bo.SHADER_5]=lo.UINT32,Hi[Bo.SHADER_6]=lo.UINT32,Hi[Bo.SHADER_7]=lo.UINT32,Hi[Bo.PLANAR_SHADER]=lo.UINT32,Hi[Bo.PLANAR_INSTANCE_SHADER]=lo.UINT32,Hi[Bo.DESCRIPTOR_SET]=lo.UINT32,Hi[Bo.INPUT_ASSEMBLER]=lo.UINT32,Hi[Bo.SUB_MESH]=lo.UINT32,Hi[Bo.COUNT]=lo.NEVER,Hi),ko=e("du",new vo(mo.SUB_MODEL,Vo,Bo));!function(e){e[e.ENABLED=0]="ENABLED",e[e.VIS_FLAGS=1]="VIS_FLAGS",e[e.CAST_SHADOW=2]="CAST_SHADOW",e[e.RECEIVE_SHADOW=3]="RECEIVE_SHADOW",e[e.WORLD_BOUNDS=4]="WORLD_BOUNDS",e[e.NODE=5]="NODE",e[e.TRANSFORM=6]="TRANSFORM",e[e.SUB_MODEL_ARRAY=7]="SUB_MODEL_ARRAY",e[e.INSTANCED_BUFFER=8]="INSTANCED_BUFFER",e[e.INSTANCED_ATTR_ARRAY=9]="INSTANCED_ATTR_ARRAY",e[e.COUNT=10]="COUNT"}(Go||(Go={}));var Wo,jo=((Gi={})[Go.ENABLED]=lo.UINT32,Gi[Go.VIS_FLAGS]=lo.UINT32,Gi[Go.CAST_SHADOW]=lo.UINT32,Gi[Go.RECEIVE_SHADOW]=lo.UINT32,Gi[Go.WORLD_BOUNDS]=lo.UINT32,Gi[Go.NODE]=lo.UINT32,Gi[Go.TRANSFORM]=lo.UINT32,Gi[Go.SUB_MODEL_ARRAY]=lo.UINT32,Gi[Go.INSTANCED_BUFFER]=lo.UINT32,Gi[Go.INSTANCED_ATTR_ARRAY]=lo.UINT32,Gi[Go.COUNT]=lo.NEVER,Gi),qo=new vo(mo.MODEL,jo,Go);!function(e){e[e.VIS_FLAGS=0]="VIS_FLAGS",e[e.PASS_COUNT=1]="PASS_COUNT",e[e.PASS_0=2]="PASS_0",e[e.PASS_1=3]="PASS_1",e[e.PASS_2=4]="PASS_2",e[e.PASS_3=5]="PASS_3",e[e.SHADER_0=6]="SHADER_0",e[e.SHADER_1=7]="SHADER_1",e[e.SHADER_2=8]="SHADER_2",e[e.SHADER_3=9]="SHADER_3",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COUNT=12]="COUNT"}(Wo||(Wo=e("dn",{})));var Yo,Xo=((Vi={})[Wo.VIS_FLAGS]=lo.UINT32,Vi[Wo.PASS_COUNT]=lo.UINT32,Vi[Wo.PASS_0]=lo.UINT32,Vi[Wo.PASS_1]=lo.UINT32,Vi[Wo.PASS_2]=lo.UINT32,Vi[Wo.PASS_3]=lo.UINT32,Vi[Wo.SHADER_0]=lo.UINT32,Vi[Wo.SHADER_1]=lo.UINT32,Vi[Wo.SHADER_2]=lo.UINT32,Vi[Wo.SHADER_3]=lo.UINT32,Vi[Wo.DESCRIPTOR_SET]=lo.UINT32,Vi[Wo.INPUT_ASSEMBLER]=lo.UINT32,Vi[Wo.COUNT]=lo.NEVER,Vi),Ko=e("dm",new vo(mo.BATCH_2D,Xo,Wo));!function(e){e[e.CENTER=0]="CENTER",e[e.HALF_EXTENSION=3]="HALF_EXTENSION",e[e.COUNT=6]="COUNT"}(Yo||(Yo=e("cB",{})));var Qo,Zo=((ki={})[Yo.CENTER]=lo.FLOAT32,ki[Yo.HALF_EXTENSION]=lo.FLOAT32,ki[Yo.COUNT]=lo.NEVER,ki),Jo=e("cA",new vo(mo.AABB,Zo,Yo));!function(e){e[e.MAIN_LIGHT=0]="MAIN_LIGHT",e[e.MODEL_ARRAY=1]="MODEL_ARRAY",e[e.SPHERE_LIGHT_ARRAY=2]="SPHERE_LIGHT_ARRAY",e[e.SPOT_LIGHT_ARRAY=3]="SPOT_LIGHT_ARRAY",e[e.BATCH_ARRAY_2D=4]="BATCH_ARRAY_2D",e[e.COUNT=5]="COUNT"}(Qo||(Qo={}));var $o,er=((Wi={})[Qo.MAIN_LIGHT]=lo.UINT32,Wi[Qo.MODEL_ARRAY]=lo.UINT32,Wi[Qo.SPHERE_LIGHT_ARRAY]=lo.UINT32,Wi[Qo.SPOT_LIGHT_ARRAY]=lo.UINT32,Wi[Qo.BATCH_ARRAY_2D]=lo.UINT32,Wi[Qo.COUNT]=lo.NEVER,Wi),tr=new vo(mo.SCENE,er,Qo);!function(e){e[e.WIDTH=0]="WIDTH",e[e.HEIGHT=1]="HEIGHT",e[e.EXPOSURE=2]="EXPOSURE",e[e.CLEAR_FLAGS=3]="CLEAR_FLAGS",e[e.CLEAR_DEPTH=4]="CLEAR_DEPTH",e[e.CLEAR_STENCIL=5]="CLEAR_STENCIL",e[e.VISIBILITY=6]="VISIBILITY",e[e.NODE=7]="NODE",e[e.SCENE=8]="SCENE",e[e.FRUSTUM=9]="FRUSTUM",e[e.WINDOW=10]="WINDOW",e[e.FORWARD=11]="FORWARD",e[e.POSITION=14]="POSITION",e[e.VIEW_PORT=17]="VIEW_PORT",e[e.CLEAR_COLOR=21]="CLEAR_COLOR",e[e.MAT_VIEW=25]="MAT_VIEW",e[e.MAT_VIEW_PROJ=41]="MAT_VIEW_PROJ",e[e.MAT_VIEW_PROJ_INV=57]="MAT_VIEW_PROJ_INV",e[e.MAT_PROJ=73]="MAT_PROJ",e[e.MAT_PROJ_INV=89]="MAT_PROJ_INV",e[e.MAT_VIEW_PROJ_OFFSCREEN=105]="MAT_VIEW_PROJ_OFFSCREEN",e[e.MAT_VIEW_PROJ_INV_OFFSCREEN=121]="MAT_VIEW_PROJ_INV_OFFSCREEN",e[e.MAT_PROJ_OFFSCREEN=137]="MAT_PROJ_OFFSCREEN",e[e.MAT_PROJ_INV_OFFSCREEN=153]="MAT_PROJ_INV_OFFSCREEN",e[e.COUNT=169]="COUNT"}($o||($o={}));var nr,ir=((ji={})[$o.WIDTH]=lo.UINT32,ji[$o.HEIGHT]=lo.UINT32,ji[$o.EXPOSURE]=lo.FLOAT32,ji[$o.CLEAR_FLAGS]=lo.UINT32,ji[$o.CLEAR_DEPTH]=lo.FLOAT32,ji[$o.CLEAR_STENCIL]=lo.UINT32,ji[$o.VISIBILITY]=lo.UINT32,ji[$o.NODE]=lo.UINT32,ji[$o.SCENE]=lo.UINT32,ji[$o.FRUSTUM]=lo.UINT32,ji[$o.WINDOW]=lo.UINT32,ji[$o.FORWARD]=lo.FLOAT32,ji[$o.POSITION]=lo.FLOAT32,ji[$o.VIEW_PORT]=lo.FLOAT32,ji[$o.CLEAR_COLOR]=lo.FLOAT32,ji[$o.MAT_VIEW]=lo.FLOAT32,ji[$o.MAT_VIEW_PROJ]=lo.FLOAT32,ji[$o.MAT_VIEW_PROJ_INV]=lo.FLOAT32,ji[$o.MAT_PROJ]=lo.FLOAT32,ji[$o.MAT_PROJ_INV]=lo.FLOAT32,ji[$o.MAT_VIEW_PROJ_OFFSCREEN]=lo.FLOAT32,ji[$o.MAT_VIEW_PROJ_INV_OFFSCREEN]=lo.FLOAT32,ji[$o.MAT_PROJ_OFFSCREEN]=lo.FLOAT32,ji[$o.MAT_PROJ_INV_OFFSCREEN]=lo.FLOAT32,ji[$o.COUNT]=lo.NEVER,ji),or=new vo(mo.CAMERA,ir,$o);!function(e){e[e.FLAGS_CHANGED=0]="FLAGS_CHANGED",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.COUNT=28]="COUNT"}(nr||(nr={}));var rr=((qi={})[nr.FLAGS_CHANGED]=lo.UINT32,qi[nr.LAYER]=lo.UINT32,qi[nr.WORLD_SCALE]=lo.FLOAT32,qi[nr.WORLD_POSITION]=lo.FLOAT32,qi[nr.WORLD_ROTATION]=lo.FLOAT32,qi[nr.WORLD_MATRIX]=lo.FLOAT32,qi[nr.COUNT]=lo.NEVER,qi);delete nr[nr.COUNT],nr[nr.COUNT=nr.LAYER+1]="COUNT";var ar,sr=new vo(mo.NODE,rr,nr);!function(e){e[e.CUMULATIVE_TIME=0]="CUMULATIVE_TIME",e[e.FRAME_TIME=1]="FRAME_TIME",e[e.COUNT=2]="COUNT"}(ar||(ar={}));var cr,lr=((Yi={})[ar.CUMULATIVE_TIME]=lo.FLOAT32,Yi[ar.FRAME_TIME]=lo.FLOAT32,Yi[ar.COUNT]=lo.NEVER,Yi),ur=new vo(mo.ROOT,lr,ar,1);!function(e){e[e.HAS_ON_SCREEN_ATTACHMENTS=0]="HAS_ON_SCREEN_ATTACHMENTS",e[e.HAS_OFF_SCREEN_ATTACHMENTS=1]="HAS_OFF_SCREEN_ATTACHMENTS",e[e.FRAMEBUFFER=2]="FRAMEBUFFER",e[e.COUNT=3]="COUNT"}(cr||(cr={}));var hr,_r=((Xi={})[cr.HAS_ON_SCREEN_ATTACHMENTS]=lo.UINT32,Xi[cr.HAS_OFF_SCREEN_ATTACHMENTS]=lo.UINT32,Xi[cr.FRAMEBUFFER]=lo.UINT32,Xi[cr.COUNT]=lo.NEVER,Xi),fr=new vo(mo.RENDER_WINDOW,_r,cr,2);!function(e){e[e.VERTICES=0]="VERTICES",e[e.PLANES=24]="PLANES",e[e.COUNT=48]="COUNT"}(hr||(hr={}));var dr,pr=((Ki={})[hr.VERTICES]=lo.FLOAT32,Ki[hr.PLANES]=lo.FLOAT32,Ki[hr.COUNT]=lo.NEVER,Ki),mr=new vo(mo.FRUSTUM,pr,hr);!function(e){e[e.ENABLE=0]="ENABLE",e[e.ILLUM=1]="ILLUM",e[e.SKY_COLOR=2]="SKY_COLOR",e[e.GROUND_ALBEDO=6]="GROUND_ALBEDO",e[e.COUNT=10]="COUNT"}(dr||(dr={}));var vr=((Qi={})[dr.ENABLE]=lo.UINT32,Qi[dr.ILLUM]=lo.FLOAT32,Qi[dr.SKY_COLOR]=lo.FLOAT32,Qi[dr.GROUND_ALBEDO]=lo.FLOAT32,Qi[dr.COUNT]=lo.NEVER,Qi);delete dr[dr.COUNT],dr[dr.COUNT=dr.ILLUM+1]="COUNT";var gr,yr=new vo(mo.AMBIENT,vr,dr,1);!function(e){e[e.ENABLE=0]="ENABLE",e[e.IS_RGBE=1]="IS_RGBE",e[e.USE_IBL=2]="USE_IBL",e[e.MODEL=3]="MODEL",e[e.COUNT=4]="COUNT"}(gr||(gr={}));var xr,Er=((Zi={})[gr.ENABLE]=lo.UINT32,Zi[gr.IS_RGBE]=lo.UINT32,Zi[gr.USE_IBL]=lo.UINT32,Zi[gr.MODEL]=lo.UINT32,Zi[gr.COUNT]=lo.NEVER,Zi),Sr=new vo(mo.SKYBOX,Er,gr,1);!function(e){e[e.ENABLE=0]="ENABLE",e[e.TYPE=1]="TYPE",e[e.DENSITY=2]="DENSITY",e[e.START=3]="START",e[e.END=4]="END",e[e.ATTEN=5]="ATTEN",e[e.TOP=6]="TOP",e[e.RANGE=7]="RANGE",e[e.COLOR=8]="COLOR",e[e.COUNT=12]="COUNT"}(xr||(xr={}));var Tr=((Ji={})[xr.ENABLE]=lo.UINT32,Ji[xr.TYPE]=lo.UINT32,Ji[xr.DENSITY]=lo.FLOAT32,Ji[xr.START]=lo.FLOAT32,Ji[xr.END]=lo.FLOAT32,Ji[xr.ATTEN]=lo.FLOAT32,Ji[xr.TOP]=lo.FLOAT32,Ji[xr.RANGE]=lo.FLOAT32,Ji[xr.COLOR]=lo.FLOAT32,Ji[xr.COUNT]=lo.NEVER,Ji);delete xr[xr.COUNT],xr[xr.COUNT=xr.RANGE+1]="COUNT";var Ar,wr=new vo(mo.FOG,Tr,xr);!function(e){e[e.ENABLE=0]="ENABLE",e[e.DIRTY=1]="DIRTY",e[e.TYPE=2]="TYPE",e[e.DISTANCE=3]="DISTANCE",e[e.INSTANCE_PASS=4]="INSTANCE_PASS",e[e.PLANAR_PASS=5]="PLANAR_PASS",e[e.NEAR=6]="NEAR",e[e.FAR=7]="FAR",e[e.ASPECT=8]="ASPECT",e[e.PCF_TYPE=9]="PCF_TYPE",e[e.SHADOW_MAP_DIRTY=10]="SHADOW_MAP_DIRTY",e[e.BIAS=11]="BIAS",e[e.PACKING=12]="PACKING",e[e.LINEAR=13]="LINEAR",e[e.SELF_SHADOW=14]="SELF_SHADOW",e[e.NORMAL_BIAS=15]="NORMAL_BIAS",e[e.ORTHO_SIZE=16]="ORTHO_SIZE",e[e.AUTO_ADAPT=17]="AUTO_ADAPT",e[e.COLOR=18]="COLOR",e[e.SIZE=22]="SIZE",e[e.NORMAL=24]="NORMAL",e[e.MAT_LIGHT=27]="MAT_LIGHT",e[e.COUNT=43]="COUNT"}(Ar||(Ar={}));var Cr=(($i={})[Ar.ENABLE]=lo.UINT32,$i[Ar.DIRTY]=lo.UINT32,$i[Ar.TYPE]=lo.UINT32,$i[Ar.DISTANCE]=lo.FLOAT32,$i[Ar.INSTANCE_PASS]=lo.UINT32,$i[Ar.PLANAR_PASS]=lo.UINT32,$i[Ar.NEAR]=lo.FLOAT32,$i[Ar.FAR]=lo.FLOAT32,$i[Ar.ASPECT]=lo.FLOAT32,$i[Ar.PCF_TYPE]=lo.UINT32,$i[Ar.SHADOW_MAP_DIRTY]=lo.UINT32,$i[Ar.BIAS]=lo.FLOAT32,$i[Ar.PACKING]=lo.UINT32,$i[Ar.LINEAR]=lo.UINT32,$i[Ar.SELF_SHADOW]=lo.UINT32,$i[Ar.NORMAL_BIAS]=lo.FLOAT32,$i[Ar.ORTHO_SIZE]=lo.FLOAT32,$i[Ar.AUTO_ADAPT]=lo.UINT32,$i[Ar.COLOR]=lo.FLOAT32,$i[Ar.SIZE]=lo.FLOAT32,$i[Ar.NORMAL]=lo.FLOAT32,$i[Ar.MAT_LIGHT]=lo.FLOAT32,$i[Ar.COUNT]=lo.NEVER,$i);delete Ar[Ar.COUNT],Ar[Ar.COUNT=Ar.AUTO_ADAPT+1]="COUNT";var Ir,Pr=new vo(mo.SHADOW,Cr,Ar,1);!function(e){e[e.SHADOW=0]="SHADOW",e[e.SKYBOX=1]="SKYBOX",e[e.AMBIENT=2]="AMBIENT",e[e.FOG=3]="FOG",e[e.IS_HDR=4]="IS_HDR",e[e.SHADING_SCALE=5]="SHADING_SCALE",e[e.FP_SCALE=6]="FP_SCALE",e[e.DEFERRED_LIGHT_PASS=7]="DEFERRED_LIGHT_PASS",e[e.DEFERRED_LIGHT_PASS_SHADER=8]="DEFERRED_LIGHT_PASS_SHADER",e[e.DEFERRED_POST_PASS=9]="DEFERRED_POST_PASS",e[e.DEFERRED_POST_PASS_SHADER=10]="DEFERRED_POST_PASS_SHADER",e[e.COUNT=11]="COUNT"}(Ir||(Ir={}));var br,Rr=((eo={})[Ir.SHADOW]=lo.UINT32,eo[Ir.SKYBOX]=lo.UINT32,eo[Ir.AMBIENT]=lo.UINT32,eo[Ir.FOG]=lo.UINT32,eo[Ir.IS_HDR]=lo.UINT32,eo[Ir.SHADING_SCALE]=lo.UINT32,eo[Ir.FP_SCALE]=lo.UINT32,eo[Ir.DEFERRED_LIGHT_PASS]=lo.UINT32,eo[Ir.DEFERRED_LIGHT_PASS_SHADER]=lo.UINT32,eo[Ir.DEFERRED_POST_PASS]=lo.UINT32,eo[Ir.DEFERRED_POST_PASS_SHADER]=lo.UINT32,eo[Ir.COUNT]=lo.NEVER,eo),Nr=new vo(mo.PIPELINE_SCENE_DATA,Rr,Ir,1);!function(e){e[e.USE_COLOR_TEMPERATURE=0]="USE_COLOR_TEMPERATURE",e[e.ILLUMINANCE=1]="ILLUMINANCE",e[e.NODE=2]="NODE",e[e.RANGE=3]="RANGE",e[e.TYPE=4]="TYPE",e[e.AABB=5]="AABB",e[e.FRUSTUM=6]="FRUSTUM",e[e.SIZE=7]="SIZE",e[e.SPOT_ANGLE=8]="SPOT_ANGLE",e[e.ASPECT=9]="ASPECT",e[e.DIRECTION=10]="DIRECTION",e[e.COLOR=13]="COLOR",e[e.COLOR_TEMPERATURE_RGB=16]="COLOR_TEMPERATURE_RGB",e[e.POSITION=19]="POSITION",e[e.COUNT=22]="COUNT"}(br||(br={}));var Or,Dr=((to={})[br.USE_COLOR_TEMPERATURE]=lo.UINT32,to[br.ILLUMINANCE]=lo.FLOAT32,to[br.NODE]=lo.UINT32,to[br.RANGE]=lo.FLOAT32,to[br.TYPE]=lo.UINT32,to[br.AABB]=lo.UINT32,to[br.FRUSTUM]=lo.UINT32,to[br.SIZE]=lo.FLOAT32,to[br.SPOT_ANGLE]=lo.FLOAT32,to[br.ASPECT]=lo.FLOAT32,to[br.DIRECTION]=lo.FLOAT32,to[br.COLOR]=lo.FLOAT32,to[br.COLOR_TEMPERATURE_RGB]=lo.FLOAT32,to[br.POSITION]=lo.FLOAT32,to[br.COUNT]=lo.NEVER,to),Mr=new vo(mo.LIGHT,Dr,br,3);!function(e){e[e.RADIUS=0]="RADIUS",e[e.CENTER=1]="CENTER",e[e.COUNT=4]="COUNT"}(Or||(Or={}));var Lr=((no={})[Or.RADIUS]=lo.FLOAT32,no[Or.CENTER]=lo.FLOAT32,no[Or.COUNT]=lo.NEVER,no);delete Or[Or.COUNT],Or[Or.COUNT=Or.RADIUS+1]="COUNT";var Fr,zr=new vo(mo.SPHERE,Lr,Or,3);!function(e){e[e.STRIDE=0]="STRIDE",e[e.AMOUNT=1]="AMOUNT",e[e.BUFFER=2]="BUFFER",e[e.COUNT=3]="COUNT"}(Fr||(Fr={}));var Br,Ur=((io={})[Fr.STRIDE]=lo.UINT32,io[Fr.AMOUNT]=lo.UINT32,io[Fr.BUFFER]=lo.UINT32,io[Fr.COUNT]=lo.NEVER,io),Hr=new vo(mo.FLAT_BUFFER,Ur,Fr,3);!function(e){e[e.FLAT_BUFFER_ARRAY=0]="FLAT_BUFFER_ARRAY",e[e.COUNT=1]="COUNT"}(Br||(Br={}));var Gr,Vr=((oo={})[Br.FLAT_BUFFER_ARRAY]=lo.UINT32,oo[Br.COUNT]=lo.NEVER,oo),kr=new vo(mo.SUB_MESH,Vr,Br,3);!function(e){e[e.IS_DISCARD=0]="IS_DISCARD",e[e.POLYGO_MODEL=1]="POLYGO_MODEL",e[e.SHADE_MODEL=2]="SHADE_MODEL",e[e.CULL_MODE=3]="CULL_MODE",e[e.IS_FRONT_FACE_CCW=4]="IS_FRONT_FACE_CCW",e[e.DEPTH_BIAS_ENABLED=5]="DEPTH_BIAS_ENABLED",e[e.DEPTH_BIAS=6]="DEPTH_BIAS",e[e.DEPTH_BIAS_CLAMP=7]="DEPTH_BIAS_CLAMP",e[e.DEPTH_BIAS_SLOP=8]="DEPTH_BIAS_SLOP",e[e.IS_DEPTH_CLIP=9]="IS_DEPTH_CLIP",e[e.IS_MULTI_SAMPLE=10]="IS_MULTI_SAMPLE",e[e.LINE_WIDTH=11]="LINE_WIDTH",e[e.COUNT=12]="COUNT"}(Gr||(Gr={}));var Wr,jr=((ro={})[Gr.IS_DISCARD]=lo.UINT32,ro[Gr.POLYGO_MODEL]=lo.UINT32,ro[Gr.SHADE_MODEL]=lo.UINT32,ro[Gr.CULL_MODE]=lo.UINT32,ro[Gr.IS_FRONT_FACE_CCW]=lo.UINT32,ro[Gr.DEPTH_BIAS_ENABLED]=lo.UINT32,ro[Gr.DEPTH_BIAS]=lo.FLOAT32,ro[Gr.DEPTH_BIAS_CLAMP]=lo.FLOAT32,ro[Gr.DEPTH_BIAS_SLOP]=lo.FLOAT32,ro[Gr.IS_DEPTH_CLIP]=lo.UINT32,ro[Gr.IS_MULTI_SAMPLE]=lo.UINT32,ro[Gr.LINE_WIDTH]=lo.FLOAT32,ro[Gr.COUNT]=lo.NEVER,ro),qr=new vo(mo.RASTERIZER_STATE,jr,Gr,9);!function(e){e[e.DEPTH_TEST=0]="DEPTH_TEST",e[e.DEPTH_WRITE=1]="DEPTH_WRITE",e[e.DEPTH_FUNC=2]="DEPTH_FUNC",e[e.STENCIL_TEST_FRONT=3]="STENCIL_TEST_FRONT",e[e.STENCIL_FUNC_FRONT=4]="STENCIL_FUNC_FRONT",e[e.STENCIL_READ_MASK_FRONT=5]="STENCIL_READ_MASK_FRONT",e[e.STENCIL_WRITE_MASK_FRONT=6]="STENCIL_WRITE_MASK_FRONT",e[e.STENCIL_FAIL_OP_FRONT=7]="STENCIL_FAIL_OP_FRONT",e[e.STENCIL_Z_FAIL_OP_FRONT=8]="STENCIL_Z_FAIL_OP_FRONT",e[e.STENCIL_PASS_OP_FRONT=9]="STENCIL_PASS_OP_FRONT",e[e.STENCIL_REF_FRONT=10]="STENCIL_REF_FRONT",e[e.STENCIL_TEST_BACK=11]="STENCIL_TEST_BACK",e[e.STENCIL_FUNC_BACK=12]="STENCIL_FUNC_BACK",e[e.STENCIL_READ_MADK_BACK=13]="STENCIL_READ_MADK_BACK",e[e.STENCIL_WRITE_MASK_BACK=14]="STENCIL_WRITE_MASK_BACK",e[e.STENCIL_FAIL_OP_BACK=15]="STENCIL_FAIL_OP_BACK",e[e.STENCIL_Z_FAIL_OP_BACK=16]="STENCIL_Z_FAIL_OP_BACK",e[e.STENCIL_PASS_OP_BACK=17]="STENCIL_PASS_OP_BACK",e[e.STENCIL_REF_BACK=18]="STENCIL_REF_BACK",e[e.COUNT=19]="COUNT"}(Wr||(Wr={}));var Yr,Xr=((ao={})[Wr.DEPTH_TEST]=lo.UINT32,ao[Wr.DEPTH_WRITE]=lo.UINT32,ao[Wr.DEPTH_FUNC]=lo.UINT32,ao[Wr.STENCIL_TEST_FRONT]=lo.UINT32,ao[Wr.STENCIL_FUNC_FRONT]=lo.UINT32,ao[Wr.STENCIL_READ_MASK_FRONT]=lo.UINT32,ao[Wr.STENCIL_WRITE_MASK_FRONT]=lo.UINT32,ao[Wr.STENCIL_FAIL_OP_FRONT]=lo.UINT32,ao[Wr.STENCIL_Z_FAIL_OP_FRONT]=lo.UINT32,ao[Wr.STENCIL_PASS_OP_FRONT]=lo.UINT32,ao[Wr.STENCIL_REF_FRONT]=lo.UINT32,ao[Wr.STENCIL_TEST_BACK]=lo.UINT32,ao[Wr.STENCIL_FUNC_BACK]=lo.UINT32,ao[Wr.STENCIL_READ_MADK_BACK]=lo.UINT32,ao[Wr.STENCIL_WRITE_MASK_BACK]=lo.UINT32,ao[Wr.STENCIL_FAIL_OP_BACK]=lo.UINT32,ao[Wr.STENCIL_Z_FAIL_OP_BACK]=lo.UINT32,ao[Wr.STENCIL_PASS_OP_BACK]=lo.UINT32,ao[Wr.STENCIL_REF_BACK]=lo.UINT32,ao[Wr.COUNT]=lo.NEVER,ao),Kr=new vo(mo.DEPTH_STENCIL_STATE,Xr,Wr,9);!function(e){e[e.BLEND=0]="BLEND",e[e.BLEND_SRC=1]="BLEND_SRC",e[e.BLEND_DST=2]="BLEND_DST",e[e.BLEND_EQ=3]="BLEND_EQ",e[e.BLEND_SRC_ALPHA=4]="BLEND_SRC_ALPHA",e[e.BLEND_DST_ALPHA=5]="BLEND_DST_ALPHA",e[e.BLEND_ALPHA_EQ=6]="BLEND_ALPHA_EQ",e[e.BLEND_COLOR_MASK=7]="BLEND_COLOR_MASK",e[e.COUNT=8]="COUNT"}(Yr||(Yr={})),(so={})[Yr.BLEND]=lo.UINT32,so[Yr.BLEND_SRC]=lo.UINT32,so[Yr.BLEND_DST]=lo.UINT32,so[Yr.BLEND_EQ]=lo.UINT32,so[Yr.BLEND_SRC_ALPHA]=lo.UINT32,so[Yr.BLEND_DST_ALPHA]=lo.UINT32,so[Yr.BLEND_ALPHA_EQ]=lo.UINT32,so[Yr.BLEND_COLOR_MASK]=lo.UINT32,so[Yr.COUNT]=lo.NEVER;var Qr,Zr=new vo(mo.BLEND_TARGET,Xr,Yr,9);!function(e){e[e.IS_A2C=0]="IS_A2C",e[e.IS_INDEPEND=1]="IS_INDEPEND",e[e.BLEND_COLOR=2]="BLEND_COLOR",e[e.BLEND_TARGET=6]="BLEND_TARGET",e[e.COUNT=7]="COUNT"}(Qr||(Qr={}));var Jr=((co={})[Qr.IS_A2C]=lo.UINT32,co[Qr.IS_INDEPEND]=lo.UINT32,co[Qr.BLEND_COLOR]=lo.FLOAT32,co[Qr.BLEND_TARGET]=lo.UINT32,co[Qr.COUNT]=lo.NEVER,co),$r=new vo(mo.BLEND_STATE,Jr,Qr,9),ea=function(){function e(){this._skyColor=new Sn(51,128,204,1),this._groundAlbedo=new Sn(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1]),this._handle=To,this._handle=yr.alloc()}var t=e.prototype;return t.initialize=function(e){this._skyColor.set(e.skyColor),this._groundAlbedo.set(e.groundAlbedo),Sn.toArray(this._colorArray,this._skyColor),An.toArray(this._albedoArray,this._groundAlbedo),yr.setVec4(this._handle,dr.SKY_COLOR,this._skyColor),yr.setVec4(this._handle,dr.GROUND_ALBEDO,this._groundAlbedo),yr.set(this._handle,dr.ILLUM,e.skyIllum)},t.destroy=function(){this._handle&&(yr.free(this._handle),this._handle=To)},J(e,[{key:"colorArray",get:function(){return this._colorArray}},{key:"albedoArray",get:function(){return this._albedoArray}},{key:"enabled",get:function(){return yr.get(this._handle,dr.ENABLE)},set:function(e){yr.set(this._handle,dr.ENABLE,e?1:0)}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor.set(e),Sn.toArray(this._colorArray,this._skyColor),yr.setVec4(this._handle,dr.SKY_COLOR,this._skyColor)}},{key:"skyIllum",get:function(){return yr.get(this._handle,dr.ILLUM)},set:function(e){yr.set(this._handle,dr.ILLUM,e)}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo.set(e),An.toArray(this._albedoArray,this._groundAlbedo),yr.setVec4(this._handle,dr.GROUND_ALBEDO,this._groundAlbedo)}},{key:"handle",get:function(){return this._handle}}]),e}();ea.SUN_ILLUM=65e3,ea.SKY_ILLUM=2e4,s.Ambient=ea;var ta=new An,na=new An,ia=new An,oa=new An,ra=new An,aa=new An,sa=new Array(3),ca=new Array(3);function la(e,t){return An.dot(t.n,e)-t.d}function ua(e,t,n){return An.copy(e,t),An.subtract(ra,n.center,n.halfExtents),An.add(aa,n.center,n.halfExtents),e.x=e.x<ra.x?ra.x:e.x,e.y=e.y<ra.y?ra.y:e.y,e.z=e.z<ra.z?ra.z:e.z,e.x=e.x>aa.x?aa.x:e.x,e.y=e.y>aa.y?aa.y:e.y,e.z=e.z>aa.z?aa.z:e.z,e}function ha(e,t,n){An.set(ta,n.orientation.m00,n.orientation.m01,n.orientation.m02),An.set(na,n.orientation.m03,n.orientation.m04,n.orientation.m05),An.set(ia,n.orientation.m06,n.orientation.m07,n.orientation.m08),sa[0]=ta,sa[1]=na,sa[2]=ia,ca[0]=n.halfExtents.x,ca[1]=n.halfExtents.y,ca[2]=n.halfExtents.z,An.subtract(oa,t,n.center),An.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var o=An.dot(oa,sa[i]);o>ca[i]&&(o=ca[i]),o<-ca[i]&&(o=-ca[i]),e.x+=o*sa[i].x,e.y+=o*sa[i].y,e.z+=o*sa[i].z}return e}var _a=Object.freeze({__proto__:null,point_plane:la,pt_point_plane:function(e,t,n){var i=la(t,n);return An.subtract(e,t,An.multiplyScalar(e,n.n,i))},pt_point_aabb:ua,pt_point_obb:ha,pt_point_line:function(e,t,n,i){An.subtract(ta,n,i);var o=ta,r=An.lengthSqr(o);if(0==r)An.copy(e,n);else{An.subtract(ta,t,n);var a=An.dot(ta,o)/r;a<0?An.copy(e,n):a>1?An.copy(e,i):An.scaleAndAdd(e,n,o,a)}}}),fa={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},da=function(){function e(e,t,n,i,o,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=fa.SHAPE_LINE,this.s=new An(e,t,n),this.e=new An(i,o,r)}return e.create=function(t,n,i,o,r,a){return new e(t,n,i,o,r,a)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return An.copy(e.s,t.s),An.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return An.copy(e.s,t),An.copy(e.e,n),e},e.set=function(e,t,n,i,o,r,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=o,e.e.y=r,e.e.z=a,e},e.len=function(e){return An.distance(e.s,e.e)},e.prototype.length=function(){return An.distance(this.s,this.e)},J(e,[{key:"type",get:function(){return this._type}}]),e}(),pa=function(){function e(e,t,n,i,o,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=fa.SHAPE_RAY,this.o=new An(e,t,n),this.d=new An(i,o,r)}return e.create=function(t,n,i,o,r,a){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=0),void 0===a&&(a=1),new e(t,n,i,o,r,a)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return An.copy(e.o,t.o),An.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return An.copy(e.o,t),An.normalize(e.d,An.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,o,r,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=o,e.d.y=r,e.d.z=a,e},e.prototype.computeHit=function(e,t){An.normalize(e,this.d),An.scaleAndAdd(e,this.o,e,t)},J(e,[{key:"type",get:function(){return this._type}}]),e}(),ma=new An,va=new An,ga=new An,ya=new An;function xa(e){return Math.max(Math.max(e.x,e.y),e.z)}var Ea,Sa,Ta,Aa,wa,Ca,Ia,Pa,ba,Ra,Na,Oa,Da,Ma,La,Fa,za,Ba,Ua,Ha,Ga,Va,ka,Wa,ja,qa,Ya,Xa,Ka,Qa,Za,Ja,$a,es,ts,ns,is,os,rs=e("dW",function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new An(0,0,0),this._poolHandle=To,this._type=void 0,this._type=fa.SHAPE_SPHERE,this._center=new An(e,t,n),this._poolHandle=zr.alloc(),zr.setVec3(this._poolHandle,Or.CENTER,this._center),zr.set(this._poolHandle,Or.RADIUS,i)}e.create=function(t,n,i,o){return new e(t,n,i,o)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return An.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return An.multiplyScalar(e.center,An.add(ma,t,n),.5),e.radius=.5*An.subtract(ma,n,t).length(),e},e.set=function(e,t,n,i,o){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=o,e},e.mergePoint=function(e,t,n){if(t.radius<0)return e.center.set(n),e.radius=0,e;An.subtract(va,n,t.center);var i=va.length();if(i>t.radius){var o=.5*(i-t.radius);e.radius+=o,An.multiplyScalar(va,va,o/i),An.add(e.center,e.center,va)}return e},e.mergeAABB=function(t,n,i){return i.getBoundary(ga,ya),e.mergePoint(t,n,ga),e.mergePoint(t,n,ya),t};var t=e.prototype;return t.destroy=function(){this._poolHandle&&(zr.free(this._poolHandle),this._poolHandle=To)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){An.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),An.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,o){An.transformMat4(o.center,this.center,e),o.radius=this.radius*xa(i)},t.translateAndRotate=function(e,t,n){An.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*xa(e)},J(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e,zr.setVec3(this._poolHandle,Or.CENTER,this._center)}},{key:"radius",get:function(){return zr.get(this._poolHandle,Or.RADIUS)},set:function(e){zr.set(this._poolHandle,Or.RADIUS,e)}},{key:"handle",get:function(){return this._poolHandle}},{key:"type",get:function(){return this._type}}]),e}()),as=function(){function e(e,t,n,i,o,r,a,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===o&&(o=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=fa.SHAPE_TRIANGLE,this.a=new An(e,t,n),this.b=new An(i,o,r),this.c=new An(a,s,c)}return e.create=function(t,n,i,o,r,a,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,o,r,a,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return An.copy(e.a,t.a),An.copy(e.b,t.b),An.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return An.copy(e.a,t),An.copy(e.b,n),An.copy(e.c,i),e},e.set=function(e,t,n,i,o,r,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=o,e.b.y=r,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e},J(e,[{key:"type",get:function(){return this._type}}]),e}(),ss=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BUFFER=1]="BUFFER",e[e.TEXTURE=2]="TEXTURE",e[e.RENDER_PASS=3]="RENDER_PASS",e[e.FRAMEBUFFER=4]="FRAMEBUFFER",e[e.SAMPLER=5]="SAMPLER",e[e.SHADER=6]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=9]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=12]="COMMAND_BUFFER",e[e.QUEUE=13]="QUEUE",e[e.GLOBAL_BARRIER=14]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=15]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=16]="BUFFER_BARRIER"}(Ea||(Ea=e("O",{}))),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(Sa||(Sa=e("S",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.WEBGL=5]="WEBGL",e[e.WEBGL2=6]="WEBGL2",e[e.WEBGPU=7]="WEBGPU"}(Ta||(Ta=e("A",{}))),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(Aa||(Aa=e("b",{}))),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_D16=7]="FORMAT_D16",e[e.FORMAT_D16S8=8]="FORMAT_D16S8",e[e.FORMAT_D24=9]="FORMAT_D24",e[e.FORMAT_D24S8=10]="FORMAT_D24S8",e[e.FORMAT_D32F=11]="FORMAT_D32F",e[e.FORMAT_D32FS8=12]="FORMAT_D32FS8",e[e.FORMAT_ETC1=13]="FORMAT_ETC1",e[e.FORMAT_ETC2=14]="FORMAT_ETC2",e[e.FORMAT_DXT=15]="FORMAT_DXT",e[e.FORMAT_PVRTC=16]="FORMAT_PVRTC",e[e.FORMAT_ASTC=17]="FORMAT_ASTC",e[e.FORMAT_RGB8=18]="FORMAT_RGB8",e[e.MSAA=19]="MSAA",e[e.ELEMENT_INDEX_UINT=20]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=21]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=22]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=23]="BLEND_MINMAX",e[e.DEPTH_BOUNDS=24]="DEPTH_BOUNDS",e[e.LINE_WIDTH=25]="LINE_WIDTH",e[e.STENCIL_WRITE_MASK=26]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=27]="STENCIL_COMPARE_MASK",e[e.MULTITHREADED_SUBMISSION=28]="MULTITHREADED_SUBMISSION",e[e.COMPUTE_SHADER=29]="COMPUTE_SHADER",e[e.COUNT=30]="COUNT"}(wa||(wa=e("F",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.D16=54]="D16",e[e.D16S8=55]="D16S8",e[e.D24=56]="D24",e[e.D24S8=57]="D24S8",e[e.D32F=58]="D32F",e[e.D32F_S8=59]="D32F_S8",e[e.BC1=60]="BC1",e[e.BC1_ALPHA=61]="BC1_ALPHA",e[e.BC1_SRGB=62]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",e[e.BC2=64]="BC2",e[e.BC2_SRGB=65]="BC2_SRGB",e[e.BC3=66]="BC3",e[e.BC3_SRGB=67]="BC3_SRGB",e[e.BC4=68]="BC4",e[e.BC4_SNORM=69]="BC4_SNORM",e[e.BC5=70]="BC5",e[e.BC5_SNORM=71]="BC5_SNORM",e[e.BC6H_UF16=72]="BC6H_UF16",e[e.BC6H_SF16=73]="BC6H_SF16",e[e.BC7=74]="BC7",e[e.BC7_SRGB=75]="BC7_SRGB",e[e.ETC_RGB8=76]="ETC_RGB8",e[e.ETC2_RGB8=77]="ETC2_RGB8",e[e.ETC2_SRGB8=78]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=81]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",e[e.EAC_R11=83]="EAC_R11",e[e.EAC_R11SN=84]="EAC_R11SN",e[e.EAC_RG11=85]="EAC_RG11",e[e.EAC_RG11SN=86]="EAC_RG11SN",e[e.PVRTC_RGB2=87]="PVRTC_RGB2",e[e.PVRTC_RGBA2=88]="PVRTC_RGBA2",e[e.PVRTC_RGB4=89]="PVRTC_RGB4",e[e.PVRTC_RGBA4=90]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=91]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=92]="PVRTC2_4BPP",e[e.ASTC_RGBA_4x4=93]="ASTC_RGBA_4x4",e[e.ASTC_RGBA_5x4=94]="ASTC_RGBA_5x4",e[e.ASTC_RGBA_5x5=95]="ASTC_RGBA_5x5",e[e.ASTC_RGBA_6x5=96]="ASTC_RGBA_6x5",e[e.ASTC_RGBA_6x6=97]="ASTC_RGBA_6x6",e[e.ASTC_RGBA_8x5=98]="ASTC_RGBA_8x5",e[e.ASTC_RGBA_8x6=99]="ASTC_RGBA_8x6",e[e.ASTC_RGBA_8x8=100]="ASTC_RGBA_8x8",e[e.ASTC_RGBA_10x5=101]="ASTC_RGBA_10x5",e[e.ASTC_RGBA_10x6=102]="ASTC_RGBA_10x6",e[e.ASTC_RGBA_10x8=103]="ASTC_RGBA_10x8",e[e.ASTC_RGBA_10x10=104]="ASTC_RGBA_10x10",e[e.ASTC_RGBA_12x10=105]="ASTC_RGBA_12x10",e[e.ASTC_RGBA_12x12=106]="ASTC_RGBA_12x12",e[e.ASTC_SRGBA_4x4=107]="ASTC_SRGBA_4x4",e[e.ASTC_SRGBA_5x4=108]="ASTC_SRGBA_5x4",e[e.ASTC_SRGBA_5x5=109]="ASTC_SRGBA_5x5",e[e.ASTC_SRGBA_6x5=110]="ASTC_SRGBA_6x5",e[e.ASTC_SRGBA_6x6=111]="ASTC_SRGBA_6x6",e[e.ASTC_SRGBA_8x5=112]="ASTC_SRGBA_8x5",e[e.ASTC_SRGBA_8x6=113]="ASTC_SRGBA_8x6",e[e.ASTC_SRGBA_8x8=114]="ASTC_SRGBA_8x8",e[e.ASTC_SRGBA_10x5=115]="ASTC_SRGBA_10x5",e[e.ASTC_SRGBA_10x6=116]="ASTC_SRGBA_10x6",e[e.ASTC_SRGBA_10x8=117]="ASTC_SRGBA_10x8",e[e.ASTC_SRGBA_10x10=118]="ASTC_SRGBA_10x10",e[e.ASTC_SRGBA_12x10=119]="ASTC_SRGBA_12x10",e[e.ASTC_SRGBA_12x12=120]="ASTC_SRGBA_12x12",e[e.COUNT=121]="COUNT"}(Ca||(Ca=e("c",{}))),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Ia||(Ia=e("d",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(Pa||(Pa=e("T",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(ba||(ba=e("e",{}))),function(e){e[e.NONE=0]="NONE"}(Ra||(Ra=e("f",{}))),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(Na||(Na=e("M",{}))),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(Oa||(Oa=e("g",{}))),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Da||(Da=e("h",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",e[e.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(Ma||(Ma=e("i",{}))),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.IMMUTABLE=2]="IMMUTABLE"}(La||(La=e("j",{}))),function(e){e[e.X1=0]="X1",e[e.X2=1]="X2",e[e.X4=2]="X4",e[e.X8=3]="X8",e[e.X16=4]="X16",e[e.X32=5]="X32",e[e.X64=6]="X64"}(Fa||(Fa=e("k",{}))),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(za||(za=e("l",{}))),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(Ba||(Ba=e("m",{}))),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Ua||(Ua=e("n",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Ha||(Ha=e("o",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Ga||(Ga=e("p",{}))),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Va||(Va=e("q",{}))),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(ka||(ka=e("r",{}))),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Wa||(Wa=e("s",{}))),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(ja||(ja=e("L",{}))),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(qa||(qa=e("t",{}))),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=3]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=17]="TRANSFER_READ",e[e.HOST_READ=18]="HOST_READ",e[e.PRESENT=19]="PRESENT",e[e.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=25]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",e[e.HOST_WRITE=27]="HOST_WRITE"}(Ya||(Ya=e("u",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Xa||(Xa=e("v",{}))),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Ka||(Ka=e("w",{}))),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Qa||(Qa=e("x",{}))),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Za||(Za=e("y",{}))),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(Ja||(Ja=e("z",{}))),function(e){e[e.NONE=0]="NONE",e[e.VIEWPORT=1]="VIEWPORT",e[e.SCISSOR=2]="SCISSOR",e[e.LINE_WIDTH=4]="LINE_WIDTH",e[e.DEPTH_BIAS=8]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}($a||($a=e("E",{}))),function(e){e[e.FRONT=0]="FRONT",e[e.BACK=1]="BACK",e[e.ALL=2]="ALL"}(es||(es=e("G",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(ts||(ts=e("H",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(ns||(ns=e("Q",{}))),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(is||(is=e("I",{}))),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(os||(os=e("J",{})));var cs,ls=e("K",function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}()),us=e("N",function(){function e(e,t,n,i,o,r,a,s,c,l,u,h,_,f,d,p,m,v,g,y,x,E,S){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=1),void 0===m&&(m=0),void 0===v&&(v=0),void 0===g&&(g=new ls),void 0===y&&(y=new ls),void 0===x&&(x=-1),void 0===E&&(E=1),void 0===S&&(S=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=o,this.maxVertexTextureUnits=r,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.depthBits=f,this.stencilBits=d,this.uboOffsetAlignment=p,this.maxComputeSharedMemorySize=m,this.maxComputeWorkGroupInvocations=v,this.maxComputeWorkGroupSize=g,this.maxComputeWorkGroupCount=y,this.clipSpaceMinZ=x,this.screenSpaceSignY=E,this.clipSpaceSignY=S}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.depthBits=e.depthBits,this.stencilBits=e.stencilBits,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}()),hs=e("U",function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}()),_s=e("V",function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}()),fs=e("W",function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}()),ds=e("X",function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}()),ps=e("Y",function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}()),ms=e("Z",function(){function e(e,t,n,i,o){void 0===e&&(e=new ds),void 0===t&&(t=new hs),void 0===n&&(n=new ds),void 0===i&&(i=new hs),void 0===o&&(o=new fs),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=o}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}()),vs=e("_",function(){function e(e,t,n,i,o,r){void 0===e&&(e=new ds),void 0===t&&(t=new hs),void 0===n&&(n=new fs),void 0===i&&(i=new ds),void 0===o&&(o=new hs),void 0===r&&(r=new fs),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=o,this.dstExtent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}()),gs=e("$",function(){function e(e,t,n,i,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new hs),void 0===i&&(i=new fs),void 0===o&&(o=new ds),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=o}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}()),ys=e("a0",function(){function e(e,t,n,i,o,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=o,this.maxDepth=r}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}()),xs=e("a1",function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}()),Es=e("a2",function(){function e(e,t,n){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=0),this.bufferOffsets=e,this.samplerOffsets=t,this.flexibleSet=n}return e.prototype.copy=function(e){return this.bufferOffsets=e.bufferOffsets.slice(),this.samplerOffsets=e.samplerOffsets.slice(),this.flexibleSet=e.flexibleSet,this},e}()),Ss=e("a3",function(){function e(e,t,n,i,o){void 0===e&&(e=ba.NONE),void 0===t&&(t=Oa.NONE),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=Ra.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=o}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}()),Ts=e("a4",function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}()),As=e("a5",function(){function e(e,t,n,i,o,r,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=0),void 0===a&&(a=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=o,this.instanceCount=r,this.firstInstance=a}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}()),ws=e("a6",function(){function e(e,t,n,i,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===o&&(o=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=o}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}()),Cs=e("a7",function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return ss(this.drawInfos,e.drawInfos,As),this},e}()),Is=e("a8",function(){function e(e,t,n,i,o,r,a,s,c,l){void 0===e&&(e=Da.TEX2D),void 0===t&&(t=Ma.NONE),void 0===n&&(n=Ca.UNKNOWN),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=La.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=Fa.X1),void 0===l&&(l=1),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=o,this.flags=r,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this},e}()),Ps=e("a9",function(){function e(e,t,n,i,o,r,a){void 0===e&&(e=null),void 0===t&&(t=Da.TEX2D),void 0===n&&(n=Ca.UNKNOWN),void 0===i&&(i=0),void 0===o&&(o=1),void 0===r&&(r=0),void 0===a&&(a=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=o,this.baseLayer=r,this.layerCount=a}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}()),bs=e("aa",function(){function e(e,t,n,i,o,r,a,s,c,l){void 0===e&&(e=za.LINEAR),void 0===t&&(t=za.LINEAR),void 0===n&&(n=za.NONE),void 0===i&&(i=Ba.WRAP),void 0===o&&(o=Ba.WRAP),void 0===r&&(r=Ba.WRAP),void 0===a&&(a=0),void 0===s&&(s=Ua.ALWAYS),void 0===c&&(c=new xs),void 0===l&&(l=0),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=o,this.addressW=r,this.maxAnisotropy=a,this.cmpFunc=s,this.borderColor=c,this.mipLODBias=l}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this.borderColor.copy(e.borderColor),this.mipLODBias=e.mipLODBias,this},e}()),Rs=e("ab",function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=Pa.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}()),Ns=e("ac",function(){function e(e,t,n,i,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===o&&(o=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,ss(this.members,e.members,Rs),this.count=e.count,this},e}()),Os=e("ad",function(){function e(e,t,n,i,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=Pa.UNKNOWN),void 0===o&&(o=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}()),Ds=e("ae",function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}()),Ms=e("af",function(){function e(e,t,n,i,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=Pa.UNKNOWN),void 0===o&&(o=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}()),Ls=e("ag",function(){function e(e,t,n,i,o,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=Pa.UNKNOWN),void 0===o&&(o=0),void 0===r&&(r=Na.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=o,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}()),Fs=e("ah",function(){function e(e,t,n,i,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===o&&(o=Na.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}()),zs=e("ai",function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}()),Bs=e("aj",function(){function e(e,t){void 0===e&&(e=Wa.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}()),Us=e("ak",function(){function e(e,t,n,i,o,r){void 0===e&&(e=""),void 0===t&&(t=Ca.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===o&&(o=!1),void 0===r&&(r=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=o,this.location=r}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}()),Hs=e("al",function(){function e(e,t,n,i,o,r,a,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===o&&(o=[]),void 0===r&&(r=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=o,this.samplerTextures=r,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,ss(this.stages,e.stages,Bs),ss(this.attributes,e.attributes,Us),ss(this.blocks,e.blocks,Ns),ss(this.buffers,e.buffers,Fs),ss(this.samplerTextures,e.samplerTextures,Os),ss(this.samplers,e.samplers,Ds),ss(this.textures,e.textures,Ms),ss(this.images,e.images,Ls),ss(this.subpassInputs,e.subpassInputs,zs),this},e}()),Gs=e("am",function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return ss(this.attributes,e.attributes,Us),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}()),Vs=e("an",function(){function e(e,t,n,i,o,r){void 0===e&&(e=Ca.UNKNOWN),void 0===t&&(t=Fa.X1),void 0===n&&(n=ja.CLEAR),void 0===i&&(i=qa.STORE),void 0===o&&(o=[]),void 0===r&&(r=[Ya.PRESENT]),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.beginAccesses=o,this.endAccesses=r}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this},e}()),ks=e("ao",function(){function e(e,t,n,i,o,r,a,s){void 0===e&&(e=Ca.UNKNOWN),void 0===t&&(t=Fa.X1),void 0===n&&(n=ja.CLEAR),void 0===i&&(i=qa.STORE),void 0===o&&(o=ja.CLEAR),void 0===r&&(r=qa.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Ya.DEPTH_STENCIL_ATTACHMENT_WRITE]),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=o,this.stencilStoreOp=r,this.beginAccesses=a,this.endAccesses=s}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this},e}()),Ws=e("ap",function(){function e(e,t,n,i,o){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===o&&(o=-1),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=o}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this},e}()),js=e("aq",function(){function e(e,t,n){void 0===e&&(e=[]),void 0===t&&(t=new ks),void 0===n&&(n=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n}return e.prototype.copy=function(e){return ss(this.colorAttachments,e.colorAttachments,Vs),this.depthStencilAttachment.copy(e.depthStencilAttachment),ss(this.subpasses,e.subpasses,Ws),this},e}()),qs=e("ar",function(){function e(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this},e}()),Ys=e("as",function(){function e(e,t,n,i,o){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===o&&(o=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=o}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}()),Xs=e("at",function(){function e(e,t,n,i,o){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=[]),void 0===o&&(o=0),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n,this.colorMipmapLevels=i,this.depthStencilMipmapLevel=o}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this.colorMipmapLevels=e.colorMipmapLevels.slice(),this.depthStencilMipmapLevel=e.depthStencilMipmapLevel,this},e}()),Ks=e("au",function(){function e(e,t,n,i,o){void 0===e&&(e=-1),void 0===t&&(t=ts.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Wa.NONE),void 0===o&&(o=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=o}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}()),Qs=e("av",function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return ss(this.bindings,e.bindings,Ks),this},e}()),Zs=e("aw",function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}()),Js=e("ax",function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}()),$s=e("ay",function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return ss(this.attributes,e.attributes,Us),this},e}()),ec=e("az",function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=is.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}()),tc=e("aA",function(){function e(e){void 0===e&&(e=ns.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}()),nc=e("aB",(function(e,t,n,i,o,r,a,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=Ia.NONE),void 0===o&&(o=!1),void 0===r&&(r=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=o,this.hasDepth=r,this.hasStencil=a,this.isCompressed=s})),ic=e("aC",function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}()),oc=e("aD",function(){function e(e){this._gfxType=Ea.UNKNOWN,this._gfxType=e}return J(e,[{key:"gfxType",get:function(){return this._gfxType}}]),e}()),rc=e("aE",(function(e,t,n,i,o,r,a){void 0===t&&(t=!0),void 0===n&&(n=!0),void 0===i&&(i=1),void 0===o&&(o=1),void 0===r&&(r=1),void 0===a&&(a=new Es),this.canvasElm=e,this.isAntialias=t,this.isPremultipliedAlpha=n,this.devicePixelRatio=i,this.nativeWidth=o,this.nativeHeight=r,this.bindingMappingInfo=a}));!function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(cs||(cs=e("aF",{})));var ac=e("aG",Object.freeze([new nc("UNKNOWN",0,0,Ia.NONE,!1,!1,!1,!1),new nc("A8",1,1,Ia.UNORM,!0,!1,!1,!1),new nc("L8",1,1,Ia.UNORM,!1,!1,!1,!1),new nc("LA8",1,2,Ia.UNORM,!0,!1,!1,!1),new nc("R8",1,1,Ia.UNORM,!1,!1,!1,!1),new nc("R8SN",1,1,Ia.SNORM,!1,!1,!1,!1),new nc("R8UI",1,1,Ia.UINT,!1,!1,!1,!1),new nc("R8I",1,1,Ia.INT,!1,!1,!1,!1),new nc("R16F",2,1,Ia.FLOAT,!1,!1,!1,!1),new nc("R16UI",2,1,Ia.UINT,!1,!1,!1,!1),new nc("R16I",2,1,Ia.INT,!1,!1,!1,!1),new nc("R32F",4,1,Ia.FLOAT,!1,!1,!1,!1),new nc("R32UI",4,1,Ia.UINT,!1,!1,!1,!1),new nc("R32I",4,1,Ia.INT,!1,!1,!1,!1),new nc("RG8",2,2,Ia.UNORM,!1,!1,!1,!1),new nc("RG8SN",2,2,Ia.SNORM,!1,!1,!1,!1),new nc("RG8UI",2,2,Ia.UINT,!1,!1,!1,!1),new nc("RG8I",2,2,Ia.INT,!1,!1,!1,!1),new nc("RG16F",4,2,Ia.FLOAT,!1,!1,!1,!1),new nc("RG16UI",4,2,Ia.UINT,!1,!1,!1,!1),new nc("RG16I",4,2,Ia.INT,!1,!1,!1,!1),new nc("RG32F",8,2,Ia.FLOAT,!1,!1,!1,!1),new nc("RG32UI",8,2,Ia.UINT,!1,!1,!1,!1),new nc("RG32I",8,2,Ia.INT,!1,!1,!1,!1),new nc("RGB8",3,3,Ia.UNORM,!1,!1,!1,!1),new nc("SRGB8",3,3,Ia.UNORM,!1,!1,!1,!1),new nc("RGB8SN",3,3,Ia.SNORM,!1,!1,!1,!1),new nc("RGB8UI",3,3,Ia.UINT,!1,!1,!1,!1),new nc("RGB8I",3,3,Ia.INT,!1,!1,!1,!1),new nc("RGB16F",6,3,Ia.FLOAT,!1,!1,!1,!1),new nc("RGB16UI",6,3,Ia.UINT,!1,!1,!1,!1),new nc("RGB16I",6,3,Ia.INT,!1,!1,!1,!1),new nc("RGB32F",12,3,Ia.FLOAT,!1,!1,!1,!1),new nc("RGB32UI",12,3,Ia.UINT,!1,!1,!1,!1),new nc("RGB32I",12,3,Ia.INT,!1,!1,!1,!1),new nc("RGBA8",4,4,Ia.UNORM,!0,!1,!1,!1),new nc("BGRA8",4,4,Ia.UNORM,!0,!1,!1,!1),new nc("SRGB8_A8",4,4,Ia.UNORM,!0,!1,!1,!1),new nc("RGBA8SN",4,4,Ia.SNORM,!0,!1,!1,!1),new nc("RGBA8UI",4,4,Ia.UINT,!0,!1,!1,!1),new nc("RGBA8I",4,4,Ia.INT,!0,!1,!1,!1),new nc("RGBA16F",8,4,Ia.FLOAT,!0,!1,!1,!1),new nc("RGBA16UI",8,4,Ia.UINT,!0,!1,!1,!1),new nc("RGBA16I",8,4,Ia.INT,!0,!1,!1,!1),new nc("RGBA32F",16,4,Ia.FLOAT,!0,!1,!1,!1),new nc("RGBA32UI",16,4,Ia.UINT,!0,!1,!1,!1),new nc("RGBA32I",16,4,Ia.INT,!0,!1,!1,!1),new nc("R5G6B5",2,3,Ia.UNORM,!1,!1,!1,!1),new nc("R11G11B10F",4,3,Ia.FLOAT,!1,!1,!1,!1),new nc("RGB5A1",2,4,Ia.UNORM,!0,!1,!1,!1),new nc("RGBA4",2,4,Ia.UNORM,!0,!1,!1,!1),new nc("RGB10A2",2,4,Ia.UNORM,!0,!1,!1,!1),new nc("RGB10A2UI",2,4,Ia.UINT,!0,!1,!1,!1),new nc("RGB9E5",2,4,Ia.FLOAT,!0,!1,!1,!1),new nc("D16",2,1,Ia.UINT,!1,!0,!1,!1),new nc("D16S8",3,2,Ia.UINT,!1,!0,!0,!1),new nc("D24",3,1,Ia.UINT,!1,!0,!1,!1),new nc("D24S8",4,2,Ia.UINT,!1,!0,!0,!1),new nc("D32F",4,1,Ia.FLOAT,!1,!0,!1,!1),new nc("D32FS8",5,2,Ia.FLOAT,!1,!0,!0,!1),new nc("BC1",1,3,Ia.UNORM,!1,!1,!1,!0),new nc("BC1_ALPHA",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("BC1_SRGB",1,3,Ia.UNORM,!1,!1,!1,!0),new nc("BC1_SRGB_ALPHA",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("BC2",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("BC2_SRGB",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("BC3",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("BC3_SRGB",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("BC4",1,1,Ia.UNORM,!1,!1,!1,!0),new nc("BC4_SNORM",1,1,Ia.SNORM,!1,!1,!1,!0),new nc("BC5",1,2,Ia.UNORM,!1,!1,!1,!0),new nc("BC5_SNORM",1,2,Ia.SNORM,!1,!1,!1,!0),new nc("BC6H_UF16",1,3,Ia.UFLOAT,!1,!1,!1,!0),new nc("BC6H_SF16",1,3,Ia.FLOAT,!1,!1,!1,!0),new nc("BC7",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("BC7_SRGB",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ETC_RGB8",1,3,Ia.UNORM,!1,!1,!1,!0),new nc("ETC2_RGB8",1,3,Ia.UNORM,!1,!1,!1,!0),new nc("ETC2_SRGB8",1,3,Ia.UNORM,!1,!1,!1,!0),new nc("ETC2_RGB8_A1",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ETC2_SRGB8_A1",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ETC2_RGBA8",2,4,Ia.UNORM,!0,!1,!1,!0),new nc("ETC2_SRGB8_A8",2,4,Ia.UNORM,!0,!1,!1,!0),new nc("EAC_R11",1,1,Ia.UNORM,!1,!1,!1,!0),new nc("EAC_R11SN",1,1,Ia.SNORM,!1,!1,!1,!0),new nc("EAC_RG11",2,2,Ia.UNORM,!1,!1,!1,!0),new nc("EAC_RG11SN",2,2,Ia.SNORM,!1,!1,!1,!0),new nc("PVRTC_RGB2",2,3,Ia.UNORM,!1,!1,!1,!0),new nc("PVRTC_RGBA2",2,4,Ia.UNORM,!0,!1,!1,!0),new nc("PVRTC_RGB4",2,3,Ia.UNORM,!1,!1,!1,!0),new nc("PVRTC_RGBA4",2,4,Ia.UNORM,!0,!1,!1,!0),new nc("PVRTC2_2BPP",2,4,Ia.UNORM,!0,!1,!1,!0),new nc("PVRTC2_4BPP",2,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_4x4",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_5x4",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_5x5",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_6x5",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_6x6",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_8x5",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_8x6",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_8x8",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_10x5",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_10x6",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_10x8",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_10x10",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_12x10",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_RGBA_12x12",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_4x4",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_5x4",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_5x5",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_6x5",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_6x6",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_8x5",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_8x6",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_8x8",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_10x5",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_10x6",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_10x8",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_10x10",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_12x10",1,4,Ia.UNORM,!0,!1,!1,!0),new nc("ASTC_SRGBA_12x12",1,4,Ia.UNORM,!0,!1,!1,!0)])),sc=e("aH",ts.UNIFORM_BUFFER|ts.DYNAMIC_UNIFORM_BUFFER|ts.STORAGE_BUFFER|ts.DYNAMIC_STORAGE_BUFFER),cc=e("aI",ts.SAMPLER_TEXTURE|ts.SAMPLER|ts.TEXTURE|ts.STORAGE_IMAGE|ts.INPUT_ATTACHMENT),lc=e("aJ",ts.DYNAMIC_STORAGE_BUFFER|ts.DYNAMIC_UNIFORM_BUFFER),uc=e("aK",28);function hc(e){return e>0&&0==(e&e-1)}function _c(e,t,n,i){if(!ac[e].isCompressed)return t*n*i*ac[e].size;switch(e){case Ca.BC1:case Ca.BC1_ALPHA:case Ca.BC1_SRGB:case Ca.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Ca.BC2:case Ca.BC2_SRGB:case Ca.BC3:case Ca.BC3_SRGB:case Ca.BC4:case Ca.BC4_SNORM:case Ca.BC6H_SF16:case Ca.BC6H_UF16:case Ca.BC7:case Ca.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Ca.BC5:case Ca.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case Ca.ETC_RGB8:case Ca.ETC2_RGB8:case Ca.ETC2_SRGB8:case Ca.ETC2_RGB8_A1:case Ca.EAC_R11:case Ca.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Ca.ETC2_RGBA8:case Ca.ETC2_SRGB8_A1:case Ca.EAC_RG11:case Ca.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Ca.PVRTC_RGB2:case Ca.PVRTC_RGBA2:case Ca.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case Ca.PVRTC_RGB4:case Ca.PVRTC_RGBA4:case Ca.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case Ca.ASTC_RGBA_4x4:case Ca.ASTC_SRGBA_4x4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Ca.ASTC_RGBA_5x4:case Ca.ASTC_SRGBA_5x4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case Ca.ASTC_RGBA_5x5:case Ca.ASTC_SRGBA_5x5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case Ca.ASTC_RGBA_6x5:case Ca.ASTC_SRGBA_6x5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case Ca.ASTC_RGBA_6x6:case Ca.ASTC_SRGBA_6x6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case Ca.ASTC_RGBA_8x5:case Ca.ASTC_SRGBA_8x5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case Ca.ASTC_RGBA_8x6:case Ca.ASTC_SRGBA_8x6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case Ca.ASTC_RGBA_8x8:case Ca.ASTC_SRGBA_8x8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case Ca.ASTC_RGBA_10x5:case Ca.ASTC_SRGBA_10x5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case Ca.ASTC_RGBA_10x6:case Ca.ASTC_SRGBA_10x6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case Ca.ASTC_RGBA_10x8:case Ca.ASTC_SRGBA_10x8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case Ca.ASTC_RGBA_10x10:case Ca.ASTC_SRGBA_10x10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case Ca.ASTC_RGBA_12x10:case Ca.ASTC_SRGBA_12x10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case Ca.ASTC_RGBA_12x12:case Ca.ASTC_SRGBA_12x12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function fc(e,t,n,i,o){for(var r=0,a=0;a<o;++a)r+=_c(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return r}var dc=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function pc(e){return dc[e]||0}function mc(e){var t=e.size/e.count;switch(e.type){case Ia.UNORM:case Ia.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Ia.SNORM:case Ia.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Ia.FLOAT:return Float32Array}return Float32Array}var vc=Object.freeze({__proto__:null,get ObjectType(){return Ea},get Status(){return Sa},get API(){return Ta},get SurfaceTransform(){return Aa},get Feature(){return wa},get Format(){return Ca},get FormatType(){return Ia},get Type(){return Pa},get BufferUsageBit(){return ba},get BufferFlagBit(){return Ra},get MemoryAccessBit(){return Na},get MemoryUsageBit(){return Oa},get TextureType(){return Da},get TextureUsageBit(){return Ma},get TextureFlagBit(){return La},get SampleCount(){return Fa},get Filter(){return za},get Address(){return Ba},get ComparisonFunc(){return Ua},get StencilOp(){return Ha},get BlendFactor(){return Ga},get BlendOp(){return Va},get ColorMask(){return ka},get ShaderStageFlagBit(){return Wa},get LoadOp(){return ja},get StoreOp(){return qa},get AccessType(){return Ya},get PipelineBindPoint(){return Xa},get PrimitiveMode(){return Ka},get PolygonMode(){return Qa},get ShadeModel(){return Za},get CullMode(){return Ja},get DynamicStateFlagBit(){return $a},get StencilFace(){return es},get DescriptorType(){return ts},get QueueType(){return ns},get CommandBufferType(){return is},get ClearFlagBit(){return os},Size:ls,DeviceCaps:us,Offset:hs,Rect:_s,Extent:fs,TextureSubresLayers:ds,TextureSubresRange:ps,TextureCopy:ms,TextureBlit:vs,BufferTextureCopy:gs,Viewport:ys,Color:xs,BindingMappingInfo:Es,BufferInfo:Ss,BufferViewInfo:Ts,DrawInfo:As,DispatchInfo:ws,IndirectBuffer:Cs,TextureInfo:Is,TextureViewInfo:Ps,SamplerInfo:bs,Uniform:Rs,UniformBlock:Ns,UniformSamplerTexture:Os,UniformSampler:Ds,UniformTexture:Ms,UniformStorageImage:Ls,UniformStorageBuffer:Fs,UniformInputAttachment:zs,ShaderStage:Bs,Attribute:Us,ShaderInfo:Hs,InputAssemblerInfo:Gs,ColorAttachment:Vs,DepthStencilAttachment:ks,SubpassInfo:Ws,RenderPassInfo:js,GlobalBarrierInfo:qs,TextureBarrierInfo:Ys,FramebufferInfo:Xs,DescriptorSetLayoutBinding:Ks,DescriptorSetLayoutInfo:Qs,DescriptorSetInfo:Zs,PipelineLayoutInfo:Js,InputState:$s,CommandBufferInfo:ec,QueueInfo:tc,FormatInfo:nc,MemoryStatus:ic,Obj:oc,DeviceInfo:rc,get AttributeName(){return cs},FormatInfos:ac,DESCRIPTOR_BUFFER_TYPE:sc,DESCRIPTOR_SAMPLER_TYPE:cc,DESCRIPTOR_DYNAMIC_TYPE:lc,DRAW_INFO_SIZE:uc,IsPowerOf2:hc,FormatSize:_c,FormatSurfaceSize:fc,GetTypeSize:pc,getTypedArrayConstructor:mc}),gc=e("B",function(e){function t(t){var n;return(n=e.call(this,Ea.BUFFER)||this)._device=void 0,n._usage=ba.NONE,n._memUsage=Oa.NONE,n._size=0,n._stride=1,n._count=0,n._flags=Ra.NONE,n._indirectBuffer=null,n._isBufferView=!1,n._device=t,n}return ee(t,e),J(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}(oc)),yc=e("a",function(e){function t(t){var n;return(n=e.call(this,Ea.COMMAND_BUFFER)||this)._device=void 0,n._queue=null,n._type=is.PRIMARY,n._numDrawCalls=0,n._numInstances=0,n._numTris=0,n._device=t,n}return ee(t,e),J(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(oc));rt(Ca);var xc=e("aQ",function(){function e(){this._canvas=null,this._canvas2D=null,this._gfxAPI=Ta.UNKNOWN,this._transform=Aa.IDENTITY,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(wa.COUNT),this._queue=null,this._cmdBuff=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._colorFmt=Ca.UNKNOWN,this._depthStencilFmt=Ca.UNKNOWN,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new ic,this._caps=new us}return e.prototype.hasFeature=function(e){return this._features[e]},J(e,[{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"surfaceTransform",get:function(){return this._transform}}]),e}()),Ec=e("aR",function(e){function t(t){var n;return(n=e.call(this,Ea.FRAMEBUFFER)||this)._device=void 0,n._renderPass=null,n._colorTextures=[],n._depthStencilTexture=null,n._device=t,n}return ee(t,e),J(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(oc)),Sc=String.prototype.charCodeAt;function Tc(e){return this[e]}function Ac(e,t){for(var n=e.length,i=t^n,o=0,r="string"==typeof e?Sc:Tc;n>=4;){var a=255&r.call(e,o)|(255&r.call(e,++o))<<8|(255&r.call(e,++o))<<16|(255&r.call(e,++o))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++o}switch(n){case 3:i^=(255&r.call(e,o+2))<<16;case 2:i^=(255&r.call(e,o+1))<<8;case 1:i=1540483477*(65535&(i^=255&r.call(e,o)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var wc=e("aS",function(e){function t(t){var n;return(n=e.call(this,Ea.INPUT_ASSEMBLER)||this)._device=void 0,n._attributes=[],n._vertexBuffers=[],n._indexBuffer=null,n._vertexCount=0,n._firstVertex=0,n._indexCount=0,n._firstIndex=0,n._vertexOffset=0,n._instanceCount=0,n._firstInstance=0,n._attributesHash=0,n._indirectBuffer=null,n._device=t,n}ee(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return Ac(e,666)},J(t,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),t}(oc)),Cc=e("D",function(e){function t(t){var n;return(n=e.call(this,Ea.DESCRIPTOR_SET)||this)._device=void 0,n._layout=null,n._buffers=[],n._textures=[],n._samplers=[],n._isDirty=!1,n._device=t,n}ee(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],o=this._layout.bindings[i];if(o)if(o.descriptorType&sc){var r=this._layout.descriptorIndices[e];this._buffers[r+n]!==t&&(this._buffers[r+n]=t,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.UNIFORM_BUFFER.")},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],o=this._layout.bindings[i];if(o)if(o.descriptorType&cc){var r=this._layout.descriptorIndices[e];this._samplers[r+n]!==t&&(this._samplers[r+n]=t,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.SAMPLER.")},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],o=this._layout.bindings[i];if(o)if(o.descriptorType&cc){var r=this._layout.descriptorIndices[e];this._textures[r+n]!==t&&(this._textures[r+n]=t,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.SAMPLER.")},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},J(t,[{key:"layout",get:function(){return this._layout}}]),t}(oc)),Ic=e("aT",function(e){function t(t){var n;return(n=e.call(this,Ea.DESCRIPTOR_SET_LAYOUT)||this)._device=void 0,n._bindings=[],n._bindingIndices=[],n._descriptorIndices=[],n._device=t,n}return ee(t,e),J(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(oc)),Pc=e("aU",function(e){function t(t){var n;return(n=e.call(this,Ea.PIPELINE_LAYOUT)||this)._device=void 0,n._setLayouts=[],n._device=t,n}return ee(t,e),J(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(oc)),bc=e("aV",function(){function e(e,t,n,i,o,r,a,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=Qa.FILL),void 0===n&&(n=Za.GOURAND),void 0===i&&(i=Ja.BACK),void 0===o&&(o=!0),void 0===r&&(r=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=o,this.depthBiasEnabled=r,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=Qa.FILL,this.shadeModel=Za.GOURAND,this.cullMode=Ja.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},J(e,[{key:"handle",get:function(){return To}}]),e}()),Rc=e("aW",function(){function e(e,t,n,i,o,r,a,s,c,l,u,h,_,f,d,p,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=Ua.LESS),void 0===i&&(i=!1),void 0===o&&(o=Ua.ALWAYS),void 0===r&&(r=65535),void 0===a&&(a=65535),void 0===s&&(s=Ha.KEEP),void 0===c&&(c=Ha.KEEP),void 0===l&&(l=Ha.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=Ua.ALWAYS),void 0===f&&(f=65535),void 0===d&&(d=65535),void 0===p&&(p=Ha.KEEP),void 0===m&&(m=Ha.KEEP),void 0===v&&(v=Ha.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=o,this.stencilReadMaskFront=r,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=d,this.stencilFailOpBack=p,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Ua.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Ua.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Ha.KEEP,this.stencilZFailOpFront=Ha.KEEP,this.stencilPassOpFront=Ha.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Ua.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Ha.KEEP,this.stencilZFailOpBack=Ha.KEEP,this.stencilPassOpBack=Ha.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},J(e,[{key:"handle",get:function(){return To}}]),e}()),Nc=e("aX",function(){function e(e,t,n,i,o,r,a,s){void 0===e&&(e=!1),void 0===t&&(t=Ga.ONE),void 0===n&&(n=Ga.ZERO),void 0===i&&(i=Va.ADD),void 0===o&&(o=Ga.ONE),void 0===r&&(r=Ga.ZERO),void 0===a&&(a=Va.ADD),void 0===s&&(s=ka.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=o,this.blendDstAlpha=r,this.blendAlphaEq=a,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=Ga.ONE,this.blendDst=Ga.ZERO,this.blendEq=Va.ADD,this.blendSrcAlpha=Ga.ONE,this.blendDstAlpha=Ga.ZERO,this.blendAlphaEq=Va.ADD,this.blendColorMask=ka.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},J(e,[{key:"handle",get:function(){return To}}]),e}()),Oc=e("aY",function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new xs),void 0===i&&(i=[new Nc]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new Nc),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},J(e,[{key:"handle",get:function(){return To}}]),e}()),Dc=e("aZ",(function(e,t,n,i,o,r,a,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new $s),void 0===o&&(o=new bc),void 0===r&&(r=new Rc),void 0===a&&(a=new Oc),void 0===s&&(s=Ka.TRIANGLE_LIST),void 0===c&&(c=$a.NONE),void 0===l&&(l=Xa.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=o,this.depthStencilState=r,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l})),Mc=e("a_",function(e){function t(t){var n;return(n=e.call(this,Ea.PIPELINE_STATE)||this)._device=void 0,n._shader=null,n._pipelineLayout=null,n._primitive=Ka.TRIANGLE_LIST,n._is=null,n._rs=new bc,n._dss=new Rc,n._bs=new Oc,n._dynamicStates=$a.NONE,n._renderPass=null,n._device=t,n}return ee(t,e),J(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(oc)),Lc=e("a$",function(e){function t(t){var n;return(n=e.call(this,Ea.QUEUE)||this)._device=void 0,n._type=ns.GRAPHICS,n._isAsync=!1,n._device=t,n}return ee(t,e),t.prototype.isAsync=function(){return this._isAsync},J(t,[{key:"type",get:function(){return this._type}}]),t}(oc)),Fc=e("b0",function(e){function t(t){var n;return(n=e.call(this,Ea.RENDER_PASS)||this)._device=void 0,n._colorInfos=[],n._depthStencilInfo=null,n._subpasses=[],n._hash=0,n._device=t,n}return ee(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var o=this._colorInfos[n.inputs[i]];e+=","+o.format+","+o.sampleCount}}if(n.colors.length){e+="ca";for(var r=0;r<n.inputs.length;++r){var a=this._colorInfos[n.inputs[r]];e+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return Ac(e,666)},J(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}(oc)),zc=e("b1",function(e){function t(t){var n;return(n=e.call(this,Ea.SAMPLER)||this)._device=void 0,n._minFilter=za.LINEAR,n._magFilter=za.LINEAR,n._mipFilter=za.NONE,n._addressU=Ba.WRAP,n._addressV=Ba.WRAP,n._addressW=Ba.WRAP,n._maxAnisotropy=16,n._cmpFunc=Ua.NEVER,n._borderColor=new xs,n._mipLODBias=0,n._device=t,n}return ee(t,e),J(t,[{key:"minFilter",get:function(){return this._minFilter}},{key:"magFilter",get:function(){return this._magFilter}},{key:"mipFilter",get:function(){return this._mipFilter}},{key:"addressU",get:function(){return this._addressU}},{key:"addressV",get:function(){return this._addressV}},{key:"addressW",get:function(){return this._addressW}},{key:"maxAnisotropy",get:function(){return this._maxAnisotropy}},{key:"cmpFunc",get:function(){return this._cmpFunc}},{key:"borderColor",get:function(){return this._borderColor}},{key:"mipLODBias",get:function(){return this._mipLODBias}}]),t}(oc)),Bc=e("b2",function(e){function t(n){var i;return(i=e.call(this,Ea.SHADER)||this)._device=void 0,i._id=void 0,i._name="",i._stages=[],i._attributes=[],i._blocks=[],i._samplers=[],i._device=n,i._id=t._shaderIdGen++,i}return ee(t,e),J(t,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(oc));Bc._shaderIdGen=0;var Uc=e("b3",function(e){function t(t){var n;return(n=e.call(this,Ea.TEXTURE)||this)._device=void 0,n._type=Da.TEX2D,n._usage=Ma.NONE,n._format=Ca.UNKNOWN,n._width=0,n._height=0,n._depth=1,n._layerCount=1,n._levelCount=1,n._samples=Fa.X1,n._flags=La.NONE,n._isPowerOf2=!1,n._size=0,n._device=t,n}return ee(t,e),J(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),t}(oc)),Hc=e("b4",function(e){function t(t){var n;return(n=e.call(this,Ea.GLOBAL_BARRIER)||this)._device=void 0,n._info=new qs,n._device=t,n}return ee(t,e),t.prototype.initialize=function(e){return this._info.copy(e),!0},t}(oc)),Gc=e("b5",function(e){function t(t){var n;return(n=e.call(this,Ea.TEXTURE_BARRIER)||this)._device=void 0,n._info=new Ys,n._device=t,n}return ee(t,e),t.prototype.initialize=function(e){return this._info.copy(e),!0},t}(oc)),Vc={Device:xc,Buffer:gc,Texture:Uc,Sampler:zc,Shader:Bc,InputAssembler:wc,RenderPass:Fc,Framebuffer:Ec,DescriptorSet:Cc,DescriptorSetLayout:Ic,PipelineLayout:Pc,PipelineState:Mc,CommandBuffer:yc,Queue:Lc,GlobalBarrier:Hc,TextureBarrier:Gc,RasterizerState:bc,BlendState:Oc,BlendTarget:Nc,DepthStencilState:Rc,PipelineStateInfo:Dc};Object.assign(Vc,vc),s.gfx=Vc;var kc,Wc={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var jc in s.gfx)if("__esModule"!==jc){var qc=Wc[jc];""===qc?qc=jc:void 0===qc&&(qc="GFX"+jc),k(s,"cc",[{name:qc,newName:jc,target:s.gfx,targetName:"cc.gfx"}])}!function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(kc||(kc={}));var Yc,Xc,Kc,Qc,Zc,Jc,$c,el,tl=(Yc=new An(0,0,0),function(e,t){var n=An.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;An.multiplyScalar(Yc,t.n,t.d);var i=An.dot(An.subtract(Yc,Yc,e.o),t.n)/n;return i<0?0:i}),nl=(Xc=new An(0,0,0),Kc=new An(0,0,0),Qc=new An(0,0,0),Zc=new An(0,0,0),Jc=new An(0,0,0),function(e,t,n){An.subtract(Xc,t.b,t.a),An.subtract(Kc,t.c,t.a),An.cross(Qc,e.d,Kc);var i=An.dot(Xc,Qc);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var o=1/i;An.subtract(Zc,e.o,t.a);var r=An.dot(Zc,Qc)*o;if(r<0||r>1)return 0;An.cross(Jc,Zc,Xc);var a=An.dot(e.d,Jc)*o;if(a<0||r+a>1)return 0;var s=An.dot(Kc,Jc)*o;return s<0?0:s}),il=function(){var e=new An(0,0,0);return function(t,n){var i=n.radius,o=n.center,r=t.o,a=t.d,s=i*i;An.subtract(e,o,r);var c=e.lengthSqr(),l=An.dot(e,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),ol=($c=new An,el=new An,function(e,t){return An.subtract($c,t.center,t.halfExtents),An.add(el,t.center,t.halfExtents),rl(e,$c,el)});function rl(e,t,n){var i=e.o,o=e.d,r=1/o.x,a=1/o.y,s=1/o.z,c=(t.x-i.x)*r,l=(n.x-i.x)*r,u=(t.y-i.y)*a,h=(n.y-i.y)*a,_=(t.z-i.z)*s,f=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),p=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return p<0||d>p?0:d>0?d:p}var al,sl,cl,ll,ul=function(){var e=new An,t=new An,n=new An,i=new An,o=new An,r=new An,a=new An,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,e=_.center,t=h.o,n=h.d,An.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),An.set(o,_.orientation.m03,_.orientation.m04,_.orientation.m05),An.set(r,_.orientation.m06,_.orientation.m07,_.orientation.m08),An.subtract(a,e,t),c[0]=An.dot(i,n),c[1]=An.dot(o,n),c[2]=An.dot(r,n),l[0]=An.dot(i,a),l[1]=An.dot(o,a),l[2]=An.dot(r,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var d=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),p=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return p<0||d>p?0:d>0?d:p}}(),hl=function(){var e=new An,t=new An,n=new An,i=new An,o=new An,r=new An,a=new An,s=new rs;return function(c,l){var u=l.radius*l.radius,h=An.normalize(e,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,d=An.subtract(t,f,_);if(d.equals(An.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),Kl.raySphere(c,s);var p=c.o,m=An.subtract(n,p,_),v=An.cross(i,h,d),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=An.subtract(o,f,p);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),Kl.raySphere(c,s)}var x=An.cross(o,m,d),E=d.lengthSqr(),S=2*An.dot(v,x),T=S*S-4*g*(x.lengthSqr()-u*E);if(T<0)return 0;var A=(-S-Math.sqrt(T))/(2*g);if(A<0){s.radius=l.radius;var w=An.subtract(r,f,p);return m.lengthSqr()<w.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),Kl.raySphere(c,s)}var C=An.scaleAndAdd(r,c.o,h,A),I=An.subtract(a,C,_),P=An.dot(I,d)/E;return P>=0&&P<=1?A:P<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),Kl.raySphere(c,s)):P>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),Kl.raySphere(c,s)):0}}(),_l=(al=as.create(),sl={distance:1/0,doubleSided:!1,mode:kc.ANY},cl=0,ll=function(e,t,n,i,o,r){e===kc.CLOSEST?(cl>t||0===cl)&&(cl=t,r&&(0===r.length?r.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:o/3}):(r[0].distance=t,r[0].vertexIndex0=n/3,r[0].vertexIndex1=i/3,r[0].vertexIndex2=o/3))):(cl=t,r&&r.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:o/3}))},function(e,t,n){if(cl=0,0===t.geometricInfo.positions.length)return cl;var i=void 0===n?sl:n;if(rl(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var o=t.primitiveMode,r=t.geometricInfo;!function(e,t,n,i,o){if(n===Ka.TRIANGLE_LIST)for(var r=t.length,a=0;a<r;a+=3){var s=3*t[a],c=3*t[a+1],l=3*t[a+2];An.set(al.a,e[s],e[s+1],e[s+2]),An.set(al.b,e[c],e[c+1],e[c+2]),An.set(al.c,e[l],e[l+1],e[l+2]);var u=Kl.rayTriangle(i,al,o.doubleSided);if(!(0===u||u>o.distance)&&(ll(o.mode,u,s,c,l,o.result),o.mode===kc.ANY))return u}else if(n===Ka.TRIANGLE_STRIP)for(var h=t.length-2,_=0,f=0;f<h;f+=1){var d=3*t[f-_],p=3*t[f+_+1],m=3*t[f+2];An.set(al.a,e[d],e[d+1],e[d+2]),An.set(al.b,e[p],e[p+1],e[p+2]),An.set(al.c,e[m],e[m+1],e[m+2]),_=~_;var v=Kl.rayTriangle(i,al,o.doubleSided);if(!(0===v||v>o.distance)&&(ll(o.mode,v,d,p,m,o.result),o.mode===kc.ANY))return v}else if(n===Ka.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];An.set(al.a,e[y],e[y+1],e[y+2]);for(var x=1;x<g;x+=1){var E=3*t[x],S=3*t[x+1];An.set(al.b,e[E],e[E+1],e[E+2]),An.set(al.c,e[S],e[S+1],e[S+2]);var T=Kl.rayTriangle(i,al,o.doubleSided);if(!(0===T||T>o.distance)&&(ll(o.mode,T,y,E,S,o.result),o.mode===kc.ANY))return T}}}(r.positions,r.indices,o,e,i)}return cl}),fl=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:kc.ANY};return function(n,i,o){e=0;var r=void 0===o?t:o,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!rl(n,s,c))return e;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=_l(n,u,r);if(h)if(r.mode===kc.CLOSEST)(0===e||e>h)&&(e=h,r.subIndices&&(r.subIndices[0]=l));else if(e=h,r.subIndices&&r.subIndices.push(l),r.mode===kc.ANY)return h}return e&&r.mode===kc.CLOSEST&&(r.result&&(r.result[0].distance=e,r.result.length=1),r.subIndices&&(r.subIndices.length=1)),e}}(),dl=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:kc.ANY},n=new pa,i=new Un;return function(o,r,a){e=0;var s=void 0===a?t:a,c=r.worldBounds;if(c&&!ol(o,c))return e;pa.copy(n,o),r.node&&(Un.invert(i,r.node.getWorldMatrix(i)),An.transformMat4(n.o,o.o,i),An.transformMat4Normal(n.d,o.d,i));for(var l=r.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=_l(n,h,s);if(_)if(s.mode===kc.CLOSEST)(0===e||e>_)&&(e=_,s.subIndices&&(s.subIndices[0]=u));else if(e=_,s.subIndices&&s.subIndices.push(u),s.mode===kc.ANY)return _}return e&&s.mode===kc.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),pl=function(){var e=new An(0,0,0);return function(t,n){An.subtract(e,t.e,t.s);var i=(n.d-An.dot(t.s,n.n))/An.dot(e,n.n);return i<0||i>1?0:i}}(),ml=function(){var e=new An(0,0,0),t=new An(0,0,0),n=new An(0,0,0),i=new An(0,0,0),o=new An(0,0,0),r=new An(0,0,0);return function(a,s,c){An.subtract(e,s.b,s.a),An.subtract(t,s.c,s.a),An.subtract(n,a.s,a.e),An.cross(o,e,t);var l=An.dot(n,o);if(l<=0)return 0;An.subtract(i,a.s,s.a);var u=An.dot(i,o);if(u<0||u>l)return 0;An.cross(r,n,i);var h=An.dot(t,r);if(h<0||h>l)return 0;var _=-An.dot(e,r);if(_<0||h+_>l)return 0;if(c){var f=1/l,d=1-(h*=f)-(_*=f);An.set(c,s.a.x*d+s.b.x*h+s.c.x*_,s.a.y*d+s.b.y*h+s.c.y*_,s.a.z*d+s.b.z*h+s.c.z*_)}return 1}}(),vl=new pa;function gl(e,t){vl.o.set(e.s),An.subtract(vl.d,e.e,e.s),vl.d.normalize();var n=ol(vl,t);return n<=e.length()?n:0}function yl(e,t){vl.o.set(e.s),An.subtract(vl.d,e.e,e.s),vl.d.normalize();var n=ul(vl,t);return n<=e.length()?n:0}function xl(e,t){vl.o.set(e.s),An.subtract(vl.d,e.e,e.s),vl.d.normalize();var n=il(vl,t);return n<=e.length()?n:0}var El,Sl,Tl,Al,wl=(El=new An,Sl=new An,Tl=new An,Al=new An,function(e,t){return An.subtract(El,e.center,e.halfExtents),An.add(Sl,e.center,e.halfExtents),An.subtract(Tl,t.center,t.halfExtents),An.add(Al,t.center,t.halfExtents),El.x<=Al.x&&Sl.x>=Tl.x&&El.y<=Al.y&&Sl.y>=Tl.y&&El.z<=Al.z&&Sl.z>=Tl.z});function Cl(e,t,n,i,o,r){An.set(r[0],e.x+n.x*t.x+i.x*t.y+o.x*t.z,e.y+n.y*t.x+i.y*t.y+o.y*t.z,e.z+n.z*t.x+i.z*t.y+o.z*t.z),An.set(r[1],e.x-n.x*t.x+i.x*t.y+o.x*t.z,e.y-n.y*t.x+i.y*t.y+o.y*t.z,e.z-n.z*t.x+i.z*t.y+o.z*t.z),An.set(r[2],e.x+n.x*t.x-i.x*t.y+o.x*t.z,e.y+n.y*t.x-i.y*t.y+o.y*t.z,e.z+n.z*t.x-i.z*t.y+o.z*t.z),An.set(r[3],e.x+n.x*t.x+i.x*t.y-o.x*t.z,e.y+n.y*t.x+i.y*t.y-o.y*t.z,e.z+n.z*t.x+i.z*t.y-o.z*t.z),An.set(r[4],e.x-n.x*t.x-i.x*t.y-o.x*t.z,e.y-n.y*t.x-i.y*t.y-o.y*t.z,e.z-n.z*t.x-i.z*t.y-o.z*t.z),An.set(r[5],e.x+n.x*t.x-i.x*t.y-o.x*t.z,e.y+n.y*t.x-i.y*t.y-o.y*t.z,e.z+n.z*t.x-i.z*t.y-o.z*t.z),An.set(r[6],e.x-n.x*t.x+i.x*t.y-o.x*t.z,e.y-n.y*t.x+i.y*t.y-o.y*t.z,e.z-n.z*t.x+i.z*t.y-o.z*t.z),An.set(r[7],e.x-n.x*t.x-i.x*t.y+o.x*t.z,e.y-n.y*t.x-i.y*t.y+o.y*t.z,e.z-n.z*t.x-i.z*t.y+o.z*t.z)}function Il(e,t){for(var n=An.dot(t,e[0]),i=n,o=1;o<8;++o){var r=An.dot(t,e[o]);n=r<n?r:n,i=r>i?r:i}return[n,i]}var Pl,bl,Rl,Nl=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new An(0,0,0);for(var n=new Array(8),i=new Array(8),o=0;o<8;o++)n[o]=new An(0,0,0),i[o]=new An(0,0,0);var r=new An,a=new An;return function(t,o){An.set(e[0],1,0,0),An.set(e[1],0,1,0),An.set(e[2],0,0,1),An.set(e[3],o.orientation.m00,o.orientation.m01,o.orientation.m02),An.set(e[4],o.orientation.m03,o.orientation.m04,o.orientation.m05),An.set(e[5],o.orientation.m06,o.orientation.m07,o.orientation.m08);for(var s=0;s<3;++s)An.cross(e[6+3*s],e[s],e[0]),An.cross(e[7+3*s],e[s],e[1]),An.cross(e[7+3*s],e[s],e[2]);An.subtract(r,t.center,t.halfExtents),An.add(a,t.center,t.halfExtents),function(e,t,n){An.set(n[0],e.x,t.y,t.z),An.set(n[1],e.x,t.y,e.z),An.set(n[2],e.x,e.y,t.z),An.set(n[3],e.x,e.y,e.z),An.set(n[4],t.x,t.y,t.z),An.set(n[5],t.x,t.y,e.z),An.set(n[6],t.x,e.y,t.z),An.set(n[7],t.x,e.y,e.z)}(r,a,n),Cl(o.center,o.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=Il(n,e[c]),u=Il(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Ol=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=An.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},Dl=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Ol(e,t.planes[n]))return 0;return 1},Ml=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new An(0,0,0);return function(i,o){for(var r=0,a=!1,s=0;s<o.planes.length;s++){if(-1===(r=Ol(i,o.planes[s])))return 0;1===r&&(a=!0)}if(!a)return 1;for(var c=0;c<o.vertices.length;c++)An.subtract(e[c],o.vertices[c],i.center);t=0,n=0;for(var l=0;l<o.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===o.vertices.length||n===o.vertices.length)return 0;t=0,n=0;for(var u=0;u<o.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===o.vertices.length||n===o.vertices.length)return 0;t=0,n=0;for(var h=0;h<o.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===o.vertices.length||n===o.vertices.length?0:1}}(),Ll=(Pl=new An(0,0,0),bl=new Pn,function(e,t){return An.subtract(Pl,t,e.center),An.transformMat3(Pl,Pl,Pn.transpose(bl,e.orientation)),n=Pl,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),Fl=(Rl=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*Rl(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Rl(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Rl(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=An.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),zl=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Fl(e,t.planes[n]))return 0;return 1},Bl=function(){for(var e=new Array(8),t=0,n=0,i=0,o=0;o<e.length;o++)e[o]=new An(0,0,0);var r=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(o,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=Fl(o,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)An.subtract(e[u],a.vertices[u],o.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=r(e[h],o.orientation.m00,o.orientation.m01,o.orientation.m02))>o.halfExtents.x?n++:t<-o.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(t=r(e[_],o.orientation.m03,o.orientation.m04,o.orientation.m05))>o.halfExtents.y?n++:t<-o.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=r(e[f],o.orientation.m06,o.orientation.m07,o.orientation.m08))>o.halfExtents.z?n++:t<-o.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),Ul=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new An(0,0,0);for(var n=new Array(8),i=new Array(8),o=0;o<8;o++)n[o]=new An(0,0,0),i[o]=new An(0,0,0);return function(t,o){An.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),An.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),An.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),An.set(e[3],o.orientation.m00,o.orientation.m01,o.orientation.m02),An.set(e[4],o.orientation.m03,o.orientation.m04,o.orientation.m05),An.set(e[5],o.orientation.m06,o.orientation.m07,o.orientation.m08);for(var r=0;r<3;++r)An.cross(e[6+3*r],e[r],e[0]),An.cross(e[7+3*r],e[r],e[1]),An.cross(e[7+3*r],e[r],e[2]);Cl(t.center,t.halfExtents,e[0],e[1],e[2],n),Cl(o.center,o.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var s=Il(n,e[a]),c=Il(i,e[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),Hl=function(){for(var e=new rs,t=new An,n=new An,i=new An,o=new Array(8),r=0;r<8;r++)o[r]=new An;for(var a=new Array(8),s=0;s<8;s++)a[s]=new An;return function(r,s){if(0===An.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),Kl.sphereOBB(e,r);t.x=r.orientation.m00,t.y=r.orientation.m01,t.z=r.orientation.m02,n.x=r.orientation.m03,n.y=r.orientation.m04,n.z=r.orientation.m05,i.x=r.orientation.m06,i.y=r.orientation.m07,i.z=r.orientation.m08,Cl(r.center,r.halfExtents,t,n,i,o);var c=a,l=An.copy(c[0],t),u=An.copy(c[1],n),h=An.copy(c[2],i);An.subtract(c[3],s.center,r.center).normalize();var _=An.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),An.cross(c[5],l,_),An.cross(c[6],u,_),An.cross(c[7],h,_);for(var f=0;f<8;++f){var d=Il(o,c[f]),p=An.dot(c[f],s.ellipseCenter0),m=An.dot(c[f],s.ellipseCenter1),v=Math.max(p,m),g=Math.min(p,m)-s.radius,y=v+s.radius;if(g>d[1]||d[0]>y)return 0}return 1}}(),Gl=function(e,t){var n=An.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},Vl=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Gl(e,t.planes[n]))return 0;return 1},kl=function(){var e=new An(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var o=0;o<6;o++){var r=i.planes[o],a=n.radius,s=n.center,c=r.n,l=r.d,u=An.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){An.add(e,s,An.multiplyScalar(e,c,a));for(var h=0;h<6;h++)if(h!==o&&h!==o+t[o]){var _=i.planes[h];if(An.dot(_.n,e)<_.d)return 0}}}return 1}}(),Wl=function(e,t){var n=e.radius+t.radius;return An.squaredDistance(e.center,t.center)<n*n},jl=function(){var e=new An;return function(t,n){return ua(e,t.center,n),An.squaredDistance(t.center,e)<t.radius*t.radius}}(),ql=function(){var e=new An;return function(t,n){return ha(e,t.center,n),An.squaredDistance(t.center,e)<t.radius*t.radius}}(),Yl=function(){var e=new An,t=new An;return function(n,i){var o=n.radius+i.radius,r=o*o,a=An.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return An.squaredDistance(n.center,i.center)<r;An.subtract(e,n.center,i.ellipseCenter0),An.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=An.dot(e,t)/a;return s<0?An.squaredDistance(n.center,i.ellipseCenter0)<r:s>1?An.squaredDistance(n.center,i.ellipseCenter1)<r:(An.scaleAndAdd(e,i.ellipseCenter0,t,s),An.squaredDistance(n.center,e)<r)}}(),Xl=function(){var e=new An,t=new An,n=new An,i=new An,o=new An,r=new An;return function(a,s){var c,l,u,h,_=An.subtract(e,a.ellipseCenter1,a.ellipseCenter0),f=An.subtract(t,s.ellipseCenter1,s.ellipseCenter0),d=An.subtract(n,a.ellipseCenter0,s.ellipseCenter0),p=An.dot(_,_),m=An.dot(_,f),v=An.dot(f,f),g=An.dot(_,d),y=An.dot(f,d),x=p*v-m*m,E=x,S=x;x<en?(l=0,E=1,h=y,S=v):(h=p*y-m*g,(l=m*y-v*g)<0?(l=0,h=y,S=v):l>E&&(l=E,h=y+m,S=v)),h<0?(h=0,-g<0?l=0:-g>p?l=E:(l=-g,E=p)):h>S&&(h=S,-g+m<0?l=0:-g+m>p?l=E:(l=-g+m,E=p)),c=Math.abs(l)<en?0:l/E,u=Math.abs(h)<en?0:h/S;var T=i;T.set(d),T.add(An.multiplyScalar(o,_,c)),T.subtract(An.multiplyScalar(r,f,u));var A=a.radius+s.radius;return T.lengthSqr()<A*A}}(),Kl={raySphere:il,rayAABB:ol,rayOBB:ul,rayPlane:tl,rayTriangle:nl,rayCapsule:hl,raySubMesh:_l,rayMesh:fl,rayModel:dl,lineSphere:xl,lineAABB:gl,lineOBB:yl,linePlane:pl,lineTriangle:ml,sphereWithSphere:Wl,sphereAABB:jl,sphereOBB:ql,spherePlane:Gl,sphereFrustum:Vl,sphereFrustumAccurate:kl,sphereCapsule:Yl,aabbWithAABB:wl,aabbWithOBB:Nl,aabbPlane:Ol,aabbFrustum:Dl,aabbFrustumAccurate:Ml,obbWithOBB:Ul,obbPlane:Fl,obbFrustum:zl,obbFrustumAccurate:Bl,obbPoint:Ll,obbCapsule:Hl,capsuleWithCapsule:Xl,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,o=t._type,r=this[i|o];return i<o?r(e,t,n):r(t,e,n)}};Kl[fa.SHAPE_RAY|fa.SHAPE_SPHERE]=il,Kl[fa.SHAPE_RAY|fa.SHAPE_AABB]=ol,Kl[fa.SHAPE_RAY|fa.SHAPE_OBB]=ul,Kl[fa.SHAPE_RAY|fa.SHAPE_PLANE]=tl,Kl[fa.SHAPE_RAY|fa.SHAPE_TRIANGLE]=nl,Kl[fa.SHAPE_RAY|fa.SHAPE_CAPSULE]=hl,Kl[fa.SHAPE_LINE|fa.SHAPE_SPHERE]=xl,Kl[fa.SHAPE_LINE|fa.SHAPE_AABB]=gl,Kl[fa.SHAPE_LINE|fa.SHAPE_OBB]=yl,Kl[fa.SHAPE_LINE|fa.SHAPE_PLANE]=pl,Kl[fa.SHAPE_LINE|fa.SHAPE_TRIANGLE]=ml,Kl[fa.SHAPE_SPHERE]=Wl,Kl[fa.SHAPE_SPHERE|fa.SHAPE_AABB]=jl,Kl[fa.SHAPE_SPHERE|fa.SHAPE_OBB]=ql,Kl[fa.SHAPE_SPHERE|fa.SHAPE_PLANE]=Gl,Kl[fa.SHAPE_SPHERE|fa.SHAPE_FRUSTUM]=Vl,Kl[fa.SHAPE_SPHERE|fa.SHAPE_FRUSTUM_ACCURATE]=kl,Kl[fa.SHAPE_SPHERE|fa.SHAPE_CAPSULE]=Yl,Kl[fa.SHAPE_AABB]=wl,Kl[fa.SHAPE_AABB|fa.SHAPE_OBB]=Nl,Kl[fa.SHAPE_AABB|fa.SHAPE_PLANE]=Ol,Kl[fa.SHAPE_AABB|fa.SHAPE_FRUSTUM]=Dl,Kl[fa.SHAPE_AABB|fa.SHAPE_FRUSTUM_ACCURATE]=Ml,Kl[fa.SHAPE_OBB]=Ul,Kl[fa.SHAPE_OBB|fa.SHAPE_PLANE]=Fl,Kl[fa.SHAPE_OBB|fa.SHAPE_FRUSTUM]=zl,Kl[fa.SHAPE_OBB|fa.SHAPE_FRUSTUM_ACCURATE]=Bl,Kl[fa.SHAPE_OBB|fa.SHAPE_CAPSULE]=Hl,Kl[fa.SHAPE_CAPSULE]=Xl,k(da.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),W(Kl,"intersect",[{name:"line_quad"}]);var Ql=new An(0,0,0),Zl=new An(0,0,0),Jl=s.mat4(),$l=s.v4(),eu=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=fa.SHAPE_PLANE,this.n=new An(e,t,n),this.d=i}return e.create=function(t,n,i,o){return new e(t,n,i,o)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return An.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return An.subtract(Ql,n,t),An.subtract(Zl,i,t),An.normalize(e.n,An.cross(e.n,Ql,Zl)),e.d=An.dot(e.n,t),e},e.set=function(e,t,n,i,o){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=o,e},e.fromNormalAndPoint=function(e,t,n){return An.copy(e.n,t),e.d=An.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return An.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){Un.invert(Jl,e),Un.transpose(Jl,Jl),Yn.set($l,this.n.x,this.n.y,this.n.z,this.d),Yn.transformMat4($l,$l,Jl),An.set(this.n,$l.x,$l.y,$l.z),this.d=$l.w},J(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),tu=new An,nu=new An,iu=new An,ou=new An,ru=new Pn,au=function(e,t,n){ru.m00=Math.abs(n.m00),ru.m01=Math.abs(n.m01),ru.m02=Math.abs(n.m02),ru.m03=Math.abs(n.m04),ru.m04=Math.abs(n.m05),ru.m05=Math.abs(n.m06),ru.m06=Math.abs(n.m08),ru.m07=Math.abs(n.m09),ru.m08=Math.abs(n.m10),An.transformMat3(e,t,ru)},su=e("bL",function(){function e(e,t,n,i,o,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===o&&(o=1),void 0===r&&(r=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=fa.SHAPE_AABB,this.center=new An(e,t,n),this.halfExtents=new An(i,o,r)}e.create=function(t,n,i,o,r,a){return new e(t,n,i,o,r,a)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return An.copy(e.center,t.center),An.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return An.add(tu,n,t),An.subtract(nu,n,t),An.multiplyScalar(e.center,tu,.5),An.multiplyScalar(e.halfExtents,nu,.5),e},e.set=function(e,t,n,i,o,r,a){return An.set(e.center,t,n,i),An.set(e.halfExtents,o,r,a),e},e.merge=function(t,n,i){return An.subtract(tu,n.center,n.halfExtents),An.subtract(nu,i.center,i.halfExtents),An.add(iu,n.center,n.halfExtents),An.add(ou,i.center,i.halfExtents),An.max(ou,iu,ou),An.min(iu,tu,nu),e.fromPoints(t,iu,ou)},e.toBoundingSphere=function(e,t){t.getBoundary(tu,nu),e.center.set(tu),e.radius=0,An.subtract(iu,nu,e.center);var n=iu.length(),i=.5*n;return e.radius+=i,An.multiplyScalar(iu,iu,i/n),An.add(e.center,e.center,iu),e},e.transform=function(e,t,n){return An.transformMat4(e.center,t.center,n),au(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){An.subtract(e,this.center,this.halfExtents),An.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,o){An.transformMat4(o.center,this.center,e),au(o.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},J(e,[{key:"type",get:function(){return this._type}}]),e}()),cu=new An,lu=new An,uu=new Pn,hu=function(){function e(e,t,n,i,o,r,a,s,c,l,u,h,_,f,d){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===o&&(o=1),void 0===r&&(r=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=fa.SHAPE_OBB,this.center=new An(e,t,n),this.halfExtents=new An(i,o,r),this.orientation=new Pn(a,s,c,l,u,h,_,f,d)}e.create=function(t,n,i,o,r,a,s,c,l,u,h,_,f,d,p){return new e(t,n,i,o,r,a,s,c,l,u,h,_,f,d,p)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return An.copy(e.center,t.center),An.copy(e.halfExtents,t.halfExtents),Pn.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return An.multiplyScalar(e.center,An.add(cu,t,n),.5),An.multiplyScalar(e.halfExtents,An.subtract(lu,n,t),.5),Pn.identity(e.orientation),e},e.set=function(e,t,n,i,o,r,a,s,c,l,u,h,_,f,d,p){return An.set(e.center,t,n,i),An.set(e.halfExtents,o,r,a),Pn.set(e.orientation,s,c,l,u,h,_,f,d,p),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){uu.m00=Math.abs(n.m00),uu.m01=Math.abs(n.m01),uu.m02=Math.abs(n.m02),uu.m03=Math.abs(n.m03),uu.m04=Math.abs(n.m04),uu.m05=Math.abs(n.m05),uu.m06=Math.abs(n.m06),uu.m07=Math.abs(n.m07),uu.m08=Math.abs(n.m08),An.transformMat3(e,t,uu)}(cu,this.halfExtents,this.orientation),An.subtract(e,this.center,cu),An.add(t,this.center,cu)},t.transform=function(e,t,n,i,o){An.transformMat4(o.center,this.center,e),Pn.fromQuat(o.orientation,n),An.multiply(o.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){An.transformMat4(n.center,this.center,e),Pn.fromQuat(n.orientation,t)},t.setScale=function(e,t){An.multiply(t.halfExtents,this.halfExtents,e)},J(e,[{key:"type",get:function(){return this._type}}]),e}(),_u=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=fa.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new An,this.rotation=new Nn,this.ellipseCenter0=new An(0,t,0),this.ellipseCenter1=new An(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,o){var r=i,a=yn(r);o.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(r.y)-o.radius;s<0&&(s=0),o.halfHeight=s,An.transformMat4(o.center,this.center,e),Nn.multiply(o.rotation,this.rotation,n),o.updateCache()},t.updateCache=function(){this.updateLocalCenter(),An.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),An.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},J(e,[{key:"type",get:function(){return this._type}}]),e}(),fu=new Array(8);fu[0]=new An(1,1,1),fu[1]=new An(-1,1,1),fu[2]=new An(-1,-1,1),fu[3]=new An(1,-1,1),fu[4]=new An(1,1,-1),fu[5]=new An(-1,1,-1),fu[6]=new An(-1,-1,-1),fu[7]=new An(1,-1,-1);var du,pu,mu,vu=function(){function e(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=fa.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=eu.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new An}e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)eu.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)An.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(An.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),An.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),An.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),An.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),An.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),An.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===fa.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],o=1/i.n.length();An.multiplyScalar(i.n,i.n,o),i.d*=o}for(var r=0;r<8;r++)An.transformMat4(this.vertices[r],fu[r],t)}},t.transform=function(e){if(this._type===fa.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)An.transformMat4(this.vertices[t],this.vertices[t],e);eu.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),eu.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),eu.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),eu.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),eu.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),eu.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}},J(e,[{key:"accurate",set:function(e){this._type=e?fa.SHAPE_FRUSTUM_ACCURATE:fa.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();function gu(e,t){if(t&&e!==To){for(var n=t.vertices,i=hr.VERTICES,o=0;o<8;++o)mr.setVec3(e,i,n[o]),i+=3;for(var r=t.planes,a=hr.PLANES,s=0;s<6;s++,a+=4)mr.setVec4(e,a,r[s])}}vu.createOrtho=(du=new An,function(e,t,n,i,o,r){var a=t/2,s=n/2;An.set(du,a,s,i),An.transformMat4(e.vertices[0],du,r),An.set(du,-a,s,i),An.transformMat4(e.vertices[1],du,r),An.set(du,-a,-s,i),An.transformMat4(e.vertices[2],du,r),An.set(du,a,-s,i),An.transformMat4(e.vertices[3],du,r),An.set(du,a,s,o),An.transformMat4(e.vertices[4],du,r),An.set(du,-a,s,o),An.transformMat4(e.vertices[5],du,r),An.set(du,-a,-s,o),An.transformMat4(e.vertices[6],du,r),An.set(du,a,-s,o),An.transformMat4(e.vertices[7],du,r),eu.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),eu.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),eu.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),eu.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),eu.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),eu.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])}),function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(pu||(pu={})),function(e){e[e.Default=pu.Default]="Default",e[e.Normal=pu.Normal]="Normal",e[e.Reverse=pu.Reverse]="Reverse",e[e.Loop=pu.Loop]="Loop",e[e.LoopReverse=pu.Loop|pu.Reverse]="LoopReverse",e[e.PingPong=pu.PingPong]="PingPong",e[e.PingPongReverse=pu.PingPong|pu.Reverse]="PingPongReverse"}(mu||(mu={})),rt(mu);var yu=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}(),xu=nt({Default:pu.Default,Normal:pu.Normal,Clamp:pu.Clamp,Loop:pu.Loop,PingPong:pu.PingPong}),Eu=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Kt.fastDefine("cc.Keyframe",Eu,{time:0,value:0,inTangent:0,outTangent:0});var Su=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),Tu=function(){function e(t){void 0===t&&(t=null),this.keyFrames=void 0,this.preWrapMode=xu.Loop,this.postWrapMode=xu.Clamp,this.cachedKey=void 0,this.keyFrames=t||[].concat(e.defaultKF),this.cachedKey=new Su}var t=e.prototype;return t.addKey=function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)},t.evaluate_slow=function(e){var t=e,n=e<0?this.preWrapMode:this.postWrapMode,i=this.keyFrames[0].time,o=this.keyFrames[this.keyFrames.length-1].time;switch(n){case xu.Loop:t=mn(e-i,o-i)+i;break;case xu.PingPong:t=vn(e-i,o-i)+i;break;case xu.Default:case xu.Normal:case xu.Clamp:default:t=on(e,i,o)}var r=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)r=this.keyFrames.length-2;else for(var a=0;a<this.keyFrames.length-1;a++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[a+1].time){r=a;break}var s=this.keyFrames[r],c=this.keyFrames[r+1],l=gn(s.time,c.time,t),u=c.time-s.time,h=s.outTangent*u,_=c.inTangent*u,f=l*l,d=f*l,p=d-2*f+l,m=d-f,v=-2*d+3*f;return(2*d-3*f+1)*s.value+p*h+m*_+v*c.value},t.evaluate=function(e){var t=e,n=e<0?this.preWrapMode:this.postWrapMode,i=this.keyFrames[0].time,o=this.keyFrames[this.keyFrames.length-1].time;switch(n){case xu.Loop:t=mn(e-i,o-i)+i;break;case xu.PingPong:t=vn(e-i,o-i)+i;break;case xu.Default:case xu.Normal:case xu.Clamp:default:t=on(e,i,o)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var r=this.findIndex(this.cachedKey,t),a=Math.min(r+1,this.keyFrames.length-1);return this.calcOptimizedKey(this.cachedKey,r,a),this.cachedKey.evaluate(t)},t.calcOptimizedKey=function(e,t,n){var i=this.keyFrames[t],o=this.keyFrames[n];e.index=t,e.time=i.time,e.endTime=o.time;var r=o.time-i.time,a=o.value-i.value,s=1/(r*r),c=i.outTangent*r,l=o.inTangent*r;e.coefficient[0]=(c+l-a-a)*s/r,e.coefficient[1]=(a+a+a-c-c-l)*s,e.coefficient[2]=i.outTangent,e.coefficient[3]=i.value},t.findIndex=function(e,t){var n=e.index;if(-1!==n)if(t>this.keyFrames[n].time)for(var i=0;i<3;i++){var o=n+i;if(o+1<this.keyFrames.length&&this.keyFrames[o+1].time>t)return o}else for(var r=0;r<3;r++){var a=n-r;if(a>=0&&this.keyFrames[a-1].time<=t)return a-1}for(var s,c=0,l=this.keyFrames.length;l-c>1;)s=Math.floor((c+l)/2),this.keyFrames[s].time>=t?l=s:c=s;return c},e}();function Au(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}Tu.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Kt.fastDefine("cc.AnimationCurve",Tu,{preWrapMode:xu.Default,postWrapMode:xu.Default,keyFrames:[]}),k(Kl,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var wu=function(e){function t(){var t;return t=e.call(this)||this,Au("line","Line"),t}return ee(t,e),t}(da),Cu=function(e){function t(){var t;return t=e.call(this)||this,Au("plane","Plane"),t}return ee(t,e),t}(eu),Iu=function(e){function t(){var t;return t=e.call(this)||this,Au("ray","Ray"),t}return ee(t,e),t}(pa),Pu=function(e){function t(){var t;return t=e.call(this)||this,Au("triangle","Triangle"),t}return ee(t,e),t}(as),bu=function(e){function t(){var t;return t=e.call(this)||this,Au("sphere","Sphere"),t}return ee(t,e),t}(rs),Ru=function(e){function t(){var t;return t=e.call(this)||this,Au("aabb","AABB"),t}return ee(t,e),t}(su),Nu=function(e){function t(){var t;return t=e.call(this)||this,Au("obb","OBB"),t}return ee(t,e),t}(hu),Ou=function(e){function t(){var t;return t=e.call(this)||this,Au("capsule","Capsule"),t}return ee(t,e),t}(_u),Du=function(e){function t(){var t;return t=e.call(this)||this,Au("frustum","Frustum"),t}return ee(t,e),t}(vu),Mu=Object.freeze({__proto__:null,distance:_a,enums:fa,intersect:Kl,Line:da,Plane:eu,Ray:pa,Triangle:as,Sphere:rs,AABB:su,OBB:hu,Capsule:_u,Frustum:vu,Keyframe:Eu,AnimationCurve:Tu,get ERaycastMode(){return kc},line:wu,plane:Cu,ray:Iu,triangle:Pu,sphere:bu,aabb:Ru,obb:Nu,capsule:Ou,frustum:Du});e("e0",Mu);var Lu={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Fu=e("dl",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=oe(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){void 0!==n?n>19||n<0?console.warn("maximum layers reached."):(e.Enum[t]=1<<n,e.Enum[n]=t,e.BitMask[t]=1<<n,e.BitMask[n]=t):console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){t>19||t<0?console.warn("do not change buildin layers."):(delete e.Enum[e.Enum[t]],delete e.Enum[t],delete e.BitMask[e.BitMask[t]],delete e.BitMask[t])},e}());Fu.Enum=nt(Lu),Fu.BitMask=tt($({},Lu)),s.Layers=Fu;var zu,Bu,Uu="GbufferFlow",Hu="LightingFlow",Gu="ForwardFlow",Vu="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(zu||(zu={})),s.RenderPassStage=zu,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Bu||(Bu=e("di",{})));var ku,Wu={bindings:[],layouts:{}},ju={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_GBUFFER_ALBEDOMAP=6]="SAMPLER_GBUFFER_ALBEDOMAP",e[e.SAMPLER_GBUFFER_POSITIONMAP=7]="SAMPLER_GBUFFER_POSITIONMAP",e[e.SAMPLER_GBUFFER_NORMALMAP=8]="SAMPLER_GBUFFER_NORMALMAP",e[e.SAMPLER_GBUFFER_EMISSIVEMAP=9]="SAMPLER_GBUFFER_EMISSIVEMAP",e[e.SAMPLER_LIGHTING_RESULTMAP=10]="SAMPLER_LIGHTING_RESULTMAP",e[e.COUNT=11]="COUNT"}(ku||(ku={}));var qu,Yu=ku.SAMPLER_SHADOWMAP,Xu=ku.COUNT-Yu;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=9]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",e[e.COUNT=11]="COUNT"}(qu||(qu=e("dy",{})));var Ku,Qu=qu.SAMPLER_JOINTS,Zu=qu.COUNT-Qu;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(Ku||(Ku={}));var Ju=new Es;Ju.bufferOffsets=[0,Yu+Qu,Yu],Ju.samplerOffsets=[-Yu,Xu+Zu,Xu-Qu],Ju.flexibleSet=1;var $u=function(){};$u.SIZE=4*($u.COUNT=4+($u.SCREEN_SIZE_OFFSET=4+($u.NATIVE_SIZE_OFFSET=4+($u.TIME_OFFSET=0)))),$u.NAME="CCGlobal",$u.BINDING=ku.UBO_GLOBAL,$u.DESCRIPTOR=new Ks($u.BINDING,ts.UNIFORM_BUFFER,1,Wa.ALL),$u.LAYOUT=new Ns(Ku.GLOBAL,$u.BINDING,$u.NAME,[new Rs("cc_time",Pa.FLOAT4,1),new Rs("cc_screenSize",Pa.FLOAT4,1),new Rs("cc_nativeSize",Pa.FLOAT4,1)],1),Wu.layouts[$u.NAME]=$u.LAYOUT,Wu.bindings[$u.BINDING]=$u.DESCRIPTOR;var eh=function(){};eh.SIZE=4*(eh.COUNT=4+(eh.GLOBAL_FOG_ADD_OFFSET=4+(eh.GLOBAL_FOG_BASE_OFFSET=4+(eh.GLOBAL_FOG_COLOR_OFFSET=4+(eh.AMBIENT_GROUND_OFFSET=4+(eh.AMBIENT_SKY_OFFSET=4+(eh.MAIN_LIT_COLOR_OFFSET=4+(eh.MAIN_LIT_DIR_OFFSET=4+(eh.EXPOSURE_OFFSET=4+(eh.SCREEN_SCALE_OFFSET=4+(eh.CAMERA_POS_OFFSET=16+(eh.MAT_VIEW_PROJ_INV_OFFSET=16+(eh.MAT_VIEW_PROJ_OFFSET=16+(eh.MAT_PROJ_INV_OFFSET=16+(eh.MAT_PROJ_OFFSET=16+(eh.MAT_VIEW_INV_OFFSET=16+(eh.MAT_VIEW_OFFSET=0))))))))))))))))),eh.NAME="CCCamera",eh.BINDING=ku.UBO_CAMERA,eh.DESCRIPTOR=new Ks(eh.BINDING,ts.UNIFORM_BUFFER,1,Wa.ALL),eh.LAYOUT=new Ns(Ku.GLOBAL,eh.BINDING,eh.NAME,[new Rs("cc_matView",Pa.MAT4,1),new Rs("cc_matViewInv",Pa.MAT4,1),new Rs("cc_matProj",Pa.MAT4,1),new Rs("cc_matProjInv",Pa.MAT4,1),new Rs("cc_matViewProj",Pa.MAT4,1),new Rs("cc_matViewProjInv",Pa.MAT4,1),new Rs("cc_cameraPos",Pa.FLOAT4,1),new Rs("cc_screenScale",Pa.FLOAT4,1),new Rs("cc_exposure",Pa.FLOAT4,1),new Rs("cc_mainLitDir",Pa.FLOAT4,1),new Rs("cc_mainLitColor",Pa.FLOAT4,1),new Rs("cc_ambientSky",Pa.FLOAT4,1),new Rs("cc_ambientGround",Pa.FLOAT4,1),new Rs("cc_fogColor",Pa.FLOAT4,1),new Rs("cc_fogBase",Pa.FLOAT4,1),new Rs("cc_fogAdd",Pa.FLOAT4,1)],1),Wu.layouts[eh.NAME]=eh.LAYOUT,Wu.bindings[eh.BINDING]=eh.DESCRIPTOR;var th=function(){};th.SIZE=4*(th.COUNT=4+(th.SHADOW_COLOR_OFFSET=4+(th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET=16+(th.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(th.MAT_LIGHT_VIEW_OFFSET=16+(th.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))),th.NAME="CCShadow",th.BINDING=ku.UBO_SHADOW,th.DESCRIPTOR=new Ks(th.BINDING,ts.UNIFORM_BUFFER,1,Wa.ALL),th.LAYOUT=new Ns(Ku.GLOBAL,th.BINDING,th.NAME,[new Rs("cc_matLightPlaneProj",Pa.MAT4,1),new Rs("cc_matLightView",Pa.MAT4,1),new Rs("cc_matLightViewProj",Pa.MAT4,1),new Rs("cc_shadowNFLSInfo",Pa.FLOAT4,1),new Rs("cc_shadowWHPBInfo",Pa.FLOAT4,1),new Rs("cc_shadowLPNNInfo",Pa.FLOAT4,1),new Rs("cc_shadowColor",Pa.FLOAT4,1)],1),Wu.layouts[th.NAME]=th.LAYOUT,Wu.bindings[th.BINDING]=th.DESCRIPTOR;var nh=ku.SAMPLER_SHADOWMAP,ih=new Ks(nh,ts.SAMPLER_TEXTURE,1,Wa.FRAGMENT),oh=new Os(Ku.GLOBAL,nh,"cc_shadowMap",Pa.SAMPLER2D,1);Wu.layouts.cc_shadowMap=oh,Wu.bindings[nh]=ih;var rh=ku.SAMPLER_GBUFFER_ALBEDOMAP,ah=new Ks(rh,ts.SAMPLER_TEXTURE,1,Wa.FRAGMENT),sh=new Os(Ku.GLOBAL,rh,"cc_gbuffer_albedoMap",Pa.SAMPLER2D,1);Wu.layouts.cc_gbuffer_albedoMap=sh,Wu.bindings[rh]=ah;var ch=ku.SAMPLER_GBUFFER_POSITIONMAP,lh=new Ks(ch,ts.SAMPLER_TEXTURE,1,Wa.FRAGMENT),uh=new Os(Ku.GLOBAL,ch,"cc_gbuffer_positionMap",Pa.SAMPLER2D,1);Wu.layouts.cc_gbuffer_positionMap=uh,Wu.bindings[ch]=lh;var hh=ku.SAMPLER_GBUFFER_NORMALMAP,_h=new Ks(hh,ts.SAMPLER_TEXTURE,1,Wa.FRAGMENT),fh=new Os(Ku.GLOBAL,hh,"cc_gbuffer_normalMap",Pa.SAMPLER2D,1);Wu.layouts.cc_gbuffer_normalMap=fh,Wu.bindings[hh]=_h;var dh=ku.SAMPLER_LIGHTING_RESULTMAP,ph=new Ks(dh,ts.SAMPLER_TEXTURE,1,Wa.FRAGMENT),mh=new Os(Ku.GLOBAL,dh,"cc_lighting_resultMap",Pa.SAMPLER2D,1);Wu.layouts.cc_lighting_resultMap=mh,Wu.bindings[dh]=ph;var vh=ku.SAMPLER_GBUFFER_EMISSIVEMAP,gh=new Ks(vh,ts.SAMPLER_TEXTURE,1,Wa.FRAGMENT),yh=new Os(Ku.GLOBAL,vh,"cc_gbuffer_emissiveMap",Pa.SAMPLER2D,1);Wu.layouts.cc_gbuffer_emissiveMap=yh,Wu.bindings[vh]=gh;var xh=ku.SAMPLER_ENVIRONMENT,Eh=new Ks(xh,ts.SAMPLER_TEXTURE,1,Wa.FRAGMENT),Sh=new Os(Ku.GLOBAL,xh,"cc_environment",Pa.SAMPLER_CUBE,1);Wu.layouts.cc_environment=Sh,Wu.bindings[xh]=Eh;var Th=ku.SAMPLER_SPOT_LIGHTING_MAP,Ah=new Ks(Th,ts.SAMPLER_TEXTURE,1,Wa.FRAGMENT),wh=new Os(Ku.GLOBAL,Th,"cc_spotLightingMap",Pa.SAMPLER2D,1);Wu.layouts.cc_spotLightingMap=wh,Wu.bindings[Th]=Ah;var Ch=e("dx",(function(){}));Ch.MAT_WORLD_OFFSET=0,Ch.MAT_WORLD_IT_OFFSET=Ch.MAT_WORLD_OFFSET+16,Ch.LIGHTINGMAP_UVPARAM=Ch.MAT_WORLD_IT_OFFSET+16,Ch.COUNT=Ch.LIGHTINGMAP_UVPARAM+4,Ch.SIZE=4*Ch.COUNT,Ch.NAME="CCLocal",Ch.BINDING=qu.UBO_LOCAL,Ch.DESCRIPTOR=new Ks(Ch.BINDING,ts.UNIFORM_BUFFER,1,Wa.VERTEX),Ch.LAYOUT=new Ns(Ku.LOCAL,Ch.BINDING,Ch.NAME,[new Rs("cc_matWorld",Pa.MAT4,1),new Rs("cc_matWorldIT",Pa.MAT4,1),new Rs("cc_lightingMapUVParam",Pa.FLOAT4,1)],1),ju.layouts[Ch.NAME]=Ch.LAYOUT,ju.bindings[Ch.BINDING]=Ch.DESCRIPTOR;var Ih="a_matWorld0",Ph=function(){};Ph.BATCHING_COUNT=10,Ph.MAT_WORLDS_OFFSET=0,Ph.SIZE=4*(Ph.COUNT=16*Ph.BATCHING_COUNT),Ph.NAME="CCLocalBatched",Ph.BINDING=qu.UBO_LOCAL,Ph.DESCRIPTOR=new Ks(Ph.BINDING,ts.UNIFORM_BUFFER,1,Wa.VERTEX),Ph.LAYOUT=new Ns(Ku.LOCAL,Ph.BINDING,Ph.NAME,[new Rs("cc_matWorlds",Pa.MAT4,Ph.BATCHING_COUNT)],1),ju.layouts[Ph.NAME]=Ph.LAYOUT,ju.bindings[Ph.BINDING]=Ph.DESCRIPTOR;var bh=function(){};bh.LIGHTS_PER_PASS=1,bh.SIZE=4*(bh.COUNT=(bh.LIGHT_DIR_OFFSET=(bh.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(bh.LIGHT_COLOR_OFFSET=(bh.LIGHT_POS_OFFSET=0)+4*bh.LIGHTS_PER_PASS)+4*bh.LIGHTS_PER_PASS)+4*bh.LIGHTS_PER_PASS)+4*bh.LIGHTS_PER_PASS),bh.NAME="CCForwardLight",bh.BINDING=qu.UBO_FORWARD_LIGHTS,bh.DESCRIPTOR=new Ks(bh.BINDING,ts.DYNAMIC_UNIFORM_BUFFER,1,Wa.FRAGMENT),bh.LAYOUT=new Ns(Ku.LOCAL,bh.BINDING,bh.NAME,[new Rs("cc_lightPos",Pa.FLOAT4,bh.LIGHTS_PER_PASS),new Rs("cc_lightColor",Pa.FLOAT4,bh.LIGHTS_PER_PASS),new Rs("cc_lightSizeRangeAngle",Pa.FLOAT4,bh.LIGHTS_PER_PASS),new Rs("cc_lightDir",Pa.FLOAT4,bh.LIGHTS_PER_PASS)],1),ju.layouts[bh.NAME]=bh.LAYOUT,ju.bindings[bh.BINDING]=bh.DESCRIPTOR;var Rh=function(){};Rh.LIGHTS_PER_PASS=10;var Nh=e("cE",(function(){}));Nh.JOINTS_TEXTURE_INFO_OFFSET=0,Nh.COUNT=Nh.JOINTS_TEXTURE_INFO_OFFSET+4,Nh.SIZE=4*Nh.COUNT,Nh.NAME="CCSkinningTexture",Nh.BINDING=qu.UBO_SKINNING_TEXTURE,Nh.DESCRIPTOR=new Ks(Nh.BINDING,ts.UNIFORM_BUFFER,1,Wa.VERTEX),Nh.LAYOUT=new Ns(Ku.LOCAL,Nh.BINDING,Nh.NAME,[new Rs("cc_jointTextureInfo",Pa.FLOAT4,1)],1),ju.layouts[Nh.NAME]=Nh.LAYOUT,ju.bindings[Nh.BINDING]=Nh.DESCRIPTOR;var Oh=e("cw",(function(){}));Oh.JOINTS_ANIM_INFO_OFFSET=0,Oh.COUNT=Oh.JOINTS_ANIM_INFO_OFFSET+4,Oh.SIZE=4*Oh.COUNT,Oh.NAME="CCSkinningAnimation",Oh.BINDING=qu.UBO_SKINNING_ANIMATION,Oh.DESCRIPTOR=new Ks(Oh.BINDING,ts.UNIFORM_BUFFER,1,Wa.VERTEX),Oh.LAYOUT=new Ns(Ku.LOCAL,Oh.BINDING,Oh.NAME,[new Rs("cc_jointAnimInfo",Pa.FLOAT4,1)],1),ju.layouts[Oh.NAME]=Oh.LAYOUT,ju.bindings[Oh.BINDING]=Oh.DESCRIPTOR;var Dh=e("cG","a_jointAnimInfo"),Mh=e("cC",(function(){}));Mh.JOINTS_OFFSET=0,Mh.COUNT=Mh.JOINTS_OFFSET+360,Mh.SIZE=4*Mh.COUNT,Mh.NAME="CCSkinning",Mh.BINDING=qu.UBO_SKINNING_TEXTURE,Mh.DESCRIPTOR=new Ks(Mh.BINDING,ts.UNIFORM_BUFFER,1,Wa.VERTEX),Mh.LAYOUT=new Ns(Ku.LOCAL,Mh.BINDING,Mh.NAME,[new Rs("cc_joints",Pa.FLOAT4,90)],1),ju.layouts[Mh.NAME]=Mh.LAYOUT,ju.bindings[Mh.BINDING]=Mh.DESCRIPTOR;var Lh=e("bz",(function(){}));Lh.MAX_MORPH_TARGET_COUNT=60,Lh.OFFSET_OF_WEIGHTS=0,Lh.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Lh.MAX_MORPH_TARGET_COUNT,Lh.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=Lh.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH+4,Lh.OFFSET_OF_VERTICES_COUNT=Lh.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT+4,Lh.COUNT_BASE_4_BYTES=4*Math.ceil(Lh.MAX_MORPH_TARGET_COUNT/4)+4,Lh.SIZE=4*Lh.COUNT_BASE_4_BYTES,Lh.NAME="CCMorph",Lh.BINDING=qu.UBO_MORPH,Lh.DESCRIPTOR=new Ks(Lh.BINDING,ts.UNIFORM_BUFFER,1,Wa.VERTEX),Lh.LAYOUT=new Ns(Ku.LOCAL,Lh.BINDING,Lh.NAME,[new Rs("cc_displacementWeights",Pa.FLOAT4,Lh.MAX_MORPH_TARGET_COUNT/4),new Rs("cc_displacementTextureInfo",Pa.FLOAT4,1)],1),ju.layouts[Lh.NAME]=Lh.LAYOUT,ju.bindings[Lh.BINDING]=Lh.DESCRIPTOR;var Fh=e("cF",qu.SAMPLER_JOINTS),zh=new Ks(Fh,ts.SAMPLER_TEXTURE,1,Wa.VERTEX),Bh=new Os(Ku.LOCAL,Fh,"cc_jointTexture",Pa.SAMPLER2D,1);ju.layouts.cc_jointTexture=Bh,ju.bindings[Fh]=zh;var Uh=e("bI",qu.SAMPLER_MORPH_POSITION),Hh=new Ks(Uh,ts.SAMPLER_TEXTURE,1,Wa.VERTEX),Gh=new Os(Ku.LOCAL,Uh,"cc_PositionDisplacements",Pa.SAMPLER2D,1);ju.layouts.cc_PositionDisplacements=Gh,ju.bindings[Uh]=Hh;var Vh=e("bH",qu.SAMPLER_MORPH_NORMAL),kh=new Ks(Vh,ts.SAMPLER_TEXTURE,1,Wa.VERTEX),Wh=new Os(Ku.LOCAL,Vh,"cc_NormalDisplacements",Pa.SAMPLER2D,1);ju.layouts.cc_NormalDisplacements=Wh,ju.bindings[Vh]=kh;var jh=e("bG",qu.SAMPLER_MORPH_TANGENT),qh=new Ks(jh,ts.SAMPLER_TEXTURE,1,Wa.VERTEX),Yh=new Os(Ku.LOCAL,jh,"cc_TangentDisplacements",Pa.SAMPLER2D,1);ju.layouts.cc_TangentDisplacements=Yh,ju.bindings[jh]=qh;var Xh=qu.SAMPLER_LIGHTMAP,Kh=new Ks(Xh,ts.SAMPLER_TEXTURE,1,Wa.FRAGMENT),Qh=new Os(Ku.LOCAL,Xh,"cc_lightingMap",Pa.SAMPLER2D,1);ju.layouts.cc_lightingMap=Qh,ju.bindings[Xh]=Kh;var Zh=qu.SAMPLER_SPRITE,Jh=new Ks(Zh,ts.SAMPLER_TEXTURE,1,Wa.FRAGMENT),$h=new Os(Ku.LOCAL,Zh,"cc_spriteTexture",Pa.SAMPLER2D,1);ju.layouts.cc_spriteTexture=$h,ju.bindings[Zh]=Jh;var e_,t_,n_,i_,o_,r_=Fu.makeMaskExclude([Fu.BitMask.UI_2D,Fu.BitMask.GIZMOS,Fu.BitMask.EDITOR,Fu.BitMask.SCENE_GIZMO,Fu.BitMask.PROFILER]),a_=Fu.makeMaskExclude([Fu.BitMask.UI_2D,Fu.BitMask.PROFILER]),s_=Fu.Enum.ALL;function c_(e){return e.hasFeature(wa.COLOR_HALF_FLOAT)&&e.hasFeature(wa.TEXTURE_HALF_FLOAT)}e("f9",Object.freeze({__proto__:null,PIPELINE_FLOW_GBUFFER:Uu,PIPELINE_FLOW_LIGHTING:Hu,PIPELINE_FLOW_FORWARD:Gu,PIPELINE_FLOW_SHADOW:Vu,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return zu},get RenderPriority(){return Bu},globalDescriptorSetLayout:Wu,localDescriptorSetLayout:ju,get PipelineGlobalBindings(){return ku},get ModelLocalBindings(){return qu},get SetIndex(){return Ku},bindingMappingInfo:Ju,UBOGlobal:$u,UBOCamera:eh,UBOShadow:th,UNIFORM_SHADOWMAP_BINDING:nh,UNIFORM_GBUFFER_ALBEDOMAP_BINDING:rh,UNIFORM_GBUFFER_POSITIONMAP_BINDING:ch,UNIFORM_GBUFFER_NORMALMAP_BINDING:hh,UNIFORM_LIGHTING_RESULTMAP_BINDING:dh,UNIFORM_GBUFFER_EMISSIVEMAP_BINDING:vh,UNIFORM_ENVIRONMENT_BINDING:xh,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:Th,UBOLocal:Ch,INST_MAT_WORLD:Ih,UBOLocalBatched:Ph,UBOForwardLight:bh,UBODeferredLight:Rh,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:Nh,UBOSkinningAnimation:Oh,INST_JOINT_ANIM_INFO:Dh,UBOSkinning:Mh,UBOMorph:Lh,UNIFORM_JOINT_TEXTURE_BINDING:Fh,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Uh,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Vh,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:jh,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Xh,UNIFORM_SPRITE_TEXTURE_BINDING:Zh,CAMERA_DEFAULT_MASK:r_,CAMERA_EDITOR_MASK:a_,MODEL_ALWAYS_MASK:s_,supportsHalfFloatTexture:c_})),function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(e_||(e_={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(t_||(t_={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(n_||(n_={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(i_||(i_={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(o_||(o_={}));var l_,u_,h_=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],__=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],f_=[100,200,400,800],d_=new An,p_=new An,m_=new Un,v_=os.STENCIL<<1,g_=[],y_=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=e_.VERTICAL,this._fov=sn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new xs(.2,.2,.2,1),this._viewport=new Jn(0,0,1,1),this._curTransform=Aa.IDENTITY,this._isProjDirty=!0,this._matView=new Un,this._matViewInv=null,this._matProj=new Un,this._matProjInv=new Un,this._matViewProj=new Un,this._matViewProjInv=new Un,this._frustum=new vu,this._forward=new An,this._position=new An,this._priority=0,this._aperture=n_.F16_0,this._apertureValue=void 0,this._shutter=o_.D125,this._shutterValue=0,this._iso=i_.ISO100,this._isoValue=0,this._ec=0,this._poolHandle=To,this._frustumHandle=To,this._window=null,this._device=e,this._apertureValue=h_[this._aperture],this._shutterValue=__[this._shutter],this._isoValue=f_[this._iso],this._aspect=this.screenScale=1,!g_.length){var t=e.capabilities.clipSpaceSignY;g_[Aa.IDENTITY]=new Un(1,0,0,0,0,t),g_[Aa.ROTATE_90]=new Un(0,1,0,0,-t,0),g_[Aa.ROTATE_180]=new Un(-1,0,0,0,0,-t),g_[Aa.ROTATE_270]=new Un(0,-1,0,0,t,0)}}var t=e.prototype;return t.initialize=function(e){this._name=e.name,this._node=e.node,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1;var t=this._poolHandle=or.alloc();or.set(t,$o.WIDTH,1),or.set(t,$o.HEIGHT,1),or.set(t,$o.CLEAR_FLAGS,os.NONE),or.set(t,$o.CLEAR_DEPTH,1),or.set(t,$o.NODE,this._node.handle),or.set(t,$o.VISIBILITY,r_),this._scene&&or.set(t,$o.SCENE,this._scene.handle),this.updateExposure(),this.changeTargetWindow(e.window),console.log("Created Camera: "+this._name+" "+or.get(t,$o.WIDTH)+"x"+or.get(t,$o.HEIGHT))},t.destroy=function(){this._window&&this._window.detachCamera(this),this._name=null,this._poolHandle&&(or.free(this._poolHandle),this._poolHandle=To,this._frustumHandle&&(mr.free(this._frustumHandle),this._frustumHandle=To))},t.attachToScene=function(e){this._scene=e,this._enabled=!0,or.set(this._poolHandle,$o.SCENE,e.handle)},t.detachFromScene=function(){this._scene=null,this._enabled=!1,or.set(this._poolHandle,$o.SCENE,0)},t.resize=function(e,t){var n=this._poolHandle;or.set(n,$o.WIDTH,e),or.set(n,$o.HEIGHT,t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this._isProjDirty=!0},t.setFixedSize=function(e,t){var n=this._poolHandle;or.set(n,$o.WIDTH,e),or.set(n,$o.HEIGHT,t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this.isWindowSize=!1},t.update=function(e){if(void 0===e&&(e=!1),this._node){var t=!1;(this._node.hasChangedFlags||e)&&(Un.invert(this._matView,this._node.worldMatrix),or.setMat4(this._poolHandle,$o.MAT_VIEW,this._matView),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),or.setVec3(this._poolHandle,$o.POSITION,this._position),or.setVec3(this._poolHandle,$o.FORWARD,this._forward),t=!0);var n=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==n){var i;this._curTransform=n;var o=this._device.capabilities.clipSpaceSignY;if((null===(i=this.window)||void 0===i?void 0:i.hasOffScreenAttachments)&&(n=Aa.IDENTITY),this._proj===t_.PERSPECTIVE)Un.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===e_.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,n);else{var r=this._orthoHeight*this._aspect,a=this._orthoHeight;Un.ortho(this._matProj,-r,r,-a,a,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,n)}Un.invert(this._matProjInv,this._matProj),or.setMat4(this._poolHandle,$o.MAT_PROJ,this._matProj),or.setMat4(this._poolHandle,$o.MAT_PROJ_INV,this._matProjInv),t=!0,this._isProjDirty=!1}t&&(Un.multiply(this._matViewProj,this._matProj,this._matView),Un.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),or.setMat4(this._poolHandle,$o.MAT_VIEW_PROJ,this._matViewProj),or.setMat4(this._poolHandle,$o.MAT_VIEW_PROJ_INV,this._matViewProjInv),gu(this._frustumHandle,this._frustum))}},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||s.director.root.mainWindow;t&&(t.attachCamera(this),this.resize(t.width,t.height),this._window=t,or.set(this._poolHandle,$o.WINDOW,t.handle))},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this._poolHandle,o=or.get(i,$o.WIDTH),r=or.get(i,$o.HEIGHT),a=this._viewport.x*o,s=this._viewport.y*r,c=this._viewport.width*o,l=this._viewport.height*r,u=this._proj===t_.PERSPECTIVE,h=this._device.capabilities.clipSpaceSignY,_=Bn[this._curTransform];An.set(d_,(t-a)/c*2-1,(n-s)/l*2-1,u?1:-1);var f=d_.x,d=d_.y;return d_.x=f*_[0]+d*_[2]*h,d_.y=f*_[1]+d*_[3]*h,An.transformMat4(u?d_:e.o,d_,this._matViewProjInv),u?(this._node.getWorldPosition(p_),pa.fromPoints(e,p_,d_)):An.transformQuat(e.d,An.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this._poolHandle,i=or.get(n,$o.WIDTH),o=or.get(n,$o.HEIGHT),r=this._viewport.x*i,a=this._viewport.y*o,s=this._viewport.width*i,c=this._viewport.height*o,l=this._device.capabilities.clipSpaceSignY,u=Bn[this._curTransform];if(this._proj===t_.PERSPECTIVE){An.set(e,(t.x-r)/s*2-1,(t.y-a)/c*2-1,1);var h=e.x,_=e.y;e.x=h*u[0]+_*u[2]*l,e.y=h*u[1]+_*u[3]*l,An.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(d_),An.lerp(e,d_,e,an(this._nearClip/this._farClip,1,t.z))}else{An.set(e,(t.x-r)/s*2-1,(t.y-a)/c*2-1,2*t.z-1);var f=e.x,d=e.y;e.x=f*u[0]+d*u[2]*l,e.y=f*u[1]+d*u[3]*l,An.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this._poolHandle,i=or.get(n,$o.WIDTH),o=or.get(n,$o.HEIGHT),r=this._viewport.x*i,a=this._viewport.y*o,s=this._viewport.width*i,c=this._viewport.height*o,l=this._device.capabilities.clipSpaceSignY,u=Bn[this._curTransform];An.transformMat4(e,t,this._matViewProj);var h=e.x,_=e.y;return e.x=h*u[0]+_*u[2]*l,e.y=h*u[1]+_*u[3]*l,e.x=r+.5*(e.x+1)*s,e.y=a+.5*(e.y+1)*c,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){Un.multiply(e,this._matViewProj,t),Un.multiply(e,g_[this._curTransform],e);var o=n/2,r=i/2;return Un.identity(m_),Un.transform(m_,m_,An.set(d_,o,r,0)),Un.scale(m_,m_,An.set(d_,o,r,1)),Un.multiply(e,m_,e),e},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);or.set(this._poolHandle,$o.EXPOSURE,.833333/Math.pow(2,e))},J(e,[{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w,or.setVec4(this._poolHandle,$o.CLEAR_COLOR,e)}},{key:"viewport",get:function(){return this._viewport},set:function(e){var t=e.x,n=e.width,i=e.height,o=this._device.capabilities.clipSpaceSignY<0?1-e.y-i:e.y;switch(this._device.surfaceTransform){case Aa.ROTATE_90:this._viewport.x=1-o-i,this._viewport.y=t,this._viewport.width=i,this._viewport.height=n;break;case Aa.ROTATE_180:this._viewport.x=1-t-n,this._viewport.y=1-o-i,this._viewport.width=n,this._viewport.height=i;break;case Aa.ROTATE_270:this._viewport.x=o,this._viewport.y=1-t-n,this._viewport.width=i,this._viewport.height=n;break;case Aa.IDENTITY:this._viewport.x=t,this._viewport.y=o,this._viewport.width=n,this._viewport.height=i}or.setVec4(this._poolHandle,$o.VIEW_PORT,this._viewport),this.resize(this.width,this.height)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return or.get(this._poolHandle,$o.WIDTH)}},{key:"height",get:function(){return or.get(this._poolHandle,$o.HEIGHT)}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView},set:function(e){this._matView=e,or.setMat4(this._poolHandle,$o.MAT_VIEW,this._matView)}},{key:"matViewInv",get:function(){return this._matViewInv||this._node.worldMatrix},set:function(e){this._matViewInv=e}},{key:"matProj",get:function(){return this._matProj},set:function(e){this._matProj=e,or.setMat4(this._poolHandle,$o.MAT_PROJ,this._matProj)}},{key:"matProjInv",get:function(){return this._matProjInv},set:function(e){this._matProjInv=e,or.setMat4(this._poolHandle,$o.MAT_PROJ_INV,this._matProjInv)}},{key:"matViewProj",get:function(){return this._matViewProj},set:function(e){this._matViewProj=e,or.setMat4(this._poolHandle,$o.MAT_VIEW_PROJ,this._matViewProj)}},{key:"matViewProjInv",get:function(){return this._matViewProjInv},set:function(e){this._matViewProjInv=e,or.setMat4(this._poolHandle,$o.MAT_VIEW_PROJ_INV,this._matViewProjInv)}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e,gu(this._frustumHandle,e)}},{key:"window",get:function(){return this._window},set:function(e){this._window=e,e&&or.set(this._poolHandle,$o.WINDOW,e.handle)}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e,or.setVec3(this._poolHandle,$o.FORWARD,this._forward)}},{key:"position",get:function(){return this._position},set:function(e){this._position=e,or.setVec3(this._poolHandle,$o.POSITION,this._position)}},{key:"visibility",get:function(){return or.get(this._poolHandle,$o.VISIBILITY)},set:function(e){or.set(this._poolHandle,$o.VISIBILITY,e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=h_[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=__[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=f_[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return or.get(this._poolHandle,$o.EXPOSURE)}},{key:"clearFlag",get:function(){return or.get(this._poolHandle,$o.CLEAR_FLAGS)},set:function(e){or.set(this._poolHandle,$o.CLEAR_FLAGS,e)}},{key:"clearDepth",get:function(){return or.get(this._poolHandle,$o.CLEAR_DEPTH)},set:function(e){or.set(this._poolHandle,$o.CLEAR_DEPTH,e)}},{key:"clearStencil",get:function(){return or.get(this._poolHandle,$o.CLEAR_STENCIL)},set:function(e){or.set(this._poolHandle,$o.CLEAR_STENCIL,e)}},{key:"handle",get:function(){return this._poolHandle}}]),e}();!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(l_||(l_={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(u_||(u_=e("c1",{}))),s.internal.TransformBit=u_;var x_=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._scenePoolHandle=To,this._modelArrayHandle=To,this._batchArrayHandle=To,this._sphereLightsHandle=To,this._spotLightsHandle=To,this._root=e,this._createHandles()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._createHandles(),!0},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var o=this._spotLights,r=0;r<o.length;r++)o[r].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._modelArrayHandle&&(Ro.free(this._modelArrayHandle),this._modelArrayHandle=To),this._scenePoolHandle&&(tr.free(this._scenePoolHandle),this._scenePoolHandle=To),this._sphereLightsHandle&&(Do.free(this._sphereLightsHandle),this._sphereLightsHandle=To),this._spotLightsHandle&&(Do.free(this._spotLightsHandle),this._spotLightsHandle=To),this._batchArrayHandle&&(Lo.free(this._batchArrayHandle),this._batchArrayHandle=To)},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=oe(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e,tr.set(this._scenePoolHandle,Qo.MAIN_LIGHT,e.handle)},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;t.length?(this._mainLight=t[t.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=u_.ROTATION)):this._mainLight=null}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e),Do.push(this._sphereLightsHandle,e.handle)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),this._sphereLights.splice(t,1),void Do.erase(this._sphereLightsHandle,t)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e),Do.push(this._spotLightsHandle,e.handle)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),this._spotLights.splice(t,1),void Do.erase(this._spotLightsHandle,t)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0,Do.clear(this._sphereLightsHandle)},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[],Do.clear(this._spotLightsHandle)},t.addModel=function(e){e.attachToScene(this),this._models.push(e),Ro.push(this._modelArrayHandle,e.handle)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),this._models.splice(t,1),void Ro.erase(this._modelArrayHandle,t)},t.removeModels=function(){for(var e,t=oe(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0,Ro.clear(this._modelArrayHandle)},t.addBatch=function(e){this._batches.push(e),Lo.push(this._batchArrayHandle,e.handle)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return this._batches.splice(t,1),void Lo.erase(this._batchArrayHandle,t)},t.removeBatches=function(){this._batches.length=0,Lo.clear(this._batchArrayHandle)},t.onGlobalPipelineStateChanged=function(){for(var e,t=oe(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._createHandles=function(){this._modelArrayHandle||(this._modelArrayHandle=Ro.alloc(),this._scenePoolHandle=tr.alloc(),tr.set(this._scenePoolHandle,Qo.MODEL_ARRAY,this._modelArrayHandle),this._spotLightsHandle=Do.alloc(),tr.set(this._scenePoolHandle,Qo.SPOT_LIGHT_ARRAY,this._spotLightsHandle),this._sphereLightsHandle=Do.alloc(),tr.set(this._scenePoolHandle,Qo.SPHERE_LIGHT_ARRAY,this._sphereLightsHandle)),this._batchArrayHandle||(this._batchArrayHandle=Lo.alloc(),tr.set(this._scenePoolHandle,Qo.BATCH_ARRAY_2D,this._batchArrayHandle))},J(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"handle",get:function(){return this._scenePoolHandle}},{key:"batches",get:function(){return this._batches}}]),e}(),E_=function(){},S_=function(){return E_},T_=A_((function(){}));function A_(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function w_(e){return function(t){return function(n){!function(e,t,n){var i=I_(e);if(i){var o=P_(i,"proto");P_(o,"editor")[t]=n}}(n,e,t)}}}var C_="__ccclassCache__";function I_(e){return P_(e,C_)}function P_(e,t){return e[t]||(e[t]={})}var b_=e("bK",A_((function(e,t){var n=et.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},o=e[C_];if(o){var r=o.proto;r&&et.mixin(i,r),e[C_]=void 0}return Kt(i)}))),R_=e("d1",w_("requireComponent")),N_=e("c6",w_("executionOrder")),O_=e("cZ",T_);function D_(e,t,n){var i=null;function o(e,t,n){var o=I_(e.constructor);if(o){var r=P_(o,"proto"),a=P_(r,"properties");!function(e,t,n,i,o,r){var a,s=o&&(o.get||o.set);i&&(a=Ut(i,s));var c=t[n],l=et.mixin(c||{},a||i||{});if(s)o.get&&(l.get=o.get),o.set&&(l.set=o.set);else if(o)o.initializer&&(l.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(o.initializer));else{var u=r.default||(r.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(n)&&(l.default=u[n])}t[n]=l}(e.constructor,a,t,i,n,o)}}return void 0===e?D_({type:void 0}):void 0===t?(i=e,o):void o(e,t,n)}var M_=e("bT",(function(e,t,n){return D_(F_({}))(e,t,n)})),L_=e("dO",(function(e,t,n){return D_({editorOnly:!0})(e,t,n)}));function F_(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}var z_=e("c0",T_),B_=e("c7",S_),U_=T_,H_=S_,G_=S_,V_=e("c5",S_),k_=e("b_",E_),W_=e("c9",S_),j_=(e("dV",E_),e("d2",S_)),q_=e("c8",S_),Y_=e("ci",S_),X_=e("dD",S_),K_=e("dE",S_),Q_=S_,Z_=e("ch",E_),J_=e("c$",S_),$_=(e("cm",S_),e("d4",E_),e("c3",E_)),ef=rf(bt),tf=rf(Rt),nf=rf(Nt),of=e("cT",rf(Ot));function rf(e){return D_({type:e})}var af=e("cL",(function(e,t,n){return D_({__noImplicit:!0,override:!0})(e,t,n)})),sf=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=et.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=et.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},J(e,[{key:"count",get:function(){return this._count}}]),e}(),cf=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,o=n.length;i<o;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(P(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var o=(0,t[n])(e);if(o)return e.isFinish=!0,o;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();cf._pipelineId=0;var lf,uf=new sf,hf=new sf,_f=new sf,ff=new sf,df=new cf("normal load",[]),pf=new cf("fetch",[]),mf=new cf("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(lf||(lf={}));var vf,gf={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(vf||(vf={}));var yf=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,o){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,o);break;case"error":this.onError&&this.onError(t,n,i,o);break;default:var r="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[r]&&this[r](t,n,i,o)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();yf.MAX_DEAD_NUM=500,yf._taskId=0,yf._deadPool=[];var xf="0123456789abcdef".split(""),Ef=["","","",""],Sf=Ef.concat(Ef,"-",Ef,"-",Ef,"-",Ef,"-",Ef,Ef,Ef),Tf=Sf.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function Af(e){var t=e.split("@")[0];if(22!==t.length)return e;Sf[0]=e[0],Sf[1]=e[1];for(var n=2,i=2;n<22;n+=2){var o=_t[e.charCodeAt(n)],r=_t[e.charCodeAt(n+1)];Sf[Tf[i++]]=xf[o>>2],Sf[Tf[i++]]=xf[(3&o)<<2|r>>4],Sf[Tf[i++]]=xf[15&r]}return e.replace(t,Sf.join(""))}var wf=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function Cf(e){var t=wf.exec(e);return t?t[1]:""}function If(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.ext=t.nativeExt;var n=ff.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),Rf(e,t)}function Pf(e){return e&&(e instanceof s.SceneAsset||e instanceof s.Scene)}function bf(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function Rf(e,t){var n=yf.create({input:e,options:t}),i=[];try{for(var o,r=oe(mf.sync(n));!(o=r()).done;){var a=o.value,s=a.url;a.recycle(),i.push(s)}}catch(e){for(var c,l=oe(n.output);!(c=l()).done;)c.value.recycle();y(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var Nf,Of,Df,Mf,Lf=Object.freeze({__proto__:null,getUuidFromURL:Cf,getUrlWithUuid:If,isScene:Pf,normalize:bf,transform:Rf,decodeUuid:Af}),Ff=e("dM",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());Ff.NO_TYPE="no_type",Ff.TOUCH="touch",Ff.MOUSE="mouse",Ff.KEYBOARD="keyboard",Ff.ACCELERATION="acceleration",Ff.NONE=0,Ff.CAPTURING_PHASE=1,Ff.AT_TARGET=2,Ff.BUBBLING_PHASE=3,s.Event=Ff;var zf=e("bN",b_("cc.Asset")((Mf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,re(t,"_native",Df,ne(t)),t._nativeUrl="",t.__onLoadedInvoked__=!1,t.__nativeDepend__=null,t.__depends__=null,t._file=null,t._ref=0,Object.defineProperty(ne(t),"_uuid",{value:"",writable:!0}),t}ee(t,e),t.deserialize=function(e){return s.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&s.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},J(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=If(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=If(this._uuid,{__nativeName__:e,nativeExt:Ri(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}(pi(ri)),Df=ae((Of=Mf).prototype,"_native",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ae(Of.prototype,"_nativeAsset",[D_],Object.getOwnPropertyDescriptor(Of.prototype,"_nativeAsset"),Of.prototype),Nf=Of))||Nf);zf.prototype.createNode=null,s.Asset=zf;var Bf,Uf,Hf,Gf,Vf,kf,Wf,jf=1024;function qf(e){return s.sys.capabilities.imageBitmap&&e instanceof ImageBitmap}!function(e){e[e.RGB565=Ca.R5G6B5]="RGB565",e[e.RGB5A1=Ca.RGB5A1]="RGB5A1",e[e.RGBA4444=Ca.RGBA4]="RGBA4444",e[e.RGB888=Ca.RGB8]="RGB888",e[e.RGB32F=Ca.RGB32F]="RGB32F",e[e.RGBA8888=Ca.RGBA8]="RGBA8888",e[e.RGBA32F=Ca.RGBA32F]="RGBA32F",e[e.A8=Ca.A8]="A8",e[e.I8=Ca.L8]="I8",e[e.AI8=Ca.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=Ca.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=Ca.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=jf++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=Ca.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=Ca.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=jf++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=Ca.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=jf++]="RGBA_ETC1",e[e.RGB_ETC2=Ca.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=Ca.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=Ca.ASTC_RGBA_4x4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=Ca.ASTC_RGBA_5x4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=Ca.ASTC_RGBA_5x5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=Ca.ASTC_RGBA_6x5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=Ca.ASTC_RGBA_6x6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=Ca.ASTC_RGBA_8x5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=Ca.ASTC_RGBA_8x6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=Ca.ASTC_RGBA_8x8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=Ca.ASTC_RGBA_10x5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=Ca.ASTC_RGBA_10x6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=Ca.ASTC_RGBA_10x8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=Ca.ASTC_RGBA_10x10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=Ca.ASTC_RGBA_12x10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=Ca.ASTC_RGBA_12x12]="RGBA_ASTC_12x12"}(Bf||(Bf=e("cK",{}))),function(e){e[e.REPEAT=Ba.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Ba.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Ba.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Ba.BORDER]="CLAMP_TO_BORDER"}(Uf||(Uf={})),function(e){e[e.NONE=za.NONE]="NONE",e[e.LINEAR=za.LINEAR]="LINEAR",e[e.NEAREST=za.POINT]="NEAREST"}(Hf||(Hf=e("cJ",{})));var Yf,Xf=e("bA",b_("cc.ImageAsset")((Wf=kf=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._tex=void 0,n._exportedExts=void 0,n._format=Bf.RGBA8888,n._width=0,n._height=0,n.loaded=!1,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}ee(t,e);var n=t.prototype;return n.reset=function(e){var t=this;qf(e)?(this._nativeData=e,this._onDataComplete()):e instanceof HTMLElement?(this._nativeData=e,e.complete||e instanceof HTMLCanvasElement?this._onDataComplete():(this.loaded=!1,e.addEventListener("load",(function(){t._onDataComplete()})),e.addEventListener("error",(function(e){P(3119,e.message)})))):(this._nativeData=e,this._format=e.format,this._onDataComplete())},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):qf(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var i,o=s.director.root?s.director.root.device:null,r=n.split("_"),a="",c=Number.MAX_VALUE,l=this._format,u="",h=s.macro.SUPPORT_TEXTURE_FORMATS,_=oe(r);!(i=_()).done;){var f=i.value.split("@"),d=parseInt(f[0],void 0),p=t.extnames[d]||f[0],m=h.indexOf(p);if(-1!==m&&m<c){var v=f[1]?parseInt(f[1]):this._format;if(!(".astc"!==p||o&&o.hasFeature(wa.FORMAT_ASTC)))continue;if(!(".pvr"!==p||o&&o.hasFeature(wa.FORMAT_PVRTC)))continue;if(!(v!==Bf.RGB_ETC1&&v!==Bf.RGBA_ETC1||o&&o.hasFeature(wa.FORMAT_ETC1)))continue;if(!(v!==Bf.RGB_ETC2&&v!==Bf.RGBA_ETC2||o&&o.hasFeature(wa.FORMAT_ETC2)))continue;if(".webp"===p&&!s.sys.capabilities.webp)continue;c=m,u=p,l=v}else a||(a=p)}u?(this._setRawAsset(u),this._format=l):a?(this._setRawAsset(a),P(3120,a,a)):P(3121)},n._onDataComplete=function(){this.loaded=!0,this.emit("load")},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),o=i.getContext("2d"),r=i.width=i.height=2;o.fillStyle="#ff00ff",o.fillRect(0,0,r,r),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},J(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||qf(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||qf(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Bf.RGB_ETC1&&this._format<=Bf.RGBA_ASTC_12x12||this._format>=Bf.RGB_A_PVRTC_2BPPV1&&this._format<=Bf.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}},{key:"_texture",get:function(){if(!this._tex){var e=new s.Texture2D;e.name=this.nativeUrl,e.image=this,this._tex=e}return this._tex},set:function(e){this._tex=e}}]),t}(zf),kf.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],kf._sharedPlaceHolderCanvas=null,ae((Vf=Wf).prototype,"_nativeAsset",[af],Object.getOwnPropertyDescriptor(Vf.prototype,"_nativeAsset"),Vf.prototype),Gf=Vf))||Gf);s.ImageAsset=Xf,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.mipLODBias=8]="mipLODBias",e[e.total=9]="total"}(Yf||(Yf={}));var Kf=[za.LINEAR,za.LINEAR,za.NONE,Ba.WRAP,Ba.WRAP,Ba.WRAP,0,Ua.NEVER,0],Qf=$f(Kf),Zf=new xs,Jf=new bs;function $f(e){for(var t=0,n=0,i=0;i<Kf.length;i++)switch(t=e[i]||Kf[i],i){case Yf.minFilter:n|=t;break;case Yf.magFilter:n|=t<<2;break;case Yf.mipFilter:n|=t<<4;break;case Yf.addressU:n|=t<<6;break;case Yf.addressV:n|=t<<8;break;case Yf.addressW:n|=t<<10;break;case Yf.maxAnisotropy:n|=t<<12;break;case Yf.cmpFunc:n|=t<<16;break;case Yf.mipLODBias:n|=t<<28}return n}var ed,td,nd,id,od,rd,ad,sd,cd,ld,ud,hd,_d=function(){function e(){this._cache={}}return e.prototype.getSampler=function(e,t){return t||(t=Qf),this._cache[t]||(Jf.minFilter=3&t,Jf.magFilter=t>>2&3,Jf.mipFilter=t>>4&3,Jf.addressU=t>>6&3,Jf.addressV=t>>8&3,Jf.addressW=t>>10&3,Jf.maxAnisotropy=t>>12&15,Jf.cmpFunc=t>>16&15,Jf.mipLODBias=t>>28&15,Jf.borderColor=Zf,this._cache[t]=e.createSampler(Jf))},e}(),fd=e("bC",new _d);s.samplerLib=fd;var dd=new fe("Tex"),pd=e("d3",b_("cc.TextureBase")((hd=ud=function(e){function t(){var t;return re(t=e.call(this)||this,"_format",nd,ne(t)),re(t,"_minFilter",id,ne(t)),re(t,"_magFilter",od,ne(t)),re(t,"_mipFilter",rd,ne(t)),re(t,"_wrapS",ad,ne(t)),re(t,"_wrapT",sd,ne(t)),re(t,"_wrapR",cd,ne(t)),re(t,"_anisotropy",ld,ne(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=[],t._samplerHash=0,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=dd.getNewId(),t.loaded=!1,t._gfxDevice=t._getGFXDevice(),t._textureHash=Ac(t._id,666),t}ee(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){this._wrapS=e,this._samplerInfo[Yf.addressU]=e,this._wrapT=t,this._samplerInfo[Yf.addressV]=t,void 0!==n&&(this._wrapR=n,this._samplerInfo[Yf.addressW]=n),this._samplerHash=$f(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=fd.getSampler(this._gfxDevice,this._samplerHash))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo[Yf.minFilter]=e,this._magFilter=t,this._samplerInfo[Yf.magFilter]=t,this._samplerHash=$f(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=fd.getSampler(this._gfxDevice,this._samplerHash))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo[Yf.mipFilter]=e,this._samplerHash=$f(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=fd.getSampler(this._gfxDevice,this._samplerHash))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo[Yf.maxAnisotropy]=e,this._samplerHash=$f(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=fd.getSampler(this._gfxDevice,this._samplerHash))},n.destroy=function(){var t=e.prototype.destroy.call(this);return t&&s.director.root&&s.director.root.batcher2D&&s.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),t},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerHash=function(){return this._samplerHash},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=fd.getSampler(this._gfxDevice,this._samplerHash):R(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return s.director.root?s.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?Bf.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===Bf.RGBA_ETC1?e=Bf.RGB_ETC1:e===Bf.RGB_A_PVRTC_4BPPV1?e=Bf.RGB_PVRTC_4BPPV1:e===Bf.RGB_A_PVRTC_2BPPV1&&(e=Bf.RGB_PVRTC_2BPPV1),e},J(t,[{key:"isCompressed",get:function(){return this._format>=Bf.RGB_ETC1&&this._format<=Bf.RGBA_ASTC_12x12||this._format>=Bf.RGB_A_PVRTC_2BPPV1&&this._format<=Bf.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(zf),ud.PixelFormat=Bf,ud.WrapMode=Uf,ud.Filter=Hf,nd=ae((td=hd).prototype,"_format",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bf.RGBA8888}}),id=ae(td.prototype,"_minFilter",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hf.LINEAR}}),od=ae(td.prototype,"_magFilter",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hf.LINEAR}}),rd=ae(td.prototype,"_mipFilter",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hf.NONE}}),ad=ae(td.prototype,"_wrapS",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uf.REPEAT}}),sd=ae(td.prototype,"_wrapT",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uf.REPEAT}}),cd=ae(td.prototype,"_wrapR",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uf.REPEAT}}),ld=ae(td.prototype,"_anisotropy",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ed=td))||ed);s.TextureBase=pd;var md=[kn,An,Yn,Nn,Sn,Qn,Jn,Un];function vd(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var gd=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},vd,vd,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){Un.fromArray(e,t,1)}],yd=e("eF",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]},t.reset=function(){this.uuidList=null,this.uuidObjList=null,this.uuidPropList=null},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function xd(e,t){for(var n=e[4][t[0]],i=n[0],o=new(0,i[0]),r=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)o[r[n[c]]]=t[c];for(;c<t.length;++c){var l=r[n[c]],u=i[n[c]+a];(0,Cd[u])(e,o,l,t[c])}return o}function Ed(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):R(5303,Ce(t)),i}function Sd(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function Td(e){return function(t,n,i,o){n[i]=o;for(var r=0;r<o.length;++r)e(t,o,r,o[r])}}function Ad(e,t,n,i){t[n]=null,e[8][i]=t}function wd(e,t,n,i){t[n]=xd(e,i)}yd.pool=new Je((function(e){e.reset()}),5),yd.pool.get=function(){return this._get()||new yd};var Cd=new Array(13);function Id(e,t){return e||Nd.reportMissingClass(t),Object}function Pd(e,t,n,i,o,r){var a=e(t);if(!a){if(o)return void(n[i]=function(t,n,i){return function(){var o=e(i)||Id(r,i);return t[n]=o,new o}}(n,i,t));a=Id(r,t)}n[i]=a}function bd(e,t,n){for(var i=n||Ke,o=e[3],r=0;r<o.length;++r){var a=o[r];"string"!=typeof a?Pd(i,a[0],a,0,t,n):Pd(i,a,o,r,t,n)}}function Rd(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var o=t[i];o[0]=n[o[0]]}}function Nd(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var i,o=!t;(t=t||yd.pool.get()).init(e),n=n||{};var r=e[0],a=!1;if("object"==typeof r&&(a=r.preprocessed,r=r.version),r<1)throw new Error(M(5304,r));n._version=r,n.result=t,e[0]=n,a||(bd(e,!1,n.classFinder),Rd(e)),s.game._isCloning=!0;var c=e[5],l=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,o=t[t.length-1],r=t.length-i;"number"!=typeof o?o=0:(o<0&&(o=~o),--r);for(var a=0;a<r;++a)t[a]=xd(e,t[a]);for(var s=e[3],c=0;c<i;++c,++a){var l=n[c],u=t[a];if(l>=0){var h=s[l];t[a]=Ed(e,h,u)}else(0,Cd[l=~l])(e,t,a,u)}return o}(e);return s.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,o=0,r=3*e[i];o<r;o+=3){var a=e[o],s=t[e[o+2]],c=e[o+1];c>=0?a[n[c]]=s:a[~c]=s}for(;o<i;o+=3){var l=t[e[o]],u=t[e[o+2]],h=e[o+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],c,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],o=e[8],r=e[9],a=e[10],s=0;s<o.length;++s){var c=o[s];"number"==typeof c&&(o[s]=t[c]);var l=r[s];"number"==typeof l&&(l=l>=0?n[l]:~l,r[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(e),i=c[l],o&&yd.pool.put(t),i}Cd[0]=function(e,t,n,i){t[n]=i},Cd[1]=Sd,Cd[2]=Td(Sd),Cd[3]=Td(Ad),Cd[4]=wd,Cd[5]=function(e,t,n,i){gd[i[0]](t[n],i)},Cd[6]=Ad,Cd[7]=function(e,t,n,i){t[n].set(i)},Cd[8]=function(e,t,n,i){var o=new md[i[0]];gd[i[0]](o,i),t[n]=o},Cd[9]=Td(wd),Cd[10]=function(e,t,n,i){var o=e[3][i[0]];t[n]=Ed(e,o,i[1])},Cd[11]=function(e,t,n,i){var o=i[0];t[n]=o;for(var r=1;r<i.length;r+=3){var a=i[r],s=i[r+1],c=i[r+2];(0,Cd[s])(e,o,a,c)}},Cd[12]=function(e,t,n,i){var o=i[0];t[n]=o;for(var r=0;r<o.length;++r){var a=o[r],s=i[r+1];0!==s&&(0,Cd[s])(e,o,r,a)}},Nd.Details=yd,Nd.reportMissingClass=function(e){P(5302,e)};var Od,Dd,Md,Ld=function(e){this.preprocessed=!0,this.version=e};function Fd(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}s.deserialize=Nd;var zd=e("eS",b_("cc.Script")(Od=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(zf))||Od);s._Script=zd;var Bd=e("eT",b_("cc.JavaScript")(Dd=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(zd))||Dd);s._JavaScript=Bd;var Ud,Hd,Gd,Vd,kd,Wd,jd,qd,Yd,Xd,Kd,Qd=e("eU",b_("cc.TypeScript")(Md=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(zd))||Md);s._TypeScript=Qd;var Zd,Jd,$d,ep,tp=new fe("Comp"),np=ri.Flags.IsOnLoadCalled,ip=e("ck",(Ud=b_("cc.Component"),Hd=j_(),Gd=rf(zd),Vd=q_(),Ud((Kd=Xd=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"node",jd,ne(t)),re(t,"_enabled",qd,ne(t)),re(t,"__prefab",Yd,ne(t)),t._sceneGetter=null,t._id=tp.getNewId(),t}ee(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&s.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),s.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=s.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=s.macro.REPEAT_FOREVER),void 0===i&&(i=0),D(e,1619),D((t=t||0)>=0,1620),n=Number.isNaN(n)?s.macro.REPEAT_FOREVER:n,i=i||0;var o=s.director.getScheduler(),r=o.isTargetPaused(this);o.schedule(e,this,t,n,i,r)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&s.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){s.director.getScheduler().unscheduleAllForTarget(this)},J(t,[{key:"name",get:function(){if(this._name)return this._name;var e=Ce(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=s.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&np}}]),t}(ri),Xd.system=null,ae((Wd=Kd).prototype,"__scriptAsset",[Hd,Gd,Vd,$_],Object.getOwnPropertyDescriptor(Wd.prototype,"__scriptAsset"),Wd.prototype),jd=ae(Wd.prototype,"node",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qd=ae(Wd.prototype,"_enabled",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yd=ae(Wd.prototype,"__prefab",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kd=Wd))||kd)),op=ip.prototype;op.update=null,op.lateUpdate=null,op.__preload=null,op.onLoad=null,op.start=null,op.onEnable=null,op.onDisable=null,op.onDestroy=null,op.onFocusInEditor=null,op.onLostFocusInEditor=null,op.resetInEditor=null,op._getLocalBounds=null,op.onRestore=null,ip._requireComponent=null,ip._executionOrder=0,Ee(ip,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),s.Component=ip;var rp=e("fB",b_("cc.MissingScript")(Zd=H_()((ep=function(e){function t(){var t;return re(t=e.call(this)||this,"_$erialized",$d,ne(t)),t}return ee(t,e),t.safeFindClass=function(e){var t=Ke(e);if(t)return t;s.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){P(4600,this.node.name)},t}(ip),$d=ae((Jd=ep).prototype,"_$erialized",[M_,L_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zd=Jd))||Zd)||Zd);function ap(e,t){var n;n=rp.safeFindClass;var i,o=yd.pool.get();try{i=Nd(e,o,{classFinder:n,customEnv:t})}catch(e){throw y(e),yd.pool.put(o),e}i._uuid=t.__uuid__||"";for(var r=o.uuidList,a=o.uuidObjList,s=o.uuidPropList,c=o.uuidTypeList||[],l=[],u=0;u<r.length;u++){var h=r[u];l[u]={uuid:Af(h),owner:a[u],prop:s[u],type:et._getClassById(c[u])}}return i.__depends__=l,i._native&&(i.__nativeDepend__=!0),yd.pool.put(o),i}s._MissingScript=rp;var sp,cp=new(function(){function e(){this._depends=new sf}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?$({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,o=null;if(Array.isArray(t)||t.__type__){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var r=ap(t,{__uuid__:e});(o=this._parseDepsFromAsset(r)).nativeDep&&(o.nativeDep.uuid=e),_f.add(e+"@import",r)}catch(t){hf.remove(e+"@import"),o={deps:[]}}else o={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(o=this._depends.get(e)).parsedFromExistAsset)return o;o=this._parseDepsFromAsset(t)}return this._depends.add(e,o),o},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=e.__depends__,i=0,o=n.length;i<o;i++)t.deps.push(n[i].uuid);return e.__nativeDepend__&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=null;return(t=function(e){var t=e[1];return e[10].map((function(e){return t[e]}))}(e)).forEach((function(e,n){return t[n]=Af(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),o=0;o<i.length;o++){var r=i[o];t[r]||(t[r]=!0,n.push(r),this._descend(r,t,n))}},e}()),lp=[new gs];function up(e){return e&&0==(e&e-1)}var hp,_p,fp,dp,pp,mp,vp=b_("cc.SimpleTexture")(sp=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t}ee(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var o=lp[0];o.texExtent.width=this._textureWidth>>t,o.texExtent.height=this._textureHeight>>t,o.texSubres.mipLevel=t,o.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,lp):i.copyTexImagesToTexture([e],this._gfxTexture,lp)}}},n._assignImage=function(e,t,n){var i=this,o=function(){var o=e.data;if(o&&(i.uploadData(o,t,n),i._checkTextureLoaded(),st.CLEANUP_IMAGE_CACHE)){var r=cp.getDeps(i._uuid),a=r.indexOf(e._uuid);-1!==a&&(le(r,a),e.decRef())}};if(e.loaded)o();else{if(e.once("load",(function(){o()})),!this.isCompressed){var r=s.builtinResMgr.get("black-texture").image;this.uploadData(r.data,t,n)}s.assetManager.postLoadNative(e)}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=La.NONE;this._mipFilter!==Hf.NONE&&function(e,t,n){return!(e.gfxAPI===Ta.WEBGL)||up(t)&&up(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=La.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Ma.SAMPLED|Ma.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t|La.IMMUTABLE});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},J(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(pd))||sp;s.SimpleTexture=vp;var gp,yp,xp,Ep,Sp,Tp,Ap=e("bB",(hp=b_("cc.Texture2D"),_p=rf([Xf]),hp((mp=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",pp,ne(t)),t}ee(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.create=function(e,t,n,i){void 0===n&&(n=Bf.RGBA8888),void 0===i&&(i=1),this.reset({width:e,height:t,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var o=e+i;this._assignImage(this._mipmaps[o],o)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var o=0;o<i.mipmaps.length;++o)if(this._mipmaps[o]=new Xf,i.mipmaps[o]){var r=i.mipmaps[o];n.result.push(this._mipmaps,""+o,r,et._getClassId(Xf)),this._mipmaps[o]._texture=this}},n._getGfxTextureCreateInfo=function(e){var t=new Is(Da.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)},n._checkTextureLoaded=function(){for(var t=!0,n=0;n<this._mipmaps.length;++n)if(!this._mipmaps[n].loaded){t=!1;break}t&&e.prototype._textureReady.call(this)},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Xf;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},J(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(vp),pp=ae((dp=mp).prototype,"_mipmaps",[_p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fp=dp))||fp));s.Texture2D=Ap,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(Tp||(Tp={}));var wp=e("eQ",b_("cc.TextureCube")((Sp=Ep=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",xp,ne(t)),t}ee(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],o=e.length/6,r=0;r<o;r++){var a=6*r;i.push({front:e[a+Tp.front].image,back:e[a+Tp.back].image,left:e[a+Tp.left].image,right:e[a+Tp.right].image,top:e[a+Tp.top].image,bottom:e[a+Tp.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),o=function(t){var i=e+t;Cp(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},r=0;r<i;++r)o(r)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var o=0;o<i.mipmaps.length;++o){this._mipmaps[o]={front:new Xf,back:new Xf,left:new Xf,right:new Xf,top:new Xf,bottom:new Xf};var r=i.mipmaps[o],a=et._getClassId(Xf);n.result.push(this._mipmaps[o],"front",r.front,a),n.result.push(this._mipmaps[o],"back",r.back,a),n.result.push(this._mipmaps[o],"left",r.left,a),n.result.push(this._mipmaps[o],"right",r.right,a),n.result.push(this._mipmaps[o],"top",r.top,a),n.result.push(this._mipmaps[o],"bottom",r.bottom,a)}},n._getGfxTextureCreateInfo=function(e){var t=new Is(Da.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Xf;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},J(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){Cp(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(vp),Ep.FaceIndex=Tp,xp=ae((yp=Sp).prototype,"_mipmaps",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gp=yp))||gp);function Cp(e,t){t(e.front,Tp.front),t(e.back,Tp.back),t(e.left,Tp.left),t(e.right,Tp.right),t(e.top,Tp.top),t(e.bottom,Tp.bottom)}s.TextureCube=wp;var Ip,Pp,bp,Rp=e("fC",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:456146524,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:50,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:1062464958,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0}]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:3946667351,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:932177378,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:293909391,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:3802928649,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:2041444135,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color2",type:16,count:1,defines:["TWO_COLORED"],stageFlags:1,format:44,location:3}]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1142786345,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:632993342,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:1518991842,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:179,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:22},globals:{blocks:[{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:2532494361,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:64,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:55},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3874167763,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:62,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3579616855,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:195,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:4181944545,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:53},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_gbuffer_albedoMap",defines:[]},{name:"cc_gbuffer_positionMap",defines:[]},{name:"cc_gbuffer_normalMap",defines:[]},{name:"cc_gbuffer_emissiveMap",defines:[]}]},locals:{blocks:[{name:"CCForwardLight",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_USE_FOG",type:"number",range:[0,4]}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:3940098901,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:210,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:53},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:2054814724,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:145,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_lighting_resultMap",defines:[]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7}]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:553035852,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:3108604430,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:58,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},precent:{value:[.5],type:13,handleInfo:["u_buffer0",2,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,.5,0]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:624029864,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]),Np=4026531840,Op=264241152,Dp=3145728,Mp=1032192;!function(e){e[e.BUFFER=0]="BUFFER",e[e.TEXTURE=1]="TEXTURE"}(bp||(bp={}));var Lp=function(e,t,n,i,o){return void 0===o&&(o=0),e<<28&Np|i<<22&Op|t<<20&Dp|n<<14&Mp|16383&o},Fp=function(e){return(e&Np)>>>28},zp=function(e){return(e&Op)>>>22},Bp=function(e){return(e&Mp)>>>14},Up=function(e){return 16383&e},Hp=function(e,t){return e&~Op|t<<22&Op},Gp=((Ip={})[Pa.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Ip[Pa.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},Ip[Pa.INT2]=function(e,t,n){return void 0===n&&(n=0),kn.fromArray(t,e,n)},Ip[Pa.INT3]=function(e,t,n){return void 0===n&&(n=0),An.fromArray(t,e,n)},Ip[Pa.INT4]=function(e,t,n){return void 0===n&&(n=0),Yn.fromArray(t,e,n)},Ip[Pa.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},Ip[Pa.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),kn.fromArray(t,e,n)},Ip[Pa.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),An.fromArray(t,e,n)},Ip[Pa.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Yn.fromArray(t,e,n)},Ip[Pa.MAT3]=function(e,t,n){return void 0===n&&(n=0),Pn.fromArray(t,e,n)},Ip[Pa.MAT4]=function(e,t,n){return void 0===n&&(n=0),Un.fromArray(t,e,n)},Ip),Vp=((Pp={})[Pa.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Pp[Pa.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Pp[Pa.INT2]=function(e,t,n){return void 0===n&&(n=0),kn.toArray(e,t,n)},Pp[Pa.INT3]=function(e,t,n){return void 0===n&&(n=0),An.toArray(e,t,n)},Pp[Pa.INT4]=function(e,t,n){return void 0===n&&(n=0),Yn.toArray(e,t,n)},Pp[Pa.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Pp[Pa.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),kn.toArray(e,t,n)},Pp[Pa.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),An.toArray(e,t,n)},Pp[Pa.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Yn.toArray(e,t,n)},Pp[Pa.MAT3]=function(e,t,n){return void 0===n&&(n=0),Pn.toArray(e,t,n)},Pp[Pa.MAT4]=function(e,t,n){return void 0===n&&(n=0),Un.toArray(e,t,n)},Pp),kp=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Wp(e){switch(e){case Pa.BOOL:case Pa.INT:case Pa.UINT:case Pa.FLOAT:return kp[0];case Pa.BOOL2:case Pa.INT2:case Pa.UINT2:case Pa.FLOAT2:return kp[1];case Pa.BOOL4:case Pa.INT4:case Pa.UINT4:case Pa.FLOAT4:return kp[2];case Pa.MAT4:return kp[3];case Pa.SAMPLER2D:return"default-texture";case Pa.SAMPLER_CUBE:return"default-cube-texture"}return kp[0]}function jp(e,t){for(var n=Object.entries(t),i=!1,o=0;o<n.length;o++)e[n[o][0]]!==n[o][1]&&(e[n[o][0]]=n[o][1],i=!0);return i}var qp=new Qs;function Yp(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Xp(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function Kp(e,t,n,i,o){for(var r=e.builtins[i],a=[],s=function(e){var t=r.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&sc))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";a.push(i),o&&!o.includes(s)&&o.push(s)},c=0;c<r.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.gfxBlocks,a);for(var l=[],u=function(e){var t=r.samplerTextures[e],i=n.layouts[t.name],a=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&a&&a.descriptorType&cc))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),o&&!o.includes(a)&&o.push(a)},h=0;h<r.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.gfxSamplerTextures,l),o&&o.sort((function(e,t){return e.binding-t.binding}))}function Qp(e){return e.members.reduce((function(e,t){return e+pc(t.type)*t.count}),0)}function Zp(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function Jp(e){switch(e.gfxAPI){case Ta.GLES2:case Ta.WEBGL:return"glsl1";case Ta.GLES3:case Ta.WEBGL2:return"glsl3";default:return"glsl4"}}var $p=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=$({},e),i=0,o=function(e){var t=n.defines[e],o=1;if("number"===t.type){var r=t.range;o=Yp(r[1]-r[0]+1),t._map=function(e){return e-r[0]}}else"string"===t.type?(o=Yp(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=o},r=0;r<n.defines.length;r++)o(r);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.gfxBlocks=[],s.gfxSamplerTextures=[],s.bindings=[],s.blockSizes=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(Qp(l)),s.bindings.push(new Ks(l.binding,l.descriptorType||ts.UNIFORM_BUFFER,1,l.stageFlags)),s.gfxBlocks.push(new Ns(Ku.MATERIAL,l.binding,l.name,l.members.map((function(e){return new Rs(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new Ks(h.binding,h.descriptorType||ts.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.gfxSamplerTextures.push(new Os(Ku.MATERIAL,h.binding,h.name,h.type,h.count))}s.gfxAttributes=[];for(var _=0;_<n.attributes.length;_++){var f=n.attributes[_];s.gfxAttributes.push(new Us(f.name,f.format,f.isNormalized,0,f.isInstanced,f.location))}Kp(n,s,ju,"locals"),s.gfxStages=[],s.gfxStages.push(new Bs(Wa.VERTEX,"")),s.gfxStages.push(new Bs(Wa.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],o=i.members,r=0,a=0;a<o.length;a++){var s=o[a];t[s.name]=Lp(bp.BUFFER,Ku.MATERIAL,i.binding,s.type,r),r+=(pc(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=Lp(bp.TEXTURE,Ku.MATERIAL,l.binding,l.type)}return t}(n),s.hPipelineLayout=To,s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],o=this._templateInfos[i.hash];return o.setLayouts.length||(qp.bindings=o.bindings,o.setLayouts[Ku.MATERIAL]=e.createDescriptorSetLayout(qp),qp.bindings=ju.bindings,o.setLayouts[Ku.LOCAL]=e.createDescriptorSetLayout(qp)),o.setLayouts[n?Ku.LOCAL:Ku.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var o="",r=0;r<i.length;r++){var a=i[r],s=t[a.name];if(s&&a._map){var c=a._map(s);o+=""+a._offset+c+"|"}}return""+o+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=t[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),o=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(Ao.get(t._cache[e]).name)}))})),r=0;r<o.length;r++){var a=o[r],s=Ao.get(this._cache[a]);console.log("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,n,i,o){Object.assign(n,i.macros),o||(o=this.getKey(t,n));var r=this._cache[o];if(r)return r;var a=this._templates[t],s=this._templateInfos[a.hash];s.hPipelineLayout||(this.getDescriptorSetLayout(e,t),Kp(a,s,Wu,"globals"),s.setLayouts[Ku.GLOBAL]=i.descriptorSetLayout,s.hPipelineLayout=Io.alloc(e,new Js(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var o=t[i],r=o.name,a=e[r],s=Xp(o,a),c=!a||"0"===a;n.push({name:r,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=a.glsl3,h=Jp(e);h?u=a[h]:console.error("Invalid GFX API!"),s.gfxStages[0].source=l+u.vert,s.gfxStages[1].source=l+u.frag;var _=function(e,t,n){for(var i=[],o=e.attributes,r=t.gfxAttributes,a=0;a<o.length;a++)Zp(o[a].defines,n)&&i.push(r[a]);return i}(a,s,n),f=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),d=new Hs(f,s.gfxStages,_,s.gfxBlocks);return d.samplerTextures=s.gfxSamplerTextures,this._cache[o]=Ao.alloc(e,d)},e}());s.programLib=$p;var em,tm,nm,im={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 rotation = a_rotation_uv.xyz;\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nrotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nrotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = rotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., rotation.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_texCoord.x\n#endif\n);\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nuniform lowp vec4 cc_shadowColor;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor *= v_color;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * pbrParams.w) * normalize(v_tangent) +\n(nmmp.y * pbrParams.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nuniform lowp vec4 cc_shadowColor;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture2D(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nuniform lowp vec4 cc_shadowColor;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture2D(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture2D(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture2D(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\ngl_FragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nvarying vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 rotation = a_rotation_uv.xyz;\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nrotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nrotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = rotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., rotation.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_texCoord.x\n#endif\n);\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nin float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor *= v_color;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * pbrParams.w) * normalize(v_tangent) +\n(nmmp.y * pbrParams.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin float v_fog_factor;\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nin vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nlayout(location = 0) out vec4 fragColor;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\nfragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout float v_percent;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nin float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},om=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;var n=this._resources,i=document.createElement("canvas"),o=i.getContext("2d"),r=new Xf(i),a=i.width=i.height=2;o.fillStyle="#000",o.fillRect(0,0,a,a);var c=new Ap;c._uuid="black-texture",c.image=r,n[c._uuid]=c,o.fillStyle="rgba(0,0,0,0)",o.fillRect(0,0,a,a);var l=new Ap;l._uuid="empty-texture",l.image=r,n[l._uuid]=l;var u=new wp;u._uuid="black-cube-texture",u.setMipFilter(wp.Filter.NEAREST),u.image={front:new Xf(i),back:new Xf(i),left:new Xf(i),right:new Xf(i),top:new Xf(i),bottom:new Xf(i)},n[u._uuid]=u,o.fillStyle="#777",o.fillRect(0,0,a,a);var h=new Ap;h._uuid="grey-texture",h.image=r,n[h._uuid]=h,o.fillStyle="#fff",o.fillRect(0,0,a,a);var _=new Ap;_._uuid="white-texture",_.image=r,n[_._uuid]=_;var f=new wp;f._uuid="white-cube-texture",f.setMipFilter(wp.Filter.NEAREST),f.image={front:new Xf(i),back:new Xf(i),left:new Xf(i),right:new Xf(i),top:new Xf(i),bottom:new Xf(i)},n[f._uuid]=f,o.fillStyle="#7f7fff",o.fillRect(0,0,a,a);var d=new Ap;d._uuid="normal-texture",d.image=r,n[d._uuid]=d,i.width=i.height=16,o.fillStyle="#ddd",o.fillRect(0,0,16,16),o.fillStyle="#555",o.fillRect(0,0,8,8),o.fillStyle="#555",o.fillRect(8,8,8,8);var p=new Ap;p._uuid="default-texture",p.image=r,n[p._uuid]=p;var m=new wp;if(m.setMipFilter(wp.Filter.NEAREST),m._uuid="default-cube-texture",m.image={front:new Xf(i),back:new Xf(i),left:new Xf(i),right:new Xf(i),top:new Xf(i),bottom:new Xf(i)},n[m._uuid]=m,s.SpriteFrame){var v=new s.SpriteFrame,g=r._texture;v.texture=g,v._uuid="default-spriteframe",n[v._uuid]=v}var y=Jp(e);if(!y)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var x=im[y];return x?Promise.resolve().then((function(){Rp.forEach((function(e,t){var n=Object.assign(new s.EffectAsset,e);n.shaders.forEach((function(e,n){var i=x[t][n];i&&(e[y]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+y+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new s.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var i=new s.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",s.color("#ffff00")),e[i._uuid]=i,t.push(i);var o=new s.Material;o._uuid="missing-material",o.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),o.setProperty("mainColor",s.color("#ff00ff")),e[o._uuid]=o,t.push(o);var r=new s.Material;r._uuid="default-clear-stencil",r.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[r._uuid]=r,t.push(r);var a=new s.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[a._uuid]=a,t.push(a);var c=new s.Material;c._uuid="ui-sprite-material",c.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var l=new s.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[l._uuid]=l,t.push(l);var u=new s.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var h=new s.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var _=new s.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[_._uuid]=_,t.push(_);var f=new s.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),e[f._uuid]=f,t.push(f);var d=new s.Material;d._uuid="default-particle-material",d.initialize({effectName:"particle"}),e[d._uuid]=d,t.push(d);var p=new s.Material;p._uuid="default-particle-gpu-material",p.initialize({effectName:"particle-gpu"}),e[p._uuid]=p,t.push(p);var m=new s.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);var v=new s.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),e[v._uuid]=v,t.push(v);var g=new s.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[g._uuid]=g,t.push(g);var y=new s.Material;y._uuid="builtin-deferred-material",y.initialize({effectName:"deferred-lighting"}),e[y._uuid]=y,t.push(y);var x=new s.Material;x._uuid="builtin-post-process-material",x.initialize({effectName:"post-process"}),e[x._uuid]=x,t.push(x),s.game.on(s.Game.EVENT_RENDERER_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),rm=e("c2",s.builtinResMgr=new om),am=e("fr",(em=new Map,tm=0,function(e){return"number"==typeof e?e:(em.has(e)||(em.set(e,1<<tm),tm++),em.get(e))})),sm=new Ss(ba.UNIFORM|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE),cm=new Ts(null),lm=new Zs(null);!function(e){e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(nm||(nm={}));var um=e("dp",function(){function e(e){this._rootBuffer=null,this._rootBufferDirty=!1,this._buffers=[],this._descriptorSet=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._root=void 0,this._device=void 0,this._hShaderDefault=To,this._handle=To,this._bs=new Oc,this._dss=new Rc,this._rs=new bc,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){var n=e.handle;void 0!==t.priority&&Ho.set(n,So.PRIORITY,t.priority),void 0!==t.primitive&&Ho.set(n,So.PRIMITIVE,t.primitive),void 0!==t.stage&&Ho.set(n,So.STAGE,t.stage),void 0!==t.dynamicStates&&Ho.set(n,So.DYNAMIC_STATES,t.dynamicStates),void 0!==t.phase&&Ho.set(n,So.PHASE,am(t.phase));var i=e._bs;if(t.blendState){var o=t.blendState,r=o.targets;r&&r.forEach((function(e,t){i.setTarget(t,e)})),void 0!==o.isA2C&&(i.isA2C=o.isA2C),void 0!==o.isIndepend&&(i.isIndepend=o.isIndepend),void 0!==o.blendColor&&(i.blendColor=o.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e,t){var n,i=e.handle,o=t+","+Ho.get(i,So.PRIMITIVE)+","+Ho.get(i,So.DYNAMIC_STATES);return o+=function(e){for(var t,n=",bs,"+e.isA2C,i=oe(e.targets);!(t=i()).done;){var o=t.value;n+=",bt,"+o.blend+","+o.blendEq+","+o.blendAlphaEq+","+o.blendColorMask,n+=","+o.blendSrc+","+o.blendDst+","+o.blendSrcAlpha+","+o.blendDstAlpha}return n}(e._bs),o+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),Ac(o+=",rs,"+(n=e._rs).cullMode+","+n.depthBias+","+n.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=Pa.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=Hp(i,n):t&&(i=Hp(i,zp(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),o=e.getTypeFromHandle(t),r=e.getOffsetFromHandle(t),a=this._blocks[i];Vp[o](a,n,r),this._rootBufferDirty=!0},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),o=e.getTypeFromHandle(t),r=e.getOffsetFromHandle(t),a=this._blocks[i];return Gp[o](a,n,r)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),o=e.getTypeFromHandle(t),r=pc(o)>>2,a=this._blocks[i],s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=r)null!==n[c]&&Vp[o](a,n[c],s);this._rootBufferDirty=!0},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t.update=function(){this._rootBufferDirty&&this._rootBuffer&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBlock=null),this._descriptorSet=null,this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._handle&&(wo.free(Ho.get(this._handle,So.DESCRIPTOR_SET)),Ho.free(this._handle),this._handle=To)},t.resetUniform=function(t){var n=this.getHandle(t);if(n){var i=e.getTypeFromHandle(n),o=e.getBindingFromHandle(n),r=e.getOffsetFromHandle(n),a=this._blocks[o],s=this._properties[t],c=s&&s.value||Wp(i);Vp[i](a,c,r),this._rootBufferDirty=!0}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var o=e.getTypeFromHandle(i),r=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":Wp(o),l=rm.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?a.samplerHash:l&&l.getSamplerHash(),_=fd.getSampler(this._device,h);this._descriptorSet.bindSampler(r,_,n),this._descriptorSet.bindTexture(r,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=this._blocks[t.binding],i=0,o=0;o<t.members.length;o++){for(var r=t.members[o],a=this._properties[r.name],s=a&&a.value||Wp(r.type),c=(pc(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)n.set(s,i+l);i+=c}this._rootBufferDirty=!0},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;return!!t&&(this._syncBatchingScheme(),this._hShaderDefault=$p.getGFXShader(this._device,this._programName,this._defines,t),this._hShaderDefault?(Ho.set(this._handle,So.PIPELINE_LAYOUT,$p.getTemplateInfo(this._programName).hPipelineLayout),Ho.set(this._handle,So.HASH,e.getPassHash(this,this._hShaderDefault)),!0):(console.warn("create shader "+this._programName+" failed"),!1))},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._hShaderDefault&&!this.tryCompile())return console.warn("pass resources incomplete"),To;if(!e)return this._hShaderDefault;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var o=$p.getGFXShader(this._device,this._programName,this._defines,t),r=0;r<e.length;r++){var a=e[r];delete this._defines[a.name]}return o},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._doInit=function(t,n){void 0===n&&(n=!1);var i=this._handle=Ho.alloc();Ho.set(i,So.PRIORITY,Bu.DEFAULT),Ho.set(i,So.STAGE,zu.DEFAULT),Ho.set(i,So.PHASE,am("default")),Ho.set(i,So.PRIMITIVE,Ka.TRIANGLE_LIST),Ho.set(i,So.RASTERIZER_STATE,this._rs.handle),Ho.set(i,So.DEPTH_STENCIL_STATE,this._dss.handle),Ho.set(i,So.BLEND_STATE,this._bs.handle),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?$({},t.defines):t.defines,this._shaderInfo=$p.getTemplate(t.program),this._properties=t.properties||this._properties;var o=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),lm.layout=$p.getDescriptorSetLayout(this._device,t.program);var r=wo.alloc(this._device,lm);Ho.set(this._handle,So.DESCRIPTOR_SET,r),this._descriptorSet=wo.get(r);for(var a=this._shaderInfo.blocks,s=$p.getTemplateInfo(t.program),c=s.blockSizes,l=s.handleMap,u=o.capabilities.uboOffsetAlignment,h=[],_=0,f=0,d=0;d<a.length;d++){var p=c[d];h.push(f),f+=Math.ceil(p/u)*u,_=p}var m=h[h.length-1]+_;m&&(sm.size=16*Math.ceil(m/16),this._rootBuffer=o.createBuffer(sm),this._rootBlock=new ArrayBuffer(m));for(var v=0,g=0;v<a.length;v++){var y=a[v].binding,x=c[v];cm.buffer=this._rootBuffer,cm.offset=h[g++],cm.range=16*Math.ceil(x/16);var E=this._buffers[y]=o.createBuffer(cm);this._blocks[y]=new Float32Array(this._rootBlock,cm.offset,x/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(y,E)}var S=this._propertyHandleMap=l,T={};for(var A in this._properties){var w=this._properties[A];w.handleInfo&&(T[A]=this.getHandle.apply(this,w.handleInfo))}Object.assign(S,T)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(wa.INSTANCED_ARRAYS)?Ho.set(this._handle,So.BATCHING_SCHEME,nm.INSTANCING):(this._defines.USE_INSTANCING=!1,Ho.set(this._handle,So.BATCHING_SCHEME,0)):this._defines.USE_BATCHING?Ho.set(this._handle,So.BATCHING_SCHEME,nm.VB_MERGING):Ho.set(this._handle,So.BATCHING_SCHEME,0)},t._destroyHandle=function(){this._handle&&(Ho.free(this._handle),this._handle=To)},t._initPassFromTarget=function(e,t,n,i){Ho.set(this.handle,So.PRIORITY,e.priority),Ho.set(this.handle,So.STAGE,e.stage),Ho.set(this.handle,So.PHASE,e.phase),Ho.set(this.handle,So.BATCHING_SCHEME,e.batchingScheme),Ho.set(this.handle,So.PRIMITIVE,e.primitive),Ho.set(this.handle,So.DYNAMIC_STATES,e.dynamicStates),this._descriptorSet=e.descriptorSet,Ho.set(this.handle,So.DESCRIPTOR_SET,Ho.get(e.handle,So.DESCRIPTOR_SET)),this._bs=n,Ho.set(this.handle,So.BLEND_STATE,n.handle),this._rs=e.rasterizerState,Ho.set(this.handle,So.RASTERIZER_STATE,Ho.get(e.handle,So.RASTERIZER_STATE)),this._dss=t,Ho.set(this.handle,So.DEPTH_STENCIL_STATE,t.handle),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._dynamics=e._dynamics,this._hShaderDefault=e._hShaderDefault,Ho.set(this._handle,So.PIPELINE_LAYOUT,$p.getTemplateInfo(this._programName).hPipelineLayout);var o=Ho.get(e.handle,So.HASH);Ho.set(this._handle,So.HASH,o^i)},J(e,[{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return $p.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"handle",get:function(){return this._handle}},{key:"priority",get:function(){return Ho.get(this._handle,So.PRIORITY)}},{key:"primitive",get:function(){return Ho.get(this._handle,So.PRIMITIVE)}},{key:"stage",get:function(){return Ho.get(this._handle,So.STAGE)}},{key:"phase",get:function(){return Ho.get(this._handle,So.PHASE)}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return Ho.get(this._handle,So.DYNAMIC_STATES)}},{key:"batchingScheme",get:function(){return Ho.get(this._handle,So.BATCHING_SCHEME)}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return Ho.get(this._handle,So.HASH)}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}}]),e}());um.PropertyType=bp,um.getPropertyTypeFromHandle=Fp,um.getTypeFromHandle=zp,um.getBindingFromHandle=Bp,um.getOffsetFromHandle=Up,W(x_.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),W(x_.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var hm={};W(hm,"CameraVisFlags",[{name:"GENERAL"}]),k(hm,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Fu.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Fu.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Fu.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Fu.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Fu.BitMask,targetName:"UI_2D"}]),s.CameraVisFlags=hm;var _m,fm={};function dm(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),o=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),r=2*i-8*o+4,a=3*i/r,s=2*o/r,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}W(fm,"VisibilityFlags",[{name:"GENERAL"}]),k(fm,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Fu.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Fu.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Fu.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Fu.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Fu.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Fu.Enum,targetName:"UI_2D"}]),s.VisibilityFlags=fm,k(um.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),W(y_.prototype,"Camera.prototype",[{name:"getSplitFrustum"}]),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(_m||(_m=e("cg",{})));var pm=e("cp",(function(e){return 4*Math.PI*Math.PI*e*e})),mm=e("cj",function(){function e(){this._baked=!1,this._color=new An(1,1,1),this._colorTemp=6550,this._colorTempRGB=new An(1,1,1),this._scene=null,this._node=null,this._name=null,this._handle=To}var t=e.prototype;return t.initialize=function(){this._handle=Mr.alloc(),Mr.setVec3(this._handle,br.COLOR,this._color),Mr.setVec3(this._handle,br.COLOR_TEMPERATURE_RGB,this._colorTempRGB),Mr.set(this._handle,br.TYPE,_m.UNKNOWN)},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._handle&&(Mr.free(this._handle),this._handle=To)},t.update=function(){},J(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),Mr.setVec3(this._handle,br.COLOR,e)}},{key:"useColorTemperature",get:function(){return 1===Mr.get(this._handle,br.USE_COLOR_TEMPERATURE)},set:function(e){Mr.set(this._handle,br.USE_COLOR_TEMPERATURE,e?1:0)}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,dm(this._colorTempRGB,this._colorTemp),Mr.setVec3(this._handle,br.COLOR_TEMPERATURE_RGB,this._colorTempRGB)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=u_.ROTATION,Mr.set(this._handle,br.NODE,this._node.handle))}},{key:"type",get:function(){return Mr.get(this._handle,br.TYPE)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"handle",get:function(){return this._handle}}]),e}()),vm=new An(0,0,-1),gm=new An,ym=e("cn",function(e){function t(){var t;return(t=e.call(this)||this)._dir=new An(1,-1,-1),t}ee(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),Mr.set(this._handle,br.ILLUMINANCE,ea.SUN_ILLUM),Mr.setVec3(this._handle,br.DIRECTION,this._dir),Mr.set(this._handle,br.TYPE,_m.DIRECTIONAL)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=An.transformQuat(gm,vm,this._node.worldRotation))},J(t,[{key:"direction",get:function(){return this._dir},set:function(e){An.normalize(this._dir,e),Mr.setVec3(this._handle,br.DIRECTION,this._dir)}},{key:"illuminance",get:function(){return Mr.get(this._handle,br.ILLUMINANCE)},set:function(e){Mr.set(this._handle,br.ILLUMINANCE,e)}}]),t}(mm));function xm(e,t){for(var n,i=oe(t);!(n=i()).done;){var o=n.value;Array.isArray(o)?xm(e,o):e.push(o)}}function Em(e){var t=[];return xm(t,e),t.join("")}var Sm=ri.Flags.Destroyed,Tm=ri.Flags.PersistentMask,Am=Kt.IDENTIFIER_RE,wm="var ",Cm="o",Im={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},Pm=Kt.escapeForJS,bm=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return wm+this.varName+"="+this.expression+";"},e}();function Rm(e,t){return t instanceof bm?new bm(t.varName,e+t.expression):e+t}function Nm(e,t,n){Array.isArray(n)?(n[0]=Rm(t,n[0]),e.push(n)):e.push(Rm(t,n)+";")}var Om=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];Nm(e,t+Dm(i[0])+"=",i[1])}},e}();function Dm(e){return Am.test(e)?"."+e:"["+Pm(e)+"]"}Om.pool=void 0,Om.pool=new Je((function(e){e._exps.length=0,e._targetExp=null}),1),Om.pool.get=function(e){var t=this._get()||new Om;return t._targetExp=e,t};var Mm=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=we(),Fe(this.funcModuleCache,Im),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=wm+this.globalVariables.join(",")+";");var i=Em(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var o=0,r=this.objsToClear_iN$t.length;o<r;++o)this.objsToClear_iN$t[o]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=Ce(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var o=-1!==n.indexOf(".");if(o)try{if(o=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var r=this.funcs.indexOf(e);r<0&&(r=this.funcs.length,this.funcs.push(e));var a="F["+r+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var o=Om.pool.get(i),r=t.constructor.__props__;r||(r=Object.keys(t));for(var a=0;a<r.length;a++){var s=r[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);o.append(s,l)}}o.writeCode(e),Om.pool.put(o)},t.enumerateCCClass=function(e,t,n){for(var i=n.__values__,o=Ct(n),r=0;r<i.length;r++){var a=i[r],c=t[a],l=o[a+"$_$default"];if(!Lm(l,c))if("object"==typeof c&&c instanceof s.ValueType&&(l=Kt.getDefault(l))&&l.constructor===c.constructor){var u=Cm+Dm(a);this.setValueType(e,l,c,u)}else this.setObjProp(e,t,a,c)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new bm(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)Nm(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new bm(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var o=0;o<e.length;++o)0!==e[o]&&Nm(i,n+"["+o+"]=",e[o]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var o=i.globalVar;if(!o){o=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(o);var r=i.source[0];i.source[0]=Rm(o+"=",r)}return o}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?Pm(n):("_objFlags"===t&&e instanceof ri&&(n&=Tm),n)},t.setObjProp=function(e,t,n,i){Nm(e,Cm+Dm(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if(s.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var o=t[i];"object"==typeof o&&o&&o===t._iN$t||this.setObjProp(e,t,i,o)}},t.instantiateObj=function(e){if(e instanceof s.ValueType)return Kt.getNewValueTypeCode(e);if(e instanceof s.Asset)return this.getObjRef(e);if(e._objFlags&Sm)return null;var t,n=e.constructor;if(s.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof s.Component){if(e instanceof s._BaseNode||e instanceof s.Component)return this.getObjRef(e)}else if(this.parent instanceof s._BaseNode)if(e instanceof s._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof s.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new bm(Cm,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new bm(Cm,"{}");else{if(n)return this.getObjRef(e);t=new bm(Cm,"Object.create(null)")}var i=[t];return e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e),this.enumerateObject(i,e),["(function(){",i,"return o;})();"]},e}();function Lm(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof s.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return ye(e)&&ye(t)}return!1}var Fm,zm=function(){function e(e){this._uiComp=null,this.opacity=1,this.localOpacity=1,this._uiTransformComp=null,this._node=void 0,this._node=e}return J(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?P(12002):this._uiComp=e}}]),e}();!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(Fm||(Fm=e("c_",{}))),rt(Fm),s.SystemEventType=Fm;var Bm=function(){function e(e,t,n){this._cameraPriority=0,this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=n,this._type=e||0,this._listenerID=t||""}e.create=function(e){D(e&&e.event,1900);var t=e.event;delete e.event;var n=null;if(t===s.EventListener.TOUCH_ONE_BY_ONE?n=new Gm:t===s.EventListener.TOUCH_ALL_AT_ONCE?n=new Vm:t===s.EventListener.MOUSE?n=new Hm:t===s.EventListener.KEYBOARD?n=new Wm:t===s.EventListener.ACCELERATION&&(n=new km(e.callback),delete e.callback),n)for(var i=0,o=Object.keys(e);i<o.length;i++){var r=o[i];n[r]=e[r]}return n};var t=e.prototype;return t._setPaused=function(e){this._paused=e},t._isPaused=function(){return this._paused},t._setRegistered=function(e){this._registered=e},t._isRegistered=function(){return this._registered},t._getType=function(){return this._type},t._getListenerID=function(){return this._listenerID},t._setFixedPriority=function(e){this._fixedPriority=e},t._getFixedPriority=function(){return this._fixedPriority},t._setSceneGraphPriority=function(e){this._target=e,this._node=e},t._getSceneGraphPriority=function(){return this._node},t.checkAvailable=function(){return null!==this._onEvent},t.clone=function(){return null},t.setEnabled=function(e){this._isEnabled=e},t.isEnabled=function(){return this._isEnabled},J(e,[{key:"onEvent",get:function(){return this._onEvent}}]),e}();Bm.UNKNOWN=0,Bm.TOUCH_ONE_BY_ONE=1,Bm.TOUCH_ALL_AT_ONCE=2,Bm.KEYBOARD=3,Bm.MOUSE=4,Bm.ACCELERATION=6,Bm.CUSTOM=8,Bm.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var Um=Bm.ListenerID,Hm=function(e){function t(){var t;return(t=e.call(this,Bm.MOUSE,Um.MOUSE,null)||this).onMouseDown=null,t.onMouseUp=null,t.onMouseMove=null,t.onMouseScroll=null,t._onEvent=function(e){return t._callback(e)},t}ee(t,e);var n=t.prototype;return n._callback=function(e){switch(e.eventType){case Fm.MOUSE_DOWN:this.onMouseDown&&this.onMouseDown(e);break;case Fm.MOUSE_UP:this.onMouseUp&&this.onMouseUp(e);break;case Fm.MOUSE_MOVE:this.onMouseMove&&this.onMouseMove(e);break;case Fm.MOUSE_WHEEL:this.onMouseScroll&&this.onMouseScroll(e)}},n.clone=function(){var e=new t;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e},n.checkAvailable=function(){return!0},t}(Bm),Gm=function(e){function t(){var t;return(t=e.call(this,Bm.TOUCH_ONE_BY_ONE,Um.TOUCH_ONE_BY_ONE,null)||this).swallowTouches=!1,t.onTouchBegan=null,t.onTouchMoved=null,t.onTouchEnded=null,t.onTouchCancelled=null,t._claimedTouches=[],t}ee(t,e);var n=t.prototype;return n.setSwallowTouches=function(e){this.swallowTouches=e},n.isSwallowTouches=function(){return this.swallowTouches},n.clone=function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e},n.checkAvailable=function(){return!!this.onTouchBegan||(C(1801),!1)},t}(Bm),Vm=function(e){function t(){var t;return(t=e.call(this,Bm.TOUCH_ALL_AT_ONCE,Um.TOUCH_ALL_AT_ONCE,null)||this).onTouchesBegan=null,t.onTouchesMoved=null,t.onTouchesEnded=null,t.onTouchesCancelled=null,t}ee(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e},n.checkAvailable=function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(C(1802),!1)},t}(Bm),km=function(e){function t(t){var n;return(n=e.call(this,Bm.ACCELERATION,Um.ACCELERATION,null)||this)._onAccelerationEvent=null,n._onEvent=function(e){return n._callback(e)},n._onAccelerationEvent=t,n}ee(t,e);var n=t.prototype;return n._callback=function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)},n.checkAvailable=function(){return D(this._onAccelerationEvent,1803),!0},n.clone=function(){return new t(this._onAccelerationEvent)},t}(Bm),Wm=function(e){function t(){var t;return(t=e.call(this,Bm.KEYBOARD,Um.KEYBOARD,null)||this).onKeyPressed=null,t.onKeyReleased=null,t._onEvent=function(e){return t._callback(e)},t}ee(t,e);var n=t.prototype;return n._callback=function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)},n.clone=function(){var e=new t;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e},n.checkAvailable=function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(C(1800),!1)},t}(Bm);s.EventListener=Bm;var jm=Bm.ListenerID,qm=function(){function e(){this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}var t=e.prototype;return t.size=function(){return this._fixedListeners.length+this._sceneGraphListeners.length},t.empty=function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length},t.push=function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)},t.clearSceneGraphListeners=function(){this._sceneGraphListeners.length=0},t.clearFixedListeners=function(){this._fixedListeners.length=0},t.clear=function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0},t.getFixedPriorityListeners=function(){return this._fixedListeners},t.getSceneGraphPriorityListeners=function(){return this._sceneGraphListeners},e}(),Ym=function(){function e(){this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners={},this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}var t=e.prototype;return t.pauseTarget=function(e,t){if(void 0===t&&(t=!1),e instanceof s._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var i=0;i<n.length;++i)n[i]._setPaused(!0);if(!0===t){var o=e.children;if(o)for(var r=0;r<o.length;++r){var a=o[r];this.pauseTarget(a,!0)}}}else P(3506)},t.resumeTarget=function(e,t){if(void 0===t&&(t=!1),e instanceof s._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var i=0;i<n.length;++i)n[i]._setPaused(!1);if(this._setDirtyForNode(e),!0===t&&e.children.length>0){var o=e.children;if(o)for(var r=0;r<o.length;++r){var a=o[r];this.resumeTarget(a,!0)}}}else P(3506)},t.frameUpdateListeners=function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var n in e)e[n].empty()&&(delete t[n],delete e[n]);var i=this._toAddedListeners;if(0!==i.length){for(var o=0,r=i.length;o<r;o++)this._forceAddEventListener(i[o]);i.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()},t.hasEventListener=function(e){return!!this._getListeners(e)},t.addListener=function(e,t){if(D(e&&t,3503),!(s.js.isNumber(t)||t instanceof s._BaseNode))return P(3506),null;if(e instanceof s.EventListener){if(e._isRegistered())return C(3505),null}else D(!s.js.isNumber(t),3504),e=s.EventListener.create(e);if(!e.checkAvailable())return null;if(s.js.isNumber(t)){if(0===t)return C(3500),null;e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!(n=t)||!n.getComponent("cc.UITransform"))return C(3512),null;e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}var n;return e},t.addCustomListener=function(e,t){var n=Bm.create({event:s.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(n,1),n},t.removeListener=function(e){if(null!=e){var t=!1,n=this._listenersMap;for(var i in e===this._currentTouchListener&&(this._currentTouchListener=this._currentTouch=null),n){var o=n[i],r=o.getFixedPriorityListeners(),a=o.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(a,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(r,e))&&this._setDirty(e._getListenerID(),1),o.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete n[i]),t)break}if(!t)for(var c=this._toAddedListeners,l=c.length-1;l>=0;l--){var u=c[l];if(u===e){s.js.array.removeAt(c,l),u._setRegistered(!1);break}}}},t.removeListeners=function(e,t){if(void 0===t&&(t=!1),s.js.isNumber(e)||e instanceof s._BaseNode)if(void 0!==e._id){var n=this._nodeListenersMap[e._id];if(n){for(var i=s.js.array.copy(n),o=0;o<i.length;++o){var r=i[o];this.removeListener(r)}delete this._nodeListenersMap[e._id]}for(var a=this._toAddedListeners,c=0;c<a.length;){var l=a[c];l._getSceneGraphPriority()===e?(l._setSceneGraphPriority(null),l._setRegistered(!1),a.splice(c,1)):++c}if(!0===t)for(var u=e.getChildren(),h=0;h<u.length;++h){var _=u[h];this.removeListeners(_,!0)}}else e===s.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(jm.TOUCH_ONE_BY_ONE):e===s.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(jm.TOUCH_ALL_AT_ONCE):e===s.EventListener.MOUSE?this._removeListenersForListenerID(jm.MOUSE):e===s.EventListener.ACCELERATION?this._removeListenersForListenerID(jm.ACCELERATION):e===s.EventListener.KEYBOARD?this._removeListenersForListenerID(jm.KEYBOARD):C(3501);else P(3506)},t.removeCustomListeners=function(e){this._removeListenersForListenerID(e)},t.removeAllListeners=function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var n in e)-1===t.indexOf(n)&&this._removeListenersForListenerID(n)},t.setPriority=function(e,t){if(null!=e){var n=this._listenersMap;for(var i in n){var o=n[i].getFixedPriorityListeners();if(o&&-1!==o.indexOf(e))return null!=e._getSceneGraphPriority()&&C(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}},t.setEnabled=function(e){this._isEnabled=e},t.isEnabled=function(){return this._isEnabled},t.dispatchEvent=function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(s.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=Ff,n=e.type;return n===t.ACCELERATION?jm.ACCELERATION:n===t.KEYBOARD?jm.KEYBOARD:n.startsWith(t.MOUSE)?jm.MOUSE:(n.startsWith(t.TOUCH)&&C(2e3),"")}(e);this._sortEventListeners(t);var n=this._listenersMap[t];null!=n&&(this._dispatchEventToListeners(n,this._onListenerCallback,e),this._onUpdateListeners(n)),this._inDispatch--}else R(3511)},t._onListenerCallback=function(e,t){t.currentTarget=e._target;var n=e.onEvent;return n&&n(t),t.isStopped()},t.dispatchCustomEvent=function(e,t){var n=new s.Event.EventCustom(e);n.setUserData(t),this.dispatchEvent(n)},t._setDirtyForNode=function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var n=0,i=t.length;n<i;n++){var o=t[n]._getListenerID();this._dirtyListeners[o]||(this._dirtyListeners[o]=!0)}if(e.children.length>0)for(var r=e.children,a=0,s=r?r.length:0;a<s;a++)this._setDirtyForNode(r[a])},t._addListener=function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)},t._forceAddEventListener=function(e){var t=e._getListenerID(),n=this._listenersMap[t];if(n||(n=new qm,this._listenersMap[t]=n),n.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var i=e._getSceneGraphPriority();null===i&&C(3507),this._associateNodeAndEventListener(i,e),i.activeInHierarchy&&this.resumeTarget(i)}else this._setDirty(t,1)},t._getListeners=function(e){return this._listenersMap[e]},t._updateDirtyFlagForSceneGraph=function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2),e[t]=!1},t._removeAllListenersInVector=function(e){if(e)for(var t,n=e.length-1;n>=0;n--)(t=e[n])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&s.js.array.removeAt(e,n)},t._removeListenersForListenerID=function(e){var t=this._listenersMap[e];if(t){var n=t.getFixedPriorityListeners(),i=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(i),this._removeAllListenersInVector(n),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var o=this._toAddedListeners,r=o.length-1;r>=0;r--){var a=o[r];a&&a._getListenerID()===e&&s.js.array.removeAt(o,r)}},t._sortEventListeners=function(e){var t=0,n=this._priorityDirtyFlagMap;n[e]&&(t=n[e]),0!==t&&(n[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&s.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))},t._sortListenersOfSceneGraphPriority=function(e){var t=this._getListeners(e);if(t){var n=t.getSceneGraphPriorityListeners();if(n&&0!==n.length){var i=t.getSceneGraphPriorityListeners();i.forEach((function(e){var t=e._getSceneGraphPriority()._uiProps.uiTransformComp;e._cameraPriority=t.cameraPriority})),i.sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},t._sortEventListenersOfSceneGraphPriorityDes=function(e,t){var n=e._getSceneGraphPriority(),i=t._getSceneGraphPriority();if(!(t&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return 1;var o=n,r=i,a=!1;if(e._cameraPriority!==t._cameraPriority)return t._cameraPriority-e._cameraPriority;for(;o.parent._id!==r.parent._id;)o=null===o.parent.parent?(a=!0)&&i:o.parent,r=null===r.parent.parent?(a=!0)&&n:r.parent;if(o._id===r._id){if(o._id===i._id)return-1;if(o._id===n._id)return 1}var s=o.getSiblingIndex(),c=r.getSiblingIndex();return a?s-c:c-s},t._sortListenersOfFixedPriority=function(e){var t=this._listenersMap[e];if(t){var n=t.getFixedPriorityListeners();if(n&&0!==n.length){n.sort(this._sortListenersOfFixedPriorityAsc);for(var i=0,o=n.length;i<o&&!(n[i]._getFixedPriority()>=0);)++i;t.gt0Index=i}}},t._sortListenersOfFixedPriorityAsc=function(e,t){return e._getFixedPriority()-t._getFixedPriority()},t._onUpdateListeners=function(e){var t=e.getFixedPriorityListeners(),n=e.getSceneGraphPriorityListeners(),i=this._toRemovedListeners;if(n)for(var o=n.length-1;o>=0;o--){var r=n[o];if(!r._isRegistered()){s.js.array.removeAt(n,o);var a=i.indexOf(r);-1!==a&&i.splice(a,1)}}if(t)for(var c=t.length-1;c>=0;c--){var l=t[c];if(!l._isRegistered()){s.js.array.removeAt(t,c);var u=i.indexOf(l);-1!==u&&i.splice(u,1)}}n&&0===n.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()},t._updateTouchListeners=function(){var e=this._inDispatch;if(D(e>0,3508),!(e>1)){var t;(t=this._listenersMap[jm.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(t),(t=this._listenersMap[jm.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(t),D(1===e,3509);var n=this._toAddedListeners;if(0!==n.length){for(var i=0,o=n.length;i<o;i++)this._forceAddEventListener(n[i]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},t._cleanToRemovedListeners=function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var n=e[t],i=this._listenersMap[n._getListenerID()];if(i){var o=i.getFixedPriorityListeners(),r=i.getSceneGraphPriorityListeners();if(r){var a=r.indexOf(n);-1!==a&&r.splice(a,1)}if(o){var s=o.indexOf(n);-1!==s&&o.splice(s,1)}}}e.length=0},t._onTouchEventCallback=function(e,t){if(!e._isRegistered())return!1;var n=t.event,i=n.touch;n.currentTarget=e._getSceneGraphPriority();var o=!1,r=-1,a=n.getEventCode();if(a===Fm.TOUCH_START){if(!st.ENABLE_MULTI_TOUCH&&Xm._currentTouch){var s=Xm._currentTouchListener._node;if(!s||s.activeInHierarchy)return!1}e.onTouchBegan&&(o=e.onTouchBegan(i,n))&&e._isRegistered()&&!e._isPaused()&&(e._claimedTouches.push(i),!st.ENABLE_MULTI_TOUCH&&Xm._currentTouch||(Xm._currentTouch=i),Xm._currentTouchListener=e)}else if(e._claimedTouches.length>0&&-1!==(r=e._claimedTouches.indexOf(i))){if(o=!0,!st.ENABLE_MULTI_TOUCH&&Xm._currentTouch&&Xm._currentTouch!==i)return!1;a===Fm.TOUCH_MOVE&&e.onTouchMoved?e.onTouchMoved(i,n):a===Fm.TOUCH_END?(e.onTouchEnded&&e.onTouchEnded(i,n),e._isRegistered()&&e._claimedTouches.splice(r,1),(st.ENABLE_MULTI_TOUCH||Xm._currentTouch===i)&&(Xm._currentTouch=null),Xm._currentTouchListener=null):a===Fm.TOUCH_CANCEL&&(e.onTouchCancelled&&e.onTouchCancelled(i,n),e._isRegistered()&&e._claimedTouches.splice(r,1),(st.ENABLE_MULTI_TOUCH||Xm._currentTouch===i)&&(Xm._currentTouch=null),Xm._currentTouchListener=null)}return n.isStopped()?(Xm._updateTouchListeners(n),!0):!!(o&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(i,1),!0)},t._dispatchTouchEvent=function(e){this._sortEventListeners(jm.TOUCH_ONE_BY_ONE),this._sortEventListeners(jm.TOUCH_ALL_AT_ONCE);var t=this._getListeners(jm.TOUCH_ONE_BY_ONE),n=this._getListeners(jm.TOUCH_ALL_AT_ONCE);if(null!==t||null!==n){var i=e.getTouches(),o=s.js.array.copy(i),r={event:e,needsMutableSet:t&&n,touches:o,selTouch:null};if(t)for(var a=0;a<i.length;++a){var c=i[a];e.touch=c,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,r)}n&&o.length>0&&(this._dispatchEventToListeners(n,this._onTouchesEventCallback,{event:e,touches:o}),e.isStopped())||this._updateTouchListeners(e)}},t._onTouchesEventCallback=function(e,t){if(!e._isRegistered())return!1;var n=t.event,i=t.touches,o=n.getEventCode();return n.currentTarget=e._getSceneGraphPriority(),o===Fm.TOUCH_START&&e.onTouchesBegan?e.onTouchesBegan(i,n):o===Fm.TOUCH_MOVE&&e.onTouchesMoved?e.onTouchesMoved(i,n):o===Fm.TOUCH_END&&e.onTouchesEnded?e.onTouchesEnded(i,n):o===Fm.TOUCH_CANCEL&&e.onTouchesCancelled&&e.onTouchesCancelled(i,n),!!n.isStopped()&&(Xm._updateTouchListeners(n),!0)},t._associateNodeAndEventListener=function(e,t){var n=this._nodeListenersMap[e.uuid];n||(n=[],this._nodeListenersMap[e.uuid]=n),n.push(t)},t._dissociateNodeAndEventListener=function(e,t){var n=this._nodeListenersMap[e.uuid];n&&(s.js.array.remove(n,t),0===n.length&&delete this._nodeListenersMap[e.uuid])},t._dispatchEventToListeners=function(e,t,n){var i=!1,o=e.getFixedPriorityListeners(),r=e.getSceneGraphPriorityListeners(),a=0;if(o&&0!==o.length)for(;a<e.gt0Index;++a){var s=o[a];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&t(s,n)){i=!0;break}}if(r&&!i)for(var c=0;c<r.length;++c){var l=r[c];if(l.isEnabled()&&!l._isPaused()&&l._isRegistered()&&t(l,n)){i=!0;break}}if(o&&!i)for(;a<o.length;++a){var u=o[a];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,n)){i=!0;break}}},t._setDirty=function(e,t){var n=this._priorityDirtyFlagMap;null==n[e]?n[e]=t:n[e]|=t},t._sortNumberAsc=function(e,t){return e-t},t._removeListenerInCallback=function(e,t){if(null==e)return!1;for(var n=e.length-1;n>=0;n--){var i=e[n];if(i._onCustomEvent===t||i.onEvent===t)return i._setRegistered(!1),null!=i._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(i._getSceneGraphPriority(),i),i._setSceneGraphPriority(null)),0===this._inDispatch?s.js.array.removeAt(e,n):this._toRemovedListeners.push(i),!0}return!1},t._removeListenerInVector=function(e,t){if(null==e)return!1;for(var n=e.length-1;n>=0;n--){var i=e[n];if(i===t)return i._setRegistered(!1),null!=i._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(i._getSceneGraphPriority(),i),i._setSceneGraphPriority(null)),0===this._inDispatch?s.js.array.removeAt(e,n):this._toRemovedListeners.push(i),!0}return!1},e}(),Xm=e("f1",new Ym);s.eventManager=Xm,ri.Flags.Destroying;var Km,Qm,Zm,Jm,$m,ev,tv,nv,iv,ov=ri.Flags.Destroying,rv=ri.Flags.DontDestroy,av=ri.Flags.Deactivating,sv=new fe("Node");function cv(e){return e?"string"==typeof e?Qe(e):e:(R(3804),null)}var lv,uv,hv,_v,fv,dv,pv,mv,vv,gv,yv,xv=e("fy",b_("cc.BaseNode")((iv=nv=function(e){ee(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var o=0;o<i.length;++o){var r=i[o];if(r.constructor===t)return r}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,o=e._components;if(i._sealed)for(var r=0;r<o.length;++r){var a=o[r];a.constructor===t&&n.push(a)}else for(var s=0;s<o.length;++s){var c=o[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var o=e[i],r=n._findComponent(o,t);if(r)return r;if(o._children.length>0&&(r=n._findChildComponent(o._children,t)))return r}return null},n._findChildComponents=function(e,t,i){for(var o=0;o<e.length;++o){var r=e[o];n._findComponents(r,t,i),r._children.length>0&&n._findChildComponents(r._children,t,i)}};var t=n.prototype;function n(t){var n;return re(n=e.call(this,t)||this,"_parent",Zm,ne(n)),re(n,"_children",Jm,ne(n)),re(n,"_active",$m,ne(n)),re(n,"_components",ev,ne(n)),re(n,"_prefab",tv,ne(n)),n._scene=null,n._activeInHierarchy=!1,n._id=sv.getNewId(),n._name=void 0,n._eventProcessor=new s.NodeEventProcessor(ne(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?y("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){Fe(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(Fm.PARENT_CHANGED,n),n&&!(n._objFlags&ov)){var o=n._children.indexOf(this);n._children.splice(o,1),n._updateSiblingIndex(),n.emit&&n.emit(Fm.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(Fm.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return v("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return v("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var o=n.children.find((function(e){return e.name===i}));if(!o)return{v:null};n=o},o=0;o<t.length;++o){var r=i(o);if("continue"!==r&&"object"==typeof r)return r.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&av)R(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,o=null,r=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(r=s[--i])if(!l&&e?e(r):l&&t&&t(r),s[i]=null,l){if(c===this._parent)break;if(l=!1,o)if(o[++a])s[i]=o[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(o=c._parent._children).indexOf(c),c=c._parent):(c=null,o=null),a<0))break}else r._children.length>0?(c=r,o=r._children,a=0,s[i]=o[a],i++):(s[i]=r,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=cv(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=cv(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=cv(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=cv(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=Qe(e)))throw s._RF.peek()&&R(3808,e),TypeError(M(3807,e))}else{if(!e)throw TypeError(M(3804));t=e}if("function"!=typeof t)throw TypeError(M(3809));if(!Ue(t,s.Component))throw TypeError(M(3810));var n=t._requireComponent;n&&!this.getComponent(n)&&this.addComponent(n);var i=new t;return i.node=this,this._components.push(i),this._activeInHierarchy&&s.director._nodeActivator.activateComp(i),i},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof ip?e:this.getComponent(e))&&t.destroy()}else R(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case Fm.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case Fm.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,o,r){this._eventProcessor.emit(e,t,n,i,o,r)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(Fm.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&ov)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&R(3815)}}else R(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(Fm.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=s.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof s.Scene||s.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&s.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=ov;var e=this._parent,t=!!e&&0!=(e._objFlags&ov);if(this._persistNode&&s.game.removePersistRootNode(this),!t&&e){this.emit(Fm.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(Fm.CHILD_REMOVED,this)}this.emit(Fm.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,o=0;o<i.length;++o)i[o]._destroyImmediate();for(var r=this._components,a=0;a<r.length;++a)r[a]._destroyImmediate();return t},J(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&rv)>0},set:function(e){e?this._objFlags|=rv:this._objFlags&=~rv}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&s.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(ri),nv.idGenerator=sv,nv._stacks=[[]],nv._stackId=0,ae((Qm=iv).prototype,"_persistNode",[D_],Object.getOwnPropertyDescriptor(Qm.prototype,"_persistNode"),Qm.prototype),ae(Qm.prototype,"name",[k_],Object.getOwnPropertyDescriptor(Qm.prototype,"name"),Qm.prototype),ae(Qm.prototype,"children",[k_],Object.getOwnPropertyDescriptor(Qm.prototype,"children"),Qm.prototype),ae(Qm.prototype,"active",[k_],Object.getOwnPropertyDescriptor(Qm.prototype,"active"),Qm.prototype),ae(Qm.prototype,"activeInHierarchy",[k_],Object.getOwnPropertyDescriptor(Qm.prototype,"activeInHierarchy"),Qm.prototype),ae(Qm.prototype,"parent",[k_],Object.getOwnPropertyDescriptor(Qm.prototype,"parent"),Qm.prototype),Zm=ae(Qm.prototype,"_parent",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jm=ae(Qm.prototype,"_children",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$m=ae(Qm.prototype,"_active",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ev=ae(Qm.prototype,"_components",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tv=ae(Qm.prototype,"_prefab",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Km=Qm))||Km);function Ev(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return R(3701,e.name),void(t.instance=void 0);var n=e._objFlags,i=e._parent,o=e._id,r=e._prefab;s.game._isCloning=!0,t.asset._doInstantiate(e),s.game._isCloning=!1,e._objFlags=n,e._parent=i,e._id=o,e._prefab&&(e._prefab.instance=null==r?void 0:r.instance)}}function Sv(e,t,n){var i;if(t){var o=t,r=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&r&&(t[r.fileId]={},o=t[r.fileId]);var a=e._prefab;a&&(o[a.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(o[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)Sv(e.children[u],o,!1)}}function Tv(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function Av(e,t,n){if(t)for(var i=0;i<t.length;i++){var o=t[i];if(o&&o.targetInfo){var r=Tv(o.targetInfo.localID,n);if(!r)continue;var a=n,s=o.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(o.nodes)for(var l=0;l<o.nodes.length;l++){var u=o.nodes[l];u&&(r._children.push(u),u._parent=r,Sv(u,a,!1),u._siblingIndex=r._children.length-1,u._onBatchCreated(!1))}}}}function wv(e,t,n){if(t)for(var i=0;i<t.length;i++){var o=t[i];if(o&&o.targetInfo){var r=Tv(o.targetInfo.localID,n);if(!r)continue;if(o.components)for(var a=0;a<o.components.length;a++){var s=o.components[a];s&&(s.node=r,r._components.push(s))}}}}function Cv(e,t,n){if(t)for(var i=0;i<t.length;i++){var o=t[i];if(o){var r=Tv(o.localID,n);if(!r||!r.node)continue;var a=r.node.components.indexOf(r);a>=0&&r.node._components.splice(a,1)}}}function Iv(e,t,n){if(!(t.length<=0))for(var i=null,o=0;o<t.length;o++){var r=t[o];if(r&&r.targetInfo){if(!(i=Tv(r.targetInfo.localID,n)))continue;var a=i,s=r.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=r.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=r.value)}else a[c]=r.value}}}}function Pv(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var o,r,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=Tv(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var d=null===(o=a.target)||void 0===o||null===(r=o._prefab)||void 0===r?void 0:r.instance;if(d&&d.targetMap&&(_=Tv(f.localID,d.targetMap))){var p=a.propertyPath.slice(),m=s;if(p.length>0){var v=p.pop();if(!v)return;for(var g=0;g<p.length&&(m=m[p[g]]);g++);if(!m)continue;m[v]=_}}}}}}s._BaseNode=xv;var bv,Rv,Nv,Ov,Dv,Mv,Lv,Fv,zv,Bv,Uv,Hv,Gv,Vv,kv,Wv,jv,qv,Yv,Xv,Kv,Qv,Zv,Jv,$v,eg,tg,ng,ig,og,rg,ag,sg,cg,lg,ug,hg,_g,fg,dg,pg,mg,vg,gg,yg,xg,Eg,Sg,Tg,Ag,wg,Cg,Ig,Pg,bg,Rg,Ng,Og,Dg,Mg,Lg,Fg,zg,Bg,Ug,Hg,Gg,Vg,kg,Wg=new An,jg=new Nn,qg=new Nn,Yg=new Array(10),Xg=new Nn,Kg=new Pn,Qg=new Pn,Zg=new Un,Jg=new Map,$g=e("cH",(lv=b_("cc.Node"),uv=rf(An),lv((yv=gv=function(e){function t(t){var n;return(n=e.call(this,t)||this)._uiProps=new zm(ne(n)),n._static=!1,n._pos=new An,n._rot=new Nn,n._scale=new An(1,1,1),n._mat=new Un,re(n,"_lpos",fv,ne(n)),re(n,"_lrot",dv,ne(n)),re(n,"_lscale",pv,ne(n)),re(n,"_layer",mv,ne(n)),re(n,"_euler",vv,ne(n)),n._dirtyFlags=u_.NONE,n._eulerDirty=!1,n._poolHandle=To,n._poolHandle=sr.alloc(),sr.set(n._poolHandle,nr.LAYER,n._layer),n}ee(t,e),t.isNode=function(e){return e instanceof t&&(e.constructor===t||!(e instanceof s.Scene))};var n=t.prototype;return n.destroy=function(){return this._poolHandle&&(sr.free(this._poolHandle),this._poolHandle=To),e.prototype.destroy.call(this)},n.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},n._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),Un.multiply(Zg,Un.invert(Zg,i._mat),this._mat),Un.toRTS(Zg,this._lrot,this._lpos,this._lscale)):(An.copy(this._lpos,this._pos),Nn.copy(this._lrot,this._rot),An.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(u_.TRS)},n._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},n._onBatchCreated=function(e){var t;sr.set(this._poolHandle,nr.LAYER,this._layer),sr.setVec3(this._poolHandle,nr.WORLD_SCALE,this._scale);var n=null===(t=this._prefab)||void 0===t?void 0:t.instance;!e&&n&&Ev(this),this.hasChangedFlags=u_.TRS,this._dirtyFlags=u_.TRS;for(var i=this._children.length,o=0;o<i;++o)this._children[o]._siblingIndex=o,this._children[o]._onBatchCreated(e);if(!e&&n){var r={};n.targetMap=r,Sv(this,r,!0),Av(0,n.mountedChildren,r),Cv(0,n.removedComponents,r),wv(0,n.mountedComponents,r),Iv(0,n.propertyOverrides,r)}Pv(this)},n._onBeforeSerialize=function(){this.eulerAngles},n._onPostActivated=function(e){e?(Xm.resumeTarget(this),this.invalidateChildren(u_.TRS)):Xm.pauseTarget(this)},n.translate=function(e,t){var n=t||l_.LOCAL;if(n===l_.LOCAL)An.transformQuat(Wg,e,this._lrot),this._lpos.x+=Wg.x,this._lpos.y+=Wg.y,this._lpos.z+=Wg.z;else if(n===l_.WORLD)if(this._parent){Nn.invert(jg,this._parent.worldRotation),An.transformQuat(Wg,e,jg);var i=this.worldScale;this._lpos.x+=Wg.x/i.x,this._lpos.y+=Wg.y/i.y,this._lpos.z+=Wg.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(u_.POSITION),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.POSITION),sr.setVec3(this._poolHandle,nr.WORLD_POSITION,this.worldPosition)},n.rotate=function(e,t){var n=t||l_.LOCAL;if(Nn.normalize(jg,e),n===l_.LOCAL)Nn.multiply(this._lrot,this._lrot,jg);else if(n===l_.WORLD){var i=this.worldRotation;Nn.multiply(qg,jg,i),Nn.invert(jg,i),Nn.multiply(qg,jg,qg),Nn.multiply(this._lrot,this._lrot,qg)}this._eulerDirty=!0,this.invalidateChildren(u_.ROTATION),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.ROTATION),sr.setVec4(this._poolHandle,nr.WORLD_ROTATION,this.worldRotation)},n.lookAt=function(e,t){this.getWorldPosition(Wg),An.subtract(Wg,Wg,e),An.normalize(Wg,Wg),Nn.fromViewUp(jg,Wg,t),this.setWorldRotation(jg)},n.invalidateChildren=function(e){var t=this.hasChangedFlags;if((this._dirtyFlags&t&e)!==e){this._dirtyFlags|=e,this.hasChangedFlags=t|e;for(var n=e|u_.POSITION,i=this._children.length,o=0;o<i;++o){var r=this._children[o];r.isValid&&r.invalidateChildren(n)}}},n.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)Yg[n++]=t,t=t._parent;for(var i=0;n;)i|=(e=Yg[--n])._dirtyFlags,t?(i&u_.POSITION&&(An.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z,sr.setVec3(e._poolHandle,nr.WORLD_POSITION,e._pos)),i&u_.RS&&(Un.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Un.multiply(e._mat,t._mat,e._mat),i&u_.ROTATION&&(Nn.multiply(e._rot,t._rot,e._lrot),sr.setVec4(e._poolHandle,nr.WORLD_ROTATION,e._rot)),Pn.fromQuat(Kg,Nn.conjugate(Xg,e._rot)),Pn.multiplyMat4(Kg,Kg,e._mat),e._scale.x=Kg.m00,e._scale.y=Kg.m04,e._scale.z=Kg.m08,sr.setVec3(e._poolHandle,nr.WORLD_SCALE,e._scale))):(i&u_.POSITION&&(An.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z,sr.setVec3(e._poolHandle,nr.WORLD_POSITION,e._pos)),i&u_.RS&&(i&u_.ROTATION&&(Nn.copy(e._rot,e._lrot),sr.setVec4(e._poolHandle,nr.WORLD_ROTATION,e._rot)),i&u_.SCALE&&(An.copy(e._scale,e._lscale),sr.setVec3(e._poolHandle,nr.WORLD_SCALE,e._scale),Un.fromRTS(e._mat,e._rot,e._pos,e._scale)))),i!==u_.NONE&&sr.setMat4(e._poolHandle,nr.WORLD_MATRIX,e._mat),e._dirtyFlags=u_.NONE,t=e}},n.setPosition=function(e,t,n){void 0===t&&void 0===n?An.copy(this._lpos,e):void 0===n?An.set(this._lpos,e,t,this._lpos.z):An.set(this._lpos,e,t,n),this.invalidateChildren(u_.POSITION),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.POSITION)},n.getPosition=function(e){return e?An.set(e,this._lpos.x,this._lpos.y,this._lpos.z):An.copy(new An,this._lpos)},n.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Nn.copy(this._lrot,e):Nn.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(u_.ROTATION),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.ROTATION)},n.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(An.copy(this._euler,e),Nn.fromEuler(this._lrot,e.x,e.y,e.z)):(An.set(this._euler,e,t,i),Nn.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(u_.ROTATION),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.ROTATION)},n.getRotation=function(e){return e?Nn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Nn.copy(new Nn,this._lrot)},n.setScale=function(e,t,n){void 0===t&&void 0===n?An.copy(this._lscale,e):void 0===n?An.set(this._lscale,e,t,this._lscale.z):An.set(this._lscale,e,t,n),this.invalidateChildren(u_.SCALE),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.SCALE)},n.getScale=function(e){return e?An.set(e,this._lscale.x,this._lscale.y,this._lscale.z):An.copy(new An,this._lscale)},n.inverseTransformPoint=function(e,t){An.copy(e,t);for(var n=this,i=0;n._parent;)Yg[i++]=n,n=n._parent;for(;i>=0;)An.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=Yg[--i];return e},n.setWorldPosition=function(e,t,n){void 0===t||void 0===n?An.copy(this._pos,e):An.set(this._pos,e,t,n),sr.setVec3(this._poolHandle,nr.WORLD_POSITION,this._pos);var i=this._parent,o=this._lpos;i?(i.updateWorldTransform(),An.transformMat4(o,this._pos,Un.invert(Zg,i._mat))):An.copy(o,this._pos),this.invalidateChildren(u_.POSITION),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.POSITION)},n.getWorldPosition=function(e){return this.updateWorldTransform(),e?An.copy(e,this._pos):An.copy(new An,this._pos)},n.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Nn.copy(this._rot,e):Nn.set(this._rot,e,t,n,i),sr.setVec4(this._poolHandle,nr.WORLD_ROTATION,this._rot),this._parent?(this._parent.updateWorldTransform(),Nn.multiply(this._lrot,Nn.conjugate(this._lrot,this._parent._rot),this._rot)):Nn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(u_.ROTATION),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.ROTATION)},n.setWorldRotationFromEuler=function(e,t,n){Nn.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),Nn.multiply(this._lrot,Nn.conjugate(this._lrot,this._parent._rot),this._rot)):Nn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(u_.ROTATION),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.ROTATION)},n.getWorldRotation=function(e){return this.updateWorldTransform(),e?Nn.copy(e,this._rot):Nn.copy(new Nn,this._rot)},n.setWorldScale=function(e,t,n){void 0===t||void 0===n?An.copy(this._scale,e):An.set(this._scale,e,t,n),sr.setVec3(this._poolHandle,nr.WORLD_SCALE,this._scale);var i=this._parent;i?(i.updateWorldTransform(),Pn.fromQuat(Kg,Nn.conjugate(Xg,i._rot)),Pn.multiplyMat4(Kg,Kg,i._mat),Qg.m00=this._scale.x,Qg.m04=this._scale.y,Qg.m08=this._scale.z,Pn.multiply(Kg,Qg,Pn.invert(Kg,Kg)),this._lscale.x=An.set(Wg,Kg.m00,Kg.m01,Kg.m02).length(),this._lscale.y=An.set(Wg,Kg.m03,Kg.m04,Kg.m05).length(),this._lscale.z=An.set(Wg,Kg.m06,Kg.m07,Kg.m08).length()):An.copy(this._lscale,this._scale),this.invalidateChildren(u_.SCALE),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.SCALE)},n.getWorldScale=function(e){return this.updateWorldTransform(),e?An.copy(e,this._scale):An.copy(new An,this._scale)},n.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new Un;return Un.copy(t,this._mat)},n.getWorldRS=function(e){this.updateWorldTransform();var t=e||new Un;return Un.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},n.getWorldRT=function(e){this.updateWorldTransform();var t=e||new Un;return Un.fromRT(t,this._rot,this._pos)},n.setRTS=function(e,t,n){var i=0;e&&(i|=u_.ROTATION,void 0!==e.w?(Nn.copy(this._lrot,e),this._eulerDirty=!0):(An.copy(this._euler,e),Nn.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(An.copy(this._lpos,t),i|=u_.POSITION),n&&(An.copy(this._lscale,n),i|=u_.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,i))},n.pauseSystemEvents=function(e){Xm.pauseTarget(this,e)},n.resumeSystemEvents=function(e){Xm.resumeTarget(this,e)},t.clearBooks=function(){Jg.clear()},n.syncToNativeTransform=function(){var e=this.hasChangedFlags;e&&(e&u_.POSITION&&sr.setVec3(this._poolHandle,nr.WORLD_POSITION,this.worldPosition),e&u_.ROTATION&&sr.setVec3(this._poolHandle,nr.WORLD_ROTATION,this.worldRotation),e&u_.SCALE&&sr.setVec3(this._poolHandle,nr.WORLD_SCALE,this.worldScale))},n.syncFromNativeTransform=function(){var e=sr.get(this._poolHandle,nr.FLAGS_CHANGED);e&&(e&u_.POSITION&&(sr.getVec3(this._poolHandle,nr.WORLD_POSITION,Wg),this.setWorldPosition(Wg)),e&u_.ROTATION&&(sr.getVec4(this._poolHandle,nr.WORLD_ROTATION,jg),this.setWorldRotation(jg)),e&u_.SCALE&&(sr.getVec3(this._poolHandle,nr.WORLD_SCALE,Wg),this.setWorldScale(Wg)))},J(t,[{key:"handle",get:function(){return this._poolHandle}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Nn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){An.set(this._euler,0,0,e),Nn.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(u_.ROTATION),1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Un.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(u_.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(Fm.TRANSFORM_CHANGED,u_.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return An.transformQuat(new An,An.FORWARD,this.worldRotation)},set:function(e){var t=e.length();An.multiplyScalar(Wg,e,-1/t),Nn.fromViewUp(jg,Wg),this.setWorldRotation(jg)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,sr.set(this._poolHandle,nr.LAYER,this._layer),this.emit(Fm.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return Jg.get(this)||0},set:function(e){Jg.set(this,e),sr.set(this._poolHandle,nr.FLAGS_CHANGED,e)}}]),t}(xv),gv.bookOfChange=Jg,gv.EventType=Fm,gv.NodeSpace=l_,gv.TransformDirtyBit=u_,gv.TransformBit=u_,fv=ae((_v=yv).prototype,"_lpos",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An}}),dv=ae(_v.prototype,"_lrot",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn}}),pv=ae(_v.prototype,"_lscale",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(1,1,1)}}),mv=ae(_v.prototype,"_layer",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fu.Enum.DEFAULT}}),vv=ae(_v.prototype,"_euler",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An}}),ae(_v.prototype,"eulerAngles",[uv],Object.getOwnPropertyDescriptor(_v.prototype,"eulerAngles"),_v.prototype),ae(_v.prototype,"angle",[k_],Object.getOwnPropertyDescriptor(_v.prototype,"angle"),_v.prototype),ae(_v.prototype,"layer",[k_],Object.getOwnPropertyDescriptor(_v.prototype,"layer"),_v.prototype),hv=_v))||hv));s.Node=$g;var ey=b_("cc.TargetInfo")((Nv=ae((Rv=function(){re(this,"localID",Nv,this)}).prototype,"localID",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bv=Rv))||bv,ty=(Ov=b_("cc.TargetOverrideInfo"),Dv=rf(ri),Mv=rf(ey),Lv=rf($g),Fv=rf(ey),Ov((Uv=ae((Bv=function(){re(this,"source",Uv,this),re(this,"sourceInfo",Hv,this),re(this,"propertyPath",Gv,this),re(this,"target",Vv,this),re(this,"targetInfo",kv,this)}).prototype,"source",[M_,Dv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hv=ae(Bv.prototype,"sourceInfo",[M_,Mv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gv=ae(Bv.prototype,"propertyPath",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vv=ae(Bv.prototype,"target",[M_,Lv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kv=ae(Bv.prototype,"targetInfo",[M_,Fv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zv=Bv))||zv),ny=b_("cc.CompPrefabInfo")((qv=ae((jv=function(){re(this,"fileId",qv,this)}).prototype,"fileId",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Wv=jv))||Wv,iy=(Yv=b_("CCPropertyOverrideInfo"),Xv=rf(ey),Yv((eg=function(){function e(){re(this,"targetInfo",Zv,this),re(this,"propertyPath",Jv,this),re(this,"value",$v,this)}return e.prototype.isTarget=function(){},e}(),Zv=ae((Qv=eg).prototype,"targetInfo",[M_,Xv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jv=ae(Qv.prototype,"propertyPath",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$v=ae(Qv.prototype,"value",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Kv=Qv))||Kv),oy=(tg=b_("cc.MountedChildrenInfo"),ng=rf(ey),ig=rf([$g]),tg((cg=function(){function e(){re(this,"targetInfo",ag,this),re(this,"nodes",sg,this)}return e.prototype.isTarget=function(){},e}(),ag=ae((rg=cg).prototype,"targetInfo",[M_,ng],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sg=ae(rg.prototype,"nodes",[M_,ig],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),og=rg))||og),ry=(lg=b_("cc.MountedComponentsInfo"),ug=rf(ey),hg=rf([ip]),lg((mg=function(){function e(){re(this,"targetInfo",dg,this),re(this,"components",pg,this)}return e.prototype.isTarget=function(){},e}(),dg=ae((fg=mg).prototype,"targetInfo",[M_,ug],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pg=ae(fg.prototype,"components",[M_,hg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_g=fg))||_g),ay=(vg=b_("cc.PrefabInstance"),gg=rf($g),yg=rf([oy]),xg=rf([ry]),Eg=rf([iy]),Sg=rf([ey]),vg((Ng=function(){function e(){re(this,"fileId",wg,this),re(this,"prefabRootNode",Cg,this),re(this,"mountedChildren",Ig,this),re(this,"mountedComponents",Pg,this),re(this,"propertyOverrides",bg,this),re(this,"removedComponents",Rg,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),wg=ae((Ag=Ng).prototype,"fileId",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Cg=ae(Ag.prototype,"prefabRootNode",[M_,gg],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ig=ae(Ag.prototype,"mountedChildren",[M_,yg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pg=ae(Ag.prototype,"mountedComponents",[M_,xg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bg=ae(Ag.prototype,"propertyOverrides",[M_,Eg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rg=ae(Ag.prototype,"removedComponents",[M_,Sg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tg=Ag))||Tg),sy=(Og=b_("cc.PrefabInfo"),Dg=rf($g),Mg=rf(s.Prefab),Lg=rf(ay),Fg=rf([ty]),Og((Ug=ae((Bg=function(){re(this,"root",Ug,this),re(this,"asset",Hg,this),re(this,"fileId",Gg,this),re(this,"instance",Vg,this),re(this,"targetOverrides",kg,this)}).prototype,"root",[M_,Dg],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Hg=ae(Bg.prototype,"asset",[M_,Mg],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Gg=ae(Bg.prototype,"fileId",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Vg=ae(Bg.prototype,"instance",[M_,Lg],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kg=ae(Bg.prototype,"targetOverrides",[M_,Fg],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),zg=Bg))||zg);s._PrefabInfo=sy;var cy,ly,uy,hy,_y,fy,dy,py,my,vy,gy,yy,xy,Ey=Object.freeze({__proto__:null,TargetInfo:ey,TargetOverrideInfo:ty,CompPrefabInfo:ny,PropertyOverrideInfo:iy,MountedChildrenInfo:oy,MountedComponentsInfo:ry,PrefabInstance:ay,PrefabInfo:sy,createNodeWithPrefab:Ev,generateTargetMap:Sv,getTarget:Tv,applyMountedChildren:Av,applyMountedComponents:wv,applyRemovedComponents:Cv,applyPropertyOverrides:Iv,applyTargetOverrides:Pv}),Sy=nt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Ty=e("eM",b_("cc.Prefab")((fy=_y=function(e){function t(){var t;return re(t=e.call(this)||this,"data",uy,ne(t)),re(t,"optimizationPolicy",hy,ne(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}ee(t,e);var n=t.prototype;return n.createNode=function(e){var t=s.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof s._BaseNode&&e,new Mm(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||P(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==Sy.SINGLE_INSTANCE&&(this.optimizationPolicy===Sy.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new $g,this.data.name="(Missing Node)";var n=new sy;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},t}(zf),_y.OptimizationPolicy=Sy,_y.OptimizationPolicyThreshold=3,uy=ae((ly=fy).prototype,"data",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hy=ae(ly.prototype,"optimizationPolicy",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sy.AUTO}}),cy=ly))||cy);et.value(Ty,"_utils",Ey),s.Prefab=Ty,Ie(s,"cc._Prefab","Prefab"),e("ew",(dy=b_("cc.PrefabLink"),py=rf(Ty),my=W_(),dy((xy=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"prefab",yy,ne(t)),t}return ee(t,e),t}(ip),yy=ae((gy=xy).prototype,"prefab",[py,M_,my],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vy=gy))||vy));var Ay=new An;function wy(e,t,n,i){i||(i=new An),e.convertToUINode(t,n,i);var o=n.position;return i.add(o),i}function Cy(e,t,n){return n||(n=new An),e.worldToScreen(t,n),n.x/=s.view.getScaleX(),n.y/=s.view.getScaleY(),n}var Iy=e("eA",{WorldNode3DToLocalNodeUI:wy,WorldNode3DToWorldNodeUI:Cy});s.pipelineUtils=Iy,k(s.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],o=t[3]||Ay;return i.convertToUINode(t[1],t[2],o),o.add(t[2].position),t[3]||o.clone()}}]),k(Fm,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]);var Py=function(){function e(){this.support=void 0,this._intervalInMileseconds=200,this._accelTimer=0,this._eventTarget=new Ti,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this.support=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,wi.browserType===mi.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileseconds)){this._accelTimer=t;var n=0,i=0,o=0;if(this._globalEventClass===window.DeviceMotionEvent){var r=e.accelerationIncludingGravity;n=.1*((null==r?void 0:r.x)||0),i=.1*((null==r?void 0:r.y)||0),o=.1*((null==r?void 0:r.z)||0)}else{var a=e;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,o=(a.alpha||0)/90*.981}if(s.view._isRotated){var c=n;n=-i,i=c}var l=n;90===window.orientation?(n=-i,i=l):-90===window.orientation?(n=i,i=-l):180===window.orientation&&(n=-n,i=-i),wi.os===xi.ANDROID&&wi.browserType!==mi.MOBILE_QQ&&(n=-n,i=-i);var u={type:Fm.DEVICEMOTION,x:n,y:i,z:o,timestamp:performance.now()};this._eventTarget.emit(Fm.DEVICEMOTION,u)}},t.start=function(){this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileseconds=e},t.onChange=function(e){this._eventTarget.on(Fm.DEVICEMOTION,e)},e}(),by=function(){function e(){this.support=void 0,this.support=!0}var t=e.prototype;return t.show=function(){throw new Error("Method not implemented.")},t.hide=function(){throw new Error("Method not implemented.")},t.onChange=function(){throw new Error("Method not implemented.")},t.onComplete=function(){throw new Error("Method not implemented.")},t.offChange=function(){throw new Error("Method not implemented.")},t.offComplete=function(){throw new Error("Method not implemented.")},e}(),Ry=function(){function e(){this.support=void 0,this._eventTarget=new Ti,this.support=void 0!==document.documentElement.onkeyup,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=document.getElementById("GameCanvas");null==e||e.addEventListener("keydown",this._createCallback(Fm.KEY_DOWN)),null==e||e.addEventListener("keyup",this._createCallback(Fm.KEY_UP))},t._createCallback=function(e){var t=this;return function(n){var i={type:e,code:n.keyCode,timestamp:performance.now()};n.stopPropagation(),n.preventDefault(),t._eventTarget.emit(e,i)}},t.onDown=function(e){this._eventTarget.on(Fm.KEY_DOWN,e)},t.onUp=function(e){this._eventTarget.on(Fm.KEY_UP,e)},e}(),Ny=function(){function e(){this.support=void 0,this._canvas=void 0,this._eventTarget=new Ti,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new kn,this.support=void 0!==document.documentElement.onmouseup,this.support&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Jn(t.x,t.y,t.width,t.height):new Jn(0,0,0,0)},t._getLocation=function(e){return new kn(e.clientX,e.clientY)},t._registerEvent=function(){var e,t,n,i,o=this;window.addEventListener("mousedown",(function(){o._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(Fm.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(Fm.MOUSE_MOVE)),window.addEventListener("mouseup",this._createCallback(Fm.MOUSE_UP)),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",this._createCallback(Fm.MOUSE_UP)),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",(function(e){var t=o._getCanvasRect(),n=o._getLocation(e),i={type:Fm.MOUSE_WHEEL,x:n.x-t.x,y:t.y+t.height-n.y,button:e.button,deltaX:5*e.deltaX,deltaY:5*-e.deltaY,timestamp:performance.now(),movementX:e.movementX,movementY:e.movementY};e.stopPropagation(),e.preventDefault(),o._eventTarget.emit(Fm.MOUSE_WHEEL,i)})),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,o=t._getCanvasRect(),r=t._getLocation(n),a=n.button;switch(n.type){case"mousedown":null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case"mouseup":t._isPressed=!1;break;case"mousemove":t._isPressed||(a=-1)}var s={type:e,x:t._pointLocked?t._preMousePos.x+n.movementX:r.x-o.x,y:t._pointLocked?t._preMousePos.y-n.movementY:o.y+o.height-r.y,button:a,timestamp:performance.now(),movementX:n.movementX,movementY:n.movementY};t._preMousePos.set(s.x,s.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,s)}},t.onDown=function(e){this._eventTarget.on(Fm.MOUSE_DOWN,e)},t.onMove=function(e){this._eventTarget.on(Fm.MOUSE_MOVE,e)},t.onUp=function(e){this._eventTarget.on(Fm.MOUSE_UP,e)},t.onWheel=function(e){this._eventTarget.on(Fm.MOUSE_WHEEL,e)},e}(),Oy=function(){function e(){this.support=void 0,this._canvas=void 0,this._eventTarget=new Ti,this.support=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart||navigator.msPointerEnabled,this.support&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(Fm.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(Fm.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(Fm.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(Fm.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var i=t._getCanvasRect(),o=[],r=n.changedTouches.length,a=0;a<r;++a){var c=n.changedTouches[a],l=t._getLocation(c),u=l.x-i.x,h=i.y+i.height-l.y;if(s.view._isRotated){var _=u;u=i.height-h,h=_}var f={identifier:c.identifier,x:u,y:h,force:c.force};o.push(f)}var d,p={type:e,changedTouches:o,timestamp:performance.now()};n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),"touchstart"===n.type&&(null===(d=t._canvas)||void 0===d||d.focus()),t._eventTarget.emit(e,p)}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Jn(t.x,t.y,t.width,t.height):new Jn(0,0,0,0)},t._getLocation=function(e){return new kn(e.clientX,e.clientY)},t.onStart=function(e){this._eventTarget.on(Fm.TOUCH_START,e)},t.onMove=function(e){this._eventTarget.on(Fm.TOUCH_MOVE,e)},t.onEnd=function(e){this._eventTarget.on(Fm.TOUCH_END,e)},t.onCancel=function(e){this._eventTarget.on(Fm.TOUCH_CANCEL,e)},e}(),Dy=new(function(){function e(){this._touch=new Oy,this._mouse=new Ny,this._keyboard=new Ry,this._accelerometer=new Py,this._inputBox=new by,this._inputEventList=[],this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){},t._pushEvent=function(e){this._inputEventList.push(e)},t.pollEvent=function(){return this._inputEventList.shift()},e}()),My=new kn,Ly=e("f4",function(e){function t(n,i,o){var r;return(r=e.call(this,Ff.MOUSE,i)||this).movementX=0,r.movementY=0,r.eventType=void 0,r._button=t.BUTTON_MISSING,r._x=0,r._y=0,r._prevX=0,r._prevY=0,r._scrollX=0,r._scrollY=0,r.eventType=n,o&&(r._prevX=o.x,r._prevY=o.y),r}ee(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new kn),kn.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new kn),kn.set(e,this._x,s.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new kn),kn.set(e,this._x,this._y),s.view._convertPointWithScale(e),e},n.getPreviousLocation=function(e){return e||(e=new kn),kn.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new kn),kn.set(e,this._prevX,this._prevY),s.view._convertPointWithScale(e),e},n.getDelta=function(e){return e||(e=new kn),kn.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new kn),kn.set(e,(this._x-this._prevX)/s.view.getScaleX(),(this._y-this._prevY)/s.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/s.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/s.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=s.view.getViewportRect();return(this._x-e.x)/s.view.getScaleX()},n.getUILocationY=function(){var e=s.view.getViewportRect();return(this._y-e.y)/s.view.getScaleY()},t}(Ff));Ly.BUTTON_MISSING=-1,Ly.BUTTON_LEFT=0,Ly.BUTTON_RIGHT=2,Ly.BUTTON_MIDDLE=1,Ly.BUTTON_4=3,Ly.BUTTON_5=4,Ly.BUTTON_6=5,Ly.BUTTON_7=6,Ly.BUTTON_8=7;var Fy=e("dL",function(e){function t(t,n,i,o){var r;return(r=e.call(this,Ff.TOUCH,n)||this).touch=null,r.simulate=!1,r._eventCode=void 0,r._touches=void 0,r._allTouches=void 0,r._eventCode=i||"",r._touches=t||[],r._allTouches=o||[],r}ee(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new kn},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new kn},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new kn},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new kn},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new kn},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new kn},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new kn},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new kn},n.getDeltaX=function(){return this.touch?this.touch.getDelta(My).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(My).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(Ff));Fy.MAX_TOUCHES=5;var zy=e("f5",function(e){function t(t,n){var i;return(i=e.call(this,Ff.ACCELERATION,n)||this).acc=void 0,i.acc=t,i}return ee(t,e),t}(Ff)),By=e("f6",function(e){function t(t,n,i){var o;return(o=e.call(this,Ff.KEYBOARD,i)||this).keyCode=void 0,o.rawEvent=void 0,o.isPressed=void 0,"number"==typeof t?o.keyCode=t:(o.keyCode=t.keyCode,o.rawEvent=t),o.isPressed=n,o}return ee(t,e),t}(Ff));Ff.EventMouse=Ly,Ff.EventTouch=Fy,Ff.EventAcceleration=zy,Ff.EventKeyboard=By;var Uy=new kn,Hy=e("f7",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new kn,this._prevPoint=new kn,this._lastModified=0,this._id=0,this._startPoint=new kn,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new kn),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new kn),e.set(this._point.x,this._point.y),s.view._convertPointWithScale(e),e},t.getUILocationX=function(){var e=s.view.getViewportRect();return(this._point.x-e.x)/s.view.getScaleX()},t.getUILocationY=function(){var e=s.view.getViewportRect();return(this._point.y-e.y)/s.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new kn),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new kn),e.set(this._prevPoint.x,this._prevPoint.y),s.view._convertPointWithScale(e),e},t.getStartLocation=function(e){return e||(e=new kn),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new kn),e.set(this._startPoint.x,this._startPoint.y),s.view._convertPointWithScale(e),e},t.getDelta=function(e){return e||(e=new kn),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new kn),Uy.set(this._point),Uy.subtract(this._prevPoint),e.set(s.view.getScaleX(),s.view.getScaleY()),kn.divide(e,Uy,e),e},t.getLocationInView=function(e){return e||(e=new kn),e.set(this._point.x,s.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new kn),e.set(this._prevPoint.x,s.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new kn),e.set(this._startPoint.x,s.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new kn(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new kn(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=s.director.getCurrentTime()},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new kn(e.x,e.y):new kn(e||0,t||0),this._lastModified=s.director.getCurrentTime()},J(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());s.Touch=Hy;var Gy=function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i},Vy=st.TOUCH_TIMEOUT,ky=new kn,Wy=new kn,jy=new(function(){function e(){this._isRegisterEvent=!1,this._preTouchPoint=new kn,this._prevMousePoint=new kn,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._glView=null}var t=e.prototype;return t.handleTouchesBegin=function(e){for(var t=[],n=this._touchesIntegerDict,i=0;i<e.length;++i){var o=e[i],r=o.getID();if(null!==r&&void 0===n[r]){var a=this._getUnUsedIndex();if(-1===a){C(2300,a);continue}o.getLocation(ky);var s=new Hy(ky.x,ky.y,r);this._touches[a]=s,o.getPreviousLocation(ky),s.setPrevPoint(ky),n[r]=a,t.push(s)}}if(t.length>0){var c=new Fy(t,!1,Fm.TOUCH_START,st.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Xm.dispatchEvent(c)}},t.handleTouchesMove=function(e){for(var t=[],n=this._touches,i=0;i<e.length;++i){var o=e[i],r=o.getID();if(null!==r){var a=this._touchesIntegerDict[r];void 0!==a&&n[a]&&(o.getLocation(ky),n[a].setPoint(ky),o.getPreviousLocation(ky),n[a].setPrevPoint(ky),t.push(n[a]))}}if(t.length>0){var s=new Fy(t,!1,Fm.TOUCH_MOVE,st.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Xm.dispatchEvent(s)}},t.handleTouchesEnd=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var n=new Fy(t,!1,Fm.TOUCH_END,st.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Xm.dispatchEvent(n)}this._preTouchPool.length=0},t.handleTouchesCancel=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var n=new Fy(t,!1,Fm.TOUCH_CANCEL,st.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Xm.dispatchEvent(n)}this._preTouchPool.length=0},t.getSetOfTouchesEndOrCancel=function(e){for(var t=[],n=this._touches,i=this._touchesIntegerDict,o=0;o<e.length;++o){var r=e[o],a=r.getID();if(null!==a){var s=i[a];void 0!==s&&n[s]&&(r.getLocation(ky),n[s].setPoint(ky),r.getPreviousLocation(ky),n[s].setPrevPoint(ky),t.push(n[s]),this._removeUsedIndexBit(s),delete i[a])}}return t},t._getPreTouch=function(e){for(var t=null,n=this._preTouchPool,i=e.getID(),o=n.length-1;o>=0;o--)if(n[o].getID()===i){t=n[o];break}return t||(t=e),t},t._setPreTouch=function(e){for(var t=!1,n=this._preTouchPool,i=e.getID(),o=n.length-1;o>=0;o--)if(n[o].getID()===i){n[o]=e,t=!0;break}t||(n.length<=50?n.push(e):(n[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))},t._getViewPixelRatio=function(){return this._glView?this._glView._devicePixelRatio:1},t._getTouch=function(e){var t=this._preTouchPoint,n=this._getViewPixelRatio(),i=e.x*n,o=e.y*n,r=new Hy(i,o,0);return r.setPrevPoint(t.x,t.y),t.x=i,t.y=o,r},t._getMouseEvent=function(e){var t=this._prevMousePoint,n=new Ly(e.type,!1,t),i=this._getViewPixelRatio();return t.x=e.x*i,t.y=e.y*i,s.GAME_VIEW&&(t.x/=s.gameView.canvas.width/s.game.canvas.width,t.y/=s.gameView.canvas.height/s.game.canvas.height),n.setLocation(t.x,t.y),n.setButton(e.button),e.movementX&&(n.movementX=e.movementX),e.movementY&&(n.movementY=e.movementY),n},t._getTouchList=function(e){for(var t=[],n=this._preTouchPoint,i=e.changedTouches.length,o=this._getViewPixelRatio(),r=0;r<i;r++){var a=e.changedTouches[r],s=a.x*o,c=a.y*o,l=new Hy(s,c,a.identifier);if(this._getPreTouch(l).getLocation(Wy),l.setPrevPoint(Wy.x,Wy.y),this._setPreTouch(l),n.x=s,n.y=c,t.push(l),!st.ENABLE_MULTI_TOUCH)break}return t},t._getUnUsedIndex=function(){for(var e=this._indexBitsUsed,t=s.director.getCurrentTime(),n=0;n<this._maxTouches;n++){if(!(1&e))return this._indexBitsUsed|=1<<n,n;var i=this._touches[n];if(t-i.lastModified>Vy){this._removeUsedIndexBit(n);var o=i.getID();return null!==o&&delete this._touchesIntegerDict[o],n}e>>=1}return-1},t._removeUsedIndexBit=function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}},t._getUsefulTouches=function(){var e=[],t=this._touchesIntegerDict;for(var n in t){var i=t[parseInt(n)];if(null!=i){var o=this._touches[i];e.push(o)}}return e},t.setAccelerometerEnabled=function(e){e?Dy._accelerometer.start():Dy._accelerometer.stop()},t.setAccelerometerInterval=function(e){Dy._accelerometer.setInterval(e)},t.registerSystemEvent=function(){this._isRegisterEvent||(this._glView=s.view,Dy._mouse.support&&this._registerMouseEvents(),Dy._touch.support&&this._registerTouchEvents(),Dy._keyboard.support&&this._registerKeyboardEvent(),Dy._accelerometer.support&&this._registerAccelerometerEvent(),this._isRegisterEvent=!0)},t._registerMouseEvents=function(){var e=this;Dy._mouse.onDown((function(t){var n=e._getMouseEvent(t),i=e._getTouch(t);e.handleTouchesBegin([i]),Xm.dispatchEvent(n)})),Dy._mouse.onMove((function(t){var n=e._getMouseEvent(t),i=e._getTouch(t);e.handleTouchesMove([i]),Xm.dispatchEvent(n)})),Dy._mouse.onUp((function(t){var n=e._getMouseEvent(t),i=e._getTouch(t);e.handleTouchesEnd([i]),Xm.dispatchEvent(n)})),Dy._mouse.onWheel((function(t){var n=e._getMouseEvent(t);n.setScrollData(t.deltaX,t.deltaY),Xm.dispatchEvent(n)}))},t._registerTouchEvents=function(){var e=this;Dy._touch.onStart((function(t){var n=e._getTouchList(t);e.handleTouchesBegin(n)})),Dy._touch.onMove((function(t){var n=e._getTouchList(t);e.handleTouchesMove(n)})),Dy._touch.onEnd((function(t){var n=e._getTouchList(t);e.handleTouchesEnd(n)})),Dy._touch.onCancel((function(t){var n=e._getTouchList(t);e.handleTouchesCancel(n)}))},t._registerKeyboardEvent=function(){Dy._keyboard.onDown((function(e){Xm.dispatchEvent(new By(e.code,!0))})),Dy._keyboard.onUp((function(e){Xm.dispatchEvent(new By(e.code,!1))}))},t._registerAccelerometerEvent=function(){Dy._accelerometer.onChange((function(e){var t=e.x,n=e.y,i=e.z,o=e.timestamp;Xm.dispatchEvent(new zy(new Gy(t,n,i,o)))}))},e}());s.internal.inputManager=jy;var qy=null,Yy=null,Xy=null,Ky=null,Qy=e("f2",function(e){function t(){return e.call(this)||this}ee(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){e&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){C(3520,e),jy.setAccelerometerEnabled("granted"===e)})).catch((function(e){P(3521,e.message),jy.setAccelerometerEnabled(!1)})):jy.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){jy.setAccelerometerInterval(e)},n.on=function(t,n,i,o){return e.prototype.on.call(this,t,n,i,o),t!==Fm.KEY_DOWN&&t!==Fm.KEY_UP||qy||(qy=Bm.create({event:Bm.KEYBOARD,onKeyPressed:function(e,t){t.type=Fm.KEY_DOWN,Zy.emit(t.type,t)},onKeyReleased:function(e,t){t.type=Fm.KEY_UP,Zy.emit(t.type,t)}}),Xm.addListener(qy,256)),t===Fm.DEVICEMOTION&&(Yy||(Yy=Bm.create({event:Bm.ACCELERATION,callback:function(e,t){t.type=Fm.DEVICEMOTION,s.systemEvent.emit(t.type,t)}}),Xm.addListener(Yy,256))),t!==Fm.TOUCH_START&&t!==Fm.TOUCH_MOVE&&t!==Fm.TOUCH_END&&t!==Fm.TOUCH_CANCEL||Xy||(Xy=Bm.create({event:Bm.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=Fm.TOUCH_START,s.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=Fm.TOUCH_MOVE,s.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=Fm.TOUCH_END,s.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=Fm.TOUCH_CANCEL,s.systemEvent.emit(t.type,e,t)}}),Xm.addListener(Xy,256)),t!==Fm.MOUSE_DOWN&&t!==Fm.MOUSE_MOVE&&t!==Fm.MOUSE_UP&&t!==Fm.MOUSE_WHEEL||Ky||(Ky=Bm.create({event:Bm.MOUSE,onMouseDown:function(e){e.type=Fm.MOUSE_DOWN,s.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=Fm.MOUSE_MOVE,s.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=Fm.MOUSE_UP,s.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=Fm.MOUSE_WHEEL,s.systemEvent.emit(e.type,e)}}),Xm.addListener(Ky,256)),n},n.off=function(t,n,i){if(e.prototype.off.call(this,t,n,i),qy&&(t===Fm.KEY_DOWN||t===Fm.KEY_UP)){var o=this.hasEventListener(Fm.KEY_DOWN),r=this.hasEventListener(Fm.KEY_UP);o||r||(Xm.removeListener(qy),qy=null)}if(Yy&&t===Fm.DEVICEMOTION&&(Xm.removeListener(Yy),Yy=null),Xy&&(t===Fm.TOUCH_START||t===Fm.TOUCH_MOVE||t===Fm.TOUCH_END||t===Fm.TOUCH_CANCEL)){var a=this.hasEventListener(Fm.TOUCH_START),s=this.hasEventListener(Fm.TOUCH_MOVE),c=this.hasEventListener(Fm.TOUCH_END),l=this.hasEventListener(Fm.TOUCH_CANCEL);a||s||c||l||(Xm.removeListener(Xy),Xy=null)}if(Ky&&(t===Fm.MOUSE_DOWN||t===Fm.MOUSE_MOVE||t===Fm.MOUSE_UP||t===Fm.MOUSE_WHEEL)){var u=this.hasEventListener(Fm.MOUSE_DOWN),h=this.hasEventListener(Fm.MOUSE_MOVE),_=this.hasEventListener(Fm.MOUSE_UP),f=this.hasEventListener(Fm.MOUSE_WHEEL);u||h||_||f||(Xm.removeListener(Ky),Ky=null)}},t}(Ti));Qy.EventType=Fm,s.SystemEvent=Qy;var Zy=e("f3",new Qy);s.systemEvent=Zy;var Jy,$y,ex,tx,nx,ix,ox,rx,ax,sx,cx=wi.getViewSize(),lx=wi.pixelRatio,ux=e("br",{NetworkType:yi,Language:gi,OS:xi,Platform:Si,BrowserType:mi,isNative:wi.isNative,isBrowser:wi.isBrowser,isMobile:wi.isMobile,isLittleEndian:wi.isLittleEndian,platform:wi.platform,language:wi.language,languageCode:wi.nativeLanguage,os:wi.os,osVersion:wi.osVersion,osMainVersion:wi.osMainVersion,browserType:wi.browserType,browserVersion:wi.browserVersion,windowPixelResolution:{width:cx.width*lx,height:cx.height*lx},capabilities:{canvas:wi.supportCapability.canvas,opengl:wi.supportCapability.gl,webp:wi.supportCapability.webp,imageBitmap:wi.supportCapability.imageBitmap,touches:!1,mouse:!1,keyboard:!1,accelerometer:!1},localStorage:null,getNetworkType:function(){return wi.networkType},getBatteryLevel:function(){return wi.getBatteryLevel()},garbageCollect:function(){wi.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",v(e+="Using "+(s.game.renderType===s.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){wi.openURL(e)},now:function(){return wi.now()},restartVM:function(){wi.restartJSVM()},getSafeAreaRect:function(){var e=s.view,t=wi.getSafeAreaEdge(),n=wi.getViewSize(),i=new kn(t.left,n.height-t.bottom),o=new kn(n.width-t.right,t.top),r={left:0,top:0,width:n.width,height:n.height};e.convertToLocationInView(i.x,i.y,r,i),e.convertToLocationInView(o.x,o.y,r,o),e._convertPointWithScale(i),e._convertPointWithScale(o);var a=i.x,c=i.y,l=o.x-i.x,u=o.y-i.y;return new Jn(a,c,l,u)},__init:function(){try{var e=ux.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){P(5200)};ux.localStorage={getItem:t,setItem:t,removeItem:t,clear:t}}var n=window,i=n.navigator,o=document,r=o.documentElement,a=ux.capabilities;(void 0!==r.ontouchstart||void 0!==o.ontouchstart||i.msPointerEnabled)&&(a.touches=!0),void 0!==r.onmouseup&&(a.mouse=!0),void 0!==r.onkeyup&&(a.keyboard=!0),(n.DeviceMotionEvent||n.DeviceOrientationEvent)&&(a.accelerometer=!0),ux.__isWebIOS14OrIPadOS14Env=(ux.os===xi.IOS||ux.os===xi.OSX)&&wi.isBrowser&&/(OS 1[4-9])|(Version\/1[4-9])/.test(window.navigator.userAgent),wi.onViewResize((function(){var e=wi.getViewSize();ux.windowPixelResolution={width:Math.round(e.width*lx),height:Math.round(e.height*lx)}}))}});ux.__init(),s.sys=ux;var hx,_x,fx,dx,px,mx,vx,gx,yx,xx,Ex,Sx,Tx,Ax=e("fd",(Jy=b_("RenderStage"),$y=J_(),ex=J_(),tx=J_(),Jy((sx=function(){function e(){re(this,"_name",ox,this),re(this,"_priority",rx,this),re(this,"_tag",ax,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},J(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}}]),e}(),ox=ae((ix=sx).prototype,"_name",[$y,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rx=ae(ix.prototype,"_priority",[ex,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ax=ae(ix.prototype,"_tag",[tx,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nx=ix))||nx));s.RenderStage=Ax;var wx,Cx,Ix,Px,bx,Rx,Nx,Ox,Dx=e("fc",(hx=b_("RenderFlow"),_x=J_(),fx=J_(),dx=J_(),px=J_(),mx=rf([Ax]),hx((Tx=function(){function e(){re(this,"_name",yx,this),re(this,"_priority",xx,this),re(this,"_tag",Ex,this),re(this,"_stages",Sx,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},J(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),yx=ae((gx=Tx).prototype,"_name",[_x,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xx=ae(gx.prototype,"_priority",[fx,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ex=ae(gx.prototype,"_tag",[dx,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sx=ae(gx.prototype,"_stages",[px,mx,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vx=gx))||vx));s.RenderFlow=Dx;var Mx,Lx,Fx,zx,Bx,Ux,Hx,Gx,Vx,kx,Wx=e("eR",b_("cc.EffectAsset")((Ox=Nx=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"techniques",Ix,ne(t)),re(t,"shaders",Px,ne(t)),re(t,"combinations",bx,ne(t)),re(t,"hideInEditor",Rx,ne(t)),t}ee(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if(t._effects[e])delete t._effects[e];else for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){$p.register(this),t.register(this),s.game.once(s.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=s.director.root,n=function(n){var i=e.shaders[n],o=e.combinations[n];if(!o)return"continue";Object.keys(o).reduce((function(e,t){return e.reduce((function(e,n){for(var i=o[t],r=0;r<i.length;++r){var a=$({},n);a[t]=i[r],e.push(a)}return e}),[])}),[{}]).forEach((function(e){return $p.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return t.remove(this.name),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(zf),Nx._effects={},Ix=ae((Cx=Ox).prototype,"techniques",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Px=ae(Cx.prototype,"shaders",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bx=ae(Cx.prototype,"combinations",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rx=ae(Cx.prototype,"hideInEditor",[M_,L_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wx=Cx))||wx);s.EffectAsset=Wx;var jx=new fe("RenderTex"),qx=new Vs;qx.endAccesses=[Ya.FRAGMENT_SHADER_READ_TEXTURE];var Yx,Xx,Kx,Qx,Zx,Jx,$x,eE,tE,nE,iE=new ks,oE=new js([qx],iE),rE={width:1,height:1,renderPassInfo:oE},aE=e("da",(Mx=b_("cc.RenderTexture"),Lx=X_(),Fx=K_(),zx=X_(),Bx=K_(),Mx((kx=function(e){function t(){var t;return re(t=e.call(this)||this,"_width",Gx,ne(t)),re(t,"_height",Vx,ne(t)),t._textureHash=0,t._id=void 0,t._window=null,t._id=jx.getNewId(),t._textureHash=Ac(t._id,666),t}ee(t,e);var n=t.prototype;return n.getHash=function(){return this._textureHash},n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._window&&(s.director.root.destroyWindow(this._window),this._window=null),e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=e,this._height=t,this._window&&this._window.resize(e,t),this.emit("resize",this._window)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.getGFXSampler=function(){var e=s.director.root;return fd.getSampler(e.device,Qf)},n.getSamplerHash=function(){return Qf},n.onLoaded=function(){this._initWindow(),this.loaded=!0,this.emit("load")},n._initWindow=function(e){var t=s.director.root;rE.title=this._name,rE.width=this._width,rE.height=this._height,rE.renderPassInfo=e&&e.passInfo?e.passInfo:oE,this._window?(this._window.destroy(),this._window.initialize(t.device,rE)):this._window=t.createWindow(rE)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},J(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"window",get:function(){return this._window}}]),t}(zf),Gx=ae((Hx=kx).prototype,"_width",[M_,Lx,Fx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Vx=ae(Hx.prototype,"_height",[M_,zx,Bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ux=Hx))||Ux));s.RenderTexture=aE;var sE=e("cI",(Yx=b_("cc.Material"),Xx=rf(Wx),Yx((nE=function(e){function t(){var t;return re(t=e.call(this)||this,"_effectAsset",Zx,ne(t)),re(t,"_techIdx",Jx,ne(t)),re(t,"_defines",$x,ne(t)),re(t,"_states",eE,ne(t)),re(t,"_props",tE,ne(t)),t._passes=[],t._hash=0,t.loaded=!1,t}ee(t,e),t.getHash=function(e){for(var t,n=0,i=oe(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=Wx.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update(),this.loaded=!0,this.emit("load")},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=oe(this._passes);!(n=i()).done;){var o=n.value;o.resetUBOs(),o.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var o=this._passes,r=o.length,a=0;a<r;a++){var s=o[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,o=0;o<i;o++){var r=n[o];if(e in r)return r[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},n.copy=function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=$({},e._props[t]);this._defines.length=e._defines.length;for(var n=0;n<e._defines.length;n++)this._defines[n]=$({},e._defines[n]);this._states.length=e._states.length;for(var i=0;i<e._states.length;i++)this._states[i]=$({},e._states[i]);this._effectAsset=e._effectAsset,this._update()},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var o=0;o<n.length;++o)Object.assign(t[o]||(t[o]={}),n[o])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var o=e.passes[i],r=o.passIndex=i,a=o.defines=this._defines[r]||(this._defines[r]={}),c=o.stateOverrides=this._states[r]||(this._states[r]={});if(void 0!==o.propertyIndex&&(Object.assign(a,this._defines[o.propertyIndex]),Object.assign(c,this._states[o.propertyIndex])),void 0!==o.embeddedMacros&&Object.assign(a,o.embeddedMacros),!o.switch||a[o.switch]){var l=new um(s.director.root);l.initialize(o),n.push(l)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){if(this._passes&&this._passes.length)for(var i,o=oe(this._passes);!(i=o()).done;)i.value.destroy();this._passes=this._createPasses();var r=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=r,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var o in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,o,i[o])}));else for(var a=0;a<this._props.length;a++)this._props[a]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;var o=um.getPropertyTypeFromHandle(i);if(o===bp.BUFFER)Array.isArray(n)?e.setUniformArray(i,n):null!==n?e.setUniform(i,n):e.resetUniform(t);else if(o===bp.TEXTURE)if(Array.isArray(n))for(var r=0;r<n.length;r++)this._bindTexture(e,i,n[r],r);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var o=um.getBindingFromHandle(t);if(n instanceof Uc)e.bindTexture(o,n,i);else if(n instanceof pd||n instanceof aE){var r=n.getGFXTexture();if(!r||!r.width||!r.height)return;e.bindTexture(o,r,i),e.bindSampler(o,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=oe(this._passes);!(e=t()).done;)e.value.destroy();this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new Sn("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},J(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(zf),Zx=ae((Qx=nE).prototype,"_effectAsset",[Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jx=ae(Qx.prototype,"_techIdx",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$x=ae(Qx.prototype,"_defines",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eE=ae(Qx.prototype,"_states",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tE=ae(Qx.prototype,"_props",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kx=Qx))||Kx));s.Material=sE;var cE=nt({Planar:0,ShadowMap:1}),lE=nt({HARD:0,FILTER_X5:1,FILTER_X9:2,FILTER_X25:3}),uE=cE.ShadowMap+1,hE=function(){function e(){this.sphere=new rs(0,0,0,.01),this.maxReceived=4,this._normal=new An(0,1,0),this._shadowColor=new Sn(0,0,0,76),this._matLight=new Un,this._material=null,this._instancingMaterial=null,this._size=new kn(512,512),this._handle=To,this._handle=Pr.alloc()}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new sE,this._material.initialize({effectName:"planar-shadow"}),Pr.set(this._handle,Ar.PLANAR_PASS,this._material.passes[0].handle)),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new sE,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),Pr.set(this._handle,Ar.INSTANCE_PASS,this._instancingMaterial.passes[0].handle)),this._instancingMaterial.passes[0].getShaderVariant(e)},t.initialize=function(e){Pr.set(this._handle,Ar.TYPE,e.enabled?e.type:uE),Pr.set(this._handle,Ar.NEAR,e.near),Pr.set(this._handle,Ar.FAR,e.far),Pr.set(this._handle,Ar.ASPECT,e.aspect),Pr.set(this._handle,Ar.ORTHO_SIZE,e.orthoSize),this._size=e.shadowMapSize,Pr.setVec2(this._handle,Ar.SIZE,this._size),Pr.set(this._handle,Ar.PCF_TYPE,e.pcf),An.copy(this._normal,e.normal),Pr.setVec3(this._handle,Ar.NORMAL,this._normal),Pr.set(this._handle,Ar.DISTANCE,e.distance),this._shadowColor.set(e.shadowColor),Pr.setVec4(this._handle,Ar.COLOR,this._shadowColor),Pr.set(this._handle,Ar.BIAS,e.bias),Pr.set(this._handle,Ar.PACKING,e.packing?1:0),Pr.set(this._handle,Ar.LINEAR,e.linear?1:0),Pr.set(this._handle,Ar.SELF_SHADOW,e.selfShadow?1:0),Pr.set(this._handle,Ar.NORMAL_BIAS,e.normalBias),Pr.set(this._handle,Ar.ENABLE,e.enabled?1:0),this.maxReceived=e.maxReceived,Pr.set(this._handle,Ar.AUTO_ADAPT,e.autoAdapt?1:0)},t.activate=function(){if(this.enabled)this.type===cE.ShadowMap?this._updatePipeline():this._updatePlanarInfo();else{var e=s.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=0,e.onGlobalPipelineStateChanged()}},t._updatePlanarInfo=function(){this._material||(this._material=new sE,this._material.initialize({effectName:"planar-shadow"}),Pr.set(this._handle,Ar.PLANAR_PASS,this._material.passes[0].handle)),this._instancingMaterial||(this._instancingMaterial=new sE,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),Pr.set(this._handle,Ar.INSTANCE_PASS,this._instancingMaterial.passes[0].handle));var e=s.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=0,e.onGlobalPipelineStateChanged()},t._updatePipeline=function(){var e=s.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=1,e.onGlobalPipelineStateChanged()},t.destroy=function(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this._handle&&(Pr.free(this._handle),this._handle=To),this.sphere.destroy()},J(e,[{key:"enabled",get:function(){return!!Pr.get(this._handle,Ar.ENABLE)},set:function(e){Pr.set(this._handle,Ar.ENABLE,e?1:0),e||Pr.set(this._handle,Ar.TYPE,uE),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){An.copy(this._normal,e),Pr.setVec3(this._handle,Ar.NORMAL,this._normal)}},{key:"distance",get:function(){return Pr.get(this._handle,Ar.DISTANCE)},set:function(e){Pr.set(this._handle,Ar.DISTANCE,e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e,Pr.setVec4(this._handle,Ar.COLOR,e)}},{key:"type",get:function(){return Pr.get(this._handle,Ar.TYPE)},set:function(e){Pr.set(this._handle,Ar.TYPE,this.enabled?e:uE),this.activate()}},{key:"near",get:function(){return Pr.get(this._handle,Ar.NEAR)},set:function(e){Pr.set(this._handle,Ar.NEAR,e)}},{key:"far",get:function(){return Pr.get(this._handle,Ar.FAR)},set:function(e){Pr.set(this._handle,Ar.FAR,e)}},{key:"aspect",get:function(){return Pr.get(this._handle,Ar.ASPECT)},set:function(e){Pr.set(this._handle,Ar.ASPECT,e)}},{key:"orthoSize",get:function(){return Pr.get(this._handle,Ar.ORTHO_SIZE)},set:function(e){Pr.set(this._handle,Ar.ORTHO_SIZE,e)}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,Pr.setVec2(this._handle,Ar.SIZE,this._size)}},{key:"pcf",get:function(){return Pr.get(this._handle,Ar.PCF_TYPE)},set:function(e){Pr.set(this._handle,Ar.PCF_TYPE,e)}},{key:"shadowMapDirty",get:function(){return!!Pr.get(this._handle,Ar.SHADOW_MAP_DIRTY)},set:function(e){Pr.set(this._handle,Ar.SHADOW_MAP_DIRTY,e?1:0)}},{key:"bias",get:function(){return Pr.get(this._handle,Ar.BIAS)},set:function(e){Pr.set(this._handle,Ar.BIAS,e)}},{key:"packing",get:function(){return!!Pr.get(this._handle,Ar.PACKING)},set:function(e){Pr.set(this._handle,Ar.PACKING,e?1:0)}},{key:"linear",get:function(){return!!Pr.get(this._handle,Ar.LINEAR)},set:function(e){Pr.set(this._handle,Ar.LINEAR,e?1:0)}},{key:"selfShadow",get:function(){return!!Pr.get(this._handle,Ar.SELF_SHADOW)},set:function(e){Pr.set(this._handle,Ar.SELF_SHADOW,e?1:0)}},{key:"normalBias",get:function(){return Pr.get(this._handle,Ar.NORMAL_BIAS)},set:function(e){Pr.set(this._handle,Ar.NORMAL_BIAS,e)}},{key:"autoAdapt",get:function(){return!!Pr.get(this._handle,Ar.AUTO_ADAPT)},set:function(e){Pr.set(this._handle,Ar.AUTO_ADAPT,e?1:0)}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"handle",get:function(){return this._handle}}]),e}();hE.MAX_FAR=2e3,hE.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),s.Shadows=hE;var _E=new An,fE=new An,dE=new An,pE=new Un,mE=new su,vE=!1,gE=[],yE=rs.create(0,0,0,1),xE=new ti((function(){return{model:null,depth:0}}),128),EE=new ti((function(){return{model:null,depth:0}}),128);function SE(e,t){var n=0;e.node&&(An.subtract(_E,e.node.worldPosition,t.position),n=An.dot(_E,t.forward));var i=xE.alloc();return i.model=e,i.depth=n,i}function TE(e,t){var n=0;e.node&&(An.subtract(_E,e.node.worldPosition,t.position),n=An.dot(_E,t.forward));var i=EE.alloc();return i.model=e,i.depth=n,i}function AE(e,t,n,i){var o=e.pipelineSceneData.shadows;An.negate(fE,n);var r=o.sphere.radius*hE.COEFFICIENT_OF_EXPANSION;return An.multiplyScalar(dE,fE,r),An.add(dE,dE,o.sphere.center),i.set(dE),Un.fromRT(pE,t,dE),pE}function wE(e,t,n){var i=t.direction,o=e.normal,r=e.distance+.001,a=1/An.dot(o,i),s=i.x*a,c=i.y*a,l=i.z*a,u=o.x,h=o.y,_=o.z,f=e.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*r,f.m13=c*r,f.m14=l*r,f.m15=1,Un.toArray(n,f,th.MAT_LIGHT_PLANE_PROJ_OFFSET)}function CE(e,t){var n=t.scene,i=n.mainLight,o=e.pipelineSceneData,r=o.shadows,a=o.skybox,s=o.renderObjects;xE.freeArray(s),s.length=0;var c=null;vE=!1,r.enabled&&(e.pipelineUBO.updateShadowUBORange(th.SHADOW_COLOR_OFFSET,r.shadowColor),r.type===cE.ShadowMap&&(c=e.pipelineSceneData.shadowObjects,EE.freeArray(c),c.length=0)),i&&r.type===cE.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,o=n.normal,r=n.distance+.001,a=1/An.dot(o,i),s=i.x*a,c=i.y*a,l=i.z*a,u=o.x,h=o.y,_=o.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*r,f.m13=c*r,f.m14=l*r,f.m15=1,e.pipelineUBO.updateShadowUBORange(th.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),a.enabled&&a.model&&t.clearFlag&v_&&s.push(SE(a.model,t));for(var l=n.models,u=0;u<l.length;u++){var h=l[u];if(h.enabled&&(h.node&&(t.visibility&h.node.layer)===h.node.layer||t.visibility&h.visFlags)){if(null!=c&&h.castShadow&&h.worldBounds&&(vE||(mE.copy(h.worldBounds),vE=!0),su.merge(mE,mE,h.worldBounds),c.push(TE(h,t))),h.worldBounds&&!Kl.aabbFrustum(h.worldBounds,t.frustum))continue;s.push(SE(h,t))}}mE&&su.toBoundingSphere(r.sphere,mE)}var IE=new Un,PE=new Un,bE=new An,RE=new Yn,NE=function(){function e(){this._globalUBO=new Float32Array($u.COUNT),this._cameraUBO=new Float32Array(eh.COUNT),this._shadowUBO=new Float32Array(th.COUNT)}e.updateGlobalUBOView=function(e,t){var n=e.device,i=s.director.root,o=t,r=Math.floor(n.width),a=Math.floor(n.height);o[$u.TIME_OFFSET]=i.cumulativeTime,o[$u.TIME_OFFSET+1]=i.frameTime,o[$u.TIME_OFFSET+2]=s.director.getTotalFrames(),o[$u.SCREEN_SIZE_OFFSET]=n.width,o[$u.SCREEN_SIZE_OFFSET+1]=n.height,o[$u.SCREEN_SIZE_OFFSET+2]=1/n.width,o[$u.SCREEN_SIZE_OFFSET+3]=1/n.height,o[$u.NATIVE_SIZE_OFFSET]=r,o[$u.NATIVE_SIZE_OFFSET+1]=a,o[$u.NATIVE_SIZE_OFFSET+2]=1/o[$u.NATIVE_SIZE_OFFSET],o[$u.NATIVE_SIZE_OFFSET+3]=1/o[$u.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){var i=e.device,o=(n.scene?n.scene:s.director.getScene().renderScene).mainLight,r=e.pipelineSceneData,a=r.ambient,c=r.fog,l=Math.floor(i.width),u=Math.floor(i.height),h=t,_=n.exposure,f=r.isHDR,d=r.shadingScale,p=r.fpScale;if(h[eh.SCREEN_SCALE_OFFSET]=n.width/l*d,h[eh.SCREEN_SCALE_OFFSET+1]=n.height/u*d,h[eh.SCREEN_SCALE_OFFSET+2]=1/h[eh.SCREEN_SCALE_OFFSET],h[eh.SCREEN_SCALE_OFFSET+3]=1/h[eh.SCREEN_SCALE_OFFSET+1],h[eh.EXPOSURE_OFFSET]=_,h[eh.EXPOSURE_OFFSET+1]=1/_,h[eh.EXPOSURE_OFFSET+2]=f?1:0,h[eh.EXPOSURE_OFFSET+3]=p/_,o){if(An.toArray(h,o.direction,eh.MAIN_LIT_DIR_OFFSET),An.toArray(h,o.color,eh.MAIN_LIT_COLOR_OFFSET),o.useColorTemperature){var m=o.colorTemperatureRGB;h[eh.MAIN_LIT_COLOR_OFFSET]*=m.x,h[eh.MAIN_LIT_COLOR_OFFSET+1]*=m.y,h[eh.MAIN_LIT_COLOR_OFFSET+2]*=m.z}h[eh.MAIN_LIT_COLOR_OFFSET+3]=f?o.illuminance*p:o.illuminance*_}else An.toArray(h,An.UNIT_Z,eh.MAIN_LIT_DIR_OFFSET),Yn.toArray(h,Yn.ZERO,eh.MAIN_LIT_COLOR_OFFSET);var v=a.colorArray;v[3]=f?a.skyIllum*p:a.skyIllum*_,h.set(v,eh.AMBIENT_SKY_OFFSET),h.set(a.albedoArray,eh.AMBIENT_GROUND_OFFSET),Un.toArray(h,n.matView,eh.MAT_VIEW_OFFSET),Un.toArray(h,n.node.worldMatrix,eh.MAT_VIEW_INV_OFFSET),An.toArray(h,n.position,eh.CAMERA_POS_OFFSET),Un.toArray(h,n.matProj,eh.MAT_PROJ_OFFSET),Un.toArray(h,n.matProjInv,eh.MAT_PROJ_INV_OFFSET),Un.toArray(h,n.matViewProj,eh.MAT_VIEW_PROJ_OFFSET),Un.toArray(h,n.matViewProjInv,eh.MAT_VIEW_PROJ_INV_OFFSET),h[eh.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),h.set(c.colorArray,eh.GLOBAL_FOG_COLOR_OFFSET),h[eh.GLOBAL_FOG_BASE_OFFSET]=c.fogStart,h[eh.GLOBAL_FOG_BASE_OFFSET+1]=c.fogEnd,h[eh.GLOBAL_FOG_BASE_OFFSET+2]=c.fogDensity,h[eh.GLOBAL_FOG_ADD_OFFSET]=c.fogTop,h[eh.GLOBAL_FOG_ADD_OFFSET+1]=c.fogRange,h[eh.GLOBAL_FOG_ADD_OFFSET+2]=c.fogAtten},e.updateShadowUBOView=function(e,t,n){var i=e.device,o=n.scene.mainLight,r=e.pipelineSceneData.shadows,a=t;if(r.enabled){if(o&&r.type===cE.ShadowMap){var s,c=0,l=0,u=0;if(r.autoAdapt){s=AE(e,o.node.getWorldRotation(),o.direction,bE);var h=r.sphere.radius;c=h*r.aspect,l=h;var _=An.distance(r.sphere.center,bE);u=Math.min(_*hE.COEFFICIENT_OF_EXPANSION,hE.MAX_FAR)}else s=o.node.getWorldMatrix(),c=r.orthoSize*r.aspect,l=r.orthoSize,u=r.far;Un.toArray(a,s,th.MAT_LIGHT_VIEW_OFFSET),Un.invert(IE,s),Un.ortho(PE,-c,c,-l,l,r.near,u,i.capabilities.clipSpaceMinZ,i.capabilities.clipSpaceSignY),Un.multiply(PE,PE,IE),Un.toArray(a,PE,th.MAT_LIGHT_VIEW_PROJ_OFFSET);var f=c_(i),d=r.linear&&f?1:0;a[th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+0]=r.near,a[th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+1]=u,a[th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+2]=d,a[th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+3]=r.selfShadow?1:0,a[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,a[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,a[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,a[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias;var p=r.packing?1:f?0:1;a[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=p,a[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,a[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else o&&r.type===cE.Planar&&wE(r,o,a);Sn.toArray(a,r.shadowColor,th.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i,o=e.device,r=e.pipelineSceneData.shadows,a=t,s=c_(o),c=r.linear&&s?1:0,l=r.packing?1:s?0:1,u=0,h=0,_=0;switch(n.type){case _m.DIRECTIONAL:if(n.update(),r.autoAdapt){var f=n.node;f&&(i=AE(e,f.getWorldRotation(),n.direction,bE));var d=r.sphere.radius;u=d*r.aspect,h=d;var p=An.distance(r.sphere.center,bE);_=Math.min(p*hE.COEFFICIENT_OF_EXPANSION,hE.MAX_FAR)}else i=n.node.getWorldMatrix(),u=r.orthoSize*r.aspect,h=r.orthoSize,_=r.far;Un.toArray(a,i,th.MAT_LIGHT_VIEW_OFFSET),Un.invert(IE,i),RE.set(r.near,_,c,r.selfShadow?1:0),Yn.toArray(a,RE,th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET),RE.set(0,l,r.normalBias,0),Yn.toArray(a,RE,th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),Un.ortho(PE,-u,u,-h,h,r.near,_,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY);break;case _m.SPOT:Un.toArray(a,n.node.getWorldMatrix(),th.MAT_LIGHT_VIEW_OFFSET),Un.invert(IE,n.node.getWorldMatrix()),RE.set(.01,n.range,c,r.selfShadow?1:0),Yn.toArray(a,RE,th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET),RE.set(1,l,r.normalBias,0),Yn.toArray(a,RE,th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),Un.perspective(PE,n.spotAngle,n.aspect,.001,n.range)}Un.multiply(PE,PE,IE),Un.toArray(a,PE,th.MAT_LIGHT_VIEW_PROJ_OFFSET),RE.set(r.size.x,r.size.y,r.pcf,r.bias),Yn.toArray(a,RE,th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Sn.toArray(a,r.shadowColor,th.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new Ss(ba.UNIFORM|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,$u.SIZE,$u.SIZE));n.bindBuffer($u.BINDING,i);var o=e.createBuffer(new Ss(ba.UNIFORM|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,eh.SIZE,eh.SIZE));n.bindBuffer(eh.BINDING,o);var r=e.createBuffer(new Ss(ba.UNIFORM|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,th.SIZE,th.SIZE));n.bindBuffer(th.BINDING,r)},t.updateGlobalUBO=function(){var t=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;t.update(),e.updateGlobalUBOView(this._pipeline,this._globalUBO),n[0].updateBuffer(t.getBuffer($u.BINDING),this._globalUBO)},t.updateCameraUBO=function(t){var n=this._pipeline.descriptorSet,i=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),i[0].updateBuffer(n.getBuffer(eh.BINDING),this._cameraUBO)},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,o=this._pipeline.commandBuffers,r=n.shadowFrameBufferMap,a=t.scene.mainLight;i.update(),a&&r.has(a)&&i.bindTexture(nh,r.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),o[0].updateBuffer(i.getBuffer(th.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t){var n=this._pipeline.descriptorSet;e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,t),n.getBuffer(th.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof Un?Un.toArray(this._shadowUBO,t,e):t instanceof Sn&&Sn.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();NE._combineSignY=0;var OE=nt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),DE=OE.LAYERED+1,ME=function(){function e(){this._fogColor=new Sn("#C8C8C8"),this._colorArray=new Float32Array([.2,.2,.2,1]),this._handle=To,this._handle=wr.alloc()}var t=e.prototype;return t.initialize=function(e){wr.set(this._handle,xr.ENABLE,e.enabled?1:0),wr.set(this._handle,xr.TYPE,e.enabled?e.type:DE),this._fogColor.set(e.fogColor),Sn.toArray(this._colorArray,this._fogColor),wr.setVec4(this._handle,xr.COLOR,this._fogColor),wr.set(this._handle,xr.DENSITY,e.fogDensity),wr.set(this._handle,xr.START,e.fogStart),wr.set(this._handle,xr.END,e.fogEnd),wr.set(this._handle,xr.ATTEN,e.fogAtten),wr.set(this._handle,xr.TOP,e.fogTop),wr.set(this._handle,xr.RANGE,e.fogRange)},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=s.director.root,t=this.enabled?this.type:DE,n=e.pipeline;n.macros.CC_USE_FOG!==t&&(n.macros.CC_USE_FOG=t,e.onGlobalPipelineStateChanged())},t.destroy=function(){this._handle&&(wr.free(this._handle),this._handle=To)},J(e,[{key:"enabled",get:function(){return wr.get(this._handle,xr.ENABLE)},set:function(e){wr.set(this._handle,xr.ENABLE,e?1:0),e||wr.set(this._handle,xr.TYPE,DE),e?this.activate():this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),Sn.toArray(this._colorArray,this._fogColor),wr.setVec4(this._handle,xr.COLOR,this._fogColor)}},{key:"type",get:function(){return wr.get(this._handle,xr.TYPE)},set:function(e){wr.set(this._handle,xr.TYPE,this.enabled?e:DE),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return wr.get(this._handle,xr.DENSITY)},set:function(e){wr.set(this._handle,xr.DENSITY,e)}},{key:"fogStart",get:function(){return wr.get(this._handle,xr.START)},set:function(e){wr.set(this._handle,xr.START,e)}},{key:"fogEnd",get:function(){return wr.get(this._handle,xr.END)},set:function(e){wr.set(this._handle,xr.END,e)}},{key:"fogAtten",get:function(){return wr.get(this._handle,xr.ATTEN)},set:function(e){wr.set(this._handle,xr.ATTEN,e)}},{key:"fogTop",get:function(){return wr.get(this._handle,xr.TOP)},set:function(e){wr.set(this._handle,xr.TOP,e)}},{key:"fogRange",get:function(){return wr.get(this._handle,xr.RANGE)},set:function(e){wr.set(this._handle,xr.RANGE,e)}},{key:"colorArray",get:function(){return this._colorArray}},{key:"handle",get:function(){return this._handle}}]),e}();s.Fog=ME;var LE=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var o=0;o<i._shaderInfo.blocks.length;o++){var r=i._shaderInfo.blocks[o],a=i._blocks[r.binding],s=i._parent.blocks[r.binding];a.set(s)}i._rootBufferDirty=!0;for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return e.prototype.tryCompile.call(ne(i)),i}ee(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),um.fillPipelineInfo(this,e),um.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!jp(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,Ho.set(this._handle,So.BATCHING_SCHEME,0)},n._onStateChange=function(){Ho.set(this._handle,So.HASH,um.getPassHash(this,this._hShaderDefault)),this._owner.onPassStateChange(this._dontNotify)},J(t,[{key:"parent",get:function(){return this._parent}}]),t}(um),FE=e("d6",function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}ee(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=oe(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var o=this._passes[i],r=this._states[i]||(this._states[i]={});for(var a in e)r[a]=e[a];o.overridePipelineStates(n[o.passIndex],r)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=sE.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new LE(t[n],this));return e},J(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(sE)),zE=null,BE=null,UE=function(){function e(){this._envmap=null,this._globalDescriptorSet=null,this._model=null,this._default=null,this._handle=To,this._handle=Sr.alloc()}var t=e.prototype;return t.initialize=function(e){Sr.set(this._handle,gr.ENABLE,e.enabled?1:0),Sr.set(this._handle,gr.USE_IBL,e.useIBL?1:0),Sr.set(this._handle,gr.IS_RGBE,e.isRGBE?1:0),this._envmap=e.envmap},t.activate=function(){var e=s.director.root.pipeline,t=e.pipelineSceneData.ambient;if(this._globalDescriptorSet=e.descriptorSet,this._default=rm.get("default-cube-texture"),this._model||(this._model=s.director.root.createModel(s.renderer.scene.Model),this._model._initLocalDescriptors=function(){}),Sr.set(this._handle,gr.MODEL,this._model.handle),this._envmap||(this._envmap=this._default),t.albedoArray[3]=this._envmap.mipmapLevel,BE)BE.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{var n=new sE;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),BE=new FE({parent:n})}this.enabled&&(zE||(zE=s.utils.createMesh(s.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,zE.renderingSubMeshes[0],BE)),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=this.useIBL?this.isRGBE?2:1:0,t=s.director.root,n=t.pipeline;n.macros.CC_USE_IBL!==e&&(n.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())},t._updateGlobalBinding=function(){var e=this.envmap.getGFXTexture(),t=fd.getSampler(s.director._device,this.envmap.getSamplerHash());this._globalDescriptorSet.bindSampler(xh,t),this._globalDescriptorSet.bindTexture(xh,e)},t.destroy=function(){this._handle&&(Sr.free(this._handle),this._handle=To)},J(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return Sr.get(this._handle,gr.ENABLE)},set:function(e){e?this.activate():this._updatePipeline(),Sr.set(this._handle,gr.ENABLE,e?1:0)}},{key:"useIBL",get:function(){return Sr.get(this._handle,gr.USE_IBL)},set:function(e){Sr.set(this._handle,gr.USE_IBL,e?1:0),this._updatePipeline()}},{key:"isRGBE",get:function(){return Sr.get(this._handle,gr.IS_RGBE)},set:function(e){e&&(BE&&BE.recompileShaders({USE_RGBE_CUBEMAP:e}),this._model&&this._model.setSubModelMaterial(0,BE)),Sr.set(this._handle,gr.IS_RGBE,e?1:0),this._updatePipeline()}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e||this._default,this._envmap&&(s.director.root.pipeline.pipelineSceneData.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}},{key:"handle",get:function(){return this._handle}}]),e}();s.Skybox=UE;var HE,GE,VE,kE,WE,jE,qE,YE,XE,KE,QE,ZE=function(){function e(){this.fog=new ME,this.ambient=new ea,this.skybox=new UE,this.shadows=new hE,this.renderObjects=[],this.shadowObjects=[],this.shadowFrameBufferMap=new Map,this._handle=Nr.alloc(),Nr.set(this._handle,Ir.AMBIENT,this.ambient.handle),Nr.set(this._handle,Ir.SKYBOX,this.skybox.handle),Nr.set(this._handle,Ir.FOG,this.fog.handle),Nr.set(this._handle,Ir.SHADOW,this.shadows.handle),Nr.set(this._handle,Ir.IS_HDR,0),Nr.set(this._handle,Ir.SHADING_SCALE,1),Nr.set(this._handle,Ir.FP_SCALE,1/1024)}var t=e.prototype;return t.initDeferredPassInfo=function(){var e=rm.get("builtin-deferred-material");if(e){var t=e.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}var n=rm.get("builtin-post-process-material");if(n){var i=n.passes[0];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}if(e){var o=e.passes[0];Nr.set(this._handle,Ir.DEFERRED_LIGHT_PASS,o.handle),Nr.set(this._handle,Ir.DEFERRED_LIGHT_PASS_SHADER,o.getShaderVariant())}if(n){var r=n.passes[0];Nr.set(this._handle,Ir.DEFERRED_POST_PASS,r.handle),Nr.set(this._handle,Ir.DEFERRED_POST_PASS_SHADER,r.getShaderVariant())}},t.activate=function(e,t){return this._device=e,this._pipeline=t,this.initDeferredPassInfo(),!0},t.destroy=function(){this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this._handle&&Nr.free(this._handle)},J(e,[{key:"handle",get:function(){return this._handle}},{key:"isHDR",get:function(){return Nr.get(this._handle,Ir.IS_HDR)},set:function(e){Nr.set(this._handle,Ir.IS_HDR,e?1:0)}},{key:"shadingScale",get:function(){return Nr.get(this._handle,Ir.SHADING_SCALE)},set:function(e){Nr.set(this._handle,Ir.SHADING_SCALE,e)}},{key:"fpScale",get:function(){return Nr.get(this._handle,Ir.FP_SCALE)},set:function(e){Nr.set(this._handle,Ir.FP_SCALE,e)}},{key:"deferredLightPassHandle",get:function(){return Nr.get(this._handle,Ir.DEFERRED_LIGHT_PASS)}},{key:"deferredLightPassShaderHandle",get:function(){return Nr.get(this._handle,Ir.DEFERRED_LIGHT_PASS_SHADER)}},{key:"deferredPostPassHandle",get:function(){return Nr.get(this._handle,Ir.DEFERRED_POST_PASS)}},{key:"deferredPostPassShaderHandle",get:function(){return Nr.get(this._handle,Ir.DEFERRED_POST_PASS_SHADER)}}]),e}(),JE=e("fb",(HE=b_("cc.RenderPipeline"),GE=J_(),VE=J_(),kE=rf([Dx]),HE((XE=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"_tag",qE,ne(t)),re(t,"_flows",YE,ne(t)),t._commandBuffers=[],t._pipelineUBO=new NE,t._pipelineSceneData=new ZE,t._macros={},t._constantMacros="",t}ee(t,e);var n=t.prototype;return n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.generateRenderArea=function(e){var t=new _s,n=e.viewport,i=this.pipelineSceneData,o=e.window.hasOnScreenAttachments&&this.device.surfaceTransform%2?e.height:e.width,r=e.window.hasOnScreenAttachments&&this.device.surfaceTransform%2?e.width:e.height;return t.x=n.x*o,t.y=n.y*r,t.width=n.width*o*i.shadingScale,t.height=n.height*r*i.shadingScale,t},n.activate=function(){this._device=s.director.root.device;var e=new Qs(Wu.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._descriptorSet=this._device.createDescriptorSet(new Zs(this._descriptorSetLayout)),this._pipelineUBO.activate(this._device,this),this._pipelineSceneData.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),!0},n.render=function(e){for(var t=0;t<this.flows.length;t++)for(var n=0;n<e.length;n++){var i=e[n];this.flows[t].render(i)}},n.destroy=function(){for(var t=0;t<this._flows.length;t++)this._flows[t].destroy();this._flows.length=0,this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null);for(var n=0;n<this._commandBuffers.length;n++)this._commandBuffers[n].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),this._pipelineSceneData.destroy(),e.prototype.destroy.call(this)},n.resize=function(){},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(wa.TEXTURE_FLOAT)?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",this._constantMacros=e},J(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}}]),t}(zf),qE=ae((jE=XE).prototype,"_tag",[GE,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YE=ae(jE.prototype,"_flows",[VE,kE,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WE=jE))||WE));s.RenderPipeline=JE,function(e){e[e.FORWARD=10]="FORWARD",e[e.UI=20]="UI"}(KE||(KE={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(QE||(QE={}));var $E,eS,tS,nS,iS,oS,rS,aS,sS,cS,lS,uS,hS,_S,fS,dS,pS,mS,vS,gS,yS,xS,ES,SS,TS,AS,wS,CS,IS,PS,bS,RS,NS,OS,DS,MS,LS,FS,zS,BS,US,HS,GS,VS,kS,WS,jS,qS,YS,XS,KS,QS,ZS,JS,$S,eT,tT,nT,iT,oT,rT,aT,sT,cT,lT,uT,hT,_T,fT,dT,pT,mT,vT,gT,yT,xT,ET,ST,TT,AT,wT=e("fq",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,o){var r=t.handle,a=Ho.get(r,So.HASH)^i.hash^o.attributesHash^n.id,s=this._PSOHashMap.get(a);if(!s){var c=Io.get(Ho.get(r,So.PIPELINE_LAYOUT)),l=new $s(o.attributes),u=new Dc(n,c,i,l,t.rasterizerState,t.depthStencilState,t.blendState,Ho.get(r,So.PRIMITIVE),Ho.get(r,So.DYNAMIC_STATES));s=e.createPipelineState(u),this._PSOHashMap.set(a,s)}return s},e}());wT._PSOHashMap=new Map,rt(Da),rt(Ma),rt(qa),rt(ja),rt(Ya),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(AT||(AT={})),rt(AT),$E=b_("RenderTextureDesc"),eS=rf(Da),tS=rf(Ma),nS=rf(Ca),$E((oS=ae((iS=function(){re(this,"name",oS,this),re(this,"type",rS,this),re(this,"usage",aS,this),re(this,"format",sS,this),re(this,"width",cS,this),re(this,"height",lS,this)}).prototype,"name",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rS=ae(iS.prototype,"type",[eS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Da.TEX2D}}),aS=ae(iS.prototype,"usage",[tS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ma.COLOR_ATTACHMENT}}),sS=ae(iS.prototype,"format",[nS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ca.UNKNOWN}}),cS=ae(iS.prototype,"width",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),lS=ae(iS.prototype,"height",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),iS));var CT,IT=(uS=b_("RenderTextureConfig"),hS=rf(aE),uS((dS=ae((fS=function(){re(this,"name",dS,this),re(this,"texture",pS,this)}).prototype,"name",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pS=ae(fS.prototype,"texture",[hS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_S=fS))||_S),PT=(mS=b_("MaterialConfig"),vS=rf(sE),mS((xS=ae((yS=function(){re(this,"name",xS,this),re(this,"material",ES,this)}).prototype,"name",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ES=ae(yS.prototype,"material",[vS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gS=yS))||gS),bT=(SS=b_("FrameBufferDesc"),TS=rf([Ot]),AS=rf(aE),SS((CS=ae((wS=function(){re(this,"name",CS,this),re(this,"renderPass",IS,this),re(this,"colorTextures",PS,this),re(this,"depthStencilTexture",bS,this),re(this,"texture",RS,this)}).prototype,"name",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),IS=ae(wS.prototype,"renderPass",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PS=ae(wS.prototype,"colorTextures",[TS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bS=ae(wS.prototype,"depthStencilTexture",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),RS=ae(wS.prototype,"texture",[AS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wS)),NS=b_("ColorDesc"),OS=rf(Ca),DS=rf(ja),MS=rf(qa),LS=rf([Ya]),FS=rf([Ya]),NS((US=ae((BS=function(){re(this,"format",US,this),re(this,"loadOp",HS,this),re(this,"storeOp",GS,this),re(this,"sampleCount",VS,this),re(this,"beginAccesses",kS,this),re(this,"endAccesses",WS,this)}).prototype,"format",[OS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ca.UNKNOWN}}),HS=ae(BS.prototype,"loadOp",[DS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ja.CLEAR}}),GS=ae(BS.prototype,"storeOp",[MS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qa.STORE}}),VS=ae(BS.prototype,"sampleCount",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kS=ae(BS.prototype,"beginAccesses",[LS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WS=ae(BS.prototype,"endAccesses",[FS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Ya.PRESENT]}}),zS=BS))||zS),RT=(jS=b_("DepthStencilDesc"),qS=rf(Ca),YS=rf(ja),XS=rf(qa),KS=rf(ja),QS=rf(qa),ZS=rf([Ya]),JS=rf([Ya]),jS((tT=ae((eT=function(){re(this,"format",tT,this),re(this,"depthLoadOp",nT,this),re(this,"depthStoreOp",iT,this),re(this,"stencilLoadOp",oT,this),re(this,"stencilStoreOp",rT,this),re(this,"sampleCount",aT,this),re(this,"beginAccesses",sT,this),re(this,"endAccesses",cT,this)}).prototype,"format",[qS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ca.UNKNOWN}}),nT=ae(eT.prototype,"depthLoadOp",[YS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ja.CLEAR}}),iT=ae(eT.prototype,"depthStoreOp",[XS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qa.STORE}}),oT=ae(eT.prototype,"stencilLoadOp",[KS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ja.CLEAR}}),rT=ae(eT.prototype,"stencilStoreOp",[QS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qa.STORE}}),aT=ae(eT.prototype,"sampleCount",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sT=ae(eT.prototype,"beginAccesses",[ZS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cT=ae(eT.prototype,"endAccesses",[JS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Ya.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),$S=eT))||$S);lT=b_("RenderPassDesc"),uT=rf([bT]),hT=rf(RT),lT((fT=ae((_T=function(){re(this,"index",fT,this),re(this,"colorAttachments",dT,this),re(this,"depthStencilAttachment",pT,this)}).prototype,"index",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),dT=ae(_T.prototype,"colorAttachments",[uT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pT=ae(_T.prototype,"depthStencilAttachment",[hT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RT}}),_T)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(CT||(CT={})),rt(CT);var NT=(mT=b_("RenderQueueDesc"),vT=rf(CT),gT=rf([Ot]),mT((ET=ae((xT=function(){re(this,"isTransparent",ET,this),re(this,"sortMode",ST,this),re(this,"stages",TT,this)}).prototype,"isTransparent",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ST=ae(xT.prototype,"sortMode",[vT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CT.FRONT_TO_BACK}}),TT=ae(xT.prototype,"stages",[gT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yT=xT))||yT);function OT(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function DT(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var MT=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new ni((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new ii(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],o=ko.get(i.handle,Bo.PASS_0+n);if(i.passes[n].blendState.targets[0].blend!==this._passDesc.isTransparent||!(Ho.get(o,So.PHASE)&this._passDesc.phases))return!1;var r=0|Ho.get(o,So.PRIORITY)<<16|i.priority<<8|n,a=this._passPool.add();return a.hash=r,a.depth=e.depth||0,a.shaderId=ko.get(i.handle,Bo.SHADER_0+n),a.subModel=i,a.passIdx=n,this.queue.push(a),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var o=this.queue.array[i],r=o.subModel,a=o.passIdx,s=r.inputAssembler,c=r.handle,l=r.passes[a],u=Ao.get(ko.get(c,Bo.SHADER_0+a)),h=wT.getOrCreatePipelineState(e,l,u,t,s);n.bindPipelineState(h),n.bindDescriptorSet(Ku.MATERIAL,l.descriptorSet),n.bindDescriptorSet(Ku.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function LT(e){for(var t=0,n=0;n<e.stages.length;n++)t|=am(e.stages[n]);var i=OT;switch(e.sortMode){case CT.BACK_TO_FRONT:i=DT;break;case CT.FRONT_TO_BACK:i=OT}return new MT({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function FT(e){e.clear()}function zT(e){e.sort()}function BT(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var UT=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var o=n.value.batches[i];if(o.mergeCount){for(var r=0;r<o.vbs.length;++r)o.vbs[r].update(o.vbDatas[r]);e.updateBuffer(o.vbIdx,o.vbIdxData.buffer),e.updateBuffer(o.ubo,o.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),o=i.next();!o.done;){for(var r=!1,a=0;a<o.value.batches.length;++a){var s=o.value.batches[a];if(s.mergeCount){if(!r){var c=Ao.get(s.hShader),l=wT.getOrCreatePipelineState(e,s.pass,c,t,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(Ku.MATERIAL,s.pass.descriptorSet),r=!0}n.bindDescriptorSet(Ku.LOCAL,s.descriptorSet,o.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}o=i.next()}},e}(),HT=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),o=i.next();!o.done;){var r=o.value,a=r.instances,s=r.pass;if(r.hasPendingModels){n.bindDescriptorSet(Ku.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=Ao.get(u.hShader),_=wT.getOrCreatePipelineState(e,s,h,t,u.ia);c!==_&&(n.bindPipelineState(_),c=_),n.bindDescriptorSet(Ku.LOCAL,wo.get(u.hDescriptorSet),o.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}o=i.next()}},e}(),GT=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}e.get=function(t,n){void 0===n&&(n=0);var i=e._buffers;i.has(t)||i.set(t,{});var o=i.get(t);return o[n]||(o[n]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var o=0,r=0,a=i[0].count,s=e.passes[t],c=ko.get(e.handle,Bo.SHADER_0+t),l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<Ph.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var d=0;d<_.vbs.length;++d){var p=i[d],m=_.vbs[d],v=_.vbDatas[d];(o=(a+_.vbCount)*p.stride)>m.size&&(m.resize(o),_.vbDatas[d]=new Uint8Array(o),_.vbDatas[d].set(v)),_.vbDatas[d].set(p.buffer,_.vbCount*p.stride)}var g=_.vbIdxData;(r=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(r),_.vbIdxData=new Float32Array(r/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+a,E=_.mergeCount;if(g[y]!==E||g[x-1]!==E)for(var S=y;S<x;S++)g[S]=E+.1;return Un.toArray(_.uboData,n.transform.worldMatrix,Ph.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(Ph.BINDING,_.ubo),l.update(),_.pass=s,_.hShader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var T=[],A=[],w=[],C=0;C<i.length;++C){var I=i[C],P=this._device.createBuffer(new Ss(ba.VERTEX|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,I.count*I.stride,I.stride));P.update(I.buffer.buffer),T.push(P),A.push(new Uint8Array(P.size)),w.push(P)}var b=this._device.createBuffer(new Ss(ba.VERTEX|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,4*a,4)),R=new Float32Array(a);R.fill(0),b.update(R),w.push(b);for(var N=e.inputAssembler.attributes,O=new Array(N.length+1),D=0;D<N.length;++D)O[D]=N[D];O[N.length]=new Us("a_dyn_batch_id",Ca.R32F,!1,i.length);var M=new Gs(O,w),L=this._device.createInputAssembler(M),F=this._device.createBuffer(new Ss(ba.UNIFORM|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,Ph.SIZE,Ph.SIZE));l.bindBuffer(Ph.BINDING,F),l.update();var z=new Float32Array(Ph.COUNT);Un.toArray(z,n.transform.worldMatrix,Ph.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:T,vbDatas:A,vbIdx:b,vbIdxData:R,vbCount:a,ia:L,ubo:F,uboData:z,pass:s,hShader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}();GT._buffers=new Map;var VT=e("fp",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}e.get=function(t,n){void 0===n&&(n=0);var i=e._buffers;i.has(t)||i.set(t,{});var o=i.get(t);return o[n]||(o[n]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var o=t.buffer.length;if(o){var r=e.inputAssembler,a=e.descriptorSet.getTexture(Xh),s=i;s||(s=ko.get(e.handle,Bo.SHADER_0+n));for(var c=ko.get(e.handle,Bo.DESCRIPTOR_SET),l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==r.indexBuffer||u.count>=1024)&&u.lightingMap===a){if(u.stride!==o)return;if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.hShader!==s&&(u.hShader=s),u.hDescriptorSet!==c&&(u.hDescriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new Ss(ba.VERTEX|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,32*o,o)),d=new Uint8Array(32*o),p=r.vertexBuffers.slice(),m=r.attributes.slice(),v=r.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],x=new Us(y.name,y.format,y.isNormalized,p.length,!0);m.push(x)}d.set(t.buffer),p.push(f);var E=new Gs(m,p,v),S=this._device.createInputAssembler(E);this.instances.push({count:1,capacity:32,vb:f,data:d,ia:S,stride:o,hShader:s,hDescriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}());VT._buffers=new Map;var kT=[za.LINEAR,za.LINEAR,za.NONE,Ba.CLAMP,Ba.CLAMP,Ba.CLAMP],WT=new ti((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),jT=new Float32Array(4),qT=rs.create(0,0,0,1),YT=[],XT=[],KT=new Un,QT=new Un;function ZT(e,t){return!(!t.worldBounds||Kl.aabbWithAABB(t.worldBounds,e.aabb))}function JT(e,t){return!(!t.worldBounds||Kl.aabbWithAABB(t.worldBounds,e.aabb)&&Kl.aabbFrustum(t.worldBounds,e.frustum))}var $T=am("forward-add"),eA=[];function tA(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var o=e[i].passes,r=-1,a=0;a<o.length;a++)if(o[a].phase===$T){r=a,n=!0;break}t.push(r)}return n}var nA,iA,oA,rA,aA,sA,cA,lA,uA,hA,_A,fA=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._validLights=[],this._lightPasses=[],this._descriptorSetMap=new Map,this._shadowUBO=new Float32Array(th.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._sampler=null,this._pipeline=e,this._device=e.device,this._instancedQueue=new HT,this._batchedQueue=new UT;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(bh.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new Ss(ba.UNIFORM|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new Ts(this._lightBuffer,0,bh.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount);var n=$f(kT);this._sampler=fd.getSampler(this._device,n)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear(),this._validLights.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}WT.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=Array.from(this._descriptorSetMap.values()),t=0;t<e.length;++t){var n=e[t];n&&(n.getBuffer($u.BINDING).destroy(),n.getBuffer(th.BINDING).destroy(),n.getSampler(nh).destroy(),n.getSampler(Th).destroy(),n.getTexture(nh).destroy(),n.getTexture(Th).destroy(),n.destroy())}this._descriptorSetMap.clear()},t.gatherLightPasses=function(e,t){var n=this._validLights;if(this.clear(),this._gatherValidLights(e,n),n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,o=0;o<i.length;o++){var r=i[o].model,a=r.subModels;if(tA(a,eA)&&(XT.length=0,this._lightCulling(r,n),XT.length))for(var s=0;s<a.length;s++){var c=eA[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.descriptorSet.bindBuffer(bh.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,r,c,n)}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._lightPasses.length;i++){var o=this._lightPasses[i],r=o.subModel,a=o.passIdx,s=o.dynamicOffsets,c=o.lights,l=Ao.get(ko.get(r.handle,Bo.SHADER_0+a)),u=r.passes[a],h=r.inputAssembler,_=wT.getOrCreatePipelineState(e,u,l,t,h),f=wo.get(Ho.get(u.handle,So.DESCRIPTOR_SET)),d=r.descriptorSet;n.bindPipelineState(_),n.bindDescriptorSet(Ku.MATERIAL,f),n.bindInputAssembler(h);for(var p=0;p<s.length;++p){var m=c[p],v=this._getOrCreateDescriptorSet(m);YT[0]=s[p],n.bindDescriptorSet(Ku.GLOBAL,v),n.bindDescriptorSet(Ku.LOCAL,d,YT),n.draw(h)}}},t._gatherValidLights=function(e,t){for(var n=e.scene.sphereLights,i=0;i<n.length;i++){var o=n[i];o.baked||(rs.set(qT,o.position.x,o.position.y,o.position.z,o.range),Kl.sphereFrustum(qT,e.frustum)&&(t.push(o),this._getOrCreateDescriptorSet(o)))}for(var r=e.scene.spotLights,a=0;a<r.length;a++){var s=r[a];s.baked||(rs.set(qT,s.position.x,s.position.y,s.position.z,s.range),Kl.sphereFrustum(qT,e.frustum)&&(t.push(s),this._getOrCreateDescriptorSet(s)))}},t._lightCulling=function(e,t){for(var n=0;n<t.length;n++){var i=t[n],o=!1;switch(i.type){case _m.SPHERE:o=ZT(i,e);break;case _m.SPOT:o=JT(i,e)}o||XT.push(n)}},t._addRenderQueue=function(e,t,n,i,o){var r=e.batchingScheme;if(r===nm.INSTANCING)for(var a=0;a<XT.length;a++){var s=XT[a],c=VT.get(e,s);c.merge(t,n.instancedAttributes,i),c.dynamicOffsets[0]=this._lightBufferStride*s,this._instancedQueue.queue.add(c)}else if(r===nm.VB_MERGING)for(var l=0;l<XT.length;l++){var u=XT[l],h=GT.get(e,u);h.merge(t,i,n),h.dynamicOffsets[0]=this._lightBufferStride*u,this._batchedQueue.queue.add(h)}else{var _=WT.alloc();_.subModel=t,_.passIdx=i;for(var f=0;f<XT.length;f++){var d=XT[f];_.lights.push(o[d]),_.dynamicOffsets.push(this._lightBufferStride*d)}this._lightPasses.push(_)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,o=i.shadows,r=i.shadowFrameBufferMap,a=e.scene.mainLight,s=c_(n),c=o.linear&&s?1:0,l=o.packing?1:s?0:1,u=0;u<this._validLights.length;u++){var h=this._validLights[u],_=this._getOrCreateDescriptorSet(h);if(_){switch(h.type){case _m.SPHERE:a&&wE(o,a,this._shadowUBO),this._shadowUBO[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,this._shadowUBO[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,this._shadowUBO[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,this._shadowUBO[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,this._shadowUBO[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=l,this._shadowUBO[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,this._shadowUBO[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Sn.toArray(this._shadowUBO,o.shadowColor,th.SHADOW_COLOR_OFFSET);break;case _m.SPOT:if(a&&wE(o,a,this._shadowUBO),Un.toArray(this._shadowUBO,h.node.getWorldMatrix(),th.MAT_LIGHT_VIEW_OFFSET),Un.invert(KT,h.node.getWorldMatrix()),Un.perspective(QT,h.spotAngle,h.aspect,.001,h.range),Un.multiply(QT,QT,KT),Un.toArray(this._shadowUBO,QT,th.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+0]=.01,this._shadowUBO[th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+1]=h.range,this._shadowUBO[th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+2]=c,this._shadowUBO[th.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+3]=o.selfShadow?1:0,this._shadowUBO[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,this._shadowUBO[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,this._shadowUBO[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,this._shadowUBO[th.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,this._shadowUBO[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=l,this._shadowUBO[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,this._shadowUBO[th.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Sn.toArray(this._shadowUBO,o.shadowColor,th.SHADOW_COLOR_OFFSET),r.has(h)&&r.has(h)){var f,d=null===(f=r.get(h))||void 0===f?void 0:f.colorTextures[0];d&&_.bindTexture(Th,d)}}_.update(),t.updateBuffer(_.getBuffer(th.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,o=i.isHDR,r=i.fpScale;this._validLights.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=pn(this._validLights.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new Ts(this._lightBuffer,0,bh.SIZE)));for(var a=0,s=0;a<this._validLights.length;a++,s+=this._lightBufferElementCount){var c=this._validLights[a];switch(c.type){case _m.SPHERE:if(An.toArray(jT,c.position),jT[3]=0,this._lightBufferData.set(jT,s+bh.LIGHT_POS_OFFSET),jT[0]=c.size,jT[1]=c.range,jT[2]=0,this._lightBufferData.set(jT,s+bh.LIGHT_SIZE_RANGE_ANGLE_OFFSET),An.toArray(jT,c.color),c.useColorTemperature){var l=c.colorTemperatureRGB;jT[0]*=l.x,jT[1]*=l.y,jT[2]*=l.z}jT[3]=o?c.luminance*r*this._lightMeterScale:c.luminance*n*this._lightMeterScale,this._lightBufferData.set(jT,s+bh.LIGHT_COLOR_OFFSET);break;case _m.SPOT:if(An.toArray(jT,c.position),jT[3]=1,this._lightBufferData.set(jT,s+bh.LIGHT_POS_OFFSET),jT[0]=c.size,jT[1]=c.range,jT[2]=c.spotAngle,this._lightBufferData.set(jT,s+bh.LIGHT_SIZE_RANGE_ANGLE_OFFSET),An.toArray(jT,c.direction),this._lightBufferData.set(jT,s+bh.LIGHT_DIR_OFFSET),An.toArray(jT,c.color),c.useColorTemperature){var u=c.colorTemperatureRGB;jT[0]*=u.x,jT[1]*=u.y,jT[2]*=u.z}jT[3]=o?c.luminance*r*this._lightMeterScale:c.luminance*n*this._lightMeterScale,this._lightBufferData.set(jT,s+bh.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},t._getOrCreateDescriptorSet=function(e){if(!this._descriptorSetMap.has(e)){var t=this._device,n=t.createDescriptorSet(new Zs(this._pipeline.descriptorSetLayout));n.bindBuffer($u.BINDING,this._pipeline.descriptorSet.getBuffer($u.BINDING)),n.bindBuffer(eh.BINDING,this._pipeline.descriptorSet.getBuffer(eh.BINDING));var i=t.createBuffer(new Ss(ba.UNIFORM|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,th.SIZE,th.SIZE));return n.bindBuffer(th.BINDING,i),n.bindSampler(nh,this._sampler),n.bindTexture(nh,rm.get("default-texture").getGFXTexture()),n.bindSampler(Th,this._sampler),n.bindTexture(Th,rm.get("default-texture").getGFXTexture()),n.update(),this._descriptorSetMap.set(e,n),n}return this._descriptorSetMap.get(e)},e}(),dA=new su,pA=function(){function e(e){this._pendingModels=[],this._instancedQueue=new HT,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=this._pipeline.pipelineUBO,o=n.shadows;if(this._instancedQueue.clear(),this._pendingModels.length=0,o.enabled&&o.type===cE.Planar){i.updateShadowUBO(e);var r=e.scene,a=e.frustum,s=0!=(e.visibility&Fu.BitMask.DEFAULT);if(r.mainLight&&s){var c=n.renderObjects,l=VT.get(o.instancingMaterial.passes[0]);this._instancedQueue.queue.add(l);for(var u=0;u<c.length;u++){var h=c[u].model;if(h.enabled&&h.node&&h.castShadow&&(!h.worldBounds||(su.transform(dA,h.worldBounds,o.matLight),Kl.aabbFrustum(dA,a))))if(h.isInstancingEnabled)for(var _=h.subModels,f=0;f<_.length;f++){var d=_[f];l.merge(d,h.instancedAttributes,0,d.planarInstanceShaderHandle)}else this._pendingModels.push(h)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===cE.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var o=i.material.passes[0],r=wo.get(Ho.get(o.handle,So.DESCRIPTOR_SET));n.bindDescriptorSet(Ku.MATERIAL,r);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=Ao.get(u.planarShaderHandle),_=u.inputAssembler,f=wT.getOrCreatePipelineState(e,o,h,t,_);n.bindPipelineState(f),n.bindDescriptorSet(Ku.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},e}(),mA=function(){function e(){this._phaseID=am("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,o=n.commandBuffers[0],r=e.scene.batches,a=0;a<r.length;a++){var s=r[a],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.handle,u=Ko.get(l,Wo.PASS_COUNT),h=0;h<u;h++){var _=s.passes[h];if(_.phase===this._phaseID){var f=Ko.get(l,Wo.SHADER_0+h),d=Ao.get(f),p=Co.get(s.hInputAssembler),m=wo.get(s.hDescriptorSet),v=wT.getOrCreatePipelineState(i,_,d,t,p);o.bindPipelineState(v),o.bindDescriptorSet(Ku.MATERIAL,_.descriptorSet),o.bindDescriptorSet(Ku.LOCAL,m),o.bindInputAssembler(p),o.draw(p)}}}},e}(),vA=[new xs(0,0,0,1)],gA=e("fg",(nA=b_("ForwardStage"),iA=rf([NT]),oA=J_(),nA((lA=cA=function(e){function t(){var t;return re(t=e.call(this)||this,"renderQueues",sA,ne(t)),t._renderQueues=[],t._renderArea=new _s,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=am("default"),t._clearFlag=4294967295,t._batchedQueue=new UT,t._instancedQueue=new HT,t._uiPhase=new mA,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=LT(this.renderQueues[i]);this._additiveLightQueue=new fA(this._pipeline),this._planarQueue=new pA(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(FT);for(var i=t.pipelineSceneData.renderObjects,o=0,r=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(o=0;o<l.length;++o){var u=l[o],h=u.passes;for(r=0;r<h.length;++r){var _=h[r];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===nm.INSTANCING){var d=VT.get(_);d.merge(u,c.model.instancedAttributes,r),this._instancedQueue.queue.add(d)}else if(f===nm.VB_MERGING){var p=GT.get(_);p.merge(u,r,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,o,r)}}}}this._renderQueues.forEach(zT);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m);var v=t.pipelineSceneData;if(this._renderArea=t.generateRenderArea(e),e.clearFlag&os.COLOR)if(v.isHDR){BT(vA[0],e.clearColor);var g=v.fpScale/e.exposure;vA[0].x*=g,vA[0].y*=g,vA[0].z*=g}else vA[0].x=e.clearColor.x,vA[0].y=e.clearColor.y,vA[0].z=e.clearColor.z;vA[0].w=e.clearColor.w;var y=e.window.framebuffer,x=y.colorTextures[0]?y.renderPass:t.getRenderPass(e.clearFlag&this._clearFlag);m.beginRenderPass(x,y,this._renderArea,vA,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Ku.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,x,m),this._instancedQueue.recordCommandBuffer(n,x,m),this._batchedQueue.recordCommandBuffer(n,x,m),this._additiveLightQueue.recordCommandBuffer(n,x,m),this._planarQueue.recordCommandBuffer(n,x,m),this._renderQueues[1].recordCommandBuffer(n,x,m),this._uiPhase.render(e,x),m.endRenderPass()},t}(Ax),cA.initInfo={name:"ForwardStage",priority:KE.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:CT.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:CT.BACK_TO_FRONT,stages:["default","planarShadow"]}]},sA=ae((aA=lA).prototype,"renderQueues",[iA,M_,oA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rA=aA))||rA)),yA=e("ff",b_("ForwardFlow")((_A=hA=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new gA;n.initialize(gA.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(Dx),hA.initInfo={name:Gu,priority:QE.FORWARD,stages:[]},uA=_A))||uA),xA=am("shadow-caster"),EA=[];function SA(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var o=e[i].passes,r=-1,a=0;a<o.length;a++)if(o[a].phase===xA){r=a,n=!0;break}t.push(r)}return n}var TA,AA,wA,CA,IA,PA,bA,RA,NA,OA,DA,MA,LA,FA,zA,BA,UA,HA,GA,VA,kA,WA,jA,qA,YA,XA,KA=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new HT,this._batchedQueue=new UT}var t=e.prototype;return t.gatherLightPasses=function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.shadows,i=this._pipeline.pipelineSceneData.shadowObjects;if(e&&n.enabled&&n.type===cE.ShadowMap){this._pipeline.pipelineUBO.updateShadowUBOLight(e);for(var o=0;o<i.length;o++){var r=i[o].model;if(SA(r.subModels,EA))switch(e.type){case _m.DIRECTIONAL:this.add(r,t,EA);break;case _m.SPOT:if(r.worldBounds&&(!Kl.aabbWithAABB(r.worldBounds,e.aabb)||!Kl.aabbFrustum(r.worldBounds,e.frustum)))continue;this.add(r,t,EA)}}}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t,n){for(var i=e.subModels,o=0;o<i.length;o++){var r=i[o],a=n[o],s=r.passes[a];if(s.batchingScheme===nm.INSTANCING){var c=VT.get(s);c.merge(r,e.instancedAttributes,a),this._instancedQueue.queue.add(c)}else if(s.batchingScheme===nm.VB_MERGING){var l=GT.get(s);l.merge(r,a,e),this._batchedQueue.queue.add(l)}else{var u=Ao.get(ko.get(r.handle,Bo.SHADER_0+a));this._subModelsArray.push(r),this._shaderArray.push(u),this._passArray.push(s)}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var o=this._subModelsArray[i],r=this._shaderArray[i],a=this._passArray[i],s=o.inputAssembler,c=wT.getOrCreatePipelineState(e,a,r,t,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(Ku.MATERIAL,l),n.bindDescriptorSet(Ku.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),QA=[new xs(1,1,1,1)],ZA=e("fo",b_("ShadowStage")((wA=AA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new _s,t._light=null,t}ee(t,e);var n=t.prototype;return n.setUsage=function(e,t){this._light=e,this._shadowFrameBuffer=t},n.destroy=function(){this._additiveShadowQueue.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){QA[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,QA,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,o=n.shadingScale,r=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._additiveShadowQueue.gatherLightPasses(this._light,r);var a=e.viewport,s=i.size;this._renderArea.x=a.x*s.x,this._renderArea.y=a.y*s.y,this._renderArea.width=a.width*s.x*o,this._renderArea.height=a.height*s.y*o;var c=t.device,l=this._shadowFrameBuffer.renderPass;r.beginRenderPass(l,this._shadowFrameBuffer,this._renderArea,QA,e.clearDepth,e.clearStencil),r.bindDescriptorSet(Ku.GLOBAL,t.descriptorSet),this._additiveShadowQueue.recordCommandBuffer(c,l,r),r.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new KA(t)},t}(Ax),AA.initInfo={name:"ShadowStage",priority:KE.FORWARD,tag:0},TA=wA))||TA),JA=e("fn",b_("ShadowFlow")((PA=IA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new ZA;n.initialize(ZA.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,o=t.pipelineSceneData.shadowObjects;if(n.enabled&&n.type===cE.ShadowMap){var r=function(e,t){gE.length=0;var n=e.scene;gE.push(n.mainLight);for(var i=n.spotLights,o=0;o<i.length;o++){var r=i[o];rs.set(yE,r.position.x,r.position.y,r.position.z,r.range),Kl.sphereFrustum(yE,e.frustum)&&t>gE.length&&gE.push(r)}return gE}(e,n.maxReceived);if(0!==o.length){for(var a=0;a<r.length;a++){var s=r[a];i.has(s)||this._initShadowFrameBuffer(t,s);var c=i.get(s);n.shadowMapDirty&&this.resizeShadowMap(s,n);for(var l=0;l<this._stages.length;l++){var u=this._stages[l];u.setUsage(s,c),u.render(e)}}t.pipelineUBO.updateShadowUBO(e)}else this.clearShadowMap(r,e)}},n.destroy=function(){e.prototype.destroy.call(this);for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var o=n[i];if(o){for(var r=o.colorTextures,a=0;a<r.length;a++){var s=r[i];s&&s.destroy()}r.length=0;var c=o.depthStencilTexture;c&&c.destroy(),o.destroy()}}t.clear(),this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows,o=i.size,r=e.pipelineSceneData.shadowFrameBufferMap,a=c_(n)?i.packing?Ca.RGBA8:Ca.RGBA16F:Ca.RGBA8;if(!this._shadowRenderPass){var s=new Vs;s.format=a,s.loadOp=ja.CLEAR,s.storeOp=qa.STORE,s.sampleCount=1;var c=new ks;c.format=n.depthStencilFormat,c.depthLoadOp=ja.CLEAR,c.depthStoreOp=qa.DISCARD,c.stencilLoadOp=ja.CLEAR,c.stencilStoreOp=qa.DISCARD,c.sampleCount=1;var l=new js([s],c);this._shadowRenderPass=n.createRenderPass(l)}var u=[];u.push(n.createTexture(new Is(Da.TEX2D,Ma.COLOR_ATTACHMENT|Ma.SAMPLED,a,o.x,o.y)));var h=n.createTexture(new Is(Da.TEX2D,Ma.DEPTH_STENCIL_ATTACHMENT,n.depthStencilFormat,o.x,o.y)),_=n.createFramebuffer(new Xs(this._shadowRenderPass,u,h));r.set(t,_)},n.clearShadowMap=function(e,t){for(var n=this._pipeline.pipelineSceneData,i=0;i<e.length;i++){var o=e[i],r=n.shadowFrameBufferMap.get(o);if(n.shadowFrameBufferMap.has(o))for(var a=0;a<this._stages.length;a++){var s=this._stages[a];s.setUsage(o,r),s.clearFramebuffer(t)}}},n.resizeShadowMap=function(e,t){var n=t.size.x,i=t.size.y,o=this._pipeline,r=o.device,a=o.pipelineSceneData.shadowFrameBufferMap,s=c_(r)?t.packing?Ca.RGBA8:Ca.RGBA16F:Ca.RGBA8;if(a.has(e)){var c=a.get(e);if(!c)return;var l=[];l.push(o.device.createTexture(new Is(Da.TEX2D,Ma.COLOR_ATTACHMENT|Ma.SAMPLED,s,n,i)));var u=c.depthStencilTexture;u&&u.resize(n,i);var h=c.renderPass;c.destroy(),c.initialize(new Xs(h,l,u))}t.shadowMapDirty=!1},t}(Dx),IA.initInfo={name:Vu,priority:QE.SHADOW,tag:AT.SCENE,stages:[]},CA=PA))||CA),$A=[za.LINEAR,za.LINEAR,za.NONE,Ba.CLAMP,Ba.CLAMP,Ba.CLAMP],ew=e("fe",(bA=b_("ForwardPipeline"),RA=rf([IT]),NA=J_(),OA=rf([PT]),DA=J_(),bA((BA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",FA,ne(t)),re(t,"materials",zA,ne(t)),t._renderPasses=new Map,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new JA;n.initialize(JA.initInfo),this._flows.push(n);var i=new yA;i.initialize(yA.initInfo),this._flows.push(i)}return!0},n.activate=function(){return!(!e.prototype.activate.call(this)||!this._activeRenderer()&&(R(2402),1))},n.render=function(e){this._commandBuffers[0].begin(),this._pipelineUBO.updateGlobalUBO();for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){CE(this,n),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n)}}this._commandBuffers[0].end(),this._device.flushCommands(this._commandBuffers),this._device.queue.submit(this._commandBuffers)},n.getRenderPass=function(e){var t=this._renderPasses.get(e);if(t)return t;var n=this.device,i=new Vs,o=new ks;i.format=n.colorFormat,o.format=n.depthStencilFormat,o.stencilStoreOp=qa.DISCARD,o.depthStoreOp=qa.DISCARD,e&os.COLOR||(e&v_?i.loadOp=ja.DISCARD:(i.loadOp=ja.LOAD,i.beginAccesses=[Ya.PRESENT])),(e&os.DEPTH_STENCIL)!==os.DEPTH_STENCIL&&(e&os.DEPTH||(o.depthLoadOp=ja.LOAD),e&os.STENCIL||(o.stencilLoadOp=ja.LOAD),o.beginAccesses=[Ya.DEPTH_STENCIL_ATTACHMENT_WRITE]);var r=new js([i],o);return t=n.createRenderPass(r),this._renderPasses.set(e,t),t},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=$f($A),n=fd.getSampler(e,t);return this._descriptorSet.bindSampler(nh,n),this._descriptorSet.bindTexture(nh,rm.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Th,n),this._descriptorSet.bindTexture(Th,rm.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n.destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer($u.BINDING).destroy(),this._descriptorSet.getBuffer(th.BINDING).destroy(),this._descriptorSet.getBuffer(eh.BINDING).destroy(),this._descriptorSet.getSampler(nh).destroy(),this._descriptorSet.getSampler(Th).destroy(),this._descriptorSet.getTexture(nh).destroy(),this._descriptorSet.getTexture(Th).destroy())},n.destroy=function(){this.destroyUBOs();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},t}(JE),FA=ae((LA=BA).prototype,"renderTextures",[RA,M_,NA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zA=ae(LA.prototype,"materials",[OA,M_,DA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MA=LA))||MA));!function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT",e[e.POSTPROCESS=19]="POSTPROCESS",e[e.UI=20]="UI"}(UA||(UA={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.GBUFFER=1]="GBUFFER",e[e.LIGHTING=5]="LIGHTING",e[e.UI=10]="UI"}(HA||(HA={}));var tw,nw,iw,ow,rw,aw,sw,cw,lw,uw,hw,_w,fw,dw,pw,mw,vw,gw,yw,xw,Ew,Sw,Tw,Aw,ww,Cw,Iw,Pw,bw,Rw,Nw,Ow,Dw,Mw,Lw,Fw=[new xs(0,0,0,0),new xs(0,0,0,0),new xs(0,0,0,0),new xs(0,0,0,0)],zw=e("fj",(GA=b_("GbufferStage"),VA=rf([NT]),kA=J_(),GA((XA=YA=function(e){function t(){var t;return re(t=e.call(this)||this,"renderQueues",qA,ne(t)),t._renderQueues=[],t._renderArea=new _s,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=am("deferred"),t._batchedQueue=new UT,t._instancedQueue=new HT,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=LT(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(FT);var i=t.pipelineSceneData.renderObjects;if(0!==i.length){for(var o=0,r=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(o=0;o<l.length;++o){var u=l[o],h=u.passes;for(r=0;r<h.length;++r){var _=h[r];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===nm.INSTANCING){var d=VT.get(_);d.merge(u,c.model.instancedAttributes,r),this._instancedQueue.queue.add(d)}else if(f===nm.VB_MERGING){var p=GT.get(_);p.merge(u,r,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,o,r)}}}}this._renderQueues.forEach(zT);var m=t.commandBuffers[0];if(this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._renderArea=t.generateRenderArea(e),t.updateQuadVertexData(this._renderArea),e.clearFlag&os.COLOR)if(t.pipelineSceneData.isHDR){BT(Fw[0],e.clearColor);var v=t.pipelineSceneData.fpScale/e.exposure;Fw[0].x*=v,Fw[0].y*=v,Fw[0].z*=v}else Fw[0].x=e.clearColor.x,Fw[0].y=e.clearColor.y,Fw[0].z=e.clearColor.z;Fw[0].w=e.clearColor.w;var g=t.getDeferredRenderData(e).gbufferFrameBuffer,y=g.renderPass;m.beginRenderPass(y,g,this._renderArea,Fw,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Ku.GLOBAL,t.descriptorSet);for(var x=0;x<this.renderQueues.length;x++)this._renderQueues[x].recordCommandBuffer(n,y,m);this._instancedQueue.recordCommandBuffer(n,y,m),this._batchedQueue.recordCommandBuffer(n,y,m),m.endRenderPass()}},t}(Ax),YA.initInfo={name:"GbufferStage",priority:UA.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:CT.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:CT.BACK_TO_FRONT,stages:["default"]}]},qA=ae((jA=XA).prototype,"renderQueues",[VA,M_,kA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WA=jA))||WA)),Bw=e("fi",b_("GbufferFlow")((iw=nw=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new zw;n.initialize(zw.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(Dx),nw.initInfo={name:Uu,priority:HA.GBUFFER,stages:[]},tw=iw))||tw),Uw=[new xs(0,0,0,1)],Hw=e("fl",(ow=b_("LightingStage"),rw=rf(sE),aw=J_(),sw=rf([NT]),cw=J_(),ow((dw=fw=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this)._deferredLitsBufs=null,t._maxDeferredLights=Rh.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new _s,re(t,"_deferredMaterial",hw,ne(t)),re(t,"renderQueues",_w,ne(t)),t._phaseID=am("default"),t._defPhaseID=am("deferred"),t._renderQueues=[],t}ee(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,o=e.scene.spotLights,r=rs.create(0,0,0,1),a=new Float32Array(4),s=e.exposure,c=0,l=Yn.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(rs.set(r,_.position.x,_.position.y,_.position.z,_.range),Kl.sphereFrustum(r,e.frustum)){if(An.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),An.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}t.pipelineSceneData.isHDR?a[3]=_.luminance*t.pipelineSceneData.fpScale*this._lightMeterScale:a[3]=_.luminance*s*this._lightMeterScale,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var d=0;d<o.length&&c<this._maxDeferredLights;d++,++c){var p=o[d];if(rs.set(r,p.position.x,p.position.y,p.position.z,p.range),Kl.sphereFrustum(r,e.frustum)){if(An.toArray(a,p.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),An.toArray(a,p.color),p.useColorTemperature){var m=p.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}t.pipelineSceneData.isHDR?a[3]=p.luminance*t.pipelineSceneData.fpScale*this._lightMeterScale:a[3]=p.luminance*s*this._lightMeterScale,this._lightBufferData.set(a,c*l+1*u),a[0]=p.size,a[1]=p.range,a[2]=p.spotAngle,this._lightBufferData.set(a,c*l+2*u),An.toArray(a,p.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=t.device,o=0;o<this.renderQueues.length;o++)this._renderQueues[o]=LT(this.renderQueues[o]);var r=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;r=Math.ceil(r/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new Ss(ba.UNIFORM|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,r,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new Ts(this._deferredLitsBufs,0,r));this._lightBufferData=new Float32Array(r/Float32Array.BYTES_PER_ELEMENT);var s=new Qs(ju.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new Zs(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(bh.BINDING,a),this._planarQueue=new pA(this._pipeline)},n.destroy=function(){this._deferredLitsBufs.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],o=t.pipelineSceneData.renderObjects;if(0!==o.length){if(this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,i),i.bindDescriptorSet(Ku.LOCAL,this._descriptorSet,[0]),this._renderArea=t.generateRenderArea(e),e.clearFlag&os.COLOR)if(t.pipelineSceneData.isHDR){BT(Uw[0],e.clearColor);var r=t.pipelineSceneData.fpScale/e.exposure;Uw[0].x*=r,Uw[0].y*=r,Uw[0].z*=r}else Uw[0].x=e.clearColor.x,Uw[0].y=e.clearColor.y,Uw[0].z=e.clearColor.z;Uw[0].w=0;var a,s,c=t.getDeferredRenderData(e).lightingFrameBuffer,l=c.renderPass;i.beginRenderPass(l,c,this._renderArea,Uw,e.clearDepth,e.clearStencil),i.bindDescriptorSet(Ku.GLOBAL,t.descriptorSet);var u=rm.get("builtin-deferred-material");u?(a=u.passes[0],s=Ao.get(a.getShaderVariant())):(a=this._deferredMaterial.passes[1],s=Ao.get(this._deferredMaterial.passes[1].getShaderVariant()));var h=t.quadIAOffscreen,_=null;null!=a&&null!=s&&null!=h&&(_=wT.getOrCreatePipelineState(n,a,s,l,h)),null!=_&&(i.bindPipelineState(_),i.bindInputAssembler(h),i.draw(h)),this._renderQueues.forEach(FT);for(var f=0,d=0,p=0,m=0;m<o.length;++m){var v=o[m],g=v.model.subModels;for(f=0;f<g.length;++f){var y=g[f].passes;for(d=0;d<y.length;++d){var x=y[d];if(x.phase===this._phaseID||x.phase===this._defPhaseID)for(p=0;p<this._renderQueues.length;p++)this._renderQueues[p].insertRenderPass(v,f,d)}}}this._renderQueues.forEach(zT);for(var E=0;E<this._renderQueues.length;E++)this._renderQueues[E].recordCommandBuffer(n,l,i);this._planarQueue.recordCommandBuffer(n,l,i),i.endRenderPass()}},J(t,[{key:"material",set:function(e){this._deferredMaterial!==e&&(this._deferredMaterial=e)}}]),t}(Ax),fw.initInfo={name:"LightingStage",priority:UA.LIGHTING,tag:0},hw=ae((uw=dw).prototype,"_deferredMaterial",[rw,M_,aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_w=ae(uw.prototype,"renderQueues",[sw,M_,cw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lw=uw))||lw)),Gw=e("fk",b_("LightingFlow")((vw=mw=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new Hw;n.initialize(Hw.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(Dx),mw.initInfo={name:Hu,priority:HA.LIGHTING,stages:[]},pw=vw))||pw),Vw=$f([za.LINEAR,za.LINEAR,za.NONE,Ba.CLAMP,Ba.CLAMP,Ba.CLAMP]),kw=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},Ww=function(){this.gbufferFrameBuffer=null,this.gbufferRenderTargets=[],this.lightingFrameBuffer=null,this.lightingRenderTargets=[],this.depthTex=null},jw=e("fh",(gw=b_("DeferredPipeline"),yw=rf([IT]),xw=J_(),Ew=rf([PT]),Sw=J_(),gw((Iw=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this)._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._deferredRenderData=null,t._gbufferRenderPass=null,t._lightingRenderPass=null,t._width=0,t._height=0,t._lastUsedRenderArea=new _s,re(t,"renderTextures",ww,ne(t)),re(t,"materials",Cw,ne(t)),t._renderPasses=new Map,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new JA;n.initialize(JA.initInfo),this._flows.push(n);var i=new Bw;i.initialize(Bw.initInfo),this._flows.push(i);var o=new Gw;o.initialize(Gw.initInfo),this._flows.push(o)}return!0},n.activate=function(){return this._macros.CC_PIPELINE_TYPE=1,!(!e.prototype.activate.call(this)||!this._activeRenderer()&&(R(2402),1))},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this._pipelineUBO.updateGlobalUBO();for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){CE(this,n),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n)}}this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n.getRenderPass=function(e){var t=this._renderPasses.get(e);if(t)return t;var n=this.device,i=new Vs,o=new ks;i.format=n.colorFormat,o.format=n.depthStencilFormat,o.stencilStoreOp=qa.DISCARD,o.depthStoreOp=qa.DISCARD,e&os.COLOR||(e&v_?i.loadOp=ja.DISCARD:(i.loadOp=ja.LOAD,i.beginAccesses=[Ya.PRESENT])),(e&os.DEPTH_STENCIL)!==os.DEPTH_STENCIL&&(e&os.DEPTH||(o.depthLoadOp=ja.LOAD),e&os.STENCIL||(o.stencilLoadOp=ja.LOAD),o.beginAccesses=[Ya.DEPTH_STENCIL_ATTACHMENT_WRITE]);var r=new js([i],o);return t=n.createRenderPass(r),this._renderPasses.set(e,t),t},n.getDeferredRenderData=function(){return this._deferredRenderData||this._generateDeferredRenderData(),this._deferredRenderData},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=fd.getSampler(e,Vw);this._descriptorSet.bindSampler(nh,t),this._descriptorSet.bindTexture(nh,rm.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Th,t),this._descriptorSet.bindTexture(Th,rm.get("default-texture").getGFXTexture()),this._descriptorSet.update();var n=new kw;if(!(n=this.createQuadInputAssembler(Aa.IDENTITY)).quadIB||!n.quadVB||!n.quadIA)return!1;this._quadIB=n.quadIB,this._quadVBOffscreen=n.quadVB,this._quadIAOffscreen=n.quadIA;var i=this.createQuadInputAssembler(e.surfaceTransform);if(!i.quadIB||!i.quadVB||!i.quadIA)return!1;if(this._quadVBOnscreen=i.quadVB,this._quadIAOnscreen=i.quadIA,!this._gbufferRenderPass){var o=new Vs;o.format=Ca.RGBA16F,o.loadOp=ja.CLEAR,o.storeOp=qa.STORE;var r=new Vs;r.format=Ca.RGBA16F,r.loadOp=ja.CLEAR,r.storeOp=qa.STORE;var a=new Vs;a.format=Ca.RGBA16F,a.loadOp=ja.CLEAR,a.storeOp=qa.STORE;var s=new Vs;s.format=Ca.RGBA16F,s.loadOp=ja.CLEAR,s.storeOp=qa.STORE;var c=new ks;c.format=e.depthStencilFormat,c.depthLoadOp=ja.CLEAR,c.depthStoreOp=qa.STORE,c.stencilLoadOp=ja.CLEAR,c.stencilStoreOp=qa.STORE;var l=new js([o,r,a,s],c);this._gbufferRenderPass=e.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Vs;u.format=Ca.RGBA16F,u.loadOp=ja.CLEAR,u.storeOp=qa.STORE,u.endAccesses=[Ya.COLOR_ATTACHMENT_WRITE];var h=new ks;h.format=e.depthStencilFormat,h.depthLoadOp=ja.LOAD,h.depthStoreOp=qa.DISCARD,h.stencilLoadOp=ja.LOAD,h.stencilStoreOp=qa.DISCARD,h.beginAccesses=[Ya.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Ya.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new js([u],h);this._lightingRenderPass=e.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),e.surfaceTransform===Aa.IDENTITY||e.surfaceTransform===Aa.ROTATE_180?(this._width=e.width,this._height=e.height):(this._width=e.height,this._height=e.width),!0},n.destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer($u.BINDING).destroy(),this._descriptorSet.getBuffer(th.BINDING).destroy(),this._descriptorSet.getBuffer(eh.BINDING).destroy(),this._descriptorSet.getSampler(nh).destroy(),this._descriptorSet.getSampler(Th).destroy(),this._descriptorSet.getTexture(nh).destroy(),this._descriptorSet.getTexture(Th).destroy())},n.destroyDeferredData=function(){var e=this._deferredRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.lightingFrameBuffer&&e.lightingFrameBuffer.destroy(),e.depthTex&&e.depthTex.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.lightingRenderTargets.length;n++)e.lightingRenderTargets[n].destroy();e.lightingRenderTargets.length=0}this._deferredRenderData=null},n.destroy=function(){this.destroyUBOs(),this.destroyQuadInputAssembler(),this.destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.resize=function(e,t){this._width===e&&this._height===t||(this._width=e,this._height=t,this.destroyDeferredData(),this._generateDeferredRenderData())},n.createQuadInputAssembler=function(){var e=new kw,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new Ss(ba.VERTEX|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,n,t));if(!i)return e;var o=Uint8Array.BYTES_PER_ELEMENT,r=6*o,a=this._device.createBuffer(new Ss(ba.INDEX|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,r,o));if(!a)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Us("a_position",Ca.RG32F),c[1]=new Us("a_texCoord",Ca.RG32F);var l=this._device.createInputAssembler(new Gs(c,[i],a));return e.quadIB=a,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e){if(this._lastUsedRenderArea!==e){this._lastUsedRenderArea=e;var t=this.genQuadVertexData(Aa.IDENTITY,e);this._quadVBOffscreen.update(t);var n=this.genQuadVertexData(this.device.surfaceTransform,e);this._quadVBOnscreen.update(n)}},n.genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this.device.width,o=(t.x+t.width)/this.device.width,r=t.y/this.device.height,a=(t.y+t.height)/this.device.height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=r,r=s}var c=0;switch(e){case Aa.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=o,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=r,n[c++]=1,n[c++]=1,n[c++]=o,n[c++]=r;break;case Aa.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=o,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=o,n[c++]=r,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=r;break;case Aa.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=r,n[c++]=1,n[c++]=-1,n[c++]=o,n[c++]=r,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=o,n[c++]=a;break;case Aa.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=r,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=o,n[c++]=r,n[c++]=1,n[c++]=1,n[c++]=o,n[c++]=a}return n},n.destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._generateDeferredRenderData=function(){var e=this.device,t=this._deferredRenderData=new Ww;t.gbufferRenderTargets.push(e.createTexture(new Is(Da.TEX2D,Ma.COLOR_ATTACHMENT|Ma.SAMPLED,Ca.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new Is(Da.TEX2D,Ma.COLOR_ATTACHMENT|Ma.SAMPLED,Ca.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new Is(Da.TEX2D,Ma.COLOR_ATTACHMENT|Ma.SAMPLED,Ca.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new Is(Da.TEX2D,Ma.COLOR_ATTACHMENT|Ma.SAMPLED,Ca.RGBA16F,this._width,this._height))),t.depthTex=e.createTexture(new Is(Da.TEX2D,Ma.DEPTH_STENCIL_ATTACHMENT,e.depthStencilFormat,this._width,this._height)),t.gbufferFrameBuffer=e.createFramebuffer(new Xs(this._gbufferRenderPass,t.gbufferRenderTargets,t.depthTex)),t.lightingRenderTargets.push(e.createTexture(new Is(Da.TEX2D,Ma.COLOR_ATTACHMENT|Ma.SAMPLED,Ca.RGBA16F,this._width,this._height))),t.lightingFrameBuffer=e.createFramebuffer(new Xs(this._lightingRenderPass,t.lightingRenderTargets,t.depthTex)),this._descriptorSet.bindTexture(rh,t.gbufferFrameBuffer.colorTextures[0]),this._descriptorSet.bindTexture(ch,t.gbufferFrameBuffer.colorTextures[1]),this._descriptorSet.bindTexture(hh,t.gbufferFrameBuffer.colorTextures[2]),this._descriptorSet.bindTexture(vh,t.gbufferFrameBuffer.colorTextures[3]),this._descriptorSet.bindTexture(dh,t.lightingFrameBuffer.colorTextures[0]);var n=fd.getSampler(e,Vw);this._descriptorSet.bindSampler(rh,n),this._descriptorSet.bindSampler(ch,n),this._descriptorSet.bindSampler(hh,n),this._descriptorSet.bindSampler(vh,n),this._descriptorSet.bindSampler(dh,n)},J(t,[{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}}]),t}(JE),ww=ae((Aw=Iw).prototype,"renderTextures",[yw,M_,xw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cw=ae(Aw.prototype,"materials",[Ew,M_,Sw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tw=Aw))||Tw)),qw=[new xs(0,0,0,1)];function Yw(){var e=new ew;return e.initialize({flows:[]}),e}e("fm",(Pw=b_("PostprocessStage"),bw=rf(sE),Rw=J_(),Pw((Lw=Mw=function(e){function t(){var t;return re(t=e.call(this)||this,"_postprocessMaterial",Dw,ne(t)),t._renderArea=new _s,t._uiPhase=void 0,t._uiPhase=new mA,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var o=e.viewport;this._renderArea.x=o.x*e.width,this._renderArea.y=o.y*e.height,this._renderArea.width=o.width*e.width*t.pipelineSceneData.shadingScale,this._renderArea.height=o.height*e.height*t.pipelineSceneData.shadingScale;var r,a,s=e.window.framebuffer,c=s.colorTextures[0]?s.renderPass:t.getRenderPass(e.clearFlag);e.clearFlag&os.COLOR&&(qw[0].x=e.clearColor.x,qw[0].y=e.clearColor.y,qw[0].z=e.clearColor.z),qw[0].w=e.clearColor.w,i.beginRenderPass(c,s,this._renderArea,qw,e.clearDepth,e.clearStencil),i.bindDescriptorSet(Ku.GLOBAL,t.descriptorSet);var l=rm.get("builtin-post-process-material");l?(r=l.passes[0],a=Ao.get(r.getShaderVariant())):(r=this._postprocessMaterial.passes[0],a=Ao.get(this._postprocessMaterial.passes[0].getShaderVariant()));var u=e.window.hasOffScreenAttachments?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=r&&null!=a&&null!=u&&(h=wT.getOrCreatePipelineState(n,r,a,c,u));var _=t.pipelineSceneData.renderObjects;null!=h&&_.length>0&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),this._uiPhase.render(e,c),i.endRenderPass()},J(t,[{key:"material",set:function(e){this._postprocessMaterial!==e&&(this._postprocessMaterial=e)}}]),t}(Ax),Mw.initInfo={name:"PostprocessStage",priority:UA.POSTPROCESS,tag:0},Dw=ae((Ow=Lw).prototype,"_postprocessMaterial",[bw,M_,Rw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nw=Ow))||Nw));var Xw=e("d8",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._paused=!0,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._gfxDevice=null,t._intervalId=null,t}ee(t,e);var n=t.prototype;return n.setFrameRate=function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),t.frameRate=e,this._paused=!0,this._setAnimFrame(),this._runMainLoop()},n.getFrameRate=function(){return this.config.frameRate||0},n.step=function(){s.director.mainLoop()},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&this._runMainLoop()},n.isPaused=function(){return this._paused},n.restart=function(){var e=this;return new Promise((function(e){return s.director.once(s.Director.EVENT_AFTER_DRAW,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return s.director.getScene().destroy(),s.Object._deferredDestroy(),s.director.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},n.end=function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),window.close()},n.on=function(e,n,i,o){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOn(e,n,i,o)},n.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},n.init=function(e){var t=this;return this._initConfig(e),this.config.assetOptions&&s.assetManager.init(this.config.assetOptions),this._initEngine().then((function(){return t._initEvents(),s.director.root.dataPoolManager&&s.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},n.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Promise.resolve(n).then((function(){return Kw.config.registerSystemEvent&&jy.registerSystemEvent(),i._setRenderPipelineNShowSplash()}))},n.addPersistRootNode=function(e){if(s.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=s.director._scene;if(s.isValid(n))if(e.parent){if(!(e.parent instanceof s.Scene))return void P(3801);if(e.parent!==n)return void P(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,s.assetManager._releaseManager._addPersistNodeRef(e)}}else P(3800)},n.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",s.assetManager._releaseManager._removePersistNodeRef(e))},n.isPersistRootNode=function(e){return!!e._persistNode},n._initEngine=function(){var e=this;return this._initDevice(),Promise.resolve(s.director._init()).then((function(){v("Cocos Creator v"+c),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,s.internal.dynamicAtlasManager.enabled=!st.CLEANUP_IMAGE_CACHE}))},n._setAnimFrame=function(){this._lastTime=performance.now();var e=this.config.frameRate;this._frameTime=1e3/e,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0);var t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=t?this._stTimeWithRAF:this._stTime,window.cAF=this._ctTime):(window.rAF=t||this._stTime,window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)},n._stTimeWithRAF=function(e){var t=performance.now(),n=Math.max(0,t-Kw._lastTime),i=Math.max(0,Kw._frameTime-n),o=window.setTimeout((function(){window.requestAnimationFrame(e)}),i);return Kw._lastTime=t+i,o},n._stTime=function(e){var t=performance.now(),n=Math.max(0,t-Kw._lastTime),i=Math.max(0,Kw._frameTime-n),o=window.setTimeout(e,i);return Kw._lastTime=t+i,o},n._ctTime=function(e){window.clearTimeout(e)},n._runMainLoop=function(){var e=this;if(this._inited){var t,n=this.config,i=s.director,o=n.frameRate;if(F(!!n.showFPS),i.startAnimation(),30===o){var r=!0;t=function(n){e._intervalId=window.rAF(t),(r=!r)||i.mainLoop(n)}}else t=function(n){e._intervalId=window.rAF(t),i.mainLoop(n)};this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(t),this._paused=!1}},n._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=N.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],S(e.debugMode),this.config=e,this._configLoaded=!0,this._setAnimFrame()},n._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(0===n?s.sys.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):s.sys.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):1===n&&s.sys.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):2===n&&s.sys.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(M(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var e=[],n=!!window.WebGL2RenderingContext,i=window.navigator.userAgent.toLowerCase();(-1!==i.indexOf("safari")&&-1===i.indexOf("chrome")||wi.browserType===mi.UC)&&(n=!1),n&&s.WebGL2Device&&e.push(s.WebGL2Device),s.WebGLDevice&&e.push(s.WebGLDevice);for(var o=new rc(this.canvas,st.ENABLE_WEBGL_ANTIALIAS,!1,window.devicePixelRatio,ux.windowPixelResolution.width,ux.windowPixelResolution.height,Ju),r=0;r<e.length&&(this._gfxDevice=new e[r],!this._gfxDevice.initialize(o));r++);}if(!this._gfxDevice)return y("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){wi.onShow(this._onShow.bind(this)),wi.onHide(this._onHide.bind(this))},n._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._setAnimFrame(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},n._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){s.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof JE?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){g(n),g("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(s.internal.SplashScreen){var e=s.internal.SplashScreen.instance;return e.main(s.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},n._setRenderPipeline=function(e){s.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},n._safeEmit=function(e){this.emit(e)},J(t,[{key:"inited",get:function(){return this._inited}},{key:"frameTime",get:function(){return this._frameTime}}]),t}(Ti));Xw.EVENT_HIDE="game_on_hide",Xw.EVENT_SHOW="game_on_show",Xw.EVENT_LOW_MEMORY="game_on_low_memory",Xw.EVENT_GAME_INITED="game_inited",Xw.EVENT_ENGINE_INITED="engine_inited",Xw.EVENT_RENDERER_INITED="renderer_inited",Xw.EVENT_RESTART="game_on_restart",Xw.RENDER_TYPE_CANVAS=0,Xw.RENDER_TYPE_WEBGL=1,Xw.RENDER_TYPE_OPENGL=2,s.Game=Xw;var Kw=e("de",s.game=new Xw),Qw=e("dd",{topLeft:s.v2(0,0),topRight:s.v2(0,0),top:s.v2(0,0),bottomLeft:s.v2(0,0),bottomRight:s.v2(0,0),bottom:s.v2(0,0),center:s.v2(0,0),left:s.v2(0,0),right:s.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,o=e.y,r=o+n,a=i+t;this.topLeft.x=i,this.topLeft.y=r,this.topRight.x=a,this.topRight.y=r,this.top.x=i+t/2,this.top.y=r,this.bottomLeft.x=i,this.bottomLeft.y=o,this.bottomRight.x=a,this.bottomRight.y=o,this.bottom.x=i+t/2,this.bottom.y=o,this.center.x=i+t/2,this.center.y=o+n/2,this.left.x=i,this.left.y=o+n/2,this.right.x=a,this.right.y=o+n/2}});s.visibleRect=Qw;var Zw=new(function(){function e(){this.html=void 0,this.meta={width:"device-width"},this.adaptationType=s.sys.browserType}var t=e.prototype;return t.init=function(){this.html=document.getElementsByTagName("html")[0]},t.availWidth=function(e){return s.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth},t.availHeight=function(e){return s.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight},e}());switch(wi.os===xi.IOS&&(Zw.adaptationType=mi.SAFARI),Zw.adaptationType){case mi.SAFARI:Zw.meta["minimal-ui"]="true",Zw.availWidth=function(e){return e.clientWidth},Zw.availHeight=function(e){return e.clientHeight};break;case mi.SOUGOU:case mi.UC:Zw.availWidth=function(e){return e.clientWidth},Zw.availHeight=function(e){return e.clientHeight}}var Jw=e("dQ",function(e){function t(){var t;(t=e.call(this)||this)._resizeWithBrowserSize=void 0,t._designResolutionSize=void 0,t._originalDesignResolutionSize=void 0,t._frameSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._devicePixelRatio=void 0,t._maxPixelRatio=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resizing=void 0,t._orientationChanging=void 0,t._isRotated=void 0,t._orientation=void 0,t._isAdjustViewport=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=$w,i=eC;return t._frameSize=new Qn(0,0),t._designResolutionSize=new Qn(0,0),t._originalDesignResolutionSize=new Qn(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new Jn(0,0,0,0),t._visibleRect=new Jn(0,0,0,0),t._autoFullScreen=!1,t._devicePixelRatio=1,t._maxPixelRatio=2,t._retinaEnabled=!1,t._resizeCallback=null,t._resizing=!1,t._resizeWithBrowserSize=!1,t._orientationChanging=!0,t._isRotated=!1,t._orientation=s.macro.ORIENTATION_AUTO,t._isAdjustViewport=!0,t._rpExactFit=new tC(n.EQUAL_TO_FRAME,i.EXACT_FIT),t._rpShowAll=new tC(n.EQUAL_TO_FRAME,i.SHOW_ALL),t._rpNoBorder=new tC(n.EQUAL_TO_FRAME,i.NO_BORDER),t._rpFixedHeight=new tC(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),t._rpFixedWidth=new tC(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,s.game.once(s.Game.EVENT_ENGINE_INITED,t.init,ne(t)),t}ee(t,e);var n=t.prototype;return n.init=function(){Zw.init(),this._initFrameSize();var e=s.game.canvas.width,t=s.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,s.winSize.width=this._visibleRect.width,s.winSize.height=this._visibleRect.height,s.visibleRect&&s.visibleRect.init(this._visibleRect)},n.resizeWithBrowserSize=function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,wi.onViewResize(this._resizeEvent),wi.onOrientationChange(this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,wi.offViewResize(this._resizeEvent),wi.offOrientationChange(this._orientationChange))},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){(e&=s.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)},n.adjustViewportMeta=function(e){this._isAdjustViewport=e},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e&&e!==this._autoFullScreen&&s.sys.isMobile&&wi.browserType!==mi.WECHAT?(this._autoFullScreen=!0,s.screen.autoFullScreen(s.game.frame)):this._autoFullScreen=!1},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){var n=s.game.canvas,i=s.game.container;this._devicePixelRatio=window.devicePixelRatio,n.width=ux.windowPixelResolution.width,n.height=ux.windowPixelResolution.height,n.style.width=e+"px",n.style.height=t+"px",i.style.width=e+"px",i.style.height=t+"px",this._resizeEvent()},n.getCanvasSize=function(){return new Qn(s.game.canvas.width,s.game.canvas.height)},n.getFrameSize=function(){return new Qn(this._frameSize.width,this._frameSize.height)},n.setFrameSize=function(e,t){this._frameSize.width=e,this._frameSize.height=t,s.game.frame.style.width=e+"px",s.game.frame.style.height=t+"px",this._resizeEvent()},n.getVisibleSize=function(){return new Qn(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new Qn(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new kn(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new kn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n.setResolutionPolicy=function(e){if(e instanceof tC)this._resolutionPolicy=e;else{var t=tC;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this.setResolutionPolicy(n);var i=this._resolutionPolicy;if(i&&i.preApply(this),s.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),i){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var o=i.apply(this,this._designResolutionSize);if(o.scale&&2===o.scale.length&&(this._scaleX=o.scale[0],this._scaleY=o.scale[1]),o.viewport){var r=this._viewportRect,a=this._visibleRect,c=o.viewport;r.x=c.x,r.y=c.y,r.width=c.width,r.height=c.height,a.x=0,a.y=0,a.width=c.width/this._scaleX,a.height=c.height/this._scaleY}i.postApply(this),s.winSize.width=this._visibleRect.width,s.winSize.height=this._visibleRect.height,Qw&&Qw.init(this._visibleRect),this.emit("design-resolution-changed")}else C(2201)}else R(2200)},n.getDesignResolutionSize=function(){return new Qn(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){this._setViewportMeta({width:e},!0),document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return this._devicePixelRatio},n.convertToLocationInView=function(e,t,n,i){var o=i||new kn,r=this._devicePixelRatio*(e-n.left),a=this._devicePixelRatio*(n.top+n.height-t);return this._isRotated?(o.x=s.game.canvas.width-a,o.y=r):(o.x=r,o.y=a),s.GAME_VIEW&&(o.x/=s.gameView.canvas.width/s.game.canvas.width,o.y/=s.gameView.canvas.height/s.game.canvas.height),o},n._convertPointWithScale=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._resizeEvent=function(){var e=s.view,t=e._frameSize.width,n=e._frameSize.height,i=e._isRotated;if(s.sys.isMobile){var o=s.game.container.style,r=o.margin;o.margin="0",o.display="none",e._initFrameSize(),o.margin=r,o.display="block"}else e._initFrameSize();if(e._orientationChanging||e._isRotated!==i||e._frameSize.width!==t||e._frameSize.height!==n){var a=e._originalDesignResolutionSize.width,c=e._originalDesignResolutionSize.height;e._resizing=!0,a>0&&e.setDesignResolutionSize(a,c,e._resolutionPolicy),e._resizing=!1,e.emit("canvas-resize"),e._resizeCallback&&e._resizeCallback.call()}},n._orientationChange=function(){s.view._orientationChanging=!0,s.view._resizeEvent()},n._initFrameSize=function(){var e=this._frameSize,t=Zw.availWidth(s.game.frame),n=Zw.availHeight(s.game.frame),i=t>=n;!s.sys.isMobile||i&&this._orientation&s.macro.ORIENTATION_LANDSCAPE||!i&&this._orientation&s.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=n,s.game.container.style["-webkit-transform"]="rotate(0deg)",s.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=n,e.height=t,s.game.container.style["-webkit-transform"]="rotate(90deg)",s.game.container.style.transform="rotate(90deg)",s.game.container.style["-webkit-transform-origin"]="0px 0px 0px",s.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,s.game.canvas.style["-webkit-transform"]="translateZ(0px)",s.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((function(){s.view._orientationChanging=!1}),1e3)},n._adjustSizeKeepCanvasSize=function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;e>0&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)},n._setViewportMeta=function(e,t){var n=document.getElementById("cocosMetaElement");n&&t&&document.head.removeChild(n);var i,o,r,a=document.getElementsByName("viewport"),s=a?a[0]:null;for(o in i=s?s.content:"",(n=n||document.createElement("meta")).id="cocosMetaElement",n.name="viewport",n.content="",e)-1===i.indexOf(o)?i+=","+o+"="+e[o]:t&&(r=new RegExp(o+"s*=s*[^,]+"),i=i.replace(r,o+"="+e[o]));/^,/.test(i)&&(i=i.substr(1)),n.content=i,s&&(s.content=i),document.head.appendChild(n)},n._adjustViewportMeta=function(){!this._isAdjustViewport||r||i||o||(this._setViewportMeta(Zw.meta,!1),this._isAdjustViewport=!1)},n._convertMouseToLocation=function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y),s.GAME_VIEW&&(e.x/=s.gameView.canvas.width/s.game.canvas.width,e.y/=s.gameView.canvas.height/s.game.canvas.height)},n._convertTouchWidthScale=function(e){var t=this._viewportRect,n=this._scaleX,i=this._scaleY;e._point.x=(e._point.x-t.x)/n,e._point.y=(e._point.y-t.y)/i,e._prevPoint.x=(e._prevPoint.x-t.x)/n,e._prevPoint.y=(e._prevPoint.y-t.y)/i},n._convertTouchesWithScale=function(e){for(var t,n,i=this._viewportRect,o=this._scaleX,r=this._scaleY,a=0;a<e.length;a++){var s=e[a];t=s._point,n=s._prevPoint,t.x=(t.x-i.x)/o,t.y=(t.y-i.y)/r,n.x=(n.x-i.x)/o,n.y=(n.y-i.y)/r}},t}(Ti));Jw.instance=void 0;var $w=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupContainer=function(e,t,n){var i=s.game.canvas,o=s.game.container;wi.os!==xi.ANDROID&&wi.os!==xi.OHOS||(document.body.style.width=(e._isRotated?n:t)+"px",document.body.style.height=(e._isRotated?t:n)+"px"),o.style.width=i.style.width=t+"px",o.style.height=i.style.height=n+"px",e._devicePixelRatio=1,e.isRetinaEnabled()&&(e._devicePixelRatio=Math.min(e._maxPixelRatio,window.devicePixelRatio||1)),i.width=t*e._devicePixelRatio,i.height=n*e._devicePixelRatio},t._fixContainer=function(){document.body.insertBefore(s.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=s.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0},e}();$w.EQUAL_TO_FRAME=void 0,$w.PROPORTION_TO_FRAME=void 0;var eC=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,o,r){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var a=new Jn(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[o,r],this._result.viewport=a,this._result},e}();eC.EXACT_FIT=void 0,eC.SHOW_ALL=void 0,eC.NO_BORDER=void 0,eC.FIXED_HEIGHT=void 0,eC.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return ee(t,e),t.prototype.apply=function(e){var t=e._frameSize.height,n=s.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?n.margin="0 0 0 "+t+"px":n.margin="0px",n.padding="0px"},t}($w),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return ee(t,e),t.prototype.apply=function(e,t){var n,i,o=e._frameSize.width,r=e._frameSize.height,a=s.game.container.style,c=t.width,l=t.height,u=o/c,h=r/l;u<h?(n=o,i=l*u):(n=c*h,i=r);var _=Math.round((o-n)/2),f=Math.round((r-i)/2);n=o-2*_,i=r-2*f,this._setupContainer(e,n,i),e._isRotated?a.margin="0 0 0 "+r+"px":a.margin="0px",a.paddingLeft=_+"px",a.paddingRight=_+"px",a.paddingTop=f+"px",a.paddingBottom=f+"px"},t}($w),n=("undefined"==typeof window?global:window).__globalAdapter;n&&(n.adaptContainerStrategy&&n.adaptContainerStrategy($w.prototype),n.adaptView&&n.adaptView(Jw.prototype)),$w.EQUAL_TO_FRAME=new e,$w.PROPORTION_TO_FRAME=new t;var i=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return ee(t,e),t.prototype.apply=function(e,t){var n=s.game.canvas.width,i=s.game.canvas.height,o=n/t.width,r=i/t.height;return this._buildResult(n,i,n,i,o,r)},t}(eC),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return ee(t,e),t.prototype.apply=function(e,t){var n,i,o=s.game.canvas.width,r=s.game.canvas.height,a=t.width,c=t.height,l=o/a,u=r/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=a*(h=u),i=r),this._buildResult(o,r,n,i,h,h)},t}(eC),r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return ee(t,e),t.prototype.apply=function(e,t){var n,i,o,r=s.game.canvas.width,a=s.game.canvas.height,c=t.width,l=t.height,u=r/c,h=a/l;return u<h?(i=c*(n=h),o=a):(i=r,o=l*(n=u)),this._buildResult(r,a,i,o,n,n)},t}(eC),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return ee(t,e),t.prototype.apply=function(e,t){var n=s.game.canvas.width,i=s.game.canvas.height,o=i/t.height,r=n,a=i;return this._buildResult(n,i,r,a,o,o)},t}(eC),c=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return ee(t,e),t.prototype.apply=function(e,t){var n=s.game.canvas.width,i=s.game.canvas.height,o=n/t.width,r=n,a=i;return this._buildResult(n,i,r,a,o,o)},t}(eC);eC.EXACT_FIT=new i,eC.SHOW_ALL=new o,eC.NO_BORDER=new r,eC.FIXED_HEIGHT=new a,eC.FIXED_WIDTH=new c}();var tC=e("f0",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof $w&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof eC&&(this._contentStrategy=e)},J(e,[{key:"canvasSize",get:function(){return new kn(s.game.canvas.width,s.game.canvas.height)}}]),e}());tC.EXACT_FIT=0,tC.NO_BORDER=1,tC.SHOW_ALL=2,tC.FIXED_HEIGHT=3,tC.FIXED_WIDTH=4,tC.UNKNOWN=5,tC.ContainerStrategy=$w,tC.ContentStrategy=eC,s.ResolutionPolicy=tC;var nC=e("df",Jw.instance=s.view=new Jw);s.winSize=new Qn,W(Jw.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),k(Ly,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:Qy.EventType,targetName:"SystemEvent.EventType"}}))),k(Ly,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:Qy.EventType,targetName:"SystemEvent.EventType"}]),k(Fy,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:Qy.EventType,targetName:"SystemEvent.EventType"}]),k(Fy,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:Qy.EventType,targetName:"SystemEvent.EventType"}]),k(Fy,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:Qy.EventType,targetName:"SystemEvent.EventType"}]),k(Fy,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:Qy.EventType,targetName:"SystemEvent.EventType"}]),k(ux,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:ux.Language,targetName:"sys.Language"}}))),k(ux,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:ux.OS,targetName:"sys.OS"}}))),k(ux,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:ux.BrowserType,targetName:"sys.BrowserType"}}))),k(ux,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:ux.BrowserType,targetName:"sys.BrowserType"}]),k(ux,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:ux.Platform,targetName:"sys.Platform"}}))),k(ux,"sys",[{name:"IPHONE",newName:"IOS",target:ux.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:ux.Platform,targetName:"sys.Platform"}]),W(ux,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}})));var iC=e("dG",{_supportsFullScreen:!1,_onfullscreenchange:null,_onfullscreenerror:null,_preOnFullScreenError:null,_preOnTouch:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){var e,t,n;this._fn={};var i,o=this._fnMap;for(e=0,t=o.length;e<t;e++)if((n=o[e])&&void 0!==document[n[1]]){for(e=0,i=n.length;e<i;e++)this._fn[o[0][e]]=n[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},get supportsFullScreen(){return this._supportsFullScreen},fullScreen:function(){return!!this._supportsFullScreen&&void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement]},requestFullScreen:function(e,t,n){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var i=this._fn.fullscreenchange;this._onfullscreenchange&&document.removeEventListener(i,this._onfullscreenchange),this._onfullscreenchange=t,document.addEventListener(i,t,!1)}if(n){var o=this._fn.fullscreenerror;this._onfullscreenerror&&document.removeEventListener(o,this._onfullscreenerror),this._onfullscreenerror=n,document.addEventListener(o,n,{once:!0})}var r=e[this._fn.requestFullscreen]();return window.Promise&&r instanceof Promise&&r.catch((function(){})),r}},exitFullScreen:function(){var e;return this.fullScreen()&&(e=document[this._fn.exitFullscreen]()).catch((function(){})),e},autoFullScreen:function(e,t){e=e||document.body,this._ensureFullScreen(e,t),this.requestFullScreen(e,t)},disableAutoFullScreen:function(e){if(this._preOnTouch){var t=s.game.canvas||e,n=this._touchEvent;t.removeEventListener(n,this._preOnTouch),this._preOnTouch=null}},_ensureFullScreen:function(e,t){var n=this,i=s.game.canvas||e,o=this._fn.fullscreenerror,r=this._touchEvent,a=function(){n._preOnFullScreenError=null,n._preOnTouch&&i.removeEventListener(r,n._preOnTouch),n._preOnTouch=function(){n._preOnTouch=null,n.requestFullScreen(e,t)},i.addEventListener(r,n._preOnTouch,{once:!0})};this._preOnFullScreenError&&e.removeEventListener(o,this._preOnFullScreenError),this._preOnFullScreenError=a,e.addEventListener(o,a,{once:!0})}});iC.init(),s.screen=iC;var oC,rC=new Zs(null),aC=function(){function e(){this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=To,this._priority=Bu.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}var t=e.prototype;return t.initialize=function(e,t,n){void 0===n&&(n=null),this._device=s.director.root.device,this._subMesh=e,this._patches=n,this._passes=t,this._handle=ko.alloc(),this._flushPassInfo(),t[0].batchingScheme===nm.VB_MERGING&&this._subMesh.genFlatBuffers(),rC.layout=t[0].localSetLayout;var i=wo.alloc(this._device,rC),o=Co.alloc(this._device,e.iaInfo);ko.set(this._handle,Bo.PRIORITY,Bu.DEFAULT),ko.set(this._handle,Bo.INPUT_ASSEMBLER,o),ko.set(this._handle,Bo.DESCRIPTOR_SET,i),ko.set(this._handle,Bo.SUB_MESH,e.handle),this._inputAssembler=Co.get(o),this._descriptorSet=wo.get(i)},t.initPlanarShadowShader=function(){var e=s.director.root.pipeline.pipelineSceneData.shadows.getPlanarShader(this._patches);ko.set(this._handle,Bo.PLANAR_SHADER,e)},t.initPlanarShadowInstanceShader=function(){var e=s.director.root.pipeline.pipelineSceneData.shadows.getPlanarInstanceShader(this._patches);ko.set(this._handle,Bo.PLANAR_INSTANCE_SHADER,e)},t.destroy=function(){wo.free(ko.get(this._handle,Bo.DESCRIPTOR_SET)),Co.free(ko.get(this._handle,Bo.INPUT_ASSEMBLER)),ko.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=Bu.DEFAULT,this._handle=To,this._patches=null,this._subMesh=null,this._passes=null},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){ko.set(this._handle,Bo.PASS_COUNT,e.length);for(var t=Bo.PASS_0,n=Bo.SHADER_0,i=0;i<e.length;i++,t++,n++)ko.set(this._handle,t,e[i].handle),ko.set(this._handle,n,e[i].getShaderVariant(this._patches))}},J(e,[{key:"passes",get:function(){return this._passes},set:function(e){if(e.length>8)R(12004,8);else if(this._passes=e,this._flushPassInfo(),this._descriptorSet){wo.free(ko.get(this._handle,Bo.DESCRIPTOR_SET)),rC.layout=e[0].localSetLayout;var t=wo.alloc(this._device,rC);ko.set(this._handle,Bo.DESCRIPTOR_SET,t),this._descriptorSet=wo.get(t)}}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._subMesh=e,this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===nm.VB_MERGING&&this._subMesh.genFlatBuffers(),ko.set(this._handle,Bo.SUB_MESH,e.handle)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,ko.set(this._handle,Bo.PRIORITY,e)}},{key:"handle",get:function(){return this._handle}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarShaderHandle",get:function(){return ko.get(this._handle,Bo.PLANAR_SHADER)}},{key:"planarInstanceShaderHandle",get:function(){return ko.get(this._handle,Bo.PLANAR_INSTANCE_SHADER)}}]),e}(),sC=new go(mo.ATTRIBUTE,(function(e,t){return t||new Us})),cC=new Un,lC=new ti((function(){return new aC}),32),uC=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(oC||(oC=e("cD",{})));var hC,_C,fC=$f([za.LINEAR,za.LINEAR,za.NONE,Ba.CLAMP,Ba.CLAMP,Ba.CLAMP]),dC=$f([za.LINEAR,za.LINEAR,za.LINEAR,Ba.CLAMP,Ba.CLAMP,Ba.CLAMP]),pC=e("bX",function(){function e(){this.type=oC.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._handle=To,this._hWorldBounds=To,this._localData=new Float32Array(Ch.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Yn,this._device=s.director.root.device}var t=e.prototype;return t.initialize=function(){if(!this._inited){this._handle=qo.alloc();var e=bo.alloc(),t=No.alloc();qo.set(this._handle,Go.INSTANCED_ATTR_ARRAY,t),qo.set(this._handle,Go.SUB_MODEL_ARRAY,e),qo.set(this._handle,Go.VIS_FLAGS,Fu.Enum.NONE),qo.set(this._handle,Go.ENABLED,1),qo.set(this._handle,Go.RECEIVE_SHADOW,1),qo.set(this._handle,Go.CAST_SHADOW,0),this._inited=!0}},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];n.destroy(),lC.free(n)}if(this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._handle){var i=qo.get(this._handle,Go.SUB_MODEL_ARRAY);i&&bo.free(i);var o=qo.get(this._handle,Go.INSTANCED_BUFFER);o&&Fo.free(o);var r=qo.get(this._handle,Go.INSTANCED_ATTR_ARRAY);r&&Eo(r,No,sC),qo.free(this._handle),this._handle=To}this._hWorldBounds&&(Jo.free(this._hWorldBounds),this._hWorldBounds=To)},t.attachToScene=function(e){this.scene=e},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._transformUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&(this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t),Jo.setVec3(this._hWorldBounds,Yo.CENTER,t.center),Jo.setVec3(this._hWorldBounds,Yo.HALF_EXTENSION,t.halfExtents))}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._transformUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&(this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t),Jo.setVec3(this._hWorldBounds,Yo.CENTER,t.center),Jo.setVec3(this._hWorldBounds,Yo.HALF_EXTENSION,t.halfExtents))}},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._transformUpdated){this._transformUpdated=!1;var i=this.transform._mat,o=this._instMatWorldIdx;if(o>=0){var r=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,r[o],r[o+1],r[o+2])}else this._localBuffer&&(Un.toArray(this._localData,i,Ch.MAT_WORLD_OFFSET),Un.inverseTranspose(cC,i),Un.toArray(this._localData,cC,Ch.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=su.fromPoints(su.create(),e,t),this._worldBounds=su.clone(this._modelBounds),this._hWorldBounds===To&&(this._hWorldBounds=Jo.alloc(),qo.set(this._handle,Go.WORLD_BOUNDS,this._hWorldBounds)),Jo.setVec3(this._hWorldBounds,Yo.CENTER,this._worldBounds.center),Jo.setVec3(this._hWorldBounds,Yo.HALF_EXTENSION,this._worldBounds.halfExtents))},t.initSubModel=function(e,t,n){this.initialize();var i=!1;if(null==this._subModels[e]?(this._subModels[e]=lC.alloc(),i=!0):this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e),i){var o=qo.get(this._handle,Go.SUB_MODEL_ARRAY);bo.assign(o,e,this._subModels[e].handle)}},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){Yn.toArray(this._localData,t,Ch.LIGHTINGMAP_UVPARAM),this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=rm.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=fd.getSampler(this._device,e.mipmaps.length>1?dC:fC),o=this._subModels,r=0;r<o.length;r++){var a=o[r].descriptorSet;a.bindTexture(Xh,n),a.bindSampler(Xh,i),a.update()}},t.getMacroPatches=function(){return this.receiveShadow?uC:null},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet);var n=Ao.get(ko.get(t.handle,Bo.SHADER_0));this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(wa.INSTANCED_ARRAYS)){var n=qo.get(this._handle,Go.INSTANCED_BUFFER);n&&Fo.free(n);var i=qo.get(this._handle,Go.INSTANCED_ATTR_ARRAY);i&&Eo(i,No,sC,!1);for(var o=0,r=0;r<e.length;r++){var a=e[r];a.isInstanced&&(o+=ac[a.format].size)}var s=Fo.alloc(o),c=Fo.getBuffer(s);qo.set(this._handle,Go.INSTANCED_BUFFER,s);var l=this.instancedAttributes;l.buffer=new Uint8Array(c),l.views.length=l.attributes.length=0;for(var u=0,h=0;h<e.length;h++){var _=e[h];if(_.isInstanced){var f=sC.alloc(),d=sC.get(f);d.format=_.format,d.name=_.name,d.isNormalized=_.isNormalized,d.location=_.location,l.attributes.push(d),No.push(i,f);var p=ac[_.format];l.views.push(new(mc(p))(c,u,p.count)),u+=p.size}}t.batchingScheme===nm.INSTANCING&&VT.get(t).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex(Ih),this._transformUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Ss(ba.UNIFORM|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,Ch.SIZE,Ch.SIZE)))},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(Ch.BINDING,this._localBuffer)},J(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return!!qo.get(this._handle,Go.RECEIVE_SHADOW)},set:function(e){qo.set(this._handle,Go.RECEIVE_SHADOW,e?1:0),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return!!qo.get(this._handle,Go.CAST_SHADOW)},set:function(e){qo.set(this._handle,Go.CAST_SHADOW,e?1:0)}},{key:"handle",get:function(){return this._handle}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,qo.set(this._handle,Go.NODE,e.handle)}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e,qo.set(this._handle,Go.TRANSFORM,e.handle)}},{key:"visFlags",get:function(){return qo.get(this._handle,Go.VIS_FLAGS)},set:function(e){qo.set(this._handle,Go.VIS_FLAGS,e)}},{key:"enabled",get:function(){return!!qo.get(this._handle,Go.ENABLED)},set:function(e){qo.set(this._handle,Go.ENABLED,e?1:0)}}]),e}()),mC=e("co",function(e){function t(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._pos=void 0,t._aabb=void 0,t._hAABB=To,t._aabb=su.create(),t._pos=new An,t}ee(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this._hAABB=Jo.alloc(),Mr.set(this._handle,br.TYPE,_m.SPHERE),Mr.set(this._handle,br.SIZE,.15),Mr.set(this._handle,br.RANGE,1),Mr.set(this._handle,br.AABB,this._hAABB),Mr.set(this._handle,br.ILLUMINANCE,1700/pm(.15))},n.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=Mr.get(this._handle,br.RANGE);su.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1,Mr.setVec3(this._handle,br.POSITION,this._pos),Jo.setVec3(this._hAABB,Yo.CENTER,this._aabb.center),Jo.setVec3(this._hAABB,Yo.HALF_EXTENSION,this._aabb.halfExtents)}},n.destroy=function(){return this._hAABB&&(Jo.free(this._hAABB),this._hAABB=To),e.prototype.destroy.call(this)},J(t,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return Mr.get(this._handle,br.SIZE)},set:function(e){Mr.set(this._handle,br.SIZE,e)}},{key:"range",get:function(){return Mr.get(this._handle,br.RANGE)},set:function(e){Mr.set(this._handle,br.RANGE,e),this._needUpdate=!0}},{key:"luminance",get:function(){return Mr.get(this._handle,br.ILLUMINANCE)},set:function(e){Mr.set(this._handle,br.ILLUMINANCE,e)}},{key:"aabb",get:function(){return this._aabb}}]),t}(mm)),vC=new An(0,0,-1),gC=new Nn,yC=new Un,xC=new Un,EC=new Un,SC=new Un,TC=e("cq",function(e){function t(){var t;return(t=e.call(this)||this)._dir=new An(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._hAABB=To,t._hFrustum=To,t._aabb=su.create(),t._frustum=vu.create(),t._pos=new An,t}ee(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this._hAABB=Jo.alloc(),this._hFrustum=mr.alloc(),Mr.set(this._handle,br.TYPE,_m.SPOT),Mr.set(this._handle,br.SIZE,.15),Mr.set(this._handle,br.AABB,this._hAABB),Mr.set(this._handle,br.ILLUMINANCE,1700/pm(.15)),Mr.set(this._handle,br.RANGE,Math.cos(Math.PI/6)),Mr.set(this._handle,br.ASPECT,1),Mr.setVec3(this._handle,br.DIRECTION,this._dir),Mr.set(this._handle,br.FRUSTUM,this._hFrustum)},n.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),An.transformQuat(this._dir,vC,this._node.getWorldRotation(gC)),An.normalize(this._dir,this._dir),Mr.setVec3(this._handle,br.DIRECTION,this._dir),su.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(yC),Un.invert(yC,yC),Un.perspective(xC,this._angle,1,.001,this._range),Un.multiply(EC,xC,yC),this._frustum.update(EC,SC),this._needUpdate=!1,Mr.setVec3(this._handle,br.POSITION,this._pos),Jo.setVec3(this._hAABB,Yo.CENTER,this._aabb.center),Jo.setVec3(this._hAABB,Yo.HALF_EXTENSION,this._aabb.halfExtents),gu(this._hFrustum,this._frustum))},n.destroy=function(){return this._hAABB&&(Jo.free(this._hAABB),this._hAABB=To),this._hFrustum&&(mr.free(this._hFrustum),this._hFrustum=To),e.prototype.destroy.call(this)},J(t,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return Mr.get(this._handle,br.SIZE)},set:function(e){Mr.set(this._handle,br.SIZE,e)}},{key:"range",get:function(){return Mr.get(this._handle,br.RANGE)},set:function(e){this._range=e,Mr.set(this._handle,br.RANGE,e),this._needUpdate=!0}},{key:"luminance",get:function(){return Mr.get(this._handle,br.ILLUMINANCE)},set:function(e){Mr.set(this._handle,br.ILLUMINANCE,e)}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return Mr.get(this._handle,br.SPOT_ANGLE)},set:function(e){this._angle=e,Mr.set(this._handle,br.SPOT_ANGLE,Math.cos(.5*e)),this._needUpdate=!0}},{key:"aspect",get:function(){return Mr.get(this._handle,br.ASPECT)},set:function(e){Mr.set(this._handle,br.ASPECT,e),this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),t}(mm)),AC=Object.freeze({__proto__:null,Ambient:ea,get CameraFOVAxis(){return e_},get CameraProjection(){return t_},get CameraAperture(){return n_},get CameraISO(){return i_},get CameraShutter(){return o_},SKYBOX_FLAG:v_,Camera:y_,CameraVisFlags:hm,VisibilityFlags:fm,DirectionalLight:ym,ColorTemperatureToRGB:dm,get LightType(){return _m},nt2lm:pm,Light:mm,get ModelType(){return oC},Model:pC,ShadowType:cE,PCFType:lE,Shadows:hE,RenderScene:x_,Skybox:UE,SphereLight:mC,SpotLight:TC,SubModel:aC});function wC(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function CC(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(hC||(hC={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(_C||(_C={}));var IC=e("cv",function(){function e(e){this._device=void 0,this._format=Ca.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new gs,this._region1=new gs,this._region2=new gs,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=ac[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=mc(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=CC(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var o=0;o<this._chunkCount&&(n=o,!((i=this._findAvailableSpace(e,n))>=0));++o);if(i>=0){var r=this._chunks[n];r.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:r.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,wC(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new Is(Da.TEX2D,Ma.SAMPLED|Ma.TRANSFER_DST,this._format,e,e,La.IMMUTABLE)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],o=e.start/this._formatSize,r=t.byteLength/this._formatSize,a=o%e.texture.width,s=Math.floor(o/e.texture.width),c=Math.min(e.texture.width-a,r),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,r-=c,l+=c),r>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,r>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(r/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=r,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,r-=c,l+=c),r>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=r,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,r*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,o=n.start;if(o+e<=n.size)i=!0;else{o=0;for(var r=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<r.length;a++){var s=r[a];if(o+e<=s.start){i=!0;break}o=s.end}!i&&o+e<=n.size&&(i=!0)}return i?o:-1},t._McDonaldAlloc=function(e){e=CC(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,o=n.start;if(o+e<=n.end?i=!0:o>n.end?o+e<=n.size?i=!0:e<=n.end&&(n.start=o=0,i=!0):o===n.end&&(n.start=o=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var r={chunkIdx:t,start:o,end:o+e,texture:n.texture};return this._handles.push(r),r}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,wC(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}()),PC=function(e){if(void 0===ho[e]){var t=1<<uo;ho[e]=t,uo+=1}},bC=Object.freeze({__proto__:null,addStage:PC,scene:AC,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,o=0;o<i;++o)n.push(t.positions[3*o],t.positions[3*o+1],t.positions[3*o+2]),t.normals&&n.push(t.normals[3*o],t.normals[3*o+1],t.normals[3*o+2]),t.uvs&&n.push(t.uvs[2*o],t.uvs[2*o+1]),t.colors&&n.push(t.colors[3*o],t.colors[3*o+1],t.colors[3*o+2]);var r=[];r.push(new Us(cs.ATTR_POSITION,Ca.RGB32F)),t.normals&&r.push(new Us(cs.ATTR_NORMAL,Ca.RGB32F)),t.uvs&&r.push(new Us(cs.ATTR_TEX_COORD,Ca.RG32F)),t.colors&&r.push(new Us(cs.ATTR_COLOR,Ca.RGB32F));var a=e.createBuffer(new Ss(ba.VERTEX|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new Ss(ba.INDEX|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new Gs(r,[a],s))},get RenderQueue(){return hC},get PassStage(){return _C},get PropertyType(){return bp},genHandle:Lp,getPropertyTypeFromHandle:Fp,getTypeFromHandle:zp,getSetIndexFromHandle:function(e){return(e&Dp)>>>20},getBindingFromHandle:Bp,getOffsetFromHandle:Up,customizeType:Hp,type2reader:Gp,type2writer:Vp,getDefaultFromType:Wp,overrideMacros:jp,get BatchingSchemes(){return nm},Pass:um,getDeviceShaderVersion:Jp,programLib:$p,get SamplerInfoIndex(){return Yf},defaultSamplerHash:Qf,genSamplerHash:$f,samplerLib:fd,nearestPOT:wC,TextureBufferPool:IC,MaterialInstance:FE,PassInstance:LE,ObjectPool:go,freeHandleArray:Eo,get PoolType(){return mo},NULL_HANDLE:To,ShaderPool:Ao,DSPool:wo,IAPool:Co,PipelineLayoutPool:Io,FramebufferPool:Po,SubModelArrayPool:bo,ModelArrayPool:Ro,AttributeArrayPool:No,FlatBufferArrayPool:Oo,LightArrayPool:Do,BlendTargetArrayPool:Mo,UIBatchArrayPool:Lo,RawBufferPool:Fo,RawObjectPool:zo,get PassView(){return So},PassPool:Ho,get SubModelView(){return Bo},SubModelPool:ko,get ModelView(){return Go},ModelPool:qo,get BatchView2D(){return Wo},BatchPool2D:Ko,get AABBView(){return Yo},AABBPool:Jo,get SceneView(){return Qo},ScenePool:tr,get CameraView(){return $o},CameraPool:or,get NodeView(){return nr},NodePool:sr,get RootView(){return ar},RootPool:ur,get RenderWindowView(){return cr},RenderWindowPool:fr,get FrustumView(){return hr},FrustumPool:mr,get AmbientView(){return dr},AmbientPool:yr,get SkyboxView(){return gr},SkyboxPool:Sr,get FogView(){return xr},FogPool:wr,get ShadowsView(){return Ar},ShadowsPool:Pr,get PipelineSceneDataView(){return Ir},PipelineSceneDataPool:Nr,get LightView(){return br},LightPool:Mr,get SphereView(){return Or},SpherePool:zr,get FlatBufferView(){return Fr},FlatBufferPool:Hr,get SubMeshView(){return Br},SubMeshPool:kr,get RasterizerStateView(){return Gr},RasterizerStatePool:qr,get DepthStencilStateView(){return Wr},DepthStencilStatePool:Kr,get BlendTargetView(){return Yr},BlendTargetPool:Zr,get BlendStateView(){return Qr},BlendStatePool:$r});function RC(e){return e*e}function NC(e){return e*(2-e)}function OC(e){return e*e*e}function DC(e){return--e*e*e+1}function MC(e){return e*e*e*e}function LC(e){return 1- --e*e*e*e}function FC(e){return e*e*e*e*e}function zC(e){return--e*e*e*e*e+1}function BC(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function UC(e){return Math.sin(e*Math.PI/2)}function HC(e){return 0===e?0:Math.pow(1024,e-1)}function GC(e){return 1===e?1:1-Math.pow(2,-10*e)}function VC(e){return 1-Math.sqrt(1-e*e)}function kC(e){return Math.sqrt(1- --e*e)}function WC(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function jC(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function qC(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function YC(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function XC(e){return 1-KC(1-e)}function KC(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}e("d_",bC);var QC=aI(RC,NC),ZC=aI(OC,DC),JC=aI(MC,LC),$C=aI(FC,zC),eI=aI(BC,UC),tI=aI(HC,GC),nI=aI(VC,kC),iI=aI(WC,jC),oI=aI(qC,YC),rI=aI(XC,KC);function aI(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var sI=Object.freeze({__proto__:null,constant:function(){return 0},linear:function(e){return e},quadIn:RC,quadOut:NC,quadInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:OC,cubicOut:DC,cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quartIn:MC,quartOut:LC,quartInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quintIn:FC,quintOut:zC,quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sineIn:BC,sineOut:UC,sineInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},expoIn:HC,expoOut:GC,expoInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circIn:VC,circOut:kC,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:WC,elasticOut:jC,elasticInOut:function(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)},backIn:qC,backOut:YC,backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)},bounceIn:XC,bounceOut:KC,bounceInOut:function(e){return e<.5?.5*XC(2*e):.5*KC(2*e-1)+.5},smooth:function(e){return e<=0?0:e>=1?1:e*e*(3-2*e)},fade:function(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)},quadOutIn:QC,cubicOutIn:ZC,quartOutIn:JC,quintOutIn:$C,sineOutIn:eI,expoOutIn:tI,circOutIn:nI,elasticOutIn:iI,backOutIn:oI,bounceOutIn:rI});e("fD",sI);var cI=new kn,lI=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new xs(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new xs(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{s.view.enableRetina(!0),s.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?s.view.setDesignResolutionSize(n.width,n.height,n.policy):s.view.setDesignResolutionSize(960,640,4),this.root=e,this.device=e.device,s.game.once(s.Game.EVENT_GAME_INITED,(function(){s.director._lateUpdate=performance.now()}),s.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else y("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),s.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new xs(e.x,e.y,e.z,e.w)];var t=this.device;this.renderArea=new _s(0,0,t.width,t.height),this.framebuffer=this.root.mainWindow.framebuffer,this.cmdBuff=t.commandBuffer;var n=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),i=4*Float32Array.BYTES_PER_ELEMENT,o=4*i;this.vertexBuffers=t.createBuffer(new Ss(ba.VERTEX|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,o,i)),this.vertexBuffers.update(n);var r=new Uint16Array([0,1,2,1,3,2]),a=Uint16Array.BYTES_PER_ELEMENT,s=6*a;this.indicesBuffers=t.createBuffer(new Ss(ba.INDEX|ba.TRANSFER_DST,Oa.HOST|Oa.DEVICE,s,a)),this.indicesBuffers.update(r);var c=[new Us("a_position",Ca.RG32F),new Us("a_texCoord",Ca.RG32F)],l=new Gs(c,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(l),this.projection=new Un,Un.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,t.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),s.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,o=e.device;Un.ortho(e.projection,-1,1,-1,1,-1,1,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY,o.surfaceTransform);var r=o.width,a=o.height,s=r<a?r:a;e.startTime<0&&(e.startTime=n);var c=n-e.startTime,l=DC(rn(c/i.totalTime));"NONE"===i.effect&&(l=1);var u=e.logoTexture.width,h=e.logoTexture.height,_=s*i.displayRatio,f=_*u/h,d=_;if(o.surfaceTransform!==Aa.ROTATE_90&&o.surfaceTransform!==Aa.ROTATE_270||(f=_*r/a,d=_*h/u*a/r),e.logoMat.setProperty("resolution",cI.set(r,a),0),e.logoMat.setProperty("scale",cI.set(f,d),0),e.logoMat.setProperty("translate",cI.set(.5*r,.5*a),0),e.logoMat.setProperty("precent",l),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var p=.5*s,m=e.watermarkTexture.width,v=p,g=p*e.watermarkTexture.height/m;o.surfaceTransform!==Aa.ROTATE_90&&o.surfaceTransform!==Aa.ROTATE_270||(v=.5*p,g=p*r/a*.5),e.watermarkMat.setProperty("resolution",cI.set(r,a),0),e.watermarkMat.setProperty("scale",cI.set(v,g),0),e.watermarkMat.setProperty("translate",cI.set(.5*r,.1*a),0),e.watermarkMat.setProperty("precent",l),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.frame(),c>i.totalTime&&(e.splashFinish=!0),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new sE,this.logoMat.initialize({effectName:"splash-screen"});var t=new bs;t.addressU=Ba.CLAMP,t.addressV=Ba.CLAMP,t.addressW=Ba.CLAMP,this.sampler=e.createSampler(t),this.logoTexture=e.createTexture(new Is(Da.TEX2D,Ma.SAMPLED|Ma.TRANSFER_DST,Ca.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=Ao.get(n.getShaderVariant());var o=wo.get(Ho.get(n.handle,So.DESCRIPTOR_SET));o.bindSampler(i,this.sampler),o.update();var r=new gs;r.texExtent.width=this.logoImage.width,r.texExtent.height=this.logoImage.height,r.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[r])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var o=new gs;o.texExtent.width=e.width,o.texExtent.height=e.height,o.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Is(Da.TEX2D,Ma.SAMPLED|Ma.TRANSFER_DST,Ca.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[o]),this.watermarkMat=new sE,this.watermarkMat.initialize({effectName:"splash-screen"});var r=this.watermarkMat.passes[0],a=r.getBinding("mainTexture");r.bindTexture(a,this.watermarkTexture),wo.get(Ho.get(r.handle,So.DESCRIPTOR_SET)).update()},e.frame=function(){var e=this.device;e.acquire();var t=this.cmdBuff,n=this.framebuffer,i=this.renderArea;i.width=e.width,i.height=e.height,t.begin(),t.beginRenderPass(n.renderPass,n,i,this.clearColors,1,0);var o=this.logoMat.passes[0],r=wT.getOrCreatePipelineState(e,o,this.shader,n.renderPass,this.quadAssmebler);if(t.bindPipelineState(r),t.bindDescriptorSet(Ku.MATERIAL,o.descriptorSet),t.bindInputAssembler(this.quadAssmebler),t.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var a=this.watermarkMat.passes[0],s=wT.getOrCreatePipelineState(e,a,this.shader,n.renderPass,this.quadAssmebler);t.bindPipelineState(s),t.bindDescriptorSet(Ku.MATERIAL,a.descriptorSet),t.bindInputAssembler(this.quadAssmebler),t.draw(this.quadAssmebler)}t.endRenderPass(),t.end(),e.flushCommands([t]),e.queue.submit([t]),e.present()},e.destroy=function(){this.callBack=null,this.root=null,this.device=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler.destroy(),this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},J(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();lI._ins=void 0,s.internal.SplashScreen=lI;var uI=e("dT",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},J(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}()),hI=new fe("Scheduler"),_I=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};_I.get=function(e,t,n,i){var o=_I._listEntries.pop();return o?(o.target=e,o.priority=t,o.paused=n,o.markedForDeletion=i):o=new _I(e,t,n,i),o},_I.put=function(e){_I._listEntries.length<20&&(e.target=null,_I._listEntries.push(e))},_I._listEntries=[];var fI=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};fI.get=function(e,t,n,i){var o=fI._hashUpdateEntries.pop();return o?(o.list=e,o.entry=t,o.target=n,o.callback=i):o=new fI(e,t,n,i),o},fI.put=function(e){fI._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,fI._hashUpdateEntries.push(e))},fI._hashUpdateEntries=[];var dI=function(e,t,n,i,o,r){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=o,this.paused=r};dI.get=function(e,t,n,i,o,r){var a=dI._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=o,a.paused=r):a=new dI(e,t,n,i,o,r),a},dI.put=function(e){dI._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,dI._hashTimerEntries.push(e))},dI._hashTimerEntries=[];var pI=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,i,o,r){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=i,this._delay=r,this._useDelay=this._delay>0,this._repeat=o,this._runForever=this._repeat===s.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();pI._timers=[],pI.get=function(){return pI._timers.pop()||new pI},pI.put=function(e){pI._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,pI._timers.push(e))};var mI=e("f8",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=we(!0),t._hashForTimers=we(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}ee(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?P(1513):e.id=hI.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,o,r;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(o=n[t]).paused||o.markedForDeletion||o.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(o=n[t]).paused||o.markedForDeletion||o.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(o=n[t]).paused||o.markedForDeletion||o.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(r=a[t],this._currentTarget=r,this._currentTargetSalvaged=!1,!r.paused)for(r.timerIndex=0;r.timerIndex<r.timers.length;++r.timerIndex)r.currentTimer=r.timers[r.timerIndex],r.currentTimerSalvaged=!1,r.currentTimer.update(e),r.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(o=n[t]).markedForDeletion?this._removeUpdateFromHash(o):t++;for(t=0,n=this._updates0List;t<n.length;)(o=n[t]).markedForDeletion?this._removeUpdateFromHash(o):t++;for(t=0,n=this._updatesPosList;t<n.length;)(o=n[t]).markedForDeletion?this._removeUpdateFromHash(o):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,i,o,r){if("function"!=typeof e){var a=e;e=t,t=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(r=!!i,i=s.macro.REPEAT_FOREVER,o=0),D(t,1502);var c=t.uuid||t.id;if(c){var l,u,h=this._hashForTimers[c];if(h?h.paused!==r&&P(1511):(h=dI.get(null,t,0,null,null,r),this._arrayForTimers.push(h),this._hashForTimers[c]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((l=h.timers[u])&&e===l._callback)return C(1507,l.getInterval(),n),void(l._interval=n);(l=pI.get()).initWithCallback(this,e,t,n,i,o),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else R(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var o=this._hashForUpdates[i];if(o&&o.entry){if(o.entry.priority===t)return o.entry.markedForDeletion=!1,void(o.entry.paused=n);if(this._updateHashLocked)return C(1506),o.entry.markedForDeletion=!1,void(o.entry.paused=n);this.unscheduleUpdate(e)}var r,a=_I.get(e,t,n,!1);0===t?(r=this._updates0List,this._appendIn(r,a)):(r=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(r,a,t)),this._hashForUpdates[i]=fI.get(r,a,e,null)}else R(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this,o=i._hashForTimers[n];if(o)for(var r=o.timers,a=0,s=r.length;a<s;a++){var c=r[a];if(e===c._callback)return c!==o.currentTimer||o.currentTimerSalvaged||(o.currentTimerSalvaged=!0),r.splice(a,1),pI.put(c),o.timerIndex>=a&&o.timerIndex--,void(0===r.length&&(i._currentTarget===o?i._currentTargetSalvaged=!0:i._removeHashElement(o)))}}else R(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else R(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var o=0,r=i.length;o<r;o++)pI.put(i[o]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else R(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(s.Scheduler.PRIORITY_SYSTEM)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,o=this._arrayForTimers;for(t=o.length-1;t>=0;t--)n=o[t],this.unscheduleAllForTarget(n.target);var r=0;if(e<0)for(t=0;t<this._updatesNegList.length;)r=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),r===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)r=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),r===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)r=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),r===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){D(e,1508),D(t,1509);var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var o=i.timers,r=0;r<o.length;++r)if(e===o[r]._callback)return!0;return!1}R(1510)},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(s.Scheduler.PRIORITY_SYSTEM)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,o,r=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(t=a[n])&&(t.paused=!0,r.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(o=this._updatesNegList[n])&&o.priority>=e&&(o.paused=!0,r.push(o.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(o=this._updates0List[n])&&(o.paused=!0,r.push(o.target));for(n=0;n<this._updatesPosList.length;n++)(o=this._updatesPosList[n])&&o.priority>=e&&(o.paused=!0,r.push(o.target));return r},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){D(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else R(1510)},n.resumeTarget=function(e){D(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else R(1510)},n.isTargetPaused=function(e){D(e,1505);var t=e.uuid||e.id;if(!t)return R(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,o=n.length;i<o;i++)if(n[i]===e){n.splice(i,1);break}dI.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,o=n.entry,r=0,a=i.length;r<a;r++)if(i[r]===o){i.splice(r,1);break}delete this._hashForUpdates[t],_I.put(o),fI.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(uI));mI.PRIORITY_SYSTEM=1<<31,mI.PRIORITY_NON_SYSTEM=mI.PRIORITY_SYSTEM+1,mI.ID="scheduler",s.Scheduler=mI;var vI=function(){function e(){this._title="",this._width=1,this._height=1,this._nativeWidth=1,this._nativeHeight=1,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._swapchainBufferIndices=0,this._shouldSyncSizeWithSwapchain=!1,this._poolHandle=To,this._cameras=[]}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){this._poolHandle=fr.alloc(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchainBufferIndices&&(this._swapchainBufferIndices=t.swapchainBufferIndices),void 0!==t.shouldSyncSizeWithSwapchain&&(this._shouldSyncSizeWithSwapchain=t.shouldSyncSizeWithSwapchain),this._width=t.width,this._height=t.height,this._nativeWidth=this._width,this._nativeHeight=this._height;for(var n=t.renderPassInfo,i=n.colorAttachments,o=n.depthStencilAttachment,r=0;r<i.length;r++)i[r].format===Ca.UNKNOWN&&(i[r].format=e.colorFormat);o&&o.format===Ca.UNKNOWN&&(o.format=e.depthStencilFormat),this._renderPass=e.createRenderPass(t.renderPassInfo);for(var a=0;a<i.length;a++){var s=null;this._swapchainBufferIndices&1<<a?fr.set(this._poolHandle,cr.HAS_ON_SCREEN_ATTACHMENTS,1):(s=e.createTexture(new Is(Da.TEX2D,Ma.COLOR_ATTACHMENT|Ma.SAMPLED,i[a].format,this._width,this._height)),fr.set(this._poolHandle,cr.HAS_OFF_SCREEN_ATTACHMENTS,1)),this._colorTextures.push(s)}o&&(this._swapchainBufferIndices>=0?(this._depthStencilTexture=e.createTexture(new Is(Da.TEX2D,Ma.DEPTH_STENCIL_ATTACHMENT|Ma.SAMPLED,o.format,this._width,this._height)),fr.set(this._poolHandle,cr.HAS_OFF_SCREEN_ATTACHMENTS,1)):fr.set(this._poolHandle,cr.HAS_ON_SCREEN_ATTACHMENTS,1));var c=Po.alloc(e,new Xs(this._renderPass,this._colorTextures,this._depthStencilTexture));return fr.set(this._poolHandle,cr.FRAMEBUFFER,c),!0},t.destroy=function(){this.clearCameras(),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._poolHandle&&(Po.get(fr.get(this._poolHandle,cr.FRAMEBUFFER)).destroy(),this._poolHandle=To)},t.resize=function(e,t){if(this._width=e,this._height=t,e>this._nativeWidth||t>this._nativeHeight){this._nativeWidth=e,this._nativeHeight=t;var n=!1;this._depthStencilTexture&&(this._depthStencilTexture.resize(e,t),n=!0);for(var i=0;i<this._colorTextures.length;i++){var o=this._colorTextures[i];o&&(o.resize(e,t),n=!0)}var r=Po.get(fr.get(this._poolHandle,cr.FRAMEBUFFER));n&&r&&(r.destroy(),r.initialize(new Xs(this._renderPass,this._colorTextures,this._depthStencilTexture)))}for(var a,s=oe(this._cameras);!(a=s()).done;){var c=a.value;c.isWindowSize&&c.resize(e,t)}},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},J(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"framebuffer",get:function(){return Po.get(fr.get(this._poolHandle,cr.FRAMEBUFFER))}},{key:"shouldSyncSizeWithSwapchain",get:function(){return this._shouldSyncSizeWithSwapchain}},{key:"hasOnScreenAttachments",get:function(){return 1===fr.get(this._poolHandle,cr.HAS_ON_SCREEN_ATTACHMENTS)}},{key:"hasOffScreenAttachments",get:function(){return 1===fr.get(this._poolHandle,cr.HAS_OFF_SCREEN_ATTACHMENTS)}},{key:"handle",get:function(){return this._poolHandle}},{key:"cameras",get:function(){return this._cameras}}]),e}(),gI=function(){function e(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._poolHandle=To,this._useDeferredPipeline=!1,this._device=e,this._dataPoolMgr=s.internal.DataPoolManager&&new s.internal.DataPoolManager(e),x_.registerCreateFunc(this),vI.registerCreateFunc(this),this._cameraPool=new ti((function(){return new y_(t._device)}),4)}var t=e.prototype;return t.initialize=function(){var e=this;this._poolHandle=ur.alloc();var t=new Vs,n=new ks;n.depthStoreOp=qa.DISCARD,n.stencilStoreOp=qa.DISCARD;var i=new js([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:this._device.width,height:this._device.height,renderPassInfo:i,swapchainBufferIndices:-1}),this._curWindow=this._mainWindow,Promise.resolve(rm.initBuiltinRes(this._device)).then((function(){s.view.on("design-resolution-changed",(function(){var t=s.game.canvas.width,n=s.game.canvas.height;e.resize(t,n)}),e)}))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._poolHandle&&(ur.free(this._poolHandle),this._poolHandle=To)},t.resize=function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);for(var n,i=oe(this._windows);!(n=i()).done;){var o=n.value;o.shouldSyncSizeWithSwapchain&&o.resize(e,t)}this._pipeline&&this._pipeline.resize(e,t)},t.setRenderPipeline=function(e){if(e instanceof jw&&(this._useDeferredPipeline=!0),e||(e=Yw()),this._pipeline=e,!this._pipeline.activate())return!1;var t=s.director.getScene();return t&&t.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&s.internal.Batcher2D&&(this._batcher=new s.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.initDeferredPassInfo()},t.activeWindow=function(e){this._curWindow=e},t.resetCumulativeTime=function(){ur.set(this._poolHandle,ar.CUMULATIVE_TIME,0)},t.frameMove=function(e){ur.set(this._poolHandle,ar.FRAME_TIME,e),++this._frameCount,ur.set(this._poolHandle,ar.CUMULATIVE_TIME,ur.get(this._poolHandle,ar.CUMULATIVE_TIME)+e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();this._batcher&&this._batcher.update();for(var n=this._windows,i=[],o=0;o<n.length;o++)n[o].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire();var r=this._scenes,a=s.director.getTotalFrames();this._batcher&&this._batcher.uploadBuffers();for(var c=0;c<r.length;c++)r[c].update(a);s.director.emit(s.Director.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},t.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},t.destroyWindows=function(){for(var e,t=oe(this._windows);!(e=t()).done;)e.value.destroy();this._windows=[]},t.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},t.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},t.destroyScenes=function(){for(var e,t=oe(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes=[]},t.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new ti((function(){return new e}),10)),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},t.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.destroy(),e.scene&&e.scene.removeModel(e)):P(1300,e.constructor.name)},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new ti((function(){return new e}),4)),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},t.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(e.destroy(),t&&(t.free(e),e.scene))switch(e.type){case _m.SPHERE:e.scene.removeSphereLight(e);break;case _m.SPOT:e.scene.removeSpotLight(e)}},J(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return ur.get(this._poolHandle,ar.CUMULATIVE_TIME)}},{key:"frameTime",get:function(){return ur.get(this._poolHandle,ar.FRAME_TIME)}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"handle",get:function(){return this._poolHandle}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}();s.Root=gI;var yI={};k(yI,"vmath",[{name:"vec2",newName:"Vec2",target:ei,targetName:"math"},{name:"vec3",newName:"Vec3",target:ei,targetName:"math"},{name:"vec4",newName:"Vec4",target:ei,targetName:"math"},{name:"quat",newName:"Quat",target:ei,targetName:"math"},{name:"mat3",newName:"Mat3",target:ei,targetName:"math"},{name:"mat4",newName:"Mat4",target:ei,targetName:"math"},{name:"color4",newName:"Color",target:ei,targetName:"math"},{name:"rect",newName:"Rect",target:ei,targetName:"math"},{name:"approx",newName:"approx",target:ei,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:ei,targetName:"math"},{name:"equals",newName:"equals",target:ei,targetName:"math"},{name:"clamp",newName:"clamp",target:ei,targetName:"math"},{name:"clamp01",newName:"clamp01",target:ei,targetName:"math"},{name:"lerp",newName:"lerp",target:ei,targetName:"math"},{name:"toRadian",newName:"toRadian",target:ei,targetName:"math"},{name:"toDegree",newName:"toDegree",target:ei,targetName:"math"},{name:"random",newName:"random",target:ei,targetName:"math"},{name:"randomRange",newName:"randomRange",target:ei,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:ei,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:ei,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:ei,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:ei,targetName:"math"},{name:"repeat",newName:"repeat",target:ei,targetName:"math"},{name:"pingPong",newName:"pingPong",target:ei,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:ei,targetName:"math"}]),s.vmath=yI,k(mI.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:mI,targetName:"Scheduler"}]),k(Fy.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:Fy,targetName:"EventTouch"}]),k(aC.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),W(aC.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),k(gI.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]);var xI=Object.freeze({__proto__:null,ccclass:b_,property:D_,requireComponent:R_,executionOrder:N_,disallowMultiple:O_,executeInEditMode:z_,menu:B_,playOnFocus:U_,inspector:H_,icon:G_,help:V_,type:rf,integer:ef,float:tf,boolean:nf,string:of});e("eB",xI);var EI,SI,TI,AI,wI,CI,II,PI,bI,RI,NI,OI=ri.Flags.Destroyed,DI=ri.Flags.PersistentMask,MI=[];function LI(e){var t;if(e instanceof ri){if(e._instantiate)return s.game._isCloning=!0,t=e._instantiate(null,!0),s.game._isCloning=!1,t;if(e instanceof s.Asset)throw new TypeError(M(6903))}return s.game._isCloning=!0,t=FI(e),s.game._isCloning=!1,t}function FI(e,t){var n;zI(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,o=MI.length;i<o;++i)MI[i]._iN$t=null;return MI.length=0,n}function zI(e,t,n){et.value(e,"_iN$t",t,!0),MI.push(e);var i=e.constructor;if(s.Class._isCCClass(i))!function(e,t,n,i){for(var o=e.__values__,r=0;r<o.length;r++){var a=o[r],s=t[a];if("object"==typeof s&&s){var c=n[a];c instanceof at&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||BI(s,i)}else n[a]=s}}(i,e,t,n);else for(var o in e)if(e.hasOwnProperty(o)&&(95!==o.charCodeAt(0)||95!==o.charCodeAt(1)||"__type__"===o)){var r=e[o];if("object"==typeof r&&r){if(r===t)continue;t[o]=r._iN$t||BI(r,n)}else t[o]=r}e instanceof ri&&(t._objFlags&=DI)}function BI(e,t){if(e instanceof at)return e.clone();if(e instanceof s.Asset)return e;var n;if(ArrayBuffer.isView(e)){var i=e.length;n=new e.constructor(i),e._iN$t=n,MI.push(e);for(var o=0;o<i;++o)n[o]=e[o];return n}if(Array.isArray(e)){var r=e.length;n=new Array(r),e._iN$t=n,MI.push(e);for(var a=0;a<r;++a){var c=e[a];n[a]="object"==typeof c&&c?c._iN$t||BI(c,t):c}return n}if(e._objFlags&OI)return null;var l=e.constructor;if(s.Class._isCCClass(l)){if(t)if(t instanceof s.Component){if(e instanceof s._BaseNode||e instanceof s.Component)return e}else if(t instanceof s._BaseNode)if(e instanceof s._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof s.Component&&e.node&&!e.node.isChildOf(t))return e;n=new l}else if(l===Object)n={};else{if(l)return e;n=Object.create(null)}return zI(e,n,t),n}function UI(e,t){return(t<<3)+e}LI._clone=FI,s.instantiate=LI,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(RI||(RI={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(NI||(NI={}));var HI=e("eK",b_("cc.CompactValueTypeArray")((PI=II=function(){function e(){re(this,"_byteOffset",TI,this),re(this,"_unitCount",AI,this),re(this,"_unitElement",wI,this),re(this,"_length",CI,this)}return e.lengthFor=function(e,t,n){return GI(t).requiredUnits*e.length*VI(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,o,r,a){for(var s=GI(n),c=VI(i),l=s.requiredUnits*t.length,u=new c(o,r,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var _=new e;return _._unitElement=UI(i,n),_._byteOffset=a,_._unitCount=l,_._length=t.length,_},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,o=GI(n.elementType),r=new(VI(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=o.decompress(r,s);return a},e}(),II.StorageUnit=RI,II.ElementType=NI,TI=ae((SI=PI).prototype,"_byteOffset",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AI=ae(SI.prototype,"_unitCount",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wI=ae(SI.prototype,"_unitElement",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UI(RI.Uint8,NI.Scalar)}}),CI=ae(SI.prototype,"_length",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EI=SI))||EI);function GI(e){return jI[e]}function VI(e){switch(e){case RI.Uint8:return Uint8Array;case RI.Uint16:return Uint16Array;case RI.Uint32:return Uint32Array;case RI.Int8:return Int8Array;case RI.Int16:return Int16Array;case RI.Int32:return Int32Array;case RI.Float32:return Float32Array;case RI.Float64:return Float64Array}}var kI,WI,jI=((bI={})[NI.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},bI[NI.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new An(e[2*t],e[2*t+1])}},bI[NI.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new An(e[3*t],e[3*t+1],e[3*t+2])}},bI[NI.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Yn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},bI[NI.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Nn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},bI[NI.Mat4]={requiredUnits:16,compress:function(e,t,n){Un.toArray(e,n,16*t)},decompress:function(e,t){return Un.fromArray(new Un,e,16*t)}},bI);s._decorator=xI,W(pd.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),k(aE.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var qI,YI=e("eL",b_("cc.BufferAsset")((ae((WI=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}ee(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},J(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(zf)).prototype,"_nativeAsset",[af],Object.getOwnPropertyDescriptor(WI.prototype,"_nativeAsset"),WI.prototype),kI=WI))||kI);s.BufferAsset=YI;var XI=((qI={})[Ia.UNORM]="Uint",qI[Ia.SNORM]="Int",qI[Ia.UINT]="Uint",qI[Ia.INT]="Int",qI[Ia.UFLOAT]="Float",qI[Ia.FLOAT]="Float",qI.default="Uint",qI);function KI(e){return""+(XI[e.type]||XI.default)+e.size/e.count*8}function QI(e,t,n,i,o,r,a){void 0===n&&(n=Ca.R32F),void 0===i&&(i=0),void 0===o&&(o=e.byteLength-i),void 0===r&&(r=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=ac[n];r||(r=s.size);for(var c="set"+KI(s),l="get"+KI(s),u=s.size/s.count,h=Math.floor(o/r),_=ux.isLittleEndian,f=0;f<h;++f)for(var d=i+r*f,p=0;p<s.count;++p){var m=d+u*p,v=e[l](m,_);a[c](m,t(v,p,e),_)}return a}e("bR",function(){function e(e,t,n,i,o){void 0===i&&(i=null),void 0===o&&(o=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._handle=To,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=o,this._primitiveMode=n,this._iaInfo=new Gs(t,e,i,o),this._handle=kr.alloc();var r=Oo.alloc();kr.set(this._handle,Br.FLAT_BUFFER_ARRAY,r)}var t=e.prototype;return t.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx],i=kr.get(this._handle,Br.FLAT_BUFFER_ARRAY);n.indexView&&(t=n.indexView.count);for(var o=0;o<n.vertexBundelIndices.length;o++){var r=n.vertexBundelIndices[o],a=e.struct.vertexBundles[r],s=n.indexView?n.indexView.count:a.view.count,c=a.view.stride,l=c*s,u=new Uint8Array(e.data.buffer,a.view.offset,a.view.length),h=Fo.alloc(n.indexView?l:a.view.length),_=Hr.alloc();Hr.set(_,Fr.STRIDE,c),Hr.set(_,Fr.AMOUNT,s),Hr.set(_,Fr.BUFFER,h),Oo.push(i,_);var f=Fo.getBuffer(h),d=new Uint8Array(f);if(n.indexView){for(var p=e.readIndices(this.subMeshIdx),m=0;m<t;++m)for(var v=m*c,g=p[m]*c,y=0;y<c;++y)d[v+y]=u[g+y];this._flatBuffers.push({stride:c,count:s,buffer:d})}else d.set(e.data.subarray(a.view.offset,a.view.offset+a.view.length)),this._flatBuffers.push({stride:c,count:s,buffer:d})}}},t.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null),this._handle&&(Eo(kr.get(this._handle,Br.FLAT_BUFFER_ARRAY),Oo,Hr),kr.free(this._handle),this._handle=To)},t.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new Us("a_vertexId",Ca.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},t._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var o=e.createBuffer(new Ss(ba.VERTEX|ba.TRANSFER_DST,Oa.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return o.update(n),o},J(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:An.ZERO,max:An.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:An.ZERO,max:An.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,cs.ATTR_POSITION),i=e.readIndices(t),o=new An,r=new An,a=this.attributes.find((function(e){return e.name===cs.ATTR_POSITION}));if(a){var s=ac[a.format].count;2===s?(o.set(n[0],n[1],0),r.set(n[0],n[1],0)):(o.set(n[0],n[1],n[2]),r.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(o.x=n[c]>o.x?n[c]:o.x,o.y=n[c+1]>o.y?n[c+1]:o.y,r.x=n[c]<r.x?n[c]:r.x,r.y=n[c+1]<r.y?n[c+1]:r.y):(o.x=n[c]>o.x?n[c]:o.x,o.y=n[c+1]>o.y?n[c+1]:o.y,o.z=n[c+2]>o.z?n[c+2]:o.z,r.x=n[c]<r.x?n[c]:r.x,r.y=n[c+1]<r.y?n[c+1]:r.y,r.z=n[c+2]<r.z?n[c+2]:r.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:o,min:r}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,o,r=this.mesh.struct,a=r.primitives[this.subMeshIdx];if(!r.jointMaps||void 0===a.jointMapIndex||!r.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var c=s.director.root.device,l=0;l<a.vertexBundelIndices.length;l++){var u=r.vertexBundles[a.vertexBundelIndices[l]];o=0,i=Ca.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===cs.ATTR_JOINTS){i=_.format;break}o+=ac[_.format].size}i?function(){var s=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(s.slice().buffer),_=r.jointMaps[a.jointMapIndex];QI(h,(function(e){return _.indexOf(e)}),i,o,u.view.length,u.view.stride,h);var f=c.createBuffer(new Ss(ba.VERTEX|ba.TRANSFER_DST,Oa.DEVICE,u.view.length,u.view.stride));f.update(h.buffer),t.push(f),n.push(l)}():t.push(this.vertexBuffers[a.vertexBundelIndices[l]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(c)),t}},{key:"iaInfo",get:function(){return this._iaInfo}},{key:"handle",get:function(){return this._handle}}]),e}());var ZI=new Array(16),JI=null,$I=new kn,eP=[Fm.TOUCH_START.toString(),Fm.TOUCH_MOVE.toString(),Fm.TOUCH_END.toString(),Fm.TOUCH_CANCEL.toString()],tP=[Fm.MOUSE_DOWN.toString(),Fm.MOUSE_ENTER.toString(),Fm.MOUSE_MOVE.toString(),Fm.MOUSE_LEAVE.toString(),Fm.MOUSE_UP.toString(),Fm.MOUSE_WHEEL.toString()];function nP(e,t){var n=this.owner;return!(!n||!n._uiProps.uiTransformComp||(e.getUILocation($I),!n._uiProps.uiTransformComp.isHit($I,this)||(t.type=Fm.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t),0)))}function iP(e,t){var n=this.owner;return!(!n||!n._uiProps.uiTransformComp||(t.type=Fm.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t),0))}function oP(e,t){var n=this.owner;n&&n._uiProps.uiTransformComp&&(e.getUILocation($I),n._uiProps.uiTransformComp.isHit($I,this)?t.type=Fm.TOUCH_END.toString():t.type=Fm.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t))}function rP(e,t){var n=this.owner;n&&n._uiProps.uiTransformComp&&(t.type=Fm.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t))}function aP(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&($I=e.getUILocation(),t._uiProps.uiTransformComp.isHit($I,this)&&(e.type=Fm.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function sP(e){var t=this.owner;if(t&&t._uiProps.uiTransformComp){if($I=e.getUILocation(),t._uiProps.uiTransformComp.isHit($I,this))this._previousIn||(JI&&JI.eventProcessor.mouseListener&&(e.type=Fm.MOUSE_LEAVE,JI.dispatchEvent(e),JI.eventProcessor.mouseListener&&(JI.eventProcessor.mouseListener._previousIn=!1)),JI=t,e.type=Fm.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=Fm.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=Fm.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,JI=null}e.propagationStopped=!0}}function cP(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&($I=e.getUILocation(),t._uiProps.uiTransformComp.isHit($I,this)&&(e.type=Fm.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function lP(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&($I=e.getUILocation(),t._uiProps.uiTransformComp.isHit($I,this)&&(e.type=Fm.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function uP(e,t){if(t){for(var n=0,i=[],o=e;o&&$g.isNode(o);o=o.parent,++n){var r=o.getComponent(t);if(r){var a={index:n,comp:r};i?i.push(a):i=[a]}}return i.length>0?i:null}return null}function hP(e,t){if(!e._persistNode){if(e.eventProcessor.bubblingTargets)for(var n=0;n<t.length;++n)if(e.eventProcessor.bubblingTargets.hasEventListener(t[n]))return!0;if(e.eventProcessor.capturingTargets)for(var i=0;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}return!0}var _P,fP=e("d7",function(){function e(e){this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}var t=e.prototype;return t.reattach=function(){var t;this.node.walk((function(n){t||(t=uP(n,e._comp)),n.eventProcessor.touchListener&&(n.eventProcessor.touchListener.mask=t),n.eventProcessor.mouseListener&&(n.eventProcessor.mouseListener.mask=t)}))},t.destroy=function(){JI===this._node&&(JI=null),(this.touchListener||this.mouseListener)&&(Xm.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()},t.on=function(e,t,n,i){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,n,i):(this.bubblingTargets||(this.bubblingTargets=new di),this.bubblingTargets.on(e,t,n))},t.once=function(e,t,n,i){var o,r=this;(o=this._checknSetupSysEvent(e)&&i?this.capturingTargets=this.capturingTargets||new di:this.bubblingTargets=this.bubblingTargets||new di).on(e,t,n,!0),o.on(e,(function(){r.off(e,t,n)}),void 0,!0)},t.off=function(e,t,n,i){var o=-1!==eP.indexOf(e),r=!o&&-1!==tP.indexOf(e);o||r?(this._offDispatch(e,t,n,i),o?this.touchListener&&!hP(this._node,eP)&&(Xm.removeListener(this.touchListener),this.touchListener=null):r&&this.mouseListener&&!hP(this._node,tP)&&(Xm.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,n)},t.emit=function(e,t,n,i,o,r){this.bubblingTargets&&this.bubblingTargets.emit(e,t,n,i,o,r)},t.dispatchEvent=function(e){!function(e,t){var n,i=0;for(t.target=e,ZI.length=0,e.eventProcessor.getCapturingTargets(t.type,ZI),t.eventPhase=1,i=ZI.length-1;i>=0;--i)if((n=ZI[i]).eventProcessor.capturingTargets&&(t.currentTarget=n,n.eventProcessor.capturingTargets.emit(t.type,t,ZI),t.propagationStopped))return void(ZI.length=0);if(ZI.length=0,t.eventPhase=2,t.currentTarget=e,e.eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,ZI),t.eventPhase=3,i=0;i<ZI.length;++i)if((n=ZI[i]).eventProcessor.bubblingTargets&&(t.currentTarget=n,n.eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(ZI.length=0);ZI.length=0}(this._node,e),ZI.length=0},t.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTargets&&(i=this.bubblingTargets.hasEventListener(e,t,n)),!i&&this.capturingTargets&&(i=this.capturingTargets.hasEventListener(e,t,n)),i},t.targetOff=function(e){this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e),this.touchListener&&!hP(this.node,eP)&&(Xm.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!hP(this.node,tP)&&(Xm.removeListener(this.mouseListener),this.mouseListener=null)},t.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;)n.eventProcessor.capturingTargets&&n.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(n),n=n.parent},t.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;)n.eventProcessor.bubblingTargets&&n.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(n),n=n.parent},t._checknSetupSysEvent=function(t){var n=this,i=!1,o=!1;return-1!==eP.indexOf(t)?(this.touchListener||(this.touchListener=s.EventListener.create({event:s.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:uP(this._node,e._comp),onTouchBegan:nP,onTouchMoved:iP,onTouchEnded:oP,onTouchCancelled:rP}),Xm.addListener(this.touchListener,this._node),i=!0),o=!0):-1!==tP.indexOf(t)&&(this.mouseListener||(this.mouseListener=s.EventListener.create({event:s.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:uP(this._node,e._comp),onMouseDown:aP,onMouseMove:sP,onMouseUp:cP,onMouseScroll:lP}),Xm.addListener(this.mouseListener,this._node),i=!0),o=!0),i&&!this._node.activeInHierarchy&&s.director.getScheduler().schedule((function(){n._node.activeInHierarchy||Xm.pauseTarget(n._node)}),this._node,0,0,0,!1),o},t._onDispatch=function(e,t,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,t){var o=null;return(o=i?this.capturingTargets=this.capturingTargets||new di:this.bubblingTargets=this.bubblingTargets||new di).hasEventListener(e,t,n)||o.on(e,t,n),t}R(6800)},t._offDispatch=function(e,t,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,t){var o=i?this.capturingTargets:this.bubblingTargets;o&&o.off(e,t,n)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)},J(e,[{key:"node",get:function(){return this._node}}]),e}());fP._comp=null,s.NodeEventProcessor=fP,k(xv.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),k($g.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new kn),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Qn),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),W($g.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),W(Fu,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),k(Fu,"Layers",[{name:"Default",newName:"DEFAULT",target:Fu.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Fu.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Fu.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Fu.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Fu.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Fu.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Fu.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Fu.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Fu,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Fu,targetName:"Layers"}]),W(Fu.Enum,"Layers.Enum",[{name:"ALWAYS"}]),W(Fu.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var dP,pP,mP,vP,gP,yP,xP,EP,SP,TP,AP,wP,CP,IP,PP,bP,RP,NP,OP,DP,MP,LP,FP,zP,BP,UP,HP,GP,VP,kP,WP,jP,qP,YP,XP,KP,QP,ZP,JP,$P,eb,tb,nb,ib,ob,rb,ab,sb,cb,lb,ub,hb,_b,fb,db,pb,mb,vb,gb,yb,xb,Eb,Sb,Tb,Ab,wb,Cb,Ib,Pb,bb,Rb,Nb,Ob,Db,Mb,Lb,Fb,zb,Bb,Ub,Hb,Gb,Vb,kb,Wb,jb,qb,Yb,Xb,Kb,Qb,Zb,Jb,$b,eR,tR,nR,iR,oR,rR,aR,sR,cR,lR,uR,hR,_R,fR,dR,pR,mR,vR,gR,yR,xR,ER,SR,TR,AR,wR=ri.Flags.HideInHierarchy,CR=ri.Flags.DontSave,IR=e("fA",b_("cc.PrivateNode")(_P=function(e){function t(t){var n;return P(12003,(n=e.call(this,t)||this).name),n.hideFlags|=CR|wR,n}return ee(t,e),t}($g))||_P);s.PrivateNode=IR;var PR=new An(0,1,0),bR=new An,RR=new Nn,NR=(dP=b_("cc.AmbientInfo"),pP=rf(Rt),dP((EP=function(){function e(){re(this,"_skyColor",gP,this),re(this,"_skyIllum",yP,this),re(this,"_groundAlbedo",xP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},J(e,[{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor.set(e),this._resource&&(this._resource.skyColor=this._skyColor)}},{key:"skyIllum",get:function(){return this._skyIllum},set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo.set(e),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)}}]),e}(),gP=ae((vP=EP).prototype,"_skyColor",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Sn(51,128,204,1)}}),yP=ae(vP.prototype,"_skyIllum",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ea.SKY_ILLUM}}),xP=ae(vP.prototype,"_groundAlbedo",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Sn(51,51,51,255)}}),ae(vP.prototype,"skyColor",[k_],Object.getOwnPropertyDescriptor(vP.prototype,"skyColor"),vP.prototype),ae(vP.prototype,"skyIllum",[k_,pP],Object.getOwnPropertyDescriptor(vP.prototype,"skyIllum"),vP.prototype),ae(vP.prototype,"groundAlbedo",[k_],Object.getOwnPropertyDescriptor(vP.prototype,"groundAlbedo"),vP.prototype),mP=vP))||mP);s.AmbientInfo=NR;var OR=(SP=b_("cc.SkyboxInfo"),TP=rf(wp),AP=rf(wp),SP((NP=function(){function e(){re(this,"_envmap",IP,this),re(this,"_isRGBE",PP,this),re(this,"_enabled",bP,this),re(this,"_useIBL",RP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)}},{key:"isRGBE",get:function(){return this._isRGBE},set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)}}]),e}(),IP=ae((CP=NP).prototype,"_envmap",[TP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PP=ae(CP.prototype,"_isRGBE",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bP=ae(CP.prototype,"_enabled",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RP=ae(CP.prototype,"_useIBL",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ae(CP.prototype,"enabled",[k_],Object.getOwnPropertyDescriptor(CP.prototype,"enabled"),CP.prototype),ae(CP.prototype,"useIBL",[k_],Object.getOwnPropertyDescriptor(CP.prototype,"useIBL"),CP.prototype),ae(CP.prototype,"envmap",[k_,AP],Object.getOwnPropertyDescriptor(CP.prototype,"envmap"),CP.prototype),ae(CP.prototype,"isRGBE",[k_],Object.getOwnPropertyDescriptor(CP.prototype,"isRGBE"),CP.prototype),wP=CP))||wP);s.SkyboxInfo=OR;var DR=(OP=b_("cc.FogInfo"),DP=rf(OE),MP=W_(),LP=rf(Rt),FP=Y_(),zP=Q_(),BP=J_(),UP=W_(),HP=rf(Rt),GP=Q_(),VP=J_(),kP=W_(),WP=rf(Rt),jP=Q_(),qP=J_(),YP=W_(),XP=rf(Rt),KP=X_(),QP=Q_(),ZP=J_(),JP=W_(),$P=rf(Rt),eb=Q_(),tb=J_(),nb=W_(),ib=rf(Rt),ob=Q_(),rb=J_(),OP((gb=vb=function(){function e(){re(this,"_type",cb,this),re(this,"_fogColor",lb,this),re(this,"_enabled",ub,this),re(this,"_fogDensity",hb,this),re(this,"_fogStart",_b,this),re(this,"_fogEnd",fb,this),re(this,"_fogAtten",db,this),re(this,"_fogTop",pb,this),re(this,"_fogRange",mb,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),vb.FogType=OE,cb=ae((sb=gb).prototype,"_type",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OE.LINEAR}}),lb=ae(sb.prototype,"_fogColor",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Sn("#C8C8C8")}}),ub=ae(sb.prototype,"_enabled",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hb=ae(sb.prototype,"_fogDensity",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),_b=ae(sb.prototype,"_fogStart",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),fb=ae(sb.prototype,"_fogEnd",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),db=ae(sb.prototype,"_fogAtten",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),pb=ae(sb.prototype,"_fogTop",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),mb=ae(sb.prototype,"_fogRange",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),ae(sb.prototype,"enabled",[k_],Object.getOwnPropertyDescriptor(sb.prototype,"enabled"),sb.prototype),ae(sb.prototype,"fogColor",[k_],Object.getOwnPropertyDescriptor(sb.prototype,"fogColor"),sb.prototype),ae(sb.prototype,"type",[k_,DP],Object.getOwnPropertyDescriptor(sb.prototype,"type"),sb.prototype),ae(sb.prototype,"fogDensity",[MP,LP,FP,zP,Z_,BP],Object.getOwnPropertyDescriptor(sb.prototype,"fogDensity"),sb.prototype),ae(sb.prototype,"fogStart",[UP,HP,GP,VP],Object.getOwnPropertyDescriptor(sb.prototype,"fogStart"),sb.prototype),ae(sb.prototype,"fogEnd",[kP,WP,jP,qP],Object.getOwnPropertyDescriptor(sb.prototype,"fogEnd"),sb.prototype),ae(sb.prototype,"fogAtten",[YP,XP,KP,QP,ZP],Object.getOwnPropertyDescriptor(sb.prototype,"fogAtten"),sb.prototype),ae(sb.prototype,"fogTop",[JP,$P,eb,tb],Object.getOwnPropertyDescriptor(sb.prototype,"fogTop"),sb.prototype),ae(sb.prototype,"fogRange",[nb,ib,ob,rb],Object.getOwnPropertyDescriptor(sb.prototype,"fogRange"),sb.prototype),ab=sb))||ab),MR=(yb=b_("cc.ShadowsInfo"),xb=rf(cE),Eb=W_(),Sb=rf(Rt),Tb=W_(),Ab=rf(lE),wb=W_(),Cb=rf(bt),Ib=W_(),Pb=rf(Rt),bb=W_(),Rb=rf(Nt),Nb=W_(),Ob=rf(Nt),Db=W_(),Mb=rf(Nt),Lb=W_(),Fb=rf(Rt),zb=W_(),Bb=rf(Nt),Ub=W_(),Hb=rf(Rt),Gb=W_(),Vb=rf(Rt),kb=W_(),Wb=rf(Rt),jb=W_(),qb=W_(),Yb=rf(Rt),Xb=W_(),yb((pR=function(){function e(){re(this,"_type",Zb,this),re(this,"_enabled",Jb,this),re(this,"_normal",$b,this),re(this,"_distance",eR,this),re(this,"_shadowColor",tR,this),re(this,"_autoAdapt",nR,this),re(this,"_pcf",iR,this),re(this,"_bias",oR,this),re(this,"_packing",rR,this),re(this,"_linear",aR,this),re(this,"_selfShadow",sR,this),re(this,"_normalBias",cR,this),re(this,"_near",lR,this),re(this,"_far",uR,this),re(this,"_aspect",hR,this),re(this,"_orthoSize",_R,this),re(this,"_maxReceived",fR,this),re(this,"_size",dR,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(RR),this.normal=An.transformQuat(bR,PR,RR),e.getWorldPosition(bR),this.distance=An.dot(this._normal,bR)},t.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"normal",get:function(){return this._normal},set:function(e){An.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e,this._resource&&(this._resource.bias=e)}},{key:"packing",get:function(){return this._packing},set:function(e){this._packing=e,e&&(this._linear=!this._linear&&this._linear,this._resource&&(this._resource.linear=this._linear)),this._resource&&(this._resource.packing=e,this._resource.shadowMapDirty=!0)}},{key:"linear",get:function(){return this._linear},set:function(e){this._linear=e,e&&(this._packing=!this._packing&&this._packing,this._resource&&(this._resource.packing=this._packing)),this._resource&&(this._resource.linear=e)}},{key:"selfShadow",get:function(){return this._selfShadow},set:function(e){this._selfShadow=e,this._resource&&(this._resource.selfShadow=e)}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e,this._resource&&(this._resource.normalBias=e)}},{key:"autoAdapt",get:function(){return this._autoAdapt},set:function(e){this._autoAdapt=e,this._resource&&(this._resource.autoAdapt=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._resource&&(this._resource.near=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._resource&&(this._resource.far=e)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}},{key:"shadowMapSize",get:function(){return this._size},set:function(e){this._size.set(e),this._resource&&(this._resource.size=e,this._resource.shadowMapDirty=!0)}},{key:"aspect",get:function(){return this._aspect},set:function(e){this._aspect=e,this._resource&&(this._resource.aspect=e)}}]),e}(),Zb=ae((Qb=pR).prototype,"_type",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cE.Planar}}),Jb=ae(Qb.prototype,"_enabled",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$b=ae(Qb.prototype,"_normal",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new An(0,1,0)}}),eR=ae(Qb.prototype,"_distance",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tR=ae(Qb.prototype,"_shadowColor",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Sn(0,0,0,76)}}),nR=ae(Qb.prototype,"_autoAdapt",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iR=ae(Qb.prototype,"_pcf",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lE.HARD}}),oR=ae(Qb.prototype,"_bias",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),rR=ae(Qb.prototype,"_packing",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),aR=ae(Qb.prototype,"_linear",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sR=ae(Qb.prototype,"_selfShadow",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cR=ae(Qb.prototype,"_normalBias",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lR=ae(Qb.prototype,"_near",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),uR=ae(Qb.prototype,"_far",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),hR=ae(Qb.prototype,"_aspect",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_R=ae(Qb.prototype,"_orthoSize",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),fR=ae(Qb.prototype,"_maxReceived",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),dR=ae(Qb.prototype,"_size",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kn(512,512)}}),ae(Qb.prototype,"enabled",[k_],Object.getOwnPropertyDescriptor(Qb.prototype,"enabled"),Qb.prototype),ae(Qb.prototype,"type",[k_,xb],Object.getOwnPropertyDescriptor(Qb.prototype,"type"),Qb.prototype),ae(Qb.prototype,"shadowColor",[k_],Object.getOwnPropertyDescriptor(Qb.prototype,"shadowColor"),Qb.prototype),ae(Qb.prototype,"normal",[Eb],Object.getOwnPropertyDescriptor(Qb.prototype,"normal"),Qb.prototype),ae(Qb.prototype,"distance",[Sb,Tb],Object.getOwnPropertyDescriptor(Qb.prototype,"distance"),Qb.prototype),ae(Qb.prototype,"pcf",[Ab,wb],Object.getOwnPropertyDescriptor(Qb.prototype,"pcf"),Qb.prototype),ae(Qb.prototype,"maxReceived",[Cb,Ib],Object.getOwnPropertyDescriptor(Qb.prototype,"maxReceived"),Qb.prototype),ae(Qb.prototype,"bias",[Pb,bb],Object.getOwnPropertyDescriptor(Qb.prototype,"bias"),Qb.prototype),ae(Qb.prototype,"packing",[Rb,Nb],Object.getOwnPropertyDescriptor(Qb.prototype,"packing"),Qb.prototype),ae(Qb.prototype,"linear",[Ob,Db],Object.getOwnPropertyDescriptor(Qb.prototype,"linear"),Qb.prototype),ae(Qb.prototype,"selfShadow",[Mb,Lb],Object.getOwnPropertyDescriptor(Qb.prototype,"selfShadow"),Qb.prototype),ae(Qb.prototype,"normalBias",[Fb,zb],Object.getOwnPropertyDescriptor(Qb.prototype,"normalBias"),Qb.prototype),ae(Qb.prototype,"autoAdapt",[Bb,Ub],Object.getOwnPropertyDescriptor(Qb.prototype,"autoAdapt"),Qb.prototype),ae(Qb.prototype,"near",[Hb,Gb],Object.getOwnPropertyDescriptor(Qb.prototype,"near"),Qb.prototype),ae(Qb.prototype,"far",[Vb,kb],Object.getOwnPropertyDescriptor(Qb.prototype,"far"),Qb.prototype),ae(Qb.prototype,"orthoSize",[Wb,jb],Object.getOwnPropertyDescriptor(Qb.prototype,"orthoSize"),Qb.prototype),ae(Qb.prototype,"shadowMapSize",[qb],Object.getOwnPropertyDescriptor(Qb.prototype,"shadowMapSize"),Qb.prototype),ae(Qb.prototype,"aspect",[Yb,Xb],Object.getOwnPropertyDescriptor(Qb.prototype,"aspect"),Qb.prototype),Kb=Qb))||Kb);s.ShadowsInfo=MR;var LR,FR,zR,BR,UR=(mR=b_("cc.SceneGlobals"),vR=rf(OR),mR((AR=function(){function e(){re(this,"ambient",xR,this),re(this,"shadows",ER,this),re(this,"_skybox",SR,this),re(this,"fog",TR,this)}return e.prototype.activate=function(){var e=s.director.root.pipeline.pipelineSceneData;this.ambient.activate(e.ambient),this.skybox.activate(e.skybox),this.shadows.activate(e.shadows),this.fog.activate(e.fog)},J(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),xR=ae((yR=AR).prototype,"ambient",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new NR}}),ER=ae(yR.prototype,"shadows",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new MR}}),SR=ae(yR.prototype,"_skybox",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OR}}),TR=ae(yR.prototype,"fog",[k_,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new DR}}),ae(yR.prototype,"skybox",[k_,vR],Object.getOwnPropertyDescriptor(yR.prototype,"skybox"),yR.prototype),gR=yR))||gR);s.SceneGlobals=UR;var HR=e("dN",b_("cc.Scene")((ae((FR=function(e){ee(n,e);var t=n.prototype;function n(t){var n;return re(n=e.call(this,t)||this,"autoReleaseAssets",zR,ne(n)),re(n,"_globals",BR,ne(n)),n._renderScene=null,n.dependAssets=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=An.ZERO,n._rot=Nn.IDENTITY,n._scale=An.ONE,n._mat=Un.IDENTITY,n._dirtyFlags=0,n._activeInHierarchy=!1,s.director&&s.director.root&&(n._renderScene=s.director.root.createScene({})),n._inited=!s.game||!s.game._isCloning,n}return t._updateScene=function(){this._scene=this},t.destroy=function(){var e=ri.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return s.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(M(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t);Pv(this)},t.getPosition=function(e){return An.copy(e||new An,An.ZERO)},t.getRotation=function(e){return Nn.copy(e||new Nn,Nn.IDENTITY)},t.getScale=function(e){return An.copy(e||new An,An.ONE)},t.getWorldPosition=function(e){return An.copy(e||new An,An.ZERO)},t.getWorldRotation=function(e){return Nn.copy(e||new Nn,Nn.IDENTITY)},t.getWorldScale=function(e){return An.copy(e||new An,An.ONE)},t.getWorldMatrix=function(e){return Un.copy(e||new Un,Un.IDENTITY)},t.getWorldRS=function(e){return Un.copy(e||new Un,Un.IDENTITY)},t.getWorldRT=function(e){return Un.copy(e||new Un,Un.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(this._onBatchCreated(false),this._inited=!0),this.walk(xv._setScene)},t._activate=function(e){e=!1!==e,s.director._nodeActivator.activateNode(this,e),this._globals.activate()},J(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"position",get:function(){return An.ZERO}},{key:"worldPosition",get:function(){return An.ZERO}},{key:"rotation",get:function(){return Nn.IDENTITY}},{key:"worldRotation",get:function(){return Nn.IDENTITY}},{key:"scale",get:function(){return An.ONE}},{key:"worldScale",get:function(){return An.ONE}},{key:"eulerAngles",get:function(){return An.ZERO}},{key:"worldMatrix",get:function(){return Un.IDENTITY}}]),n}(xv)).prototype,"globals",[k_],Object.getOwnPropertyDescriptor(FR.prototype,"globals"),FR.prototype),zR=ae(FR.prototype,"autoReleaseAssets",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BR=ae(FR.prototype,"_globals",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new UR}}),LR=FR))||LR);function GR(e,t){if(!t){var n=s.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}s.Scene=HR,s.find=GR;var VR=$e.fastRemoveAt,kR=ri.Flags.IsStartCalled,WR=ri.Flags.IsOnEnableCalled;function jR(e,t){for(var n=t.constructor._executionOrder,i=t._id,o=0,r=e.length-1,a=r>>>1;o<=r;a=o+r>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)r=a-1;else if(c<n)o=a+1;else{var l=s._id;if(l>i)r=a-1;else{if(!(l<i))return a;o=a+1}}}return~o}function qR(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var o=n[i];o.node._activeInHierarchy?++i:(e.removeAt(i),t&&(o._objFlags&=~t))}}ri.Flags.IsEditorOnEnableCalled;var YR=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=se;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function XR(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}YR.stableRemoveInactive=qR;var KR=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){qR(this._zero,e),qR(this._neg,e),qR(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(XR),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(XR),this._invoke(t),t.array.length=0)},t}(YR),QR=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=jR(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=jR(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(YR);function ZR(e,t,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",o=t?Function("it","dt",i):Function("it",i);return function(e,t,n){return function(i,o){try{t(i,o)}catch(t){s._throw(t);var r=i.array;for(n&&(r[i.i]._objFlags|=n),++i.i;i.i<r.length;++i.i)try{e(r[i.i],o)}catch(e){s._throw(e),n&&(r[i.i]._objFlags|=n)}}}}(Function("c","dt",e),o,n)}var JR=ZR("c.start();c._objFlags|="+kR,!1,kR),$R=ZR("c.update(dt)",!0),eN=ZR("c.lateUpdate(dt)",!0),tN=function(e){var t=s.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i))}},nN=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new KR(JR),this.updateInvoker=new QR($R),this.lateUpdateInvoker=new QR(eN),this._updating=!1},t._onEnabled=function(e){s.director.getScheduler().resumeTarget(e),e._objFlags|=WR,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){s.director.getScheduler().pauseTarget(e),e._objFlags&=~WR;var t=this._deferredComps.indexOf(e);t>=0?VR(this._deferredComps,t):(!e.start||e._objFlags&kR||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&WR)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&WR&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&kR||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),iN=ri.Flags.IsPreloadStarted,oN=ri.Flags.IsOnLoadStarted,rN=ri.Flags.IsOnLoadCalled,aN=ri.Flags.Deactivating,sN=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){YR.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(YR),cN=ZR("c.__preload();"),lN=ZR("c.onLoad();c._objFlags|="+rN,!1,rN),uN=new Je(4);function hN(e,t,n){t?e._removeComponent(t):$e.removeAt(e._components,n)}uN.get=function(){var e=this._get()||{preload:new sN(cN),onLoad:new KR(lN),onEnable:new KR(tN)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var _N,fN,dN,pN,mN,vN,gN,yN,xN=e("fz",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=uN.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),uN.put(n)}else{this._deactivateNodeRecursively(e);for(var i,o=oe(this._activatingStack);!(i=o()).done;){var r=i.value;r.preload.cancelInactive(iN),r.onLoad.cancelInactive(oN),r.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)},t.activateComp=function(e,t,n,i){if(si(e,!0)&&(e._objFlags&iN||(e._objFlags|=iN,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&oN||(e._objFlags|=oN,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=rN):e._objFlags|=rN),e._enabled)){if(!e.node._activeInHierarchy)return;s.director._compScheduler.enableComp(e,i)}},t.destroyComp=function(e){s.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&rN&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,i){if(e._objFlags&aN)R(3816,e.name);else{e._activeInHierarchy=!0;for(var o=e._components.length,r=0;r<o;++r){var a=e._components[r];a instanceof s.Component?this.activateComp(a,t,n,i):(hN(e,a,r),--r,--o)}e._childArrivalOrder=e._children.length;for(var c=0,l=e._children.length;c<l;++c){var u=e._children[c];u._active&&this._activateNodeRecursively(u,t,n,i)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=aN,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(s.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~aN)}for(var o=0,r=e._children.length;o<r;++o){var a=e._children[o];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),e._activeInHierarchy))return void(e._objFlags&=~aN)}e._onPostActivated(!1),e._objFlags&=~aN},e}()),EN=e("eN",b_("cc.SceneAsset")((pN=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"scene",dN,ne(t)),t}ee(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new HR("New Scene")},n.validate=function(){return!!this.scene},t}(zf),dN=ae((fN=pN).prototype,"scene",[k_,M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_N=fN))||_N);s.SceneAsset=EN;var SN,TN,AN,wN,CN=e("eO",b_("cc.TextAsset")((yN=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"text",gN,ne(t)),t}return ee(t,e),t.prototype.toString=function(){return this.text},t}(zf),gN=ae((vN=yN).prototype,"text",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mN=vN))||mN);s.TextAsset=CN;var IN=e("eP",b_("cc.JsonAsset")((wN=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"json",AN,ne(t)),t}return ee(t,e),t}(zf),AN=ae((TN=wN).prototype,"json",[M_,k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SN=TN))||SN);s.JsonAsset=IN;var PN=e("cY",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._purgeDirectorInNextLoop=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._lastUpdate=void 0,t._deltaTime=void 0,t._startTime=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._purgeDirectorInNextLoop=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._lastUpdate=0,t._deltaTime=0,t._startTime=0,t._scheduler=new mI,t._compScheduler=new nN,t._nodeActivator=new xN,t._systems=[],s.game.once(Xw.EVENT_RENDERER_INITED,t._initOnRendererInitialized,ne(t)),t}ee(t,e);var n=t.prototype;return n.calculateDeltaTime=function(e){e||(e=performance.now()),this._deltaTime=e>this._lastUpdate?(e-this._lastUpdate)/1e3:0,this._lastUpdate=e},n.convertToGL=function(e){var t=s.game.container,n=s.view,i=t.getBoundingClientRect(),o=i.left+window.pageXOffset-t.clientLeft,r=i.top+window.pageYOffset-t.clientTop,a=n._devicePixelRatio*(e.x-o),c=n._devicePixelRatio*(r+i.height-e.y);return n._isRotated?qn(n._viewportRect.width-c,a):qn(a,c)},n.convertToUI=function(e){var t=s.game.container,n=s.view,i=t.getBoundingClientRect(),o=i.left+window.pageXOffset-t.clientLeft,r=i.top+window.pageYOffset-t.clientTop,a=qn(0,0);return n._isRotated?(a.x=o+e.y/n._devicePixelRatio,a.y=r+i.height-(n._viewportRect.width-e.x)/n._devicePixelRatio):(a.x=o+e.x*n._devicePixelRatio,a.y=r+i.height-e.y*n._devicePixelRatio),a},n.end=function(){this._purgeDirectorInNextLoop=!0},n.getWinSize=function(){return Zn(s.winSize)},n.getWinSizeInPixels=function(){return Zn(s.winSize)},n.pause=function(){this._paused||(this._paused=!0)},n.purgeCachedData=function(){s.assetManager.releaseAll()},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),Xm&&Xm.setEnabled(!1),s.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),s.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),Xm&&Xm.setEnabled(!0),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof EN&&(e=e.scene),D(e instanceof HR,1216),e._load();for(var i=Object.keys(s.game._persistRootNodes).map((function(e){return s.game._persistRootNodes[e]})),o=0;o<i.length;o++){var r=i[o];r.emit(s.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var a=e.uuid===r._originalSceneId&&e.getChildByUuid(r.uuid);if(a){var c=a.getSiblingIndex();a._destroyImmediate(),e.insertChild(r,c)}else r.parent=e}var l=this._scene;s.isValid(l)&&l.destroy(),s.assetManager._releaseManager._autoRelease(l,e,s.game._persistRootNodes),this._scene=null,ri._deferredDestroy(),t&&t(),this.emit(s.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(s.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var i=this;e instanceof EN&&(e=e.scene),D(e,1205),D(e instanceof HR,1216),e._load(),this.once(s.Director.EVENT_AFTER_DRAW,(function(){i.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var i=this;if(this._loadingScene)return P(1208,e,this._loadingScene),!1;var o=s.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return o?(this.emit(s.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),o.loadScene(e,(function(o,r){console.timeEnd("LoadScene "+e),i._loadingScene="",o?(y(o),t&&t(o)):i.runSceneImmediate(r,n,t)})),!0):(R(1209,e),!1)},n.preloadScene=function(e,t,n){var i=s.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(i)i.preloadScene(e,null,t,n);else{var o='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(o)),y("preloadScene: "+o)}},n.resume=function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||C(1200),this._paused=!1,this._deltaTime=0)},n.setDepthTest=function(e){s.Camera.main&&(s.Camera.main.depth=!!e)},n.setClearColor=function(e){s.Camera.main&&(s.Camera.main.backgroundColor=e)},n.getRunningScene=function(){return this._scene},n.getScene=function(){return this._scene},n.getAnimationInterval=function(){return 1e3/s.game.getFrameRate()},n.setAnimationInterval=function(e){s.game.setFrameRate(Math.round(1e3/e))},n.getDeltaTime=function(){return this._deltaTime},n.getTotalTime=function(){return performance.now()-this._startTime},n.getCurrentTime=function(){return this._lastUpdate},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(mI.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(uI.sortByPriority)},n.unregisterSystem=function(e){$e.fastRemove(this._systems,e),this._systems.sort(uI.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(s.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1,this._lastUpdate=performance.now()},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this._invalid){this.calculateDeltaTime(e),this.emit(t.EVENT_BEGIN_FRAME);var n=this._deltaTime;if(!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(n);for(var i=0;i<this._systems.length;++i)this._systems[i].update(n);this._compScheduler.lateUpdatePhase(n),this.emit(t.EVENT_AFTER_UPDATE),ri._deferredDestroy();for(var o=0;o<this._systems.length;++o)this._systems[o].postUpdate(n)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this.emit(t.EVENT_AFTER_DRAW),Xm.frameUpdateListeners(),$g.clearBooks(),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._startTime=this._lastUpdate,this._paused=!1,this._purgeDirectorInNextLoop=!1,Xm&&Xm.setEnabled(!0),this.registerSystem(mI.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new gI(s.game._gfxDevice),this._root.initialize({}).catch((function(e){return R(1217),Promise.reject(e)}))},J(t,[{key:"root",get:function(){return this._root}}]),t}(Ti));PN.EVENT_INIT="director_init",PN.EVENT_RESET="director_reset",PN.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",PN.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",PN.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",PN.EVENT_BEFORE_UPDATE="director_before_update",PN.EVENT_AFTER_UPDATE="director_after_update",PN.EVENT_BEFORE_DRAW="director_before_draw",PN.EVENT_AFTER_DRAW="director_after_draw",PN.EVENT_BEFORE_COMMIT="director_before_commit",PN.EVENT_BEFORE_PHYSICS="director_before_physics",PN.EVENT_AFTER_PHYSICS="director_after_physics",PN.EVENT_BEGIN_FRAME="director_begin_frame",PN.EVENT_END_FRAME="director_end_frame",PN.instance=void 0,s.Director=PN;var bN=e("cX",PN.instance=s.director=new PN),RN=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new sf,this.scenes=new sf,this.paths=new sf}var t=e.prototype;return t.init=function(e){!function(e){var t=e.uuids,n=e.paths,i=e.types,o=e.deps,r=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,s=t.length;a<s;a++)t[a]=Af(t[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=t.length;_<f;_++){var d=t[_];t[_]=h[d]=Af(d)}t=h}for(var p in n){var m=n[p];r[t[p]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var x=e.packs;for(var E in x)for(var S=x[E],T=0;T<S.length;++T)S[T]=t[S[T]];var A=e.versions;if(A)for(var w in A)for(var C=A[w],I=0;I<C.length;I+=2){var P=C[I];C[I]=t[P]||P}var b=e.redirect;if(b)for(var R=0;R<b.length;R+=2)b[R]=t[b[R]],b[R+1]=o[b[R+1]]}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect)},t.getInfoWithPath=function(e,t){if(!e)return null;e=bf(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,o=n.length;i<o;i++){var r=n[i];if(et.isChildClassOf(r.ctor,t))return r}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=bf(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,o){if(o.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(o,e)||!e)for(var r=0,a=n.length;r<a;r++){var s=n[r];t&&!et.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],o=i[0],r=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=o,s.ctor=et._getClassById(r),t.has(o)?a?t.get(o).push(s):t.get(o).splice(0,0,s):t.add(o,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var o=e[i],r=n.get(o);r.url=i,t.add(i,r)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],o={uuid:n,packedUuids:i,ext:".json"};t.add(n,o);for(var r=0,a=i.length;r<a;r++){var s=i[r],c=t.get(s),l=c.packs;l?1===a?l.splice(0,0,o):l.push(o):c.packs=[o]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,o=n.length;i<o;i+=2){var r=n[i];t.get(r).ver=n[i+1]}if(n=e.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];t.get(c).nativeVer=n[a+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var o=e[n];t.get(o).redirect=e[n+1]}},e}();function NN(e,t){e._uuid&&t.push(e._uuid)}function ON(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var o=n[i];if("node"!==o&&"__eventTargets"!==o){var r=e[o];if("object"==typeof r&&r)if(Array.isArray(r))for(var a=0;a<r.length;a++){var s=r[a];s instanceof zf&&NN(s,t)}else if(r.constructor&&r.constructor!==Object)r instanceof zf&&NN(r,t);else for(var c=Object.getOwnPropertyNames(r),l=0;l<c.length;l++){var u=r[c[l]];u instanceof zf&&NN(u,t)}}}}function DN(e,t){for(var n=0;n<e._components.length;n++)ON(e._components[n],t);for(var i=0;i<e._children.length;i++)DN(e._children[i],t)}function MN(e,t,n,i){n.push(e._uuid);for(var o=cp.getDeps(e._uuid),r=0,a=o.length;r<a;r++){var s=uf.get(o[r]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||MN(s,t,n,i)}}}var LN=[],FN=new(function(){function e(){this._persistNodeDeps=new sf,this._toDelete=new sf,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];DN(e,t);for(var n=0,i=t.length;n<i;n++){var o=uf.get(t[n]);o&&o.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var o=uf.get(t[n]);o&&o.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=cp.getDeps(e.uuid),o=0,r=i.length;o<r;o++){var a=uf.get(i[o]);a&&a.decRef(e.autoReleaseAssets)}var s=cp._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=uf.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&cp.remove(e.uuid)}var _=cp._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var d,p,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=oe(v);!(p=g()).done;){var y=p.value,x=uf.get(y);x&&x.addRef()}_&&(d=_.persistDeps).push.apply(d,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof zf&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,vt(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),si(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,MN(e,t,LN,-1),LN.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&MN(uf.get(n),t,LN,1);return LN.length=0,t[e._uuid]}(e)>0)){uf.remove(n);for(var i=cp.getDeps(n),o=0,r=i.length;o<r;o++){var a=uf.get(i[o]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),cp.remove(n)}},e}()),zN=null;function BN(e,t){for(var n=0,i=e.input.length;n<i;n++){var o=e.input[n];t&&!o.isNative&&o.content instanceof zf&&o.content.decRef(!1),o.recycle()}e.input=null}function UN(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function HN(e,t,n,i,o){void 0===o&&(o=0),e(o,(function(r,a){o++,!r||o>t?i&&i(r,a):setTimeout((function(){HN(e,t,n,i,o)}),n)}))}function GN(e,t,n,i,o){try{for(var r=cp.parse(e,t),a=0,s=r.deps.length;a<s;a++){var c=r.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:o&&o.name}))}r.nativeDep&&(o&&(r.nativeDep.bundle=o.name),i.push($({},r.nativeDep)))}catch(e){y(e.message,e.stack)}}function VN(e,t,n){t&&(n=void 0!==n?n:s.assetManager.cacheAsset,Pf(t)||!n||t.isDefault||uf.add(e,t))}function kN(e,t,n){var i=0,o=[],r=e.length;0===r&&n&&n(o);for(var a=function(e){e&&o.push(e),++i===r&&n&&n(o)},s=0;s<r;s++)t(e[s],a)}function WN(e,t,n){var i=e,o=t,r=n;if(void 0===n){var a="function"==typeof e;t?(r=t,a||(o=null)):void 0===t&&a&&(r=e,i=null,o=null),void 0!==t&&a&&(o=e,i=null)}return{options:i||Object.create(null),onProgress:o,onComplete:r}}function jN(e,t,n){var i=e,o=t,r=n;if(void 0===n){var a=et.isChildClassOf(e,zf);t?(r=t,a&&(o=null)):void 0!==t||a||(r=e,o=null,i=null),void 0===t||a||(o=e,i=null)}return{type:i,onProgress:o||zN,onComplete:r}}function qN(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var o=!1,r=cp.getDeps(t);if(r)for(var a=0,s=r.length;a<s;a++){var c=r[a];if(c===e||qN(e,c,n,i)){o=!0;break}}return o}function YN(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof zf&&i.push(e.addRef())})):n instanceof zf&&i.push(n.addRef()),vt((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var XN=function(){function e(){this._config=new RN}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),ff.add(e.name,this)},t.load=function(e,t,n,i){var o=jN(t,n,i),r=o.type,a=o.onProgress,c=o.onComplete,l={__requestType__:lf.PATH,type:r,bundle:this.name,__outputAsArray__:Array.isArray(e)};s.assetManager.loadAny(e,l,a,c)},t.preload=function(e,t,n,i){var o=jN(t,n,i),r=o.type,a=o.onProgress,c=o.onComplete;s.assetManager.preloadAny(e,{__requestType__:lf.PATH,type:r,bundle:this.name},a,c)},t.loadDir=function(e,t,n,i){var o=jN(t,n,i),r=o.type,a=o.onProgress,c=o.onComplete;s.assetManager.loadAny(e,{__requestType__:lf.DIR,type:r,bundle:this.name,__outputAsArray__:!0},a,c)},t.preloadDir=function(e,t,n,i){var o=jN(t,n,i),r=o.type,a=o.onProgress,c=o.onComplete;s.assetManager.preloadAny(e,{__requestType__:lf.DIR,type:r,bundle:this.name},a,c)},t.loadScene=function(e,t,n,i){var o=WN(t,n,i),r=o.options,a=o.onProgress,c=o.onComplete;r.preset=r.preset||"scene",r.bundle=this.name,s.assetManager.loadAny({scene:e},r,a,(function(e,t){if(e)y(e.message,e.stack);else if(t instanceof EN&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");c&&c(e,t)}))},t.preloadScene=function(e,t,n,i){var o=WN(t,n,i),r=o.options,a=o.onProgress,c=o.onComplete;r.bundle=this.name,s.assetManager.preloadAny({scene:e},r,a,(function(t){t&&R(1210,e,t.message),c&&c(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&uf.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&FN.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;uf.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&FN.tryRelease(t)}))},t.releaseAll=function(){var e=this;uf.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&FN.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},J(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),KN=e("ft",new XN);function QN(e,t,n){var i=new Image;function o(){i.removeEventListener("load",o),i.removeEventListener("error",r),n&&n(null,i)}function r(){i.removeEventListener("load",o),i.removeEventListener("error",r),n&&n(new Error(M(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",o),i.addEventListener("error",r),i.src=e,i}function ZN(e,t,n,i){var o=new XMLHttpRequest,r="download failed: "+e+", status: ";if(o.open("GET",e,!0),void 0!==t.xhrResponseType&&(o.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(o.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&o.overrideMimeType&&o.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(o.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)o.setRequestHeader(a,t.xhrHeader[a]);return o.onload=function(){200===o.status||0===o.status?i&&i(null,o.response):i&&i(new Error(""+r+o.status+"(no response)"))},n&&(o.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),o.onerror=function(){i&&i(new Error(""+r+o.status+"(error)"))},o.ontimeout=function(){i&&i(new Error(""+r+o.status+"(time out)"))},o.onabort=function(){i&&i(new Error(""+r+o.status+"(abort)"))},o.send(null),o}s.resources=KN;var JN={};function $N(e,t,n){if(JN[e])return n&&n(null),null;var i=document.createElement("script");function o(){i.parentNode.removeChild(i),i.removeEventListener("load",o,!1),i.removeEventListener("error",r,!1),JN[e]=!0,n&&n(null)}function r(){i.parentNode.removeChild(i),i.removeEventListener("load",o,!1),i.removeEventListener("error",r,!1),n&&n(new Error(M(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",o,!1),i.addEventListener("error",r,!1),document.body.appendChild(i),i}var eO=/^(?:\w+:\/\/|\.+\/).+/,tO=function(e,t,n){(ux.capabilities.imageBitmap&&s.assetManager.allowImageBitmap?nO:QN)(e,t,n)},nO=function(e,t,n){t.xhrResponseType="blob",ZN(e,t,t.onFileProgress,n)},iO=function(e,t,n){t.xhrResponseType="json",ZN(e,t,t.onFileProgress,n)},oO=function(e,t,n){t.xhrResponseType="arraybuffer",ZN(e,t,t.onFileProgress,n)},rO=function(e,t,n){t.xhrResponseType="text",ZN(e,t,t.onFileProgress,n)},aO=function(e,t,n){var i=Oi(e),o=e;eO.test(o)||(o=-1!==cO.remoteBundles.indexOf(i)?cO.remoteServerAddress+"remote/"+i:"assets/"+i);var r=t.version||cO.bundleVers[i],a=0,s=null,c=null;iO(o+"/config."+(r?r+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=o+"/"),2==++a&&n(c,s)})),$N(o+"/index."+(r?r+".":"")+"js",t,(function(e){c=e,2==++a&&n(e,s)}))},sO=function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=QN,this.downloadDomAudio=null,this.downloadFile=ZN,this.downloadScript=$N,this._downloaders={".png":tO,".jpg":tO,".bmp":tO,".jpeg":tO,".gif":tO,".ico":tO,".tiff":tO,".webp":tO,".image":tO,".pvr":oO,".pkm":oO,".astc":oO,".txt":rO,".xml":rO,".vsh":rO,".fsh":rO,".atlas":rO,".tmx":rO,".tsx":rO,".json":iO,".ExportJson":iO,".plist":rO,".fnt":rO,".binary":oO,".bin":oO,".dbbin":oO,".skel":oO,".js":$N,bundle:aO,default:rO},this._downloading=new sf,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?Fe(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,o){var r=this,a=hf.get(e);if(a)o(null,a);else{var s=this._downloading.get(e);if(s){s.push(o);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;HN((function(n,a){if(0===n&&r._downloading.add(e,[o]),r.limited){r._updateTime();var s=function(e,t){r._totalNum--,r._handleQueueInNextFrame(h,_),a(e,t)};r._totalNum<h&&r._totalNumThisPeriod<_?(f(UN(t,r.appendTimeStamp),i,s),r._totalNum++,r._totalNumThisPeriod++):(r._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:f}),r._queueDirty=!0,r._totalNum<h&&r._handleQueueInNextFrame(h,_))}else f(UN(t,r.appendTimeStamp),i,a)}),u,this.retryInterval,(function(t,n){t||hf.add(e,n);for(var i=r._downloading.remove(e),o=0,a=i.length;o<a;o++)i[o](t,n)}))}}},t.loadSubpackage=function(e,t){s.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=Date.now(),t=s.director.getDeltaTime(),n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(UN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(vt(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},J(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}(),cO=e("dz",new sO);function lO(e,t,n,i){var o=null,r=null;try{(o=new Xf)._nativeUrl=e,o._nativeAsset=t}catch(e){r=e}i(r,o)}function uO(e,t,n,i){var o=new IN;o.json=t,i(null,o)}function hO(e,t,n,i){var o=new CN;o.text=t,i(null,o)}function _O(e,t,n,i){var o=new YI;o._nativeUrl=e,o._nativeAsset=t,i(null,o)}function fO(e,t,n,i){var o=new zf;o._nativeUrl=e,o._nativeAsset=t,i(null,o)}function dO(e,n,i,o){var r=ff.get(n.name);r||(r=n.name===vf.RESOURCES?KN:new XN,n.base=n.base||e+"/",r.init(n)),t.import("virtual:///prerequisite-imports/"+r.name).then((function(){o(null,r)})).catch(o)}var pO=function(){function e(){this._creating=new sf,this._producers={".png":lO,".jpg":lO,".bmp":lO,".jpeg":lO,".gif":lO,".ico":lO,".tiff":lO,".webp":lO,".image":lO,".pvr":lO,".pkm":lO,".txt":hO,".xml":hO,".vsh":hO,".fsh":hO,".atlas":hO,".tmx":hO,".tsx":hO,".fnt":hO,".json":uO,".ExportJson":uO,".binary":_O,".bin":_O,".dbbin":_O,".skel":_O,bundle:dO,default:fO}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?et.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,o){var r=this,a=this._producers[n]||this._producers.default,s=uf.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(o):(this._creating.add(e,[o]),a(e,t,i,(function(t,n){!t&&n instanceof zf&&(n._uuid=e,VN(e,n,i.cacheAsset));for(var o=r._creating.remove(e),a=0,s=o.length;a<s;a++)o[a](t,n)})))}else o(null,s)},e}(),mO=e("dA",new pO),vO=new(function(){function e(){this._loading=new sf,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var o=et.createMap(!0),r=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(M(5304,e[0]));bd(e,!0,void 0),Rd(e);for(var t=new Ld(e[0]),n=e[1],i=e[2],o=e[3],r=e[4],a=e[5],s=0;s<a.length;++s)a[s].unshift(t,n,i,o,r);return a}(t)).length!==e.length&&R(4915);for(var a=0;a<e.length;a++)o[e[a]+"@import"]=t[a]}else{var s=et._getClassId(Ap),c=et._getClassId(Xf);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&R(4915);for(var u=0;u<e.length;u++)o[e[u]+"@import"]=Fd(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&R(4915);for(var _=0;_<e.length;_++)o[e[_]+"@import"]=h[_]}else r=new Error("unmatched type pack!"),o=null}i(r,o)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?et.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,o){t?(0,this._unpackers[n])(e,t,i,o):o(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(hf.has(e.id))n(null,hf.get(e.id));else{var o=e.info.packs,r=o.find((function(e){return i._loading.has(e.uuid)}));if(r)this._loading.get(r.uuid).push({onComplete:n,id:e.id});else{r=o[0],this._loading.add(r.uuid,[{onComplete:n,id:e.id}]);var a=Rf(r.uuid,{ext:r.ext,bundle:e.config.name});cO.download(r.uuid,a,r.ext,e.options,(function(t,n){hf.remove(r.uuid),t&&y(t.message,t.stack),i.unpack(r.packedUuids,n,r.ext,e.options,(function(e,n){if(!e)for(var o in n)hf.add(o,n[o]);for(var a=i._loading.remove(r.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else cO.download(e.id,e.url,e.ext,e.options,n)},e}());function gO(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,o=e.progress,r=[],a=o.total,c=i.__exclude__=i.__exclude__||Object.create(null);e.output=[],kN(e.input,(function(i,l){if(!i.isNative&&uf.has(i.uuid)){var u=uf.get(i.uuid);return i.content=u.addRef(),e.output.push(i),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,i),void l()}vO.load(i,e.options,(function(u,h){u?e.isFinish||(!s.assetManager.force||n?(y(u.message,u.stack),o.canInvoke=!1,t(u)):(e.output.push(i),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,i))):e.isFinish||(i.file=h,e.output.push(i),i.isNative||(c[i.uuid]=!0,GN(i.uuid,h,c,r,i.config),o.total=a+r.length),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,i)),l()}))}),(function(){if(e.isFinish)return BN(e,!0),void e.dispatch("error");if(r.length>0){var a=yf.create({input:r,progress:o,options:i,onProgress:e.onProgress,onError:yf.prototype.recycle,onComplete:function(i){var o;i||((o=e.output).push.apply(o,a.output),a.recycle()),n&&yO(e),t(i)}});pf.async(a)}else n&&yO(e),t()}))}function yO(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var xO=new(function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return P(5100),{};for(var n=null,i=0,o=t.childNodes.length;i<o&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var o=e.childNodes[n];1===o.nodeType&&t.push(this._parseNode(o))}return t},n._parseDict=function(e){for(var t={},n="",i=0,o=e.childNodes.length;i<o;i++){var r=e.childNodes[i];1===r.nodeType&&("key"===r.tagName?n=r.firstChild.nodeValue:t[n]=this._parseNode(r))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function EO(e,t){return e[t]<<8|e[t+1]}var SO=new(function(){function e(){this._parsing=new sf,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".mp3":this.parseAudio,".ogg":this.parseAudio,".wav":this.parseAudio,".m4a":this.parseAudio,".plist":this.parsePlist,import:this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parseAudio=function(e,t,n){e instanceof ArrayBuffer?ux.__audioSupport.context.decodeAudioData(e,(function(e){n(null,e)}),(function(e){n(new Error("Error with decoding audio data"+e.err),null)})):n(null,e)},t.parsePVRTex=function(e,t,n){var i=null,o=null;try{var r=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(r,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;o={_data:new Uint8Array(r,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];o={_data:new Uint8Array(r,u),_compressed:!0,width:_,height:h,format:0}}}catch(e){i=e}n(i,o)},t.parsePKMTex=function(e,t,n){var i=null,o=null;try{var r=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(r),s=EO(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=EO(a,12),l=EO(a,14);EO(a,8),EO(a,10),o={_data:new Uint8Array(r,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,o)},t.parseASTCTex=function(e,t,n){var i=null,o=null;try{var r=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(r);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?Bf.RGBA_ASTC_4x4:5===e?4===t?Bf.RGBA_ASTC_5x4:Bf.RGBA_ASTC_5x5:6===e?5===t?Bf.RGBA_ASTC_6x5:Bf.RGBA_ASTC_6x6:8===e?5===t?Bf.RGBA_ASTC_8x5:6===t?Bf.RGBA_ASTC_8x6:Bf.RGBA_ASTC_8x8:10===e?5===t?Bf.RGBA_ASTC_10x5:6===t?Bf.RGBA_ASTC_10x6:8===t?Bf.RGBA_ASTC_10x8:Bf.RGBA_ASTC_10x10:10===t?Bf.RGBA_ASTC_12x10:Bf.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],o={_data:new Uint8Array(r,16),_compressed:!0,width:h,height:_,format:u}}catch(e){i=e}n(i,o)},t.parsePlist=function(e,t,n){var i=null,o=xO.parse(e);o||(i=new Error("parse failed")),n(i,o)},t.parseImport=function(e,t,n){if(e){var i=null,o=null;try{i=ap(e,t)}catch(e){o=e}n(o,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?Fe(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,o){var r=this,a=_f.get(e);if(a)o(null,a);else{var s=this._parsing.get(e);if(s)s.push(o);else{var c=this._parsers[n];c?(this._parsing.add(e,[o]),c(t,i,(function(t,n){t?hf.remove(e):Pf(n)||_f.add(e,n);for(var i=r._parsing.remove(e),o=0,a=i.length;o<a;o++)i[o](t,n)}))):o(null,t)}}},e}());function TO(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,o=e.progress;i.__exclude__=i.__exclude__||Object.create(null),e.output=[],kN(e.input,(function(r,a){var c=yf.create({input:r,onProgress:e.onProgress,options:i,progress:o,onComplete:function(i,l){i&&!e.isFinish&&(!s.assetManager.force||n?(y(i.message,i.stack),o.canInvoke=!1,t(i)):o.canInvoke&&e.dispatch("progress",++o.finish,o.total,r)),e.output.push(l),c.recycle(),a(null)}});AO.async(c)}),(function(){if(i.__exclude__=null,e.isFinish)return BN(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,o=t.length;i<o;i++)n.push(t[i].content);else e.output=t[0].content}(e),BN(e,!0),t()}))}var AO=new cf("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,o=n.isNative,r=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!o&&uf.has(r)?t():vO.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,o=e.options.__exclude__,r=n.id,a=n.file,s=n.options;if(n.isNative)SO.parse(r,a,n.ext,s,(function(o,a){o?t(o):(n.content=a,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),hf.remove(r),_f.remove(r),t())}));else{var c=n.uuid;if(c in o){var l=o[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||qN(c,c,o)?(h&&h.addRef(),n.content=h,t(_)):f.push({done:t,item:n})}else if(!s.reloadAsset&&uf.has(c)){var d=uf.get(c);n.content=d.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,SO.parse(r,a,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,o=e.progress,r=i,a=r.uuid,s=r.id,c=r.options,l=r.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),GN(a,t,Object.create(null),h,l),o.canInvoke&&e.dispatch("progress",++o.finish,o.total+=h.length,i);var _=e.options.__exclude__[a]={content:t,finish:!1,callbacks:[{done:n,item:i}]},f=yf.create({input:h,options:e.options,onProgress:e.onProgress,onError:yf.prototype.recycle,progress:o,onComplete:function(e){if(t.decRef&&t.decRef(!1),_.finish=!0,_.err=e,!e){for(var n,i=Array.isArray(f.output)?f.output:[f.output],o=Object.create(null),r=oe(i);!(n=r()).done;){var c=n.value;c&&(o[c instanceof zf?c._uuid+"@import":a+"@native"]=c)}!function(e,t,n){var i=t.__depends__;if(i){for(var o=0,r=i.length;o<r;o++){var a=i[o],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(y("The asset "+a.uuid+" is missing!"),a.type&&a.type!==zf){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}t.__depends__=null}t.__nativeDepend__&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),t.__nativeDepend__=!1)}(a,t,o);try{"function"!=typeof t.onLoaded||t.__onLoadedInvoked__||t.__nativeDepend__||(t.onLoaded(),t.__onLoadedInvoked__=!0)}catch(e){y("The asset "+a+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}hf.remove(s),_f.remove(s),VN(a,t,u),f.recycle()}for(var l=_.callbacks,h=0,d=l.length;h<d;h++){var p=l[h];t.addRef&&t.addRef(),p.item.content=t,p.done(e)}l.length=0}});df.async(f)}(e,i,t)}))}}]);function wO(e,t){var n=e.options,i=Object.create(null),o=Object.create(null);for(var r in n)switch(r){case lf.PATH:case lf.UUID:case lf.DIR:case lf.SCENE:case lf.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[r]=n[r];break;case"__exclude__":case"__outputAsArray__":o[r]=n[r];break;default:i[r]=n[r],o[r]=n[r]}e.options=o;var a=yf.create({input:e.input,options:i}),s=null;try{e.output=e.source=mf.sync(a)}catch(e){s=e;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),t(s)}var CO=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},J(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();CO.MAX_DEAD_NUM=500,CO._deadPool=[];var IO=[];function PO(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var o=n[i],r=CO.create(),a=null,s=null;if("string"==typeof o&&((o=Object.create(null))[t.__requestType__||lf.UUID]=n[i]),"object"==typeof o)for(var c in Le(o,t),o.preset&&Le(o,gf[o.preset]),o){switch(c){case lf.UUID:if("break"===function(){var e=r.uuid=Af(o.uuid);if(!o.bundle){var t=ff.find((function(t){return!!t.getAssetInfo(e)}));o.bundle=t&&t.name}if(ff.has(o.bundle)){if(a=ff.get(o.bundle).config,(s=a.getAssetInfo(e))&&s.redirect){if(!ff.has(s.redirect))throw new Error("Please load bundle "+s.redirect+" first");a=ff.get(s.redirect).config,s=a.getAssetInfo(e)}r.config=a,r.info=s}return r.ext=o.ext||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case lf.DIR:if(ff.has(o.bundle)){ff.get(o.bundle).config.getDirWithPath(o.dir,o.type,IO);for(var l,u=oe(IO);!(l=u()).done;){var h=l.value;n.push({uuid:h.uuid,__isNative__:!1,ext:".json",bundle:o.bundle})}IO.length=0}r.recycle(),r=null;break;case lf.PATH:if(ff.has(o.bundle)){if(a=ff.get(o.bundle).config,(s=a.getInfoWithPath(o.path,o.type))&&s.redirect){if(!ff.has(s.redirect))throw new Error("you need to load bundle "+s.redirect+" first");a=ff.get(s.redirect).config,s=a.getAssetInfo(s.uuid)}if(!s)throw r.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);r.config=a,r.uuid=s.uuid,r.info=s}r.ext=o.ext||".json";break;case lf.SCENE:if(!o.bundle){var _=ff.find((function(e){return!!e.getSceneInfo(o.scene)}));o.bundle=_&&_.name}if(ff.has(o.bundle)){if(a=ff.get(o.bundle).config,(s=a.getSceneInfo(o.scene))&&s.redirect){if(!ff.has(s.redirect))throw new Error("you need to load bundle "+s.redirect+" first");a=ff.get(s.redirect).config,s=a.getAssetInfo(s.uuid)}if(!s)throw r.recycle(),new Error("Bundle "+a.name+" doesn't contain scene "+o.scene);r.config=a,r.uuid=s.uuid,r.info=s}break;case"__isNative__":r.isNative=o.__isNative__;break;case lf.URL:r.url=o.url,r.uuid=o.uuid||o.url,r.ext=o.ext||Ri(o.url),r.isNative=void 0===o.__isNative__||o.__isNative__;break;default:r.options[c]=o[c]}if(!r)break}if(!r)return"continue";if(e.output.push(r),!r.uuid&&!r.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},o=0;o<n.length;o++)i(o);return null}function bO(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var i=t[n];if(!i.url){var o,r,a=i.config;r=i.isNative?a&&a.nativeBase?a.base+a.nativeBase:s.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:s.assetManager.generalImportBase;var c=i.uuid,l="";i.info&&(l=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),o=".ttf"===i.ext?r+"/"+c.slice(0,2)+"/"+c+l+"/"+i.options.__nativeName__:r+"/"+c.slice(0,2)+"/"+c+l+i.ext,i.url=o}}return null}var RO=e("fs",function(){function e(){this.pipeline=df.append(wO).append(TO),this.fetchPipeline=pf.append(wO).append(gO),this.transformPipeline=mf.append(PO).append(bO),this.bundles=ff,this.assets=uf,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=cp,this.force=!1,this.allowImageBitmap=!ux.isMobile,this.utils=Lf,this.downloader=cO,this.parser=SO,this.packManager=vO,this.cacheAsset=!0,this.cacheManager=null,this.presets=gf,this.factory=mO,this.preprocessPipe=wO,this.fetchPipe=gO,this.loadPipe=TO,this.references=null,this._releaseManager=FN,this._files=hf,this._parsed=_f,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return ff.get(e)||null},t.removeBundle=function(e){e._destroy(),ff.remove(e.name)},t.loadAny=function(e,t,n,i){var o=WN(t,n,i),r=o.options,a=o.onProgress,s=o.onComplete;r.preset=r.preset||"default",e=Array.isArray(e)?e.slice():e;var c=yf.create({input:e,onProgress:a,onComplete:YN(s),options:r});df.async(c)},t.preloadAny=function(e,t,n,i){var o=WN(t,n,i),r=o.options,a=o.onProgress,s=o.onComplete;r.preset=r.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=yf.create({input:e,onProgress:a,onComplete:YN(s),options:r});pf.async(c)},t.postLoadNative=function(e,t,n){var i=WN(t,void 0,n),o=i.options,r=i.onComplete;if(e._native&&e.__nativeDepend__){var a=cp.getNativeDep(e._uuid);if(a){if(!ff.has(a.bundle)){var s=ff.find((function(t){return!!t.getAssetInfo(e._uuid)}));s&&(a.bundle=s.name)}this.loadAny(a,o,(function(t,n){t?y(t.message,t.stack):e.isValid&&e.__nativeDepend__&&(e._nativeAsset=n,e.__nativeDepend__=!1),r&&r(t)}))}}else YN(r)(null)},t.loadRemote=function(e,t,n){var i=WN(t,void 0,n),o=i.options,r=i.onComplete;o.reloadAsset||!this.assets.has(e)?(o.__isNative__=!0,o.preset=o.preset||"remote",this.loadAny({url:e},o,null,(function(t,n){t?(y(t.message,t.stack),r&&r(t,n)):mO.create(e,n,o.ext||Ri(e),o,(function(e,t){r&&r(e,t)}))}))):YN(r)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=WN(t,void 0,n),o=i.options,r=i.onComplete,a=Oi(e);this.bundles.has(a)?YN(r)(null,this.getBundle(a)):(o.preset=o.preset||"bundle",o.ext="bundle",o.__isNative__=!0,this.loadAny({url:e},o,null,(function(t,n){t?(y(t.message,t.stack),r&&r(t,n)):mO.create(e,n,"bundle",o,(function(e,t){r&&r(e,t)}))})))},t.releaseAsset=function(e){FN.tryRelease(e,!0)},t.releaseUnusedAssets=function(){uf.forEach((function(e){FN.tryRelease(e)}))},t.releaseAll=function(){uf.forEach((function(e){FN.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},J(e,[{key:"main",get:function(){return ff.get(vf.MAIN)||null}},{key:"resources",get:function(){return ff.get(vf.RESOURCES)||null}}]),e}());RO.Pipeline=cf,RO.Task=yf,RO.Cache=sf,RO.RequestItem=CO,RO.Bundle=XN,RO.BuiltinBundleName=vf;var NO=e("dh",s.assetManager=new RO);s.AssetManager=RO;var OO=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],DO=[".mp3",".ogg",".wav",".m4a"];function MO(){return!0}var LO={transformURL:function(e){var t=Cf(e);if(!t)return e;var n=ff.find((function(e){return!!e.getAssetInfo(t)}));if(!n)return e;var i,o=n.getAssetInfo(t);if(!(i=e.startsWith(n.base+n.config.nativeBase)?o.nativeVer||"":o.ver||"")||-1!==e.indexOf(i))return e;var r=!1;if(".ttf"===Ri(e)&&(r=!0),r){var a=Di(e),s=Oi(e);e=a+"."+i+"/"+s}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/,(function(e){return e+"."+i}));return e}},FO=e("fu",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=jN}var t=e.prototype;return t.load=function(e,t,n){void 0===n&&void 0!==t&&(n=t,t=null);for(var i=Array.isArray(e)?e:[e],o=0;o<i.length;o++){var r=i[o];"string"==typeof r?i[o]={url:r,__isNative__:!0}:(r.type&&(r.ext="."+r.type,r.type=void 0),r.url&&(r.__isNative__=!0))}var a=[],s=[];NO.loadAny(i,null,(function(e,n,i){i.content&&(OO.includes(i.ext)?a.push(i.content):DO.includes(i.ext)&&s.push(i.content)),t&&t(e,n,i)}),(function(e,t){var o=null;if(!e){t=Array.isArray(t)?t:[t];for(var r=function(e){var n=t[e];if(!(n instanceof zf)){var o=n,r=i[e].url;a.includes(o)?mO.create(r,n,".png",{},(function(n,i){o=t[e]=i})):s.includes(o)&&mO.create(r,n,".mp3",{},(function(n,i){o=t[e]=i})),uf.add(r,o)}},c=0;c<t.length;c++)r(c);if(t.length>1){var l=Object.create(null);t.forEach((function(e){l[e._uuid]=e})),o={isCompleted:MO,_map:l}}else o=t[0]}n&&n(e,o)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return NO.assets.has(e)?{content:NO.assets.get(e)}:null},t.loadRes=function(e,t,n,i){var o=this._parseLoadResArgs(t,n,i),r=o.type,a=o.onProgress,s=o.onComplete,c=Ri(e);c&&!KN.getInfoWithPath(e,r)&&(e=e.slice(0,-c.length)),KN.load(e,r,a,s)},t.loadResArray=function(e,t,n,i){var o=this._parseLoadResArgs(t,n,i),r=o.type,a=o.onProgress,s=o.onComplete;e.forEach((function(t,n){var i=Ri(t);i&&!KN.getInfoWithPath(t,r)&&(e[n]=t.slice(0,-i.length))})),KN.load(e,r,a,s)},t.loadResDir=function(e,t,n,i){var o=this._parseLoadResArgs(t,n,i),r=o.type,a=o.onProgress,s=o.onComplete;KN.loadDir(e,r,a,(function(t,n){var i=[];t||(i=KN.getDirWithPath(e,r).map((function(e){return e.path}))),s&&s(t,n,i)}))},t.getRes=function(e,t){return uf.has(e)?uf.get(e):KN.get(e,t)},t.getResCount=function(){return uf.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return cp.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({url:e},n)}};for(var i in e)n(i);cO.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({content:e},n)}};for(var i in e)n(i);SO.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];"string"==typeof n&&(n=uf.get(n)),NO.releaseAsset(n)}else e&&("string"==typeof e&&(e=uf.get(e)),NO.releaseAsset(e))},t.releaseAsset=function(e){NO.releaseAsset(e)},t.releaseRes=function(e,t){KN.release(e,t)},t.releaseAll=function(){NO.releaseAll(),uf.clear()},t.removeItem=function(e){return!!uf.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=cp.getDepsRecursively(e),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},J(e,[{key:"onProgress",set:function(e){zN=e}},{key:"_cache",get:function(){return uf._map}},{key:"md5Pipe",get:function(){return LO}},{key:"downloader",get:function(){return cO}},{key:"loader",get:function(){return NO.parser}}]),e}()),zO=e("fv",new FO),BO=e("fw",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,NO.init(e),e.rawAssets&&KN.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:vf.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets)})},loadAsset:function(e,t){NO.loadAny(e,t)}}),UO=e("fx",{});k(UO,"url",[{name:"normalize",target:NO.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?Rf({path:Mi(e.substr(10)),bundle:vf.RESOURCES,__isNative__:!0,ext:Ri(e)}):""}}]),W(BO,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),W(zO,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),k(s,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return zO}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return BO}},{name:"Pipeline",target:RO,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return UO}}]),W(s,"cc",[{name:"LoadingItems",suggest:M(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),k(st,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:cO,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),k(bN,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return NO.main?null===(t=NO.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),k(Kw,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return NO.main&&NO.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var HO,GO,VO,kO,WO,jO,qO,YO,XO,KO,QO,ZO,JO,$O,eD=FN._autoRelease;FN._autoRelease=function(e,t,n){eD.call(FN,e,t,n);for(var i=zO._autoReleaseSetting,o=Object.keys(i),r=0;r<o.length;r++){var a=o[r];if(!0===i[a]){var s=uf.get(a);s&&FN.tryRelease(s)}}};var tD,nD,iD,oD,rD,aD,sD,cD,lD,uD,hD,_D,fD,dD,pD,mD,vD,gD,yD,xD,ED,SD,TD,AD,wD,CD,ID,PD,bD,RD,ND,OD,DD,MD,LD,FD,zD,BD,UD,HD,GD,VD,kD,WD,jD,qD,YD,XD,KD,QD,ZD,JD,$D,eM,tM,nM,iM,oM,rM,aM,sM,cM,lM,uM,hM,_M,fM,dM=e("dB",(HO=b_("cc.ClickEvent"),GO=rf(s.Node),VO=q_(),kO=q_(),WO=q_(),jO=q_(),HO(($O=function(){function e(){re(this,"target",XO,this),re(this,"component",KO,this),re(this,"_componentId",QO,this),re(this,"handler",ZO,this),re(this,"customEventData",JO,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];for(var r=0,a=t.length;r<a;r++){var s=t[r];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(s.isValid(t)){this._genCompIdIfNeeded();var n=s.js._getClassById(this._componentId),i=t.getComponent(n);if(s.isValid(i)){var o=i[this.handler];"function"==typeof o&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),o.apply(i,e))}}},t._compName2Id=function(e){var t=s.js.getClassByName(e);return s.js._getClassId(t)},t._compId2Name=function(e){var t=s.js._getClassById(e);return s.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},J(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),XO=ae((YO=$O).prototype,"target",[M_,GO,VO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KO=ae(YO.prototype,"component",[M_,k_,kO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),QO=ae(YO.prototype,"_componentId",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZO=ae(YO.prototype,"handler",[M_,k_,WO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),JO=ae(YO.prototype,"customEventData",[M_,k_,jO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qO=YO))||qO));s.Component.EventHandler=dM;var pM,mM,vM,gM,yM,xM,EM,SM,TM,AM,wM=new An,CM=nt(t_),IM=nt(e_),PM=nt(n_),bM=nt(o_),RM=nt(i_),NM=nt({SKYBOX:v_|os.DEPTH_STENCIL,SOLID_COLOR:os.ALL,DEPTH_ONLY:os.DEPTH_STENCIL,DONT_CLEAR:os.NONE}),OM=e("dc",(tD=b_("cc.Camera"),nD=V_(),iD=B_(),oD=J_(),rD=q_(),aD=rf(Fu.BitMask),sD=J_(),cD=q_(),lD=rf(NM),uD=J_(),hD=q_(),_D=J_(),fD=q_(),dD=J_(),pD=q_(),mD=J_(),vD=q_(),gD=rf(CM),yD=J_(),xD=q_(),ED=rf(IM),SD=J_(),TD=q_(),AD=J_(),wD=q_(),CD=J_(),ID=q_(),PD=J_(),bD=q_(),RD=J_(),ND=q_(),OD=rf(PM),DD=J_(),MD=q_(),LD=rf(bM),FD=J_(),zD=q_(),BD=rf(RM),UD=J_(),HD=q_(),GD=J_(),VD=q_(),kD=rf(aE),WD=J_(),jD=q_(),tD(qD=nD(qD=iD(qD=z_((fM=_M=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"_projection",XD,ne(t)),re(t,"_priority",KD,ne(t)),re(t,"_fov",QD,ne(t)),re(t,"_fovAxis",ZD,ne(t)),re(t,"_orthoHeight",JD,ne(t)),re(t,"_near",$D,ne(t)),re(t,"_far",eM,ne(t)),re(t,"_color",tM,ne(t)),re(t,"_depth",nM,ne(t)),re(t,"_stencil",iM,ne(t)),re(t,"_clearFlags",oM,ne(t)),re(t,"_rect",rM,ne(t)),re(t,"_aperture",aM,ne(t)),re(t,"_shutter",sM,ne(t)),re(t,"_iso",cM,ne(t)),re(t,"_screenScale",lM,ne(t)),re(t,"_visibility",uM,ne(t)),re(t,"_targetTexture",hM,ne(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=u_.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=pa.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new An),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new An),!this._camera)return n;this.worldToScreen(e,wM);var i=t.getComponent("cc.UITransform"),o=nC.getVisibleSize(),r=wM.x-.5*this._camera.width,a=wM.y-.5*this._camera.height;return wM.x=r/s.view.getScaleX()+.5*o.width,wM.y=a/s.view.getScaleY()+.5*o.height,i&&i.convertToNodeSpaceAR(wM,n),n},n._createCamera=function(){this._camera||(this._camera=s.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?s.director.root&&s.director.root.mainWindow:s.director.root&&s.director.root.tempWindow,priority:this._priority}),this._camera.viewport=this._rect,this._camera.fovAxis=this._fovAxis,this._camera.fov=sn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._chechTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},J(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===e_.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=sn(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?s.director.root&&s.director.root.mainWindow:s.director.root&&s.director.root.tempWindow)}}]),t}(ip),_M.ProjectionType=CM,_M.FOVAxis=IM,_M.ClearFlag=NM,_M.Aperture=PM,_M.Shutter=bM,_M.ISO=RM,XD=ae((YD=fM).prototype,"_projection",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CM.PERSPECTIVE}}),KD=ae(YD.prototype,"_priority",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QD=ae(YD.prototype,"_fov",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),ZD=ae(YD.prototype,"_fovAxis",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return IM.VERTICAL}}),JD=ae(YD.prototype,"_orthoHeight",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),$D=ae(YD.prototype,"_near",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),eM=ae(YD.prototype,"_far",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),tM=ae(YD.prototype,"_color",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Sn("#333333")}}),nM=ae(YD.prototype,"_depth",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),iM=ae(YD.prototype,"_stencil",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oM=ae(YD.prototype,"_clearFlags",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NM.SOLID_COLOR}}),rM=ae(YD.prototype,"_rect",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(0,0,1,1)}}),aM=ae(YD.prototype,"_aperture",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PM.F16_0}}),sM=ae(YD.prototype,"_shutter",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bM.D125}}),cM=ae(YD.prototype,"_iso",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RM.ISO100}}),lM=ae(YD.prototype,"_screenScale",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),uM=ae(YD.prototype,"_visibility",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return r_}}),hM=ae(YD.prototype,"_targetTexture",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ae(YD.prototype,"priority",[oD,rD],Object.getOwnPropertyDescriptor(YD.prototype,"priority"),YD.prototype),ae(YD.prototype,"visibility",[aD,sD,cD],Object.getOwnPropertyDescriptor(YD.prototype,"visibility"),YD.prototype),ae(YD.prototype,"clearFlags",[lD,uD,hD],Object.getOwnPropertyDescriptor(YD.prototype,"clearFlags"),YD.prototype),ae(YD.prototype,"clearColor",[_D,fD],Object.getOwnPropertyDescriptor(YD.prototype,"clearColor"),YD.prototype),ae(YD.prototype,"clearDepth",[dD,pD],Object.getOwnPropertyDescriptor(YD.prototype,"clearDepth"),YD.prototype),ae(YD.prototype,"clearStencil",[mD,vD],Object.getOwnPropertyDescriptor(YD.prototype,"clearStencil"),YD.prototype),ae(YD.prototype,"projection",[gD,yD,xD],Object.getOwnPropertyDescriptor(YD.prototype,"projection"),YD.prototype),ae(YD.prototype,"fovAxis",[ED,SD,TD],Object.getOwnPropertyDescriptor(YD.prototype,"fovAxis"),YD.prototype),ae(YD.prototype,"fov",[AD,wD],Object.getOwnPropertyDescriptor(YD.prototype,"fov"),YD.prototype),ae(YD.prototype,"orthoHeight",[CD,ID],Object.getOwnPropertyDescriptor(YD.prototype,"orthoHeight"),YD.prototype),ae(YD.prototype,"near",[PD,bD],Object.getOwnPropertyDescriptor(YD.prototype,"near"),YD.prototype),ae(YD.prototype,"far",[RD,ND],Object.getOwnPropertyDescriptor(YD.prototype,"far"),YD.prototype),ae(YD.prototype,"aperture",[OD,DD,MD],Object.getOwnPropertyDescriptor(YD.prototype,"aperture"),YD.prototype),ae(YD.prototype,"shutter",[LD,FD,zD],Object.getOwnPropertyDescriptor(YD.prototype,"shutter"),YD.prototype),ae(YD.prototype,"iso",[BD,UD,HD],Object.getOwnPropertyDescriptor(YD.prototype,"iso"),YD.prototype),ae(YD.prototype,"rect",[GD,VD],Object.getOwnPropertyDescriptor(YD.prototype,"rect"),YD.prototype),ae(YD.prototype,"targetTexture",[kD,WD,jD],Object.getOwnPropertyDescriptor(YD.prototype,"targetTexture"),YD.prototype),qD=YD))||qD)||qD)||qD)||qD));s.Camera=OM;var DM,MM,LM,FM,zM,BM,UM,HM,GM={parent:null,owner:null,subModelIdx:0},VM=e("ca",(pM=b_("cc.RenderableComponent"),mM=rf([sE]),vM=rf(sE),gM=J_(),yM=j_(),pM((AM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"_materials",SM,ne(t)),re(t,"_visFlags",TM,ne(t)),t._materialInstances=[],t._models=[],t}ee(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof FE&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n?n.parent!==this._materials[t]&&(n.destroy(),this._materialInstances[t]=null,this._onMaterialModified(t,this._materials[t])):this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){GM.parent=this._materials[e],GM.owner=this,GM.subModelIdx=e;var t=new FE(GM);this.setMaterialInstance(e,t)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){t&&t.parent?t!==this._materialInstances[e]&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):t!==this._materials[e]&&this.setMaterial(t,e)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},J(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var n=this._materials.length-t;n<this._materials.length;++n)this.setMaterialInstance(n,null);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=e[i]&&this.setMaterialInstance(i,e[i])}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterialInstance(0,e)}}]),t}(ip),SM=ae((EM=AM).prototype,"_materials",[mM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TM=ae(EM.prototype,"_visFlags",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fu.Enum.NONE}}),ae(EM.prototype,"sharedMaterials",[vM,gM,yM],Object.getOwnPropertyDescriptor(EM.prototype,"sharedMaterials"),EM.prototype),xM=EM))||xM));function kM(e){return"string"==typeof e||"number"==typeof e}function WM(e,t){return e instanceof t}s.RenderableComponent=VM,k(OM,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),k(OM.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),s.CameraComponent=OM,et.setClassAlias(OM,"cc.CameraComponent");var jM,qM,YM,XM,KM,QM,ZM=e("bb",b_("cc.animation.HierarchyPath")((FM=function(){function e(e){re(this,"path",LM,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof $g?e.getChildByPath(this.path)||(g('Node "'+e.name+'" has no path "'+this.path+'"'),null):(g("Target of hierarchy path should be of type Node."),null)},e}(),LM=ae((MM=FM).prototype,"path",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),DM=MM))||DM),JM=e("bc",b_("cc.animation.ComponentPath")((HM=function(){function e(e){re(this,"component",UM,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof $g?e.getComponent(this.component)||(g('Node "'+e.name+'" has no component "'+this.component+'"'),null):(g("Target of component path should be of type Node."),null)},e}(),UM=ae((BM=HM).prototype,"component",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zM=BM))||zM);function $M(e){for(var t=e,n=0;n<(arguments.length<=1?0:arguments.length-1);++n){var i=n+1<1||arguments.length<=n+1?void 0:arguments[n+1];if(kM(i)){if(!(i in t))return g('Target object has no property "'+i+'"'),null;t=t[i]}else t=i.get(t);if(null===t)break}return t}var eL,tL,nL,iL,oL,rL,aL,sL,cL,lL,uL,hL=e("b6",b_("cc.animation.UniformProxyFactory")((QM=function(){function e(e,t){re(this,"passIndex",YM,this),re(this,"uniformName",XM,this),re(this,"channelIndex",KM,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');var i=um.getPropertyTypeFromHandle(n);if(i===bp.BUFFER){var o=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,Pa.FLOAT);if(!o)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=oe(e.shaderInfo.blocks);!(n=i()).done;)for(var o,r=oe(n.value.members);!(o=r()).done;){var a=o.value;if(a.name===t)return a.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(o,e)}}:{set:function(e){t.setUniform(o,e)}}}if(i===bp.TEXTURE){var r=um.getBindingFromHandle(n),a=t.properties[this.uniformName],c=a&&a.value?a.value+"-texture":Wp(a.type),l=rm.get(c);return l||(g("Illegal texture default value: "+c+"."),l=rm.get("default-texture")),{set:function(e){e||(e=l);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(r,n),e instanceof pd&&t.bindSampler(r,fd.getSampler(s.game._gfxDevice,e.getSamplerHash())))}}}throw new Error("Animations are not available for uniforms with property type "+i+".")},e}(),YM=ae((qM=QM).prototype,"passIndex",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XM=ae(qM.prototype,"uniformName",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),KM=ae(qM.prototype,"channelIndex",[tf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),jM=qM))||jM);function _L(e,t,n,i){var o,r,a,s,c,l,u=new t,h=new t,_=new t,f=b_(e)((l=function(){function e(e,n,i){re(this,"dataPoint",a,this),re(this,"inTangent",s,this),re(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var o=e.prototype;return o.lerp=function(e,t,o){var r=this.dataPoint,a=e.dataPoint;h=n(h,this.inTangent,o),_=n(_,e.outTangent,o);var s=t*t*t,c=t*t,l=s-2*c+t,f=-2*s+3*c,d=s-c;return u=n(u,r,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,f),u=i(u,u,_,d)},o.getNoLerp=function(){return this.dataPoint},e}(),a=ae((r=l).prototype,"dataPoint",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=ae(r.prototype,"inTangent",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=ae(r.prototype,"outTangent",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),o=r))||o;if(t===Nn){var d=f.prototype.lerp;f.prototype.lerp=function(e,t,n){var i=d.call(this,e,t,n);return Nn.normalize(i,i),i}}return f}e("b7",b_("cc.animation.MorphWeightsValueProxy")((iL=function(){function e(){re(this,"subMeshIndex",nL,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),nL=ae((tL=iL).prototype,"subMeshIndex",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eL=tL))||eL),e("b8",b_("cc.animation.MorphWeightsAllValueProxy")(oL=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,o=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,r=0;r<o;++r)e.setWeights(t,r)}}},e}())||oL);var fL=e("be",_L("cc.CubicSplineVec2Value",kn,kn.multiplyScalar,kn.scaleAndAdd));s.CubicSplineVec2Value=fL;var dL=e("bf",_L("cc.CubicSplineVec3Value",An,An.multiplyScalar,An.scaleAndAdd));s.CubicSplineVec3Value=dL;var pL=e("bg",_L("cc.CubicSplineVec4Value",Yn,Yn.multiplyScalar,Yn.scaleAndAdd));s.CubicSplineVec4Value=pL;var mL=e("bh",_L("cc.CubicSplineQuatValue",Nn,Nn.multiplyScalar,Nn.scaleAndAdd));s.CubicSplineQuatValue=mL;var vL=e("bi",b_("cc.CubicSplineNumberValue")((uL=function(){function e(e,t,n){re(this,"dataPoint",sL,this),re(this,"inTangent",cL,this),re(this,"outTangent",lL,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,o=e.dataPoint,r=t*t*t,a=t*t;return i*(2*r-3*a+1)+this.outTangent*n*(r-2*a+t)+o*(-2*r+3*a)+e.inTangent*n*(r-a)},t.getNoLerp=function(){return this.dataPoint},e}(),sL=ae((aL=uL).prototype,"dataPoint",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cL=ae(aL.prototype,"inTangent",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lL=ae(aL.prototype,"outTangent",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rL=aL))||rL);function gL(e,t,n){void 0===n&&(n=1e-6);for(var i=0,o=e.length-1,r=o>>>1;i<=o;r=i+o>>>1){var a=e[r];if(a>t+n)o=r-1;else{if(!(a<t-n))return r;i=r+1}}return~i}function yL(e,t,n,i,o){var r=1-o;return r*(r*(e+(3*t-e)*o)+3*n*o*o)+i*o*o*o}s.CubicSplineNumberValue=vL,s.bezier=yL;var xL=Math.cos,EL=Math.acos,SL=Math.max,TL=2*Math.PI,AL=Math.sqrt;function wL(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function CL(e,t){var n=function(e,t){var n,i,o,r,a=t-0,s=t-e[0],c=3*a,l=3*s,u=3*(t-e[2]),h=1/(-a+l-u+(t-1)),_=1/3,f=(c-6*s+u)*h,d=f*_,p=(-c+l)*h,m=(3*p-f*f)*_,v=m*_,g=(2*f*f*f-9*f*p+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var E=-m*_,S=AL(E*E*E),T=-g/(2*S),A=EL(T<-1?-1:T>1?1:T),w=2*wL(S);return i=w*xL(A*_)-d,o=w*xL((A+TL)*_)-d,r=w*xL((A+2*TL)*_)-d,i>=0&&i<=1?o>=0&&o<=1?r>=0&&r<=1?SL(i,o,r):SL(i,o):r>=0&&r<=1?SL(i,r):i:o>=0&&o<=1?r>=0&&r<=1?SL(o,r):o:r}if(0===x)return o=-(n=y<0?wL(-y):-wL(y))-d,(i=2*n-d)>=0&&i<=1?o>=0&&o<=1?SL(i,o):i:o;var C=AL(x);return(n=wL(-y+C))-wL(y+C)-d}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}s.bezierByTime=CL;var IL=e("fN",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,o=1,r=e.length;o<r;o++)if(t=e[o]-e[o-1],1===o)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?NL:gL}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());s.RatioSampler=IL;var PL=e("fO",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var o=0,r=Object.keys(t.easingMethods);o<r.length;o++){var a=r[o];this.types[a]=i(t.easingMethods[a])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=YL(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,o){if(this._lerp){var r=this.types?this.types[t]:this.type,a=o-n,s=(e-n)/a;if(r&&(s=RL(s,r)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*t+f];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function bL(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function RL(e,t){if("string"==typeof t){var n=sI[t];n?e=n(e):R(3906,t)}else Array.isArray(t)&&(e=CL(t,e));return e}function NL(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var o=e[n];if(t>o)return n;var r=(t=(t-i)/(o-i))/(1/n),a=0|r,s=1e-6;return r-a<s?a:a+1-r<s?a+1:~(a+1)}PL.Linear=null,s.AnimCurve=PL,e("fP",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),s.sampleAnimationCurve=bL;var OL,DL,ML,LL,FL,zL,BL,UL,HL,GL,VL,kL,WL,jL,qL,YL=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return an;if("object"==typeof t&&t.constructor){if(t instanceof Nn)return n=new Nn,function(e,t,i){return Nn.slerp(n,e,t,i)};if(t instanceof at)return function(e){var t=new e;return function(n,i,o){return e.lerp(t,n,i,o),t}}(t.constructor);if(t.constructor===Number)return an;if("function"==typeof t.lerp)return e}var n}}}(),XL=e("cu",function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);return n&&n.info.sample===t.sample||(n&&s.director.root.dataPoolManager.releaseAnimationClip(t),n=function(e){var t={};e.curves.forEach((function(e){if(!e.valueAdapter&&WM(e.modifiers[0],ZM)&&kM(e.modifiers[1])){var n=e.modifiers[0].path,i=t[n];i||(i=t[n]={}),i[e.modifiers[1]]={values:e.data.values,keys:e.data.keys}}}));for(var n=Math.ceil(e.sample*e.duration)+1,i=function(){var i=r[o],a=t[i];if(!a)return"continue";Object.defineProperty(a,"worldMatrix",{get:function(){if(!a._worldMatrix){var o=a.position,r=a.rotation,s=a.scale;KL(e,o,n),KL(e,r,n),KL(e,s,n),function(e,t,n){var i=n.position.values,o=n.rotation.values,r=n.scale.values,a=i.map((function(){return new Un})),s=t.lastIndexOf("/"),c=null;if(s>0){var l=e[t.substring(0,s)];if(!l)return void console.warn("no data for parent bone?");c=l.worldMatrix.values}for(var u=0;u<i.length;u++){var h=i[u],_=o[u],f=r[u],d=a[u];Un.fromRTS(d,_,h,f),c&&Un.multiply(d,c[u],d)}Object.keys(n).forEach((function(e){return delete n[e]})),n._worldMatrix={keys:0,interpolate:!1,values:a}}(t,i,a)}return a._worldMatrix}})},o=0,r=Object.keys(t);o<r.length;o++)i();return{info:{frames:n,sample:e.sample},data:t}}(t),e.pool.set(t,n)),n},e.destroy=function(t){e.pool.delete(t)},e}());function KL(e,t,n){var i=e.keys[t.keys],o=[];if(i&&1!==i.length)for(var r=t.values[0]instanceof Nn,a=0,s=0;a<n;a++){for(var c=a/e.sample;i[s]<=c;)s++;s>i.length-1?c=i[s=i.length-1]:0===s&&(s=1);var l=t.values[s-1].clone(),u=i[s]-i[s-1],h=u?rn((c-i[s-1])/u):1;r?l.slerp(t.values[s],h):l.lerp(t.values[s],h),o[a]=l}else for(var _=0;_<n;_++)o[_]=t.values[0].clone();t.values=o}XL.pool=new Map;var QL=e("fS",b_("cc.AnimationClip")((qL=jL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"sample",ML,ne(t)),re(t,"speed",LL,ne(t)),re(t,"wrapMode",FL,ne(t)),re(t,"events",zL,ne(t)),re(t,"enableTrsBlending",BL,ne(t)),re(t,"_duration",UL,ne(t)),re(t,"_keys",HL,ne(t)),re(t,"_stepness",GL,ne(t)),re(t,"_curves",VL,ne(t)),re(t,"_commonTargets",kL,ne(t)),re(t,"_hash",WL,ne(t)),t.frameRate=0,t._ratioSamplers=[],t._runtimeCurves=void 0,t._runtimeEvents=void 0,t._data=null,t}ee(t,e),t.createWithSpriteFrames=function(e,n){if(!Array.isArray(e))return R(3905),null;var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;for(var o=1/i.sample,r=new Array(e.length),a=new Array(r.length),s=0;s<e.length;s++)r[s]=s*o,a[s]=e[s];return i.keys=[r],i.curves=[{modifiers:[new JM("cc.Sprite"),"spriteFrame"],data:{keys:0,values:a}}],i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this._decodeCVTAs()},n.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},n.updateEventDatas=function(){delete this._runtimeEvents},n.getEventGroupIndexAtRatio=function(e){return this._runtimeEvents||this._createRuntimeEvents(),gL(this._runtimeEvents.ratios,e)},n.hasEvents=function(){return 0!==this.events.length},n.destroy=function(){return s.director.root.dataPoolManager&&s.director.root.dataPoolManager.releaseAnimationClip(this),XL.destroy(this),e.prototype.destroy.call(this)},n._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new IL(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new PL(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}})),this._applyStepness()},n._createRuntimeEvents=function(){for(var e,t=this,n=[],i=[],o=function(){var o=e.value,r=o.frame/t._duration,a=n.findIndex((function(e){return e===r}));a<0&&(a=n.length,n.push(r),i.push({events:[]})),i[a].events.push({functionName:o.func,parameters:o.params})},r=oe(this.events.sort((function(e,t){return e.frame-t.frame})));!(e=r()).done;)o();this._runtimeEvents={ratios:n,eventGroups:i}},n._applyStepness=function(){},n._decodeCVTAs=function(){var e=ArrayBuffer.isView(this._nativeAsset)?this._nativeAsset.buffer:this._nativeAsset;if(e){for(var t=this._keys,n=0;n<t.length;++n){var i=t[n];i instanceof HI&&(t[n]=i.decompress(e))}for(var o=0;o<this._curves.length;++o){var r=this._curves[o];r.data.values instanceof HI&&(r.data.values=r.data.values.decompress(e))}}},n.validate=function(){return this.keys.length>0&&this.curves.length>0},J(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"eventGroups",get:function(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}},{key:"stepness",get:function(){return this._stepness},set:function(e){this._stepness=e,this._applyStepness()}},{key:"hash",get:function(){if(this._hash)return this._hash;var e=this._nativeAsset,t=new Uint8Array(ArrayBuffer.isView(e)?e.buffer:e);return this._hash=Ac(t,666)}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"data",get:function(){return this._data}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}}]),t}(zf),jL.WrapMode=mu,ML=ae((DL=qL).prototype,"sample",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),LL=ae(DL.prototype,"speed",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),FL=ae(DL.prototype,"wrapMode",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mu.Normal}}),zL=ae(DL.prototype,"events",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BL=ae(DL.prototype,"enableTrsBlending",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UL=ae(DL.prototype,"_duration",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HL=ae(DL.prototype,"_keys",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),GL=ae(DL.prototype,"_stepness",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VL=ae(DL.prototype,"_curves",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kL=ae(DL.prototype,"_commonTargets",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WL=ae(DL.prototype,"_hash",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OL=DL))||OL);function ZL(e,t,n){var i=t[t.length-1];if(0!==t.length&&kM(i)&&!n){var o=$M.apply(void 0,[e].concat(t.slice(0,t.length-1)));return null===o?null:{setValue:function(e){o[i]=e},getValue:function(){return o[i]}}}if(n){var r=$M.apply(void 0,[e].concat(t));if(null===r)return null;var a=n.forTarget(r);return{setValue:function(e){a.set(e)},getValue:function(){return a.get?a.get():(y("Target doesn't provide a get method."),null)}}}return y("Empty animation curve."),null}function JL(e,t,n){var i=ZL(e,t,n);if(null===i)return null;var o=i.getValue(),r=eF(o);if(!r)return y("Value is not copyable!"),null;var a=r.createBuffer(),s=r.copy;return Object.assign(i,{peek:function(){return a},pull:function(){var e=i.getValue();s(a,e)},push:function(){i.setValue(a)}})}s.AnimationClip=QL;var $L,eF=(($L=new Map).set(kn,{createBuffer:function(){return new kn},copy:kn.copy}),$L.set(An,{createBuffer:function(){return new An},copy:An.copy}),$L.set(Yn,{createBuffer:function(){return new Yn},copy:Yn.copy}),$L.set(Sn,{createBuffer:function(){return new Sn},copy:Sn.copy}),$L.set(Qn,{createBuffer:function(){return new Qn},copy:function(e,t){return e.set(t)}}),function(e){return $L.get(null==e?void 0:e.constructor)}),tF=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(M(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},J(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),nF=function(){function e(){this._nodeBlendStates=new Map,this._states=new Set}var t=e.prototype;return t.ref=function(e,t){var n=this._nodeBlendStates.get(e);n||(n={dirty:!1,properties:{}},this._nodeBlendStates.set(e,n));var i=n.properties[t];return i||(i=n.properties[t]=new rF(n,iF(t)?new An:new Nn)),++i.refCount,i},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);if(n){var i=n.properties[t];i&&(--i.refCount,i.refCount>0||(delete n.properties[t],function(e){return!(e.properties.position||e.properties.rotation||e.properties.eulerAngles||e.properties.scale)}(n)&&this._nodeBlendStates.delete(e)))}},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){if(e.dirty){e.dirty=!1;var n,i,o,r=e.properties,a=r.position,s=r.scale,c=r.rotation,l=r.eulerAngles,u=!1;a&&0!==a.weight&&(a.weight=0,n=a.value,u=!0),s&&0!==s.weight&&(s.weight=0,i=s.value,u=!0),c&&0!==c.weight&&(c.weight=0,o=c.value,u=!0),l&&0!==l.weight&&(l.weight=0,o=l.value,u=!0),u&&t.setRTS(o,n,i)}})),this._states.forEach((function(e){e.onBlendFinished()}))},t.bindState=function(e){this._states.add(e)},t.unbindState=function(e){this._states.delete(e)},e}();function iF(e){return!function(e){return"rotation"===e}(e)}var oF,rF=function(){function e(e,t){this.weight=0,this.value=void 0,this.refCount=0,this._node=void 0,this._node=e,this.value=t}return e.prototype.markAsDirty=function(){this._node.dirty=!0},e}();function aF(e,t,n){return 0===n.weight&&An.zero(n.value),0===t?n.value:1===t?An.copy(n.value,e):An.scaleAndAdd(n.value,n.value,e,t)}function sF(e,t,n){if(0===n.weight&&Nn.identity(n.value),0===t)return n.value;if(1===t)return Nn.copy(n.value,e);var i=t/(n.weight+t);return Nn.slerp(n.value,n.value,e,i)}!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(oF||(oF={})),rt(oF);var cF=function(){function e(e,t,n){this.commonTargetIndex=void 0,this._curve=void 0,this._boundTarget=void 0,this._rootTargetProperty=void 0,this._curveDetail=void 0,this._curve=e.curve,this._curveDetail=e,this._boundTarget=n,this._shouldLerp=e.curve.hasLerp()}var t=e.prototype;return t.applySample=function(e,t,n,i,o){var r;r=this._shouldLerp&&n?this._curve.valueBetween(e,i.from,i.fromRatio,i.to,i.toRatio):this._curve.valueAt(t),this._setValue(r,o)},t._setValue=function(e){this._boundTarget.setValue(e)},J(e,[{key:"propertyName",get:function(){return this._rootTargetProperty||""}},{key:"curveDetail",get:function(){return this._curveDetail}}]),e}(),lF=e("cN",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.weight=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._process=i.process,i._samplerSharedGroups=[],i._target=null,i._ignoreIndex=-1,i._commonTargetStatuses=[],i._wrapMode=mu.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=void 0,i._lastWrapInfo=null,i._lastWrapInfoEvent=null,i._wrappedInfo=new yu,i._blendStateBuffer=null,i._blendStateWriters=[],i._allowLastFrame=!1,i._blendStateWriterHost={weight:0,enabled:!1},i._playbackRange=void 0,i._playbackDuration=0,i._invDuration=1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:i._clip.duration},i._playbackDuration=t.duration,t.duration||E("Clip "+t.name+" has zero duration."),i}ee(t,e);var n=t.prototype;return n.initialize=function(e,t){var n,i,o=this;if(!this._curveLoaded){this._curveLoaded=!0,this._destroyBlendStateWriters(),this._samplerSharedGroups.length=0,this._blendStateBuffer=null!==(n=null===(i=s.director.getAnimationManager())||void 0===i?void 0:i.blendState)&&void 0!==n?n:null,this._blendStateBuffer&&this._blendStateBuffer.bindState(this),this._targetNode=e;var r=this._clip;this.duration=r.duration,this._invDuration=1/this.duration,this.speed=r.speed,this.wrapMode=r.wrapMode,this.frameRate=r.sample,this._playbackRange={min:0,max:r.duration},this._playbackDuration=r.duration,(this.wrapMode&pu.Loop)===pu.Loop?this.repeatCount=1/0:this.repeatCount=1;var a=function(e,t,n,i,a){if(!(r.enableTrsBlending&&function(e){var t;if(1===e.length&&"string"==typeof e[0])t=e[0];else if(e.length>1){for(var n=0;n<e.length-1;++n)if(!(e[n]instanceof ZM))return!1;t=e[e.length-1]}switch(t){case"position":case"scale":case"rotation":case"eulerAngles":return!0;default:return!1}}(n)&&o._blendStateBuffer))return e(t,n,i);var s=$M.apply(void 0,[t].concat(n.slice(0,n.length-1)));if(null!==s&&s instanceof $g){var c=n[n.length-1],l=function(e,t,n,i,o){var r=iF(n)?aF:sF,a=e.ref(t,n),s=!1,c=-1;return{destroy:function(){a&&(e.deRef(t,n),a=null)},forTarget:function(){return{get:function(){return t[n]},set:function(e){if(a&&i.enabled){var t=i.weight;if(o)if(1!==t||t!==c)s=!1;else if(s)return;r(e,t,a),a.weight+=t,a.markAsDirty(),s=!0,c=t}}}}}}(o._blendStateBuffer,s,c,o._blendStateWriterHost,a);return o._blendStateWriters.push(l),e(t,[],l)}return null};this._commonTargetStatuses=r.commonTargets.map((function(t){var n=a(JL,e,t.modifiers,t.valueAdapter,!1);return null===n?null:{target:n,changed:!1}})),t||(t=r.getPropertyCurves());for(var c=function(n){var i=t[n];if(i.curve.empty())return"continue";var r=o._samplerSharedGroups.find((function(e){return e.sampler===i.sampler}));r||(r={sampler:i.sampler,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}},o._samplerSharedGroups.push(r));var s=void 0;if(void 0===i.commonTarget)s=e;else{var c=o._commonTargetStatuses[i.commonTarget];if(!c)return"continue";s=c.target.peek()}var l=a(ZL,s,i.modifiers,i.valueAdapter,i.curve.constant());if(null===l);else{var u=new cF(i,s,l);u.commonTargetIndex=i.commonTarget,r.curves.push(u)}},l=0;l<t.length;++l)c(l)}},n.destroy=function(){this._destroyBlendStateWriters()},n.onBlendFinished=function(){this._blendStateWriterHost.enabled=!1},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];s.director.getAnimationManager().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0,this._lastWrapInfoEvent=null,this._ignoreIndex=-1;var t=this.getWrappedInfo(e,this._wrappedInfo),n=t.direction,i=this._clip.getEventGroupIndexAtRatio(t.ratio);i<0&&(i=~i-1,n<0&&(i+=1),this._ignoreIndex=i)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(0),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(oF.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(oF.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(oF.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(oF.PAUSE,this)},n._sampleCurves=function(e){this._blendStateWriterHost.weight=this.weight,this._blendStateWriterHost.enabled=!0;for(var t=this._commonTargetStatuses,n=0,i=t.length;n<i;++n){var o=t[n];o&&(o.target.pull(),o.changed=!1)}for(var r=0,a=!1,s=this._samplerSharedGroups,c=0,l=s.length;c<l;++c){var u=s[c],h=u.sampler,_=u.samplerResultCache;a=!1,h?(r=h.sample(e))<0&&((r=~r)<=0?r=0:r>=h.ratios.length?r=h.ratios.length-1:(a=!0,_.from=r-1,_.fromRatio=h.ratios[_.from],_.to=r,_.toRatio=h.ratios[_.to],r=_.from)):r=0;for(var f=u.curves,d=0,p=f.length;d<p;++d){var m=f[d];if(m.applySample(e,r,a,_,this.weight),void 0!==m.commonTargetIndex){var v=t[m.commonTargetIndex];v&&(v.changed=!0)}}}for(var g=0,y=t.length;g<y;++g){var x=t[g];x&&x.changed&&x.target.push()}},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new yu(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(oF.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(oF.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(void 0===this._lastIterations&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(oF.LASTFRAME,this),this._lastIterations=i)},n.cache=function(){},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&pu.PingPong)===pu.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&pu.Reverse)===pu.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new yu;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,o=!1,r=this.repeatCount,a=e>0?e/i:-e/i;if(a>=r){a=r,o=!0;var s=r-(0|r);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&pu.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=o,t.iterations=a,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t=this._clip.eventGroups.length,n=e.direction,i=this._clip.getEventGroupIndexAtRatio(e.ratio);if(i<0&&(i=~i-1,n<0&&(i+=1)),this._ignoreIndex!==i&&(this._ignoreIndex=-1),e.frameIndex=i,!this._lastWrapInfoEvent)return this._fireEvent(i),void(this._lastWrapInfoEvent=new yu(e));var o=this.wrapMode,r=uF(e.iterations),a=this._lastWrapInfoEvent,c=uF(a.iterations),l=a.frameIndex,u=a.direction,h=-1!==c&&r!==c;if(l===i&&h&&1===t)this._fireEvent(0);else if(l!==i||h){n=u;do{if(l!==i){if(-1===n&&0===l&&i>0?((o&pu.PingPong)===pu.PingPong?n*=-1:l=t,c++):1===n&&l===t-1&&i<t-1&&((o&pu.PingPong)===pu.PingPong?n*=-1:l=-1,c++),l===i)break;if(c>r)break}l+=n,s.director.getAnimationManager().pushDelayEvent(this._fireEvent,this,[l])}while(l!==i&&l>-1&&l<t)}this._lastWrapInfoEvent.set(e)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._fireEvent=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._clip.eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n,i=t[e],o=this._targetNode.components,r=oe(i.events);!(n=r()).done;)for(var a,s=n.value,c=s.functionName,l=oe(o);!(a=l()).done;){var u=a.value,h=u[c];"function"==typeof h&&h.apply(u,s.parameters)}}},n._onReplayOrResume=function(){s.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){s.director.getAnimationManager().removeAnimation(this)},n._destroyBlendStateWriters=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._blendStateWriters[e].destroy();this._blendStateWriters.length=0,this._blendStateBuffer&&(this._blendStateBuffer.unbindState(this),this._blendStateBuffer=null),this._blendStateWriterHost.enabled=!1},J(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){this._wrapMode=e,this.time=0,e&pu.Loop?this.repeatCount=1/0:this.repeatCount=1}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&pu.ShouldWrap,n=(this.wrapMode&pu.Reverse)===pu.Reverse;this._process=e!==1/0||t||n?this.process:this.simpleProcess}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(tF));function uF(e){return e-(0|e)==0&&(e-=1),0|e}s.AnimationState=lF;var hF,_F,fF,dF,pF,mF,vF,gF,yF,xF,EF,SF,TF,AF,wF,CF,IF,PF=function(e){function t(){var t;return(t=e.call(this)||this)._managedStates=[],t._fadings=[],t}ee(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);for(var o=0;o<t.length;++o){var r=t[o].state;r&&r.isMotionless&&r.sample()}}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i})},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),s.director.getAnimationManager().addCrossFade(this)},n.onPause=function(){e.prototype.onPause.call(this),s.director.getAnimationManager().removeCrossFade(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}},n.onResume=function(){e.prototype.onResume.call(this),s.director.getAnimationManager().addCrossFade(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}},n.onStop=function(){e.prototype.onStop.call(this),s.director.getAnimationManager().removeCrossFade(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=(this._fadings,0);n<t.length;++n){var i=t[n].state;i&&(i.weight=0)}for(var o=1,r=this._fadings.length,a=0;a<this._fadings.length;++a){var s=this._fadings[a];s.easeTime+=e;var c=0===s.easeDuration?1:rn(s.easeTime/s.easeDuration),l=c*o;if(o*=1-c,s.target.state&&(s.target.state.weight+=l),s.easeTime>=s.easeDuration){r=a+1,s.easeTime=s.easeDuration;break}}if(r!==this._fadings.length){for(var u=r;u<this._fadings.length;++u){var h=this._fadings[u];--h.target.reference,h.target.reference<=0&&(h.target.state&&h.target.state.stop(),ue(this._managedStates,h.target))}this._fadings.splice(r)}},t}(tF),bF=e("cO",(hF=b_("cc.Animation"),_F=V_(),fF=N_(99),dF=B_(),pF=rf([QL]),mF=q_(),vF=rf(QL),gF=q_(),yF=q_(),xF=rf([QL]),hF(EF=_F(EF=fF(EF=z_(EF=dF((IF=CF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return re(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",TF,ne(t)),t._crossFade=new PF,t._nameToState=we(!0),re(t,"_clips",AF,ne(t)),re(t,"_defaultClip",wF,ne(t)),t._hasBeenPlayed=!1,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=we(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&(this._crossFade.play(),this._crossFade.crossFade(n,t))},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(e){return this.getState(e)},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return he(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var o=this._nameToState[i];if(o.clip===e){n=o;break}}if(e===this._defaultClip){if(!t)return void P(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void P(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,o){var r=e.prototype.on.call(this,t,n,i,o);return t===oF.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.once=function(t,n,i){var o=e.prototype.once.call(this,t,n,i);return t===oF.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===oF.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new lF(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(oF.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n._getStateByNameOrDefaultClip=function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}return this._nameToState[e]||null},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];RF(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(oF.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(oF.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},J(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=oe(this._clips);!(n=i()).done;){var o=n.value;o&&this._removeStateOfAutomaticClip(o)}for(var r,a=oe(e);!(r=a()).done;){var s=r.value;s&&this.createState(s)}var c=e.find((function(e){return RF(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return RF(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(pi(ip)),CF.EventType=oF,ae((SF=IF).prototype,"clips",[pF,mF],Object.getOwnPropertyDescriptor(SF.prototype,"clips"),SF.prototype),ae(SF.prototype,"defaultClip",[vF,gF],Object.getOwnPropertyDescriptor(SF.prototype,"defaultClip"),SF.prototype),TF=ae(SF.prototype,"playOnLoad",[M_,yF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AF=ae(SF.prototype,"_clips",[xF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wF=ae(SF.prototype,"_defaultClip",[M_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EF=SF))||EF)||EF)||EF)||EF)||EF));function RF(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}k(bF.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return bF.prototype.removeState.call(this,e.name)}}]),s.AnimationComponent=bF,et.setClassAlias(bF,"cc.AnimationComponent");var NF,OF,DF,MF=[],LF=new Map;function FF(e,t){for(var n=0,i=Un.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,MF[n++]=e,e=e.parent}for(;n>0;){var o=(e=MF[--n]).node;Un.fromRTS(e.local,o.rotation,o.position,o.scale),i=Un.multiply(e.world,i,e.local)}return i}function zF(e,t){for(var n,i=null,o=0;e!==t;){var r=e.uuid;if(LF.has(r)){i=LF.get(r);break}i={node:e,local:new Un,world:new Un,stamp:-1,parent:null},LF.set(r,i),MF[o++]=i,e=e.parent,i=null}for(;o>0;)(n=MF[--o]).parent=i,i=n;return i}function BF(e){for(var t=LF.get(e.uuid)||null;t;)LF.delete(t.node.uuid),t=t.parent}var UF=e("fT",b_((DF=OF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new se([]),t._delayEvents=[],t._blendStateBuffer=new nF,t._crossFades=[],t._sockets=[],t}ee(t,e);var n=t.prototype;return n.addCrossFade=function(e){this._crossFades.push(e)},n.removeCrossFade=function(e){ue(this._crossFades,e)},n.update=function(e){for(var t=this._delayEvents,n=this._crossFades,i=this._sockets,o=0,r=n.length;o<r;o++)n[o].update(e);var a=this._anims,c=a.array;for(a.i=0;a.i<c.length;++a.i){var l=c[a.i];l.isMotionless||l.update(e)}this._blendStateBuffer.apply();for(var u=s.director.getTotalFrames(),h=0,_=i.length;h<_;h++){var f=i[h],d=f.target,p=f.transform;d.matrix=FF(p,u)}for(var m=0,v=t.length;m<v;m++){var g=t[m];g.fn.apply(g.thisArg,g.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):R(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var o=t[i];if(n._sockets.find((function(e){return e.target===o.target})))return"continue";var r=e.getChildByPath(o.path),a=o.target&&r&&zF(r,e);a&&n._sockets.push({target:o.target,transform:a})},o=0;o<t.length;++o)i(o)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],o=0;o<this._sockets.length;++o){var r=this._sockets[o];if(r.target===i.target){BF(r.transform.node),this._sockets[o]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},J(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(uI),OF.ID="animation",NF=DF))||NF);bN.on(PN.EVENT_INIT,(function(){var e=new UF;bN.registerSystem(UF.ID,e,mI.PRIORITY_SYSTEM)})),s.AnimationManager=UF;var HF,GF,VF,kF,WF=new Un;s.easing=sI;var jF=e("fE",b_("cc.HierachyModifier")(HF=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(ZM))||HF);s.HierachyModifier=jF;var qF=e("fF",b_("cc.ComponentModifier")(GF=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(JM))||GF);s.ComponentModifier=qF;var YF=e("fG",b_("cc.CurveValueAdapter")(VF=function(){function e(){}return e.prototype.forTarget=function(){return{set:function(){}}},e}())||VF);s.CurveValueAdapter=YF;var XF=e("fH",b_("cc.UniformCurveValueAdapter")(kF=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(hL))||kF);function KF(e){return"string"==typeof e}function QF(e){return"number"==typeof e}function ZF(e,t){return e instanceof t}s.UniformCurveValueAdapter=XF,s.isPropertyModifier=KF,s.isElementModifier=QF,s.isCustomTargetModifier=ZF,s.math=ei,s.geometry=Mu;var JF=e("fV",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var o=this._pool[i];this._pool.length=i;var r=this.poolHandlerComp?o.getComponent(this.poolHandlerComp):null;return r&&r.reuse&&r.reuse(arguments),o},e}());s.NodePool=JF,s.renderer=bC;var $F=new URL("assets/ammo.wasm-2f572f72.wasm",t.meta.url).href;let ez,tz=!1;"undefined"==typeof WebAssembly?ez=await t.import("./ammo-3dd61cc9.js"):(ez=await t.import("./ammo.wasm-3bc223bd.js"),tz=!0);var nz,iz=ez.default,oz=e("dR",{});function rz(e){var t={};return void 0!==e&&(oz.wasmBinary=e),new Promise((function(e){iz.call(t,oz).then((function(){e()}))}))}(nz=rz||(rz=e("fW",{}))).isWasm=tz,nz.wasmBinaryURL=$F}}}));
